<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://api.ontostandard.org; frame-ancestors 'none'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ONTO — Client Portal</title>
<meta name="description" content="ONTO Client Portal — Connect your AI model, measure epistemic discipline, get scored and certified. 10× measured improvement.">
<meta name="robots" content="noindex, nofollow">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Ccircle cx='18' cy='18' r='17' fill='white'/%3E%3Cpath d='M16 10L20 10L20 26L16 26L16 14L13 14L13 10L16 10Z' fill='%230a0a0a'/%3E%3C/svg%3E">
<style>
:root {
    color-scheme: dark;
    --bg: #0a0a0a;
    --bg-secondary: #121212;
    --bg-card: #1a1a1a;
    --bg-elevated: #242424;
    --border: #333333;
    --border-hover: #444444;
    --text: #fafafa;
    --text-secondary: #a0a0a0;
    --text-muted: #606060;
    --accent: #15803d;
    --accent-hover: #166534;
    --accent-subtle: rgba(21, 128, 61, 0.1);
    --danger: #dc2626;
    --danger-subtle: rgba(220, 38, 38, 0.1);
    --blue: #64748b;
    --blue-subtle: rgba(59, 130, 246, 0.1);
}

/* === LIGHT THEME === */
[data-theme="light"] {
    color-scheme: light;
    --bg: #ffffff;
    --bg-secondary: #fafafa;
    --bg-card: #ffffff;
    --bg-elevated: #f5f5f5;
    --border: #e5e7eb;
    --border-hover: #d1d5db;
    --text: #111827;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
}
[data-theme="light"] select,
[data-theme="light"] select option,
[data-theme="light"] select optgroup {
    background-color: #ffffff;
    color: #111827;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.6; color: var(--text); background: var(--bg-secondary); }

/* === AUTH === */
.auth-container { min-height: 100vh; display: flex; align-items: stretch; }
.auth-hero { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 48px 56px; background: var(--bg); border-right: 1px solid var(--border); }
.auth-hero h1 { font-size: 28px; font-weight: 700; line-height: 1.25; margin-bottom: 16px; letter-spacing: -0.5px; }
.auth-hero p { font-size: 14px; color: var(--text-secondary); line-height: 1.6; max-width: 400px; }
.auth-hero-stats { display: flex; gap: 32px; margin-top: 40px; padding-top: 32px; border-top: 1px solid var(--border); }
.auth-hero-stat { display: flex; flex-direction: column; }
.auth-hero-stat strong { font-size: 22px; font-weight: 700; font-variant-numeric: tabular-nums; }
.auth-hero-stat span { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
.auth-form-side { width: 480px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; padding: 24px 40px; background: var(--bg-card); }
.auth-card { background: none; border: none; border-radius: 0; padding: 0; width: 100%; max-width: 380px; }
.auth-title { font-size: 15px; font-weight: 600; text-align: center; margin-bottom: 4px; }
.auth-subtitle { color: var(--text-secondary); text-align: center; margin-bottom: 24px; font-size: 12px; }

/* === FORMS === */
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 11px; font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: .3px; color: var(--text-muted); }
.form-input { width: 100%; padding: 8px 10px; font-size: 13px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-elevated); color: var(--text); transition: all 0.15s; }
.form-input::placeholder { color: var(--text-muted); opacity: 0.7; }
.form-input:focus { outline: none; border-color: var(--accent); }
.form-input.error { border-color: var(--danger); }
.form-input.error:focus { box-shadow: none; }

/* Institutional Form */
.form-inst .form-group { margin-bottom: 14px; }
.form-inst .form-label { font-size: 12px; font-weight: 400; color: var(--text-muted); margin-bottom: 4px; }
.form-inst .form-label.required::after { content: ' *'; color: var(--text-muted); }
.form-inst .form-input { padding: 8px 10px; font-size: 13px; border-radius: 4px; background: var(--bg-elevated); transition: border-color 0.2s, background-color 0.2s; }
.form-inst .form-input::placeholder { color: var(--text-muted); opacity: 0.6; }
.form-inst textarea.form-input { resize: vertical; min-height: 60px; font-family: inherit; }
.form-inst .form-input:focus { box-shadow: none; border-color: var(--text-muted); }
.form-inst .form-input.valid { border-color: var(--border); }
.form-inst .form-input.empty-required { border-color: rgba(156, 163, 175, 0.5); background: rgba(156, 163, 175, 0.03); }
.form-inst .form-input.error { border-color: rgba(239, 68, 68, 0.5); background: rgba(239, 68, 68, 0.03); }
.form-inst select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 32px; cursor: pointer; }
.form-inst select.form-input option { background: var(--bg-card); color: var(--text); padding: 8px; }
.form-inst select.form-input optgroup { background: var(--bg-elevated); color: var(--text-secondary); font-weight: 600; }
.form-inst select.form-input.valid { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); }
.password-wrapper { position: relative; }
.password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); }

/* === TERMS SCROLL === */
.terms-container { border: 1px solid var(--border); border-radius: 4px; height: 160px; overflow-y: auto; padding: 12px; margin-bottom: 12px; background: var(--bg); font-size: 12px; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.terms-container h3 { font-size: 12px; margin: 12px 0 4px; color: var(--text); }
.terms-container h3:first-child { margin-top: 0; }
.terms-container p { margin-bottom: 4px; color: var(--text-secondary); }
.terms-container ul { margin: 4px 0 4px 16px; }
.terms-container li { margin-bottom: 2px; color: var(--text-secondary); }
.terms-container table { width: 100%; margin: 4px 0; font-size: 11px; border-collapse: collapse; }
.terms-container th, .terms-container td { padding: 4px 6px; border: 1px solid var(--border); text-align: left; }
.terms-container th { background: var(--bg-elevated); font-weight: 500; }

.checkbox-group { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 16px; }
.agreement-notice { font-size: 11px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5; }
.agreement-notice a { color: var(--text-muted); text-decoration: underline; }
.form-inst .checkbox-group { margin-bottom: 8px; }
.form-inst .checkbox-group label { font-size: 11px; color: var(--text-secondary); transition: color 0.2s; }
.form-inst .checkbox-group.checked label { color: var(--text); }
.form-inst .checkbox-group input[type="checkbox"] { accent-color: var(--accent); }
.checkbox-group input[type="checkbox"] { width: 16px; height: 16px; margin-top: 1px; accent-color: var(--accent); }
.checkbox-group label { font-size: 12px; color: var(--text-secondary); cursor: pointer; }
.checkbox-group a { color: var(--accent); text-decoration: none; }

/* === BUTTONS === */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; width: 100%; }
.btn-primary { background: var(--accent-subtle); color: var(--accent); border: 1px solid var(--accent); }
.btn-primary:hover { background: var(--accent); color: white; }
.btn-primary:disabled { background: var(--bg-elevated); color: var(--text-muted); cursor: not-allowed; transform: none; pointer-events: none; border-color: var(--border); }
.btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--bg-elevated); color: var(--text); }

.auth-switch { text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-secondary); }
.auth-switch a { color: var(--accent); text-decoration: none; font-weight: 500; cursor: pointer; }

/* === AUTH MENU (mobile burger) === */
.auth-menu { display: none; position: fixed; top: 0; left: 0; width: 280px; height: 100vh; background: var(--bg-card); border-right: 1px solid var(--border); z-index: 102; flex-direction: column; transform: translateX(-100%); transition: transform 0.2s ease; }
.auth-menu.open { display: flex; transform: translateX(0); }
.auth-menu-header { display: flex; align-items: center; gap: 8px; padding: 14px 16px; border-bottom: 1px solid var(--border); }
.auth-menu-header svg { width: 24px; height: 24px; flex-shrink: 0; }
.auth-menu-close { margin-left: auto; background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; }
.auth-menu-close:hover { color: var(--text); }
.auth-menu-nav { padding: 12px 8px; flex: 1; overflow-y: auto; }
.auth-menu-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 4px; color: var(--text-secondary); text-decoration: none; font-size: 12px; font-weight: 500; transition: all 0.15s; }
.auth-menu-item:hover { background: var(--bg-elevated); color: var(--text); }
.auth-menu-item svg { width: 16px; height: 16px; flex-shrink: 0; }
.auth-menu-sub { display: block; padding: 4px 12px 4px 38px; font-size: 11px; color: var(--text-muted); text-decoration: none; }
.auth-menu-sub:hover { color: var(--text); }
.auth-menu-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 101; }
.auth-menu-overlay.visible { display: block; }
.otp-input { width: 40px; height: 46px; text-align: center; font-size: 18px; font-weight: 600; font-family: 'JetBrains Mono', monospace; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text); outline: none; transition: border-color 0.2s; }
.otp-input:focus { border-color: var(--accent); }
.otp-input.error { border-color: #ef4444; }

/* === DASHBOARD === */
.dashboard { display: none; min-height: 100vh; }
.dashboard.active { display: flex; }
.sidebar { display: none; width: 240px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 0; position: fixed; height: 100vh; flex-direction: column; }
.sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.sidebar-header-actions { display: flex; align-items: center; gap: 6px; }
.sidebar-logo { display: flex; align-items: center; gap: 8px; }
.sidebar-logo svg { width: 24px; height: 24px; }
.sidebar-logo span { font-size: 18px; font-weight: 700; }
.sidebar-close { display: none; background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; }
.sidebar-close:hover { color: var(--text); }
.sidebar.mobile-open .sidebar-close { display: block; }
.sidebar-nav { padding: 12px 8px; flex: 1; overflow-y: auto; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 4px; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; font-size: 12px; font-weight: 500; }
.nav-item:hover { background: var(--bg-elevated); color: var(--text); }
.nav-item.active { background: var(--accent-subtle); color: var(--accent); }
.nav-item svg { width: 16px; height: 16px; }
.nav-divider { height: 1px; background: var(--border); margin: 8px 12px; }
.sidebar-footer { border-top: 1px solid var(--border); padding: 8px 12px; margin-top: auto; flex-shrink: 0; }
.sidebar-user { display: flex; align-items: center; gap: 8px; }
.user-avatar { width: 28px; height: 28px; border-radius: 4px; background: var(--bg-elevated); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 11px; border: 1px solid var(--border); }
.user-info { flex: 1; min-width: 0; }
.user-name { font-weight: 500; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-tier { font-size: 10px; color: var(--text-muted); }
.user-plan { font-size: 11px; color: var(--text-muted); }
.tier-badge { font-size: 10px; color: var(--text-muted); }

.main-content { flex: 1; margin-left: 0; padding: 12px; padding-top: 64px; overflow-x: hidden; }
.page { display: none; overflow-x: hidden; }
.page.active { display: block; }
.page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; gap: 16px; }
.page-title { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
.page-subtitle { color: var(--text-secondary); font-size: 12px; }

/* === INSTITUTIONAL PAGES === */
.page-header-clean { margin-bottom: 24px; }
.page-header-clean .page-title { font-size: 18px; font-weight: 500; letter-spacing: -0.3px; }

.section-block { margin-bottom: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px 20px; overflow-x: auto; }
.section-block:last-child { margin-bottom: 0; }
.section-label { font-size: 9px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
.section-text { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; word-wrap: break-word; }
.section-footnote { font-size: 11px; color: var(--text-muted); margin-top: 10px; word-break: break-word; }
.section-footnote a { color: var(--text-secondary); text-decoration: none; word-break: break-all; }
.section-footnote a:hover { text-decoration: underline; }

.key-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.key-input { width: 100%; padding: 10px 12px; font-family: 'JetBrains Mono', monospace; font-size: 11px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
.key-buttons { display: flex; gap: 8px; }
.key-meta { display: flex; flex-direction: column; gap: 4px; font-size: 11px; color: var(--text-muted); }

.btn-minimal { padding: 7px 14px; font-size: 11px; font-weight: 500; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
.btn-minimal:hover { border-color: var(--accent); color: var(--accent); }
.btn-minimal:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-minimal:disabled:hover { background: var(--bg-elevated); color: var(--text-secondary); border-color: var(--border); }

.btn-danger-outline { padding: 8px 14px; font-size: 12px; font-weight: 500; background: transparent; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); cursor: pointer; transition: all 0.15s; }
.btn-danger-outline:hover { background: rgba(239, 68, 68, 0.08); }

pre { max-width: 100%; overflow-x: auto; }

/* Info Rows */
.info-row { display: flex; align-items: center; padding: 10px 12px; margin: 0 -12px; border-radius: 4px; gap: 12px; transition: background 0.1s; }
.info-row:hover { background: var(--bg-elevated); }
.info-key { font-size: 12px; color: var(--text-muted); min-width: 100px; }
.info-val { font-size: 13px; color: var(--text); flex: 1; font-weight: 500; }
a.info-val { color: var(--text-secondary); text-decoration: none; }
a.info-val:hover { color: var(--text); }
.info-val.status-active { display: flex; align-items: center; gap: 6px; }
.info-val .dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }
.info-action { font-size: 11px; color: var(--accent); cursor: pointer; font-weight: 500; opacity: 0.7; }
.info-action:hover { opacity: 1; }

/* Doc Rows */
.doc-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; margin: 0 -12px; border-radius: 4px; transition: background 0.1s; }
.doc-row:hover { background: var(--bg-elevated); }
.doc-name { font-size: 13px; color: var(--text); font-weight: 500; }
.doc-link { font-size: 11px; color: var(--accent); cursor: pointer; font-weight: 500; }
.doc-link:hover { color: var(--text); }

/* === TIERS === */
.tiers-grid { display: grid; grid-template-columns: 1fr; gap: 12px; max-width: 320px; margin: 0 auto; }
.tier-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; }
.tier-name { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 6px; }
.tier-price { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.tier-price span { font-size: 12px; font-weight: 400; color: var(--text-muted); }
.tier-desc { font-size: 11px; color: var(--text-muted); margin-bottom: 12px; }
.tier-list { list-style: none; padding: 0; margin: 0 0 16px 0; }
.tier-list li { font-size: 12px; color: var(--text-secondary); padding: 4px 0; border-bottom: 1px solid var(--border); }
.tier-list li:last-child { border-bottom: none; }
.btn-tier { width: 100%; padding: 8px; font-size: 12px; font-weight: 500; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text); cursor: pointer; transition: all 0.15s; margin-bottom: 6px; }
.btn-tier:hover { background: var(--bg-elevated); }
.btn-tier.current { background: var(--bg-elevated); color: var(--text-muted); cursor: default; }
.btn-tier-secondary { width: 100%; padding: 6px; font-size: 11px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; }
.btn-tier-secondary:hover { color: var(--text); }

/* === CARDS === */
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 20px; }

/* === SETTINGS === */

/* === BILLING CARDS === */

/* === EVALUATE PAGE === */
.eval-select { width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:6px 10px;font-size:12px;cursor:pointer; }
.eval-select:focus { outline:none;border-color:var(--accent); }

/* Compact model list */
@media (max-width: 768px) { #dash-demo-grid { grid-template-columns: 1fr !important; } #dash-detail-expanded > div:last-child { grid-template-columns: 1fr !important; } }
@media (max-width: 768px) { #dash-status-bar { flex-wrap:wrap;gap:8px; } #dash-status-bar > div[style*="width:1px"] { display:none; } }
@media (max-width: 768px) { #audit-stats-bar { grid-template-columns: repeat(2, 1fr) !important; } }

.eval-form-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 16px; }
.eval-form-card label { display: block; font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.eval-form-card textarea { width: 100%; min-height: 120px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); padding: 10px 12px; font-size: 13px; font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; resize: vertical; box-sizing: border-box; }
.eval-form-card textarea:focus { outline: none; border-color: var(--accent); }
.eval-form-card select { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); padding: 8px 12px; font-size: 13px; cursor: pointer; }
.eval-form-card select:focus { outline: none; border-color: var(--accent); }
.eval-form-card input[type="number"] { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); padding: 8px 12px; font-size: 13px; box-sizing: border-box; }
.eval-form-card input[type="number"]:focus { outline: none; border-color: var(--accent); }
.eval-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
.eval-form-group { margin-bottom: 14px; }
.eval-form-group:last-child { margin-bottom: 0; }
.eval-optional-toggle { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; cursor: pointer; font-size: 12px; color: var(--text-secondary); }
.eval-optional-toggle:hover { color: var(--text); }
.eval-optional-fields { display: none; }
.eval-optional-fields.show { display: block; }
.eval-submit-row { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; }
.eval-submit-btn { background: var(--accent); color: #fff; border: none; padding: 10px 28px; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; transition: opacity 0.15s; }
.eval-submit-btn:hover { opacity: 0.85; }
.eval-submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.eval-submit-hint { font-size: 11px; color: var(--text-muted); }

/* Results */
.eval-result-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 16px; display: none; }
.eval-result-card.show { display: block; }
.eval-result-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.eval-score-ring { width: 80px; height: 80px; position: relative; flex-shrink: 0; }
.eval-score-ring svg { width: 80px; height: 80px; transform: rotate(-90deg); }
.eval-score-ring .ring-bg { fill: none; stroke: var(--border); stroke-width: 6; }
.eval-score-ring .ring-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease, stroke 0.3s; }
.eval-score-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.eval-score-value { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
.eval-score-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.eval-result-meta { flex: 1; }
.eval-compliance-badge { display: inline-block; padding: 4px 12px; border-radius: 3px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px; margin-bottom: 6px; }
.eval-compliance-badge.passed { background: rgba(34,197,94,0.12); color: #22c55e; }
.eval-compliance-badge.review { background: rgba(234,179,8,0.12); color: #eab308; }
.eval-compliance-badge.failed { background: rgba(239,68,68,0.12); color: #ef4444; }
.eval-result-domain { font-size: 12px; color: var(--text-secondary); }
.eval-result-timestamp { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

/* Factor breakdown */
.eval-factors { display: grid; grid-template-columns: 1fr; gap: 8px; }
.eval-factor { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
.eval-factor-name { width: 140px; font-size: 11px; color: var(--text-secondary); flex-shrink: 0; }
.eval-factor-bar-wrap { flex: 1; height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden; }
.eval-factor-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
.eval-factor-val { width: 44px; text-align: right; font-size: 12px; font-weight: 500; font-variant-numeric: tabular-nums; flex-shrink: 0; }

/* Session history */
.eval-history { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px; }
.eval-history-title { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
.eval-history-empty { font-size: 12px; color: var(--text-muted); text-align: center; padding: 20px 0; }
.eval-history-row { display: grid; grid-template-columns: 60px 1fr 70px 70px; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; align-items: center; }
.eval-history-row:last-child { border-bottom: none; }
.eval-history-row .risk-pill { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; }
.eval-history-output { color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
@media (max-width: 768px) { .eval-form-row { grid-template-columns: 1fr; } .eval-history-row { grid-template-columns: 60px 1fr 60px; } .eval-history-row span:last-child { display: none; } }

/* === MODALS === */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
.modal-overlay.active { display: flex; }
.modal { background: var(--bg-card); border-radius: 6px; width: 100%; max-width: 520px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); }
.modal-wide { max-width: 600px; }
.modal-inst { border-radius: 6px; }
.modal-inst .modal-header { padding: 14px 16px; border-bottom: 1px solid var(--border); }
.modal-inst .modal-header h2 { font-size: 14px; font-weight: 500; }
.modal-inst .modal-body { padding: 16px; }
.modal-inst .modal-footer { padding: 12px 16px; }
.form-section { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.form-section:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.form-section-title { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
.form-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 480px) { .form-row { grid-template-columns: 1fr 1fr; } }
.modal-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-header h2 { font-size: 15px; font-weight: 500; }
.modal-close { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 20px; line-height: 1; }
.modal-body { padding: 16px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
.modal-footer .btn { width: auto; min-width: 100px; }

/* === BILLING CYCLE SELECTOR === */

/* Order Modal - Institutional */
.order-section { margin-bottom: 20px; }
.order-features { display: flex; flex-direction: column; gap: 4px; }
.order-feature { font-size: 12px; color: var(--text-secondary); padding-left: 12px; position: relative; }
.order-feature::before { content: '—'; position: absolute; left: 0; color: var(--text-muted); font-size: 10px; }

.billing-options { display: flex; flex-direction: column; gap: 8px; }
.billing-option { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.15s; }
.billing-option:hover { border-color: var(--text-muted); }
.billing-option:has(input:checked) { border-color: var(--accent); background: rgba(34, 197, 94, 0.03); }
.billing-option input[type="radio"] { accent-color: var(--accent); }
.billing-option-content { flex: 1; display: flex; flex-direction: column; gap: 1px; }
.billing-option-name { font-size: 13px; font-weight: 500; color: var(--text); }
.billing-option-detail { font-size: 11px; color: var(--text-muted); }
.billing-option-price { font-size: 14px; font-weight: 600; color: var(--text); }

.payment-options { display: flex; gap: 8px; }
.payment-opt { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 12px 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.15s; text-align: center; }
.payment-opt:hover { border-color: var(--text-muted); }
.payment-opt:has(input:checked) { border-color: var(--accent); background: rgba(34, 197, 94, 0.03); }
.payment-opt:has(input:disabled) { opacity: 0.4; cursor: not-allowed; }
.payment-opt input[type="radio"] { accent-color: var(--accent); margin-bottom: 2px; }
.payment-opt-name { font-size: 12px; font-weight: 500; color: var(--text); }
.payment-opt-note { font-size: 10px; color: var(--text-muted); }

.order-summary { margin-top: 20px; padding: 16px; background: var(--bg-elevated); border-radius: 6px; }
.order-summary-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
.order-summary-row.total { padding-top: 12px; margin-top: 8px; border-top: 1px solid var(--border); }
.order-summary-label { font-size: 12px; color: var(--text-secondary); }
.order-summary-row.total .order-summary-label { font-size: 13px; font-weight: 500; color: var(--text); }
.order-summary-value { font-size: 13px; font-weight: 500; color: var(--text); }
.order-summary-row.total .order-summary-value { font-size: 18px; font-weight: 600; }

.payment-method { margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); }
.payment-method h4 { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
.payment-option { display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
.payment-option.disabled { opacity: 0.5; cursor: not-allowed; }
.payment-option input[type="radio"] { accent-color: var(--accent); }
.payment-option .lock-icon { color: var(--text-muted); font-size: 12px; }

/* === DOCUMENTS === */
/* === HIDDEN === */
.hidden { display: none !important; }

/* === DOCUMENTATION STYLES === */

/* Docs mobile select */

/* === LOADING STATE === */
.btn.loading { pointer-events: none; opacity: 0.7; }
.btn.loading::after { content: ""; width: 14px; height: 14px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; margin-left: 8px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* === TOAST === */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast { padding: 12px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.2s ease; }
.toast.success { background: var(--accent); color: white; }
.toast.error { background: var(--danger); color: white; }
.toast.info { background: var(--blue); color: white; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* === MOBILE === */
.mobile-header { display: flex; position: fixed; top: 0; left: 0; right: 0; height: 56px; background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 0 16px; align-items: center; justify-content: space-between; z-index: 100; }
.mobile-header .hamburger:first-child { order: 0; }
.mobile-header .logo { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; order: 1; }
.mobile-header .logo svg { width: 22px; height: 22px; }
.mobile-header .hamburger:last-child { order: 2; }
.hamburger { background: none; border: none; cursor: pointer; padding: 8px; color: var(--text); }
.hamburger svg { width: 24px; height: 24px; }
.sidebar.mobile-open { display: flex; flex-direction: column; position: fixed; z-index: 99; left: 0; top: 56px; height: calc(100vh - 56px); height: calc(100dvh - 56px); width: 240px; }
.mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 98; }
.mobile-overlay.active { display: block; }
.signal-hash { display: flex; align-items: center; gap: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
.signal-hash .label { color: var(--text-muted); }
.signal-hash .bytes { display: flex; gap: 2px; }
.signal-hash .byte { color: var(--accent); animation: pulse-byte 2s infinite; }
.signal-hash .ellipsis { color: var(--text-muted); }
.signal-hash .size { color: var(--text-muted); margin-left: 8px; font-size: 11px; }
@keyframes pulse-byte { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

/* Status Bar */
.utc-clock { font-family: 'JetBrains Mono', monospace; color: var(--text); }
@keyframes pulse-signal { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

/* === DASHBOARD — CLEAN INSTITUTIONAL === */

/* Header */
/* === INSTITUTIONAL DASHBOARD === */

/* Status Bar — minimal, institutional */
.metric-val { font-size: 14px; font-weight: 500; color: var(--text); }
.metric-val.mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 400; }
.status-active { display: flex; align-items: center; gap: 6px; color: var(--text); }
.status-active .dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

/* Signal Bars — subtle */

/* === MODELS OVERVIEW === */

/* Models Grid */

/* Comparison */

/* Detail Panel */

/* === MODEL STATUS === */
.model-name { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.model-id { font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
.risk-label { font-size: 9px; color: var(--text-muted); letter-spacing: 1px; margin-top: 2px; }

/* Trend Chart */
.trend-bar { flex: 1; border-radius: 2px 2px 0 0; min-width: 8px; transition: height .3s; position: relative; }
.trend-bar.low { background: var(--accent); opacity: 0.7; }
.trend-bar.medium { background: #d97706; opacity: 0.7; }
.trend-bar.high { background: #dc2626; opacity: 0.7; }
.trend-bar:hover { opacity: 1; }
.trend-bar::after { content: attr(data-val); position: absolute; top: -16px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--text-muted); display: none; }
.trend-bar:hover::after { display: block; }
.trend-dir.improving { color: var(--accent); }
.trend-dir.worsening { color: #dc2626; }

/* Signal Compact */
@media (max-width: 768px) { .signal-compact { flex-direction: column; gap: 8px; } .signal-compact-hash { max-width: 100%; } }

/* Proof Badge */
.proof-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 4px; padding: 4px 10px; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #22c55e; cursor: pointer; transition: all 0.2s; margin-top: 8px; text-decoration: none; }
.proof-badge:hover { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.4); }
.proof-badge .proof-icon { font-size: 12px; }
.proof-badge .proof-hash-text { max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.proof-badge .proof-verify { color: rgba(34,197,94,0.6); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Grid — clean */
@media (max-width: 768px) { .dash-grid-2col { grid-template-columns: 1fr; } }
@media (max-width: 768px) { .welcome-banner > div:nth-child(2) { grid-template-columns: 1fr; } }
@media (max-width: 768px) { #cert-cards { grid-template-columns: 1fr !important; } }
.dash-card-clean { background: var(--bg-card); border-radius: 6px; padding: 20px; }
.card-head { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 16px; }

/* Chart — centered */

/* Table — clean */

/* Quick Start — minimal */

/* Welcome Banner */
.welcome-banner { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px 20px; margin-bottom: 24px; }

/* Plan Card */
.plan-name { font-size: 20px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.btn-upgrade { width: 100%; padding: 10px; background: transparent; border: 1px solid var(--accent); color: var(--accent); border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all .15s; }
.btn-upgrade:hover { background: var(--accent); color: #fff; }
.welcome-banner.hidden { display: none; }
.code { background: #0c0f14; color: #e2e8f0; padding: 14px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; overflow-x: auto; margin: 0; max-width: 100%; box-sizing: border-box; }

/* ============================================
   SKELETON
   ============================================ */
.skeleton { background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-elevated) 50%, var(--bg-secondary) 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; border-radius: 4px; }
@keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.skeleton-text { height: 14px; width: 60%; }
.skeleton-text-sm { height: 11px; width: 80%; }
.skeleton-metric { height: 20px; width: 50px; margin: 0 auto; }

/* ============================================
   ADMIN PANEL
   ============================================ */
@keyframes slideDown { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

/* Signal Panel */
.signal-panel { background: linear-gradient(135deg, #0a1a0f 0%, #0d2818 50%, #0a1a0f 100%); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 20px 24px; margin-bottom: 20px; position: relative; overflow: hidden; animation: borderGlow 4s ease-in-out infinite; }
@keyframes borderGlow {
    0%, 100% { border-color: rgba(34, 197, 94, 0.3); box-shadow: 0 0 20px rgba(34, 197, 94, 0.1); }
    50% { border-color: rgba(34, 197, 94, 0.6); box-shadow: 0 0 40px rgba(34, 197, 94, 0.2); }
}
.signal-panel::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(34, 197, 94, 0.08) 0%, transparent 70%); pointer-events: none; }
.signal-panel::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent 0%, rgba(34, 197, 94, 0.8) 50%, transparent 100%); animation: scanline 6s linear infinite; pointer-events: none; box-shadow: 0 0 10px rgba(34, 197, 94, 0.6), 0 0 20px rgba(34, 197, 94, 0.4), 0 0 30px rgba(34, 197, 94, 0.2); }
@keyframes scanline {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(300px); opacity: 0; }
}
.signal-panel-grid { position: absolute; inset: 0; background-image: 
    linear-gradient(rgba(34, 197, 94, 0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(34, 197, 94, 0.03) 1px, transparent 1px);
    background-size: 20px 20px; pointer-events: none; }
.signal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; position: relative; z-index: 1; }
.signal-title-row { display: flex; align-items: center; gap: 10px; }
.signal-live-indicator { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(34, 197, 94, 0.15); border-radius: 12px; font-size: 10px; font-weight: 600; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; }
.signal-title { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; color: var(--text); }
.signal-live { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(34, 197, 94, 0.15); border-radius: 12px; font-size: 10px; font-weight: 600; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; }
.signal-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 0 6px #22c55e, 0 0 12px rgba(34, 197, 94, 0.5); }
@keyframes pulse { 0%, 100% { opacity: 1; box-shadow: 0 0 6px #22c55e, 0 0 12px rgba(34, 197, 94, 0.5); } 50% { opacity: 0.6; box-shadow: 0 0 3px #22c55e; } }
.signal-body { position: relative; z-index: 1; }
.signal-main-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
.signal-id-block { flex: 1; }
.signal-id { font-size: 24px; font-weight: 700; color: #22c55e; font-family: 'JetBrains Mono', monospace; margin-bottom: 6px; text-shadow: 0 0 20px rgba(34, 197, 94, 0.4); animation: idGlow 3s ease-in-out infinite; }
@keyframes idGlow {
    0%, 100% { text-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
    50% { text-shadow: 0 0 30px rgba(34, 197, 94, 0.6), 0 0 50px rgba(34, 197, 94, 0.3); }
}
.signal-skeleton-id { height: 28px; width: 200px; background: rgba(34, 197, 94, 0.1); border-radius: 4px; animation: skeleton-loading 1.5s infinite; background-size: 200% 100%; background-image: linear-gradient(90deg, rgba(34, 197, 94, 0.05) 25%, rgba(34, 197, 94, 0.15) 50%, rgba(34, 197, 94, 0.05) 75%); }
.signal-skeleton-hash { height: 14px; width: 300px; background: rgba(34, 197, 94, 0.1); border-radius: 4px; animation: skeleton-loading 1.5s infinite; background-size: 200% 100%; background-image: linear-gradient(90deg, rgba(34, 197, 94, 0.05) 25%, rgba(34, 197, 94, 0.15) 50%, rgba(34, 197, 94, 0.05) 75%); }
.signal-countdown-block { text-align: right; }
.signal-countdown-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.signal-countdown-value { font-size: 28px; font-weight: 700; color: #22c55e; font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
.signal-metrics { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
.signal-metric { text-align: center; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.1); transition: all 0.3s; }
.signal-metric.updated { border-color: rgba(34, 197, 94, 0.4); background: rgba(34, 197, 94, 0.1); }
.signal-metric-value { font-size: 14px; font-weight: 600; color: #22c55e; font-family: 'JetBrains Mono', monospace; margin-bottom: 2px; transition: color 0.3s; }
.signal-metric-value.metric-good { color: #22c55e; }
.signal-metric-value.metric-warn { color: #f59e0b; }
.signal-metric-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

/* Accounts Panel */
.accounts-search { width: 180px; padding: 6px 10px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); }
.accounts-search:focus { outline: none; border-color: var(--accent); }
.accounts-list { max-height: 300px; overflow-y: auto; }
.accounts-loading { padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px; }
.account-row { display: flex; align-items: center; padding: 10px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
.account-row:hover { background: var(--bg-secondary); }
.account-row:last-child { border-bottom: none; }
.account-email { flex: 1; font-size: 12px; color: var(--text); font-weight: 500; }
.account-type { width: 70px; font-size: 10px; color: var(--text-muted); }
.account-plan { width: 60px; }
.account-plan .tier-badge { font-size: 9px; padding: 2px 6px; }
.account-status { width: 50px; font-size: 10px; }
.account-status.active { color: #22c55e; }
.account-status.paused { color: #f59e0b; }
.account-date { width: 70px; font-size: 10px; color: var(--text-muted); text-align: right; }
.account-details { display: none; padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); animation: slideDown 0.2s ease; }
.account-details.open { display: block; }
.account-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
.account-detail-item { font-size: 11px; }
.account-detail-label { color: var(--text-muted); margin-bottom: 2px; }
.account-detail-value { color: var(--text); font-weight: 500; }
.account-actions { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border); }
.account-action-btn { padding: 5px 10px; font-size: 10px; font-weight: 500; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
.account-action-btn:hover { background: var(--bg-elevated); color: var(--text); }
.account-action-btn.danger { color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
.account-action-btn.danger:hover { background: rgba(239, 68, 68, 0.1); }
.account-action-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* Signal 104b Log */
.signal-log-panel { position: fixed; bottom: 20px; right: 20px; width: 360px; max-height: 300px; background: var(--bg-elevated); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000; overflow: hidden; }
.signal-log-list { max-height: 240px; overflow-y: auto; }
.signal-log-item { padding: 8px 14px; border-bottom: 1px solid var(--border); font-size: 10px; }
.signal-log-item:last-child { border-bottom: none; }
.signal-log-code { font-weight: 600; color: #ef4444; }
.signal-log-endpoint { color: var(--text-muted); font-family: monospace; }
.signal-log-time { color: var(--text-muted); float: right; }

.sidebar, .nav-item, button, .admin-user-card { user-select: none; -webkit-user-select: none; }

/* ============================================
   RESPONSIVE
   ============================================ */

@media (max-width: 639px) {
    .auth-title { font-size: 20px; }
    .otp-input { width: 38px; height: 46px; font-size: 20px; }
    .signal-metrics { grid-template-columns: repeat(3, 1fr); }
    .signal-main-row { flex-direction: column; gap: 12px; }
    .signal-countdown-block { text-align: left; }
}

@media (max-width: 900px) {
    .auth-container { flex-direction: column; }
    .auth-hero { padding: 32px 24px 24px; border-right: none; border-bottom: 1px solid var(--border); }
    .auth-hero h1 { font-size: 22px; }
    .auth-hero-stats { gap: 24px; margin-top: 24px; padding-top: 20px; }
    .auth-hero-stat strong { font-size: 18px; }
    .auth-form-side { width: 100%; padding: 24px; }
}

@media (min-width: 640px) {
    .main-content { padding: 24px; }
    
    .signal-hash { display: flex; }
    
    .metric-val { font-size: 15px; }
    
    .dash-card-clean { padding: 20px; }
    
    
    
    .code { font-size: 12px; padding: 14px; }
    
    /* API Key page */
    .key-row { flex-direction: row; align-items: center; }
    .key-input { width: auto; flex: 1; font-size: 13px; }
    .key-meta { flex-direction: row; gap: 24px; font-size: 12px; }
}

@media (min-width: 900px) {
    .sidebar { display: flex; flex-direction: column; }
    .sidebar-close { display: none !important; }
    .main-content { margin-left: 240px; padding: 28px 36px; padding-top: 28px; }
    .mobile-header { display: none; }
    
    
    .metric-val { font-size: 16px; }
    
    .dash-card-clean { padding: 20px; border-radius: 6px; }
    .card-head { font-size: 13px; }
    
    
    .tiers-grid { grid-template-columns: repeat(3, 1fr); max-width: none; gap: 16px; }
    .tier-card { padding: 20px; border-radius: 6px; }
}

@media (min-width: 1200px) {
    .main-content { padding: 32px 40px; }
    
    .metric-val { font-size: 16px; }
    
    .dash-card-clean { padding: 24px; }
    
}

/* Risk badges */

</style>

</head>
<body>

<!-- TOAST -->
<div class="toast-container" id="toast-container"></div>

<!-- MOBILE HEADER -->
<div class="mobile-header">
    <button class="hamburger" onclick="toggleAuthMenu()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="logo">
        <svg width="22" height="22" viewBox="0 0 36 36" fill="none"><circle cx="18" cy="18" r="17" fill="white"/><path d="M16 10L20 10L20 26L16 26L16 14L13 14L13 10L16 10Z" fill="#0a0a0a"/></svg>
        <span>ONTO</span>
    </div>
    <div style="width: 40px;"></div>
</div>

<!-- AUTH MENU (burger on login/register screen) -->
<div class="auth-menu" id="auth-menu">
    <div class="auth-menu-header">
        <svg width="24" height="24" viewBox="0 0 36 36" fill="none"><circle cx="18" cy="18" r="17" fill="white"/><path d="M16 10L20 10L20 26L16 26L16 14L13 14L13 10L16 10Z" fill="#0a0a0a"/></svg>
        <span style="font-weight: 700; font-size: 18px;">ONTO</span>
        <button class="auth-menu-close" onclick="closeAuthMenu()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
    </div>
    <nav class="auth-menu-nav">
        <a href="/" class="auth-menu-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
            Home
        </a>
        <a href="/docs/" class="auth-menu-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            Docs
        </a>
        <a href="/docs/#terms" class="auth-menu-sub">Terms of Service</a>
        <a href="/docs/#privacy" class="auth-menu-sub">Privacy Policy</a>
        <a href="/docs/#license" class="auth-menu-sub">License</a>
        <a href="/docs/#specifications" class="auth-menu-sub">Specifications</a>
        <div style="border-top: 1px solid var(--border); margin: 12px 0;"></div>
        <div class="auth-menu-item" onclick="toggleTheme(); closeAuthMenu();" style="cursor: pointer;">
            <svg id="theme-icon-mobile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>
            Theme
        </div>
    </nav>
</div>
<div class="auth-menu-overlay" id="auth-menu-overlay" onclick="closeAuthMenu()"></div>

<div class="mobile-overlay" id="mobile-overlay" onclick="toggleMobile()"></div>

<script>if(localStorage.getItem('onto_logged_in')==='true')document.write('<style id="auth-preload-hide">#auth-screen{display:none!important}</style>');</script>

<!-- AUTH SCREEN -->
<div class="auth-container" id="auth-screen">
    <div class="auth-hero">
        <h1>Make your AI<br>epistemically disciplined.</h1>
        <p>ONTO reduces epistemic error in production LLM systems through deterministic discipline enforcement and auditable scoring.</p>
        <div class="auth-hero-stats">
            <div class="auth-hero-stat">
                <strong>10×</strong>
                <span>Measured Improvement</span>
            </div>
            <div class="auth-hero-stat">
                <strong>11</strong>
                <span>Models Tested</span>
            </div>
            <div class="auth-hero-stat">
                <strong>100</strong>
                <span>Questions Scored</span>
            </div>
        </div>
    </div>
    <div class="auth-form-side">
    <div class="auth-card"><!-- LOGIN FORM -->
        <div id="login-form">
            <h1 class="auth-title">Welcome back</h1>
            <p class="auth-subtitle">Sign in to your account</p>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="you@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-wrapper">
                    <input type="password" class="form-input" id="login-password" placeholder="••••••••">
                    <button type="button" class="password-toggle" onclick="togglePassword('login-password', this)"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>
            <button class="btn btn-primary" id="login-btn" onclick="handleLogin(this)">Sign In</button>
            <p style="text-align:right;margin-top:8px"><a onclick="showForgotPassword()" style="color:#8b95a5;font-size:13px;cursor:pointer">Forgot password?</a></p>
            <p class="auth-switch">Don't have an account? <a onclick="showRegister()">Create one</a></p>
        </div>
        
        <!-- REGISTER FORM -->
        <div id="register-form" class="hidden">
            <h1 class="auth-title">Create Account</h1>
            <p class="auth-subtitle">Free tier — no credit card required</p>
            
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-input" id="reg-name" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="reg-email" placeholder="you@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-wrapper">
                    <input type="password" class="form-input" id="reg-password" placeholder="Min 8 characters">
                    <button type="button" class="password-toggle" onclick="togglePassword('reg-password', this)"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>
            
            <!-- TERMS SCROLL -->
            <div class="terms-container">
                <h3>Terms of Service</h3>
                <p>By creating an account, you agree to the following:</p>
                <p><strong>Service.</strong> ONTO provides AI evaluation and epistemic risk scoring as a hosted service. Your evaluation data, API keys, and account credentials are stored securely and never shared with third parties.</p>
                <p><strong>Acceptable Use.</strong> You may use the ONTO platform to evaluate AI model outputs, track risk scores, and obtain certifications for your organization. Automated abuse, reverse engineering of scoring algorithms, and redistribution of evaluation results without attribution are prohibited.</p>
                <p><strong>Data &amp; Privacy.</strong> We collect email, name, and usage metrics necessary to provide the service. Data is processed in accordance with GDPR. We never sell your data. You may request deletion at any time.</p>
                <p><strong>Billing.</strong> Open tier includes limited evaluations. Standard billed monthly or annually. AI Provider licensing by agreement. Refund policy applies within 30 days of first payment.</p>
                <p style="margin-top: 12px;"><strong>Full terms:</strong> <a href="/legal" target="_blank">ontostandard.org/legal</a></p>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="terms-agree">
                <label for="terms-agree">I agree to the <a href="/docs/#terms" target="_blank">Terms of Service</a> and <a href="/docs/#privacy" target="_blank">Privacy Policy</a></label>
            </div>
            
            <button class="btn btn-primary" id="register-btn" onclick="handleRegister(this)" disabled>Create Account</button>
            <p class="auth-switch">Already have an account? <a onclick="showLogin()">Sign in</a></p>
        </div>
        
        <!-- OTP VERIFICATION -->
        <div id="verify-pending" class="hidden">
            <div style="text-align: center; margin-bottom: 24px;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
                    <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
            </div>
            <h1 class="auth-title">Enter verification code</h1>
            <p class="auth-subtitle">We sent a 6-digit code to</p>
            <p style="color: var(--text); font-weight: 600; margin: 8px 0 24px;" id="verify-email-display"></p>
            
            <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 24px;">
                <input type="text" id="otp-1" class="otp-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                <input type="text" id="otp-2" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-3" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-4" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-5" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-6" class="otp-input" maxlength="1" inputmode="numeric">
            </div>
            
            <p id="otp-error" style="color: #dc2626; font-size: 13px; margin-bottom: 16px; display: none;"></p>
            
            <button class="btn btn-primary" id="verify-btn" onclick="handleVerifyOTP(this)">Verify</button>
            
            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                <p style="color: var(--text-muted); font-size: 13px;">Didn't receive the code?</p>
                <button class="btn btn-secondary" style="margin-top: 12px;" onclick="resendVerification()">Resend code</button>
            </div>
            <p style="color: var(--text-muted); font-size: 12px; margin-top: 16px;">Code expires in 15 minutes</p>
            <p class="auth-switch" style="margin-top: 16px;"><a onclick="showLogin()">Back to sign in</a></p>
        </div>
        
        <!-- EMAIL VERIFIED SUCCESS -->
        <div id="verify-success" class="hidden">
            <div style="text-align: center; margin-bottom: 24px;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
            </div>
            <h1 class="auth-title">Email verified!</h1>
            <p class="auth-subtitle">Your account is ready. You can now sign in.</p>
            <button class="btn btn-primary" style="margin-top: 24px;" onclick="showLogin()">Sign In</button>
        </div>
        
        <!-- FORGOT PASSWORD -->
        <div id="forgot-form" class="hidden">
            <h1 class="auth-title">Reset password</h1>
            <p class="auth-subtitle">Enter your email and we'll send a reset link</p>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="forgot-email" placeholder="you@company.com">
            </div>
            <button class="btn btn-primary" id="forgot-btn" onclick="handleForgotPassword(this)">Send Reset Link</button>
            <p class="auth-switch" style="margin-top:16px"><a onclick="showLogin()">Back to sign in</a></p>
        </div>
        
        <!-- RESET PASSWORD (from email link) -->
        <div id="reset-form" class="hidden">
            <h1 class="auth-title">Set new password</h1>
            <p class="auth-subtitle">Choose a strong password</p>
            <div class="form-group">
                <label class="form-label">New Password</label>
                <div class="password-wrapper">
                    <input type="password" class="form-input" id="reset-password" placeholder="••••••••">
                    <button type="button" class="password-toggle" onclick="togglePassword('reset-password', this)"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>
            <button class="btn btn-primary" id="reset-btn" onclick="handleResetPassword(this)">Reset Password</button>
        </div>
    </div>
    </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" onclick="showPage('monitor', null); return false;" class="sidebar-logo" style="text-decoration: none; color: inherit;">
                <svg width="32" height="32" viewBox="0 0 36 36" fill="none">
                    <circle cx="18" cy="18" r="17" fill="white"/>
                    <path d="M16 10L20 10L20 26L16 26L16 14L13 14L13 10L16 10Z" fill="#0a0a0a"/>
                </svg>
                <span>ONTO</span>
            </a>
            <div class="sidebar-header-actions">
                <button class="sidebar-close" onclick="toggleMobile()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" onclick="showPage('monitor', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                Dashboard
            </div>
            <div class="nav-divider"></div>
            <div class="nav-item" onclick="showPage('billing', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                Billing
            </div>
            <div class="nav-item" onclick="showPage('settings', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
                Account
            </div>
            <div class="nav-item" id="nav-reference" onclick="showReferencePage(this)" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                Reference
            </div>
            <div class="nav-divider"></div>
            <a class="nav-item" href="/verify/" target="_blank" style="text-decoration: none; color: var(--text-muted);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>
                Verify ↗
            </a>
            <a class="nav-item" href="/docs/" target="_blank" style="text-decoration: none; color: var(--text-muted);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Docs ↗
            </a>
            <a class="nav-item" href="/reports/" target="_blank" style="text-decoration: none; color: var(--text-muted);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>
                Reports ↗
            </a>
            <div class="nav-item" onclick="toggleTheme()" style="color: var(--text-muted);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>
                Theme
            </div>
            <div class="nav-item" onclick="handleLogout()" style="color: var(--text-muted);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Sign Out
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="user-avatar" id="user-avatar">J</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">John Doe</div>
                    <div class="user-tier" id="user-plan">Open</div>
                </div>
            </div>
        </div>
    </aside>
    
    <main class="main-content">
        <!-- ========== AUDIT PAGE ========== -->
        <div class="page active" id="page-monitor">

            <!-- PLAN STATUS (shared) -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
                <div class="dash-card-clean" style="padding:14px 16px;margin-bottom:0">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Plan</div>
                    <div style="font-size:18px;font-weight:700" id="dash-plan-name">Open</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px" id="dash-plan-rate">10/day</div>
                </div>
                <div class="dash-card-clean" style="padding:14px 16px;margin-bottom:0">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Status</div>
                    <div style="display:flex;align-items:center;gap:6px">
                        <div id="dash-status-dot" style="width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent)"></div>
                        <span style="font-size:18px;font-weight:700" id="dash-status-text">Active</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px" id="dash-plan-expires">—</div>
                </div>
                <div class="dash-card-clean" style="padding:14px 16px;margin-bottom:0">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Evaluations</div>
                    <div style="font-size:18px;font-weight:700" id="dash-plan-calls">0</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px">this period</div>
                </div>
            </div>

            <!-- API KEY (shared) -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div class="card-head">API Key</div>
                </div>
                <div class="key-row">
                    <input type="password" class="key-input" id="dash-api-key" value="" readonly placeholder="Loading...">
                    <div class="key-buttons">
                        <button class="btn-minimal" onclick="toggleDashKeyVis()" id="dash-toggle-key">Show</button>
                        <button class="btn-minimal" onclick="copyDashKey(this)">Copy</button>
                    </div>
                </div>
            </div>

            <!-- ═══════════ PROXY DASHBOARD (Open + Standard) ═══════════ -->
            <div id="dash-proxy-view">
                <!-- QUICK TEST — always visible -->
                <div class="dash-card-clean" style="margin-bottom:16px">
                    <div class="card-head" style="margin-bottom:4px">Connect your AI</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Paste your provider key → test GOLD in one click. No code changes needed yet.</div>
                    <div style="display:flex;gap:8px;margin-bottom:8px">
                        <select id="test-std-provider" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:7px 8px;font-size:12px;color:var(--text);width:130px">
                            <option value="anthropic">Anthropic</option>
                            <option value="openai">OpenAI</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="mistral">Mistral</option>
                        </select>
                        <input type="text" id="test-std-provider-key" placeholder="Provider API key (sk-...)" style="flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:7px 10px;font-size:12px;color:var(--text)">
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button class="btn-minimal" onclick="testStandardProxy()" id="test-std-btn" style="font-size:12px;padding:7px 20px;background:var(--accent);color:white;border-color:var(--accent)">Test Connection</button>
                        <span id="test-std-status" style="font-size:11px;color:var(--text-muted)"></span>
                    </div>
                    <div id="test-std-result" class="hidden" style="margin-top:10px;background:#0c0f14;border-radius:6px;padding:10px 12px;font-size:11px;color:#e2e8f0;max-height:200px;overflow-y:auto;white-space:pre-wrap;font-family:'JetBrains Mono',monospace;line-height:1.5"></div>
                </div>

                <!-- INTEGRATION DETAILS (collapsible) -->
                <div class="dash-card-clean" style="margin-bottom:16px">
                    <div onclick="document.getElementById('guide-standard').classList.toggle('hidden');this.querySelector('svg').style.transform=document.getElementById('guide-standard').classList.contains('hidden')?'':'rotate(90deg)'" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">
                        <div>
                            <div class="card-head">Integration guide</div>
                            <div style="font-size:11px;color:var(--text-muted)">Python, cURL, proof chain — 3 lines of code</div>
                        </div>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="transition:transform 0.2s;flex-shrink:0"><polyline points="9,18 15,12 9,6"/></svg>
                    </div>
                    <div id="guide-standard" class="hidden" style="margin-top:12px">
                        <div style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:12px 16px;margin-bottom:12px">
                            <div style="font-size:10px;color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">How it works</div>
                            <div style="font-size:12px;color:var(--text-secondary);line-height:1.6">
                                Your app → <span style="color:var(--accent);font-weight:600">ONTO Proxy</span> → AI Provider (OpenAI, Anthropic, etc.)<br>
                                ONTO injects GOLD discipline layer into every request. Your provider key never stored.
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Python (OpenAI-compatible)</div>
                        <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:12px;overflow-x:auto;line-height:1.6"><code><span style="color:var(--text-muted)"># Replace your OpenAI client with:</span>
client = OpenAI(
    api_key=<span style="color:#4ade80">"YOUR_ONTO_API_KEY"</span>,
    base_url=<span style="color:#4ade80">"https://api.ontostandard.org/v1/proxy"</span>,
    default_headers={
        <span style="color:#4ade80">"X-Provider-Key"</span>: <span style="color:#4ade80">"sk-...your_openai_key"</span>
    }
)</code></pre>
                        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">cURL</div>
                        <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:12px;overflow-x:auto;line-height:1.6"><code>curl -X POST https://api.ontostandard.org/v1/proxy/chat/completions \
  -H <span style="color:#4ade80">"x-api-key: YOUR_ONTO_API_KEY"</span> \
  -H <span style="color:#4ade80">"X-Provider-Key: sk-...your_openai_key"</span> \
  -H <span style="color:#4ade80">"Content-Type: application/json"</span> \
  -d <span style="color:#4ade80">'{"model":"gpt-4o","messages":[{"role":"user","content":"Your question"}]}'</span></code></pre>
                        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">What changes</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                            <div style="background:#1a1a2e;border-radius:6px;padding:10px 12px">
                                <div style="font-size:9px;color:#ef4444;font-weight:600;margin-bottom:4px">BEFORE</div>
                                <code style="font-size:11px;color:#e2e8f0">base_url: api.openai.com</code><br>
                                <code style="font-size:11px;color:#e2e8f0">api_key: sk-...</code>
                            </div>
                            <div style="background:#1a2e1a;border-radius:6px;padding:10px 12px">
                                <div style="font-size:9px;color:var(--accent);font-weight:600;margin-bottom:4px">AFTER</div>
                                <code style="font-size:11px;color:#e2e8f0">base_url: api.ontostandard.org</code><br>
                                <code style="font-size:11px;color:#e2e8f0">api_key: onto_sk_...</code><br>
                                <code style="font-size:11px;color:#e2e8f0">X-Provider-Key: sk-...</code>
                            </div>
                        </div>
                        <div style="margin-top:4px"><a href="/docs/" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none;font-weight:500">Full API documentation →</a></div>
                    </div>
                </div>
            </div>

            <!-- ═══════════ PROVIDER DASHBOARD (AI Provider + White Label) ═══════════ -->
            <div id="dash-provider-view" class="hidden">
                <!-- GOLD STREAM STATUS -->
                <div class="dash-card-clean" style="margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <div class="card-head">GOLD Stream</div>
                        <div id="prov-stream-status" style="font-size:10px;font-weight:600;color:var(--accent)">● CONNECTED</div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:10px">
                        <div>
                            <div style="font-size:10px;color:var(--text-muted)">Layer</div>
                            <div style="font-size:13px;font-weight:600;color:var(--text)" id="prov-gold-layer">TIER4</div>
                        </div>
                        <div>
                            <div style="font-size:10px;color:var(--text-muted)">Cache</div>
                            <div style="font-size:13px;font-weight:600;color:var(--text)" id="prov-gold-cache">Active</div>
                        </div>
                        <div>
                            <div style="font-size:10px;color:var(--text-muted)">Updated</div>
                            <div style="font-size:13px;font-weight:600;color:var(--text)" id="prov-gold-age">—</div>
                        </div>
                    </div>
                    <button class="btn-minimal" onclick="testProviderSSE()" id="test-prov-btn" style="font-size:11px">Refresh Status</button>
                </div>

                <!-- QUICK EVALUATE -->
                <div class="dash-card-clean" style="margin-bottom:16px">
                    <div class="card-head" style="margin-bottom:4px">Test Scoring</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Paste any AI output → get epistemic risk score instantly.</div>
                    <textarea id="test-eval-output" placeholder="Paste model output here..." style="width:100%;min-height:80px;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px 10px;font-size:12px;color:var(--text);resize:vertical;font-family:inherit;box-sizing:border-box"></textarea>
                    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                        <button class="btn-minimal" onclick="testProviderEval()" id="test-eval-btn" style="font-size:12px;padding:7px 20px;background:var(--accent);color:white;border-color:var(--accent)">Evaluate</button>
                        <span id="test-prov-status" style="font-size:11px;color:var(--text-muted)"></span>
                    </div>
                    <div id="test-prov-result" class="hidden" style="margin-top:10px;background:#0c0f14;border-radius:6px;padding:10px 12px;font-size:11px;color:#e2e8f0;max-height:200px;overflow-y:auto;white-space:pre-wrap;font-family:'JetBrains Mono',monospace;line-height:1.5"></div>
                </div>

                <!-- INTEGRATION DETAILS (collapsible) -->
                <div class="dash-card-clean" style="margin-bottom:16px">
                    <div onclick="document.getElementById('guide-provider').classList.toggle('hidden');this.querySelector('svg').style.transform=document.getElementById('guide-provider').classList.contains('hidden')?'':'rotate(90deg)'" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">
                        <div>
                            <div class="card-head">Integration guide</div>
                            <div style="font-size:11px;color:var(--text-muted)">SSE stream, scoring API, architecture</div>
                        </div>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="transition:transform 0.2s;flex-shrink:0"><polyline points="9,18 15,12 9,6"/></svg>
                    </div>
                    <div id="guide-provider" class="hidden" style="margin-top:12px">
                        <div style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:12px 16px;margin-bottom:12px">
                            <div style="font-size:10px;color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">How it works</div>
                            <div style="font-size:12px;color:var(--text-secondary);line-height:1.6">
                                Your server connects to ONTO SSE → receives GOLD corpus → injects into system prompt. ONTO is <span style="color:var(--accent);font-weight:600">not in inference path</span> — zero latency.
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Connect to GOLD SSE</div>
                        <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:12px;overflow-x:auto;line-height:1.6"><code>stream = requests.get(
    <span style="color:#4ade80">"https://api.ontostandard.org/v1/gold/stream"</span>,
    headers={<span style="color:#4ade80">"x-api-key"</span>: <span style="color:#4ade80">"YOUR_ONTO_KEY"</span>},
    stream=True
)
for line in stream.iter_lines():
    if line.startswith(b<span style="color:#4ade80">"data: "</span>):
        gold = json.loads(line[6:])
        update_system_prompt(gold)</code></pre>
                        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Submit for scoring</div>
                        <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:12px;overflow-x:auto;line-height:1.6"><code>requests.post(
    <span style="color:#4ade80">"https://api.ontostandard.org/v1/models/evaluate"</span>,
    headers={<span style="color:#4ade80">"x-api-key"</span>: <span style="color:#4ade80">"YOUR_ONTO_KEY"</span>},
    json={
        <span style="color:#4ade80">"model_id"</span>: your_model_id,
        <span style="color:#4ade80">"output"</span>: model_output,
        <span style="color:#4ade80">"context"</span>: user_message,
        <span style="color:#4ade80">"domain"</span>: <span style="color:#4ade80">"general"</span>
    }
)</code></pre>
                        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Architecture</div>
                        <div style="background:#0c0f14;border-radius:6px;padding:12px 16px;margin-bottom:12px;font-family:'JetBrains Mono',monospace;font-size:11px;color:#e2e8f0;line-height:1.8">
                            ONTO SSE ──→ GOLD corpus (real-time)<br>
                            &nbsp;&nbsp;&nbsp;↓<br>
                            <span style="color:var(--accent)">Your Server</span> ──→ Your Model (inference)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;↓<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ONTO Scoring ──→ proof chain
                        </div>
                        <div style="margin-top:4px"><a href="/docs/" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none;font-weight:500">Full API documentation →</a></div>
                    </div>
                </div>
            </div>

            <!-- CERTIFICATE (shared) -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <div class="card-head">Certificate</div>
                    <div id="dash-cert-status" style="font-size:10px;font-weight:600;color:var(--accent)">● ACTIVE</div>
                </div>
                <div style="margin-bottom:8px">
                    <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Verification Hash</div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <code style="font-size:11px;color:var(--text);font-family:'JetBrains Mono',monospace;word-break:break-all;flex:1" id="erm-cert-hash">—</code>
                        <button class="btn-minimal" onclick="ermCopyHash()" style="flex-shrink:0">Copy</button>
                    </div>
                </div>
                <div style="display:flex;gap:8px;margin-top:10px">
                    <a id="dash-verify-link" href="/verify/" target="_blank" class="btn-minimal" style="text-decoration:none;text-align:center;flex:1">Verify ↗</a>
                    <button class="btn-minimal" onclick="ermDownloadCert()" style="flex:1">Download JSON</button>
                </div>
            </div>

            <!-- SIGNAL (shared) -->
            <div class="signal-panel" id="user-signal-panel" style="padding:14px 18px">
                <div class="signal-panel-grid"></div>
                <div style="position:relative;z-index:1">
                    <div class="signal-main-row" style="margin-bottom:0">
                        <div class="signal-id-block">
                            <div class="signal-id" id="user-signal-id"><div class="signal-skeleton-id"></div></div>
                            <div class="signal-hash" id="user-signal-hash"><div class="signal-skeleton-hash"></div></div>
                        </div>
                        <div class="signal-countdown-block">
                            <div class="signal-countdown-label">NEXT</div>
                            <div class="signal-countdown-value" id="user-signal-countdown">—</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px;margin-top:8px">
                        <span id="erm-check-proxy" style="font-size:9px;color:rgba(255,255,255,0.4)"><span style="color:var(--accent)">✓</span> PROXY</span>
                        <span id="erm-check-gold" style="font-size:9px;color:rgba(255,255,255,0.4)"><span style="color:var(--accent)">✓</span> GOLD</span>
                        <span id="erm-check-sig" style="font-size:9px;color:rgba(255,255,255,0.4)"><span style="color:var(--accent)">✓</span> SIG</span>
                        <span id="erm-check-chain" style="font-size:9px;color:rgba(255,255,255,0.4)"><span style="color:var(--accent)">✓</span> CHAIN</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding:10px 0;margin-top:8px">
                <span style="font-size:9px;color:var(--text-muted)">ONTO does not guarantee accuracy. Not responsible for decisions made by AI systems or their operators.</span>
            </div>
        </div>


        <!-- ========== CERTIFY PAGE ========== -->
        <div class="page" id="page-sdk">
            <div class="page-header-clean" style="margin-bottom:20px">
                <h1 class="page-title" style="margin-bottom:2px">API & SDK</h1>
                <p style="color:var(--text-muted);font-size:12px;margin:0">Connect your AI to ONTO GOLD epistemic discipline</p>
            </div>

            <!-- API Key -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div class="card-head" style="margin-bottom:12px">API Key</div>
                <div class="key-row">
                    <input type="password" class="key-input" id="api-key-display" value="" readonly placeholder="Loading...">
                    <div class="key-buttons">
                        <button class="btn-minimal" onclick="toggleApiKeyVisibility()" id="toggle-key-btn">Show</button>
                        <button class="btn-minimal" onclick="copyApiKey(this)">Copy</button>
                    </div>
                </div>
                <div class="key-meta">
                    <span id="key-created">Created: —</span>
                    <span id="key-last-used">Last used: —</span>
                </div>
                <button class="btn-danger-outline" onclick="regenerateApiKey(this)" style="margin-top:10px;font-size:11px">Regenerate</button>
            </div>

            <!-- Quick Start -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div class="card-head" style="margin-bottom:12px">Quick Start</div>
                <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Python — OpenAI-compatible (3 lines changed)</div>
                <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:16px;overflow-x:auto;line-height:1.6"><code><span style="color:var(--text-muted)"># Before (direct to OpenAI):</span>
client = OpenAI(api_key=<span style="color:#4ade80">"sk-..."</span>)

<span style="color:var(--text-muted)"># After (through ONTO proxy — GOLD injected server-side):</span>
client = OpenAI(
    api_key=<span style="color:#4ade80">"onto_sk_..."</span>,
    base_url=<span style="color:#4ade80">"https://api.ontostandard.org/v1/proxy"</span>,
    default_headers={<span style="color:#4ade80">"X-Provider-Key"</span>: <span style="color:#4ade80">"sk-...your_openai_key"</span>}
)

<span style="color:var(--text-muted)"># Everything else stays the same</span>
response = client.chat.completions.create(
    model=<span style="color:#4ade80">"gpt-4o"</span>,
    messages=[{<span style="color:#4ade80">"role"</span>: <span style="color:#4ade80">"user"</span>, <span style="color:#4ade80">"content"</span>: <span style="color:#4ade80">"Your question"</span>}]
)</code></pre>
                <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Other providers (DeepSeek, Groq, Mistral, etc.)</div>
                <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:16px;overflow-x:auto;line-height:1.6"><code><span style="color:var(--text-muted)"># Same endpoint, add X-Provider-Base-URL header:</span>
client = OpenAI(
    api_key=<span style="color:#4ade80">"onto_sk_..."</span>,
    base_url=<span style="color:#4ade80">"https://api.ontostandard.org/v1/proxy"</span>,
    default_headers={
        <span style="color:#4ade80">"X-Provider-Key"</span>: <span style="color:#4ade80">"sk-...your_provider_key"</span>,
        <span style="color:#4ade80">"X-Provider-Base-URL"</span>: <span style="color:#4ade80">"https://api.deepseek.com/v1"</span>
    }
)</code></pre>
                <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">cURL</div>
                <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:16px;overflow-x:auto;line-height:1.6"><code>curl -X POST https://api.ontostandard.org/v1/proxy/chat/completions \
  -H "x-api-key: onto_sk_..." \
  -H "X-Provider-Key: sk-...your_openai_key" \
  -H "Content-Type: application/json" \
  -d '{"model":"gpt-4o","messages":[{"role":"user","content":"Your question"}]}'</code></pre>
                <div style="background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.15);border-radius:6px;padding:10px 14px;font-size:11px;color:var(--text-secondary);line-height:1.5">
                    <span style="color:var(--accent);font-weight:600">How it works:</span> Your request → ONTO injects GOLD discipline into system prompt → forwards to your provider → returns enhanced response. ONTO never stores your prompts or responses. Standard provider token costs apply.
                </div>
            </div>

            <!-- Rate Limits -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div class="card-head" style="margin-bottom:12px">Rate Limits</div>
                <table style="width:100%;border-collapse:collapse;font-size:12px">
                    <tr style="border-bottom:1px solid var(--border)">
                        <th style="text-align:left;padding:8px 10px;font-weight:500;color:var(--text-muted);font-size:10px;text-transform:uppercase">Tier</th>
                        <th style="text-align:left;padding:8px 10px;font-weight:500;color:var(--text-muted);font-size:10px;text-transform:uppercase">Proxy Rate</th>
                        <th style="text-align:left;padding:8px 10px;font-weight:500;color:var(--text-muted);font-size:10px;text-transform:uppercase">GOLD Level</th>
                        <th style="text-align:left;padding:8px 10px;font-weight:500;color:var(--text-muted);font-size:10px;text-transform:uppercase">Proof Chain</th>
                    </tr>
                    <tr style="border-bottom:1px solid var(--border)">
                        <td style="padding:8px 10px;font-weight:500">Open</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">10/day</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">GOLD Core</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Ed25519 signed</td>
                    </tr>
                    <tr style="border-bottom:1px solid var(--border)">
                        <td style="padding:8px 10px;font-weight:500">Standard</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">1,000/day</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">GOLD Extended</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Ed25519 signed</td>
                    </tr>
                    <tr>
                        <td style="padding:8px 10px;font-weight:500">AI Provider</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Unlimited</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">GOLD Full</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Ed25519 + audit trail</td>
                    </tr>
                </table>
                <div style="margin-top:12px">
                    <a href="/docs/" target="_blank" style="font-size:12px;color:var(--accent);text-decoration:none;font-weight:500">Full API documentation →</a>
                </div>
            </div>

            <!-- Current plan -->
            <div class="dash-card-clean">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div class="card-head" style="margin-bottom:4px">Current Plan</div>
                        <div style="font-size:13px"><span style="font-weight:600" id="sdk-plan-name">Open</span> · <span style="color:var(--text-muted)" id="sdk-plan-rate">10 requests / day</span></div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:4px" id="sdk-plan-calls">0 / 50 proxy calls used today</div>
                    </div>
                    <button class="btn-upgrade" id="sdk-upgrade-btn" onclick="showPage('billing', document.querySelector('.nav-item[onclick*=billing]'))" style="font-size:12px;padding:8px 20px">Upgrade →</button>
                </div>
            </div>
        </div>
        
        <!-- EVALUATE PAGE -->
        <div class="page" id="page-settings">
            <div class="page-header-clean">
                <h1 class="page-title">Account</h1>
            </div>
            
            <div class="section-block">
                <div class="section-label">Identity</div>
                <div class="info-row">
                    <span class="info-key">Name</span>
                    <span class="info-val" id="settings-name">John Doe</span>
                    <span class="info-action" onclick="editProfile()">Edit</span>
                </div>
                <div class="info-row">
                    <span class="info-key">Email</span>
                    <span class="info-val" id="settings-email">support@ontostandard.org</span>
                </div>
                <div class="info-row">
                    <span class="info-key">Type</span>
                    <span class="info-val" id="settings-account-type">Individual</span>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-label">Organization</div>
                <div id="company-not-registered">
                    <p class="section-text">No organization registered. Required to generate invoices and access institutional features.</p>
                    <button class="btn-minimal" onclick="openCompanyModal()" style="background:var(--accent);color:#0c0f14;border-color:var(--accent)">Register Organization →</button>
                </div>
                <div id="company-registered" class="hidden">
                    <div class="info-row">
                        <span class="info-key">Name</span>
                        <span class="info-val" id="company-name">—</span>
                        <span class="info-action" onclick="openCompanyModal()">Edit</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Industry</span>
                        <span class="info-val" id="company-industry">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Registration</span>
                        <span class="info-val" id="company-reg">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Status</span>
                        <span class="info-val status-active"><span class="dot"></span>Verified</span>
                    </div>
                </div>
            </div>
            
            <div class="section-block" id="subscription-block">
                <div class="section-label">Subscription</div>
                <div id="subscription-none">
                    <p class="section-text">No active subscription. Using Open tier (10 evaluations/day).</p>
                    <button class="btn-minimal" onclick="showPage('billing')">View Plans</button>
                </div>
                <div id="subscription-active" class="hidden">
                    <div class="info-row">
                        <span class="info-key">Active Plan</span>
                        <span class="info-val" id="sub-plan">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Rate Limit</span>
                        <span class="info-val" id="sub-rate">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Plan Expires</span>
                        <span class="info-val" id="sub-expires">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Total Paid</span>
                        <span class="info-val" id="sub-total">—</span>
                    </div>
                    <button class="btn-minimal" onclick="showPage('billing')" style="margin-top: 12px;">Extend Subscription</button>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-label">Documents</div>
                <div class="doc-row">
                    <span class="doc-name">Specifications & Policies</span>
                    <span class="doc-link" onclick="window.open('/docs/', '_blank')">View</span>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-label">Support</div>
                <div class="info-row">
                    <span class="info-key">General</span>
                    <a class="info-val" href="mailto:support@ontostandard.org">support@ontostandard.org</a>
                </div>
                <div class="info-row">
                    <span class="info-key">Sales</span>
                    <a class="info-val" href="mailto:support@ontostandard.org">support@ontostandard.org</a>
                </div>
                <div class="info-row">
                    <span class="info-key">Billing</span>
                    <a class="info-val" href="mailto:support@ontostandard.org">support@ontostandard.org</a>
                </div>
            </div>
        </div>
        
        <!-- BILLING PAGE -->
        <div class="page" id="page-billing">
            <div class="page-header-clean">
                <h1 class="page-title">Access Tiers</h1>
            </div>
            
            <div class="tiers-grid">
                <!-- OPEN (TIER 3) -->
                <div class="tier-card" id="card-free">
                    <div class="tier-name">Open</div>
                    <div class="tier-price">Free</div>
                    <div class="tier-desc">Evaluate ONTO on your AI before you commit</div>
                    <ul class="tier-list">
                        <li>10 proxy requests/day</li>
                        <li>GOLD Core (epistemic discipline layer)</li>
                        <li>Scoring API</li>
                        <li>Ed25519 proof chain</li>
                        <li style="color:var(--text-muted)">No SSE stream</li>
                    </ul>
                    <button class="btn-tier current" id="btn-free" disabled>Current</button>
                </div>
                
                <!-- STANDARD (GOLD Core) -->
                <div class="tier-card" id="card-business">
                    <div class="tier-name">Standard</div>
                    <div class="tier-price">$2,500<span>/month</span></div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">or $30,000/year</div>
                    <div class="tier-desc">Production GOLD discipline for companies using AI</div>
                    <ul class="tier-list">
                        <li>1,000 proxy requests/day</li>
                        <li>GOLD Extended Corpus</li>
                        <li>Unlimited SSE stream</li>
                        <li>Scoring API</li>
                        <li>Ed25519 proof chain</li>
                    </ul>
                    <button class="btn-tier" id="btn-business" onclick="openSubscribeModal('business')">Select</button>
                </div>
                
                <!-- PROVIDER (TIER 1) -->
                <div class="tier-card" id="card-enterprise">
                    <div class="tier-name">AI Provider</div>
                    <div class="tier-price">$250,000<span>/year</span></div>
                    <div class="tier-desc">Full GOLD access for AI model providers</div>
                    <ul class="tier-list">
                        <li>GOLD Full Corpus via SSE</li>
                        <li>Unlimited scoring API</li>
                        <li>All production models</li>
                        <li>Ed25519 proof chain</li>
                        <li>Full audit trail</li>
                    </ul>
                    <button class="btn-tier" id="btn-enterprise" onclick="openSubscribeModal('enterprise')">Select</button>
                </div>
            </div>

            <!-- Provider licensing doc -->
            <div style="margin-top:24px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:20px">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
                    <div>
                        <div style="font-size:11px;color:var(--text-secondary)">SSE integration · fixed annual license · unlimited scale · ONTO not in inference path</div>
                    </div>
                    <a href="https://github.com/nickarstrong/onto-research/blob/main/ONTO_PROVIDER_LICENSING.md" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none;font-weight:500;white-space:nowrap">Provider Licensing →</a>
                </div>
            </div>

            <!-- GRANT PROGRAM -->
            <div style="margin-top:24px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:20px">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    <div style="font-size:13px;font-weight:600;color:var(--text)">Grant Program</div>
                </div>
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;margin-bottom:12px">
                    Free Standard access for independent researchers, early-stage startups, and nonprofit organizations whose work benefits society. Grant recipients receive the same infrastructure as paid Standard customers: 1,000 proxy requests/day, GOLD Extended, signed proof chain. No restrictions, no watermarks.
                </div>
                <div style="display:flex;align-items:center;gap:12px">
                    <a href="mailto:council@ontostandard.org" style="font-size:11px;color:var(--accent);text-decoration:none;font-weight:500">Apply → council@ontostandard.org</a>
                </div>
            </div>
            
            <p class="section-footnote" style="text-align: center; margin-top: 16px; font-size: 10px; color: var(--text-muted);">
                Invoice payment requires registered organization. <a href="#" onclick="showPage('settings')" style="color:var(--accent)">Account settings</a>
            </p>
            
            <!-- INVOICE -->
            <div style="margin-top:24px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:20px" id="billing-invoice-block">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
                    <div>
                        <div style="font-size:13px;font-weight:600;color:var(--text)">Invoice</div>
                        <div style="font-size:11px;color:var(--text-secondary);margin-top:4px" id="invoice-status">No active subscription</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <select id="invoice-tier-select" style="background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:4px;font-size:12px">
                            <option value="standard_monthly">Standard — $2,500/mo</option>
                            <option value="standard">Standard — $30,000/yr</option>
                            <option value="critical">AI Provider — $250,000/yr</option>
                            <option value="white_label">White Label — $500,000/yr</option>
                        </select>
                        <button class="btn-minimal hidden" id="invoice-download" onclick="downloadInvoice()" style="font-size:12px">Download PDF</button>
                        <button class="btn-minimal hidden" id="invoice-register-org" onclick="openCompanyModal()" style="font-size:12px;color:var(--accent)">Register Organization first →</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- REFERENCE PAGE (ADMIN) -->
        <!-- REFERENCE PAGE (ADMIN) -->
        <div class="page" id="page-reference">
            <h1 class="page-title" style="margin-bottom:2px">Reference</h1>
            <p style="color:var(--text-muted);font-size:12px;margin:0 0 20px 0">Admin panel</p>

            <!-- ACCOUNTS -->
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:6px;overflow:hidden">
                <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
                    <div style="font-size:14px;font-weight:600">Accounts</div>
                    <input type="text" id="account-search" placeholder="Search email..." oninput="filterAccounts()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:5px 10px;font-size:11px;color:var(--text);width:200px">
                </div>
                <div style="padding:8px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
                    <select id="filter-type" onchange="filterAccounts()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;color:var(--text-secondary)">
                        <option value="">All Types</option>
                        <option value="individual">Individual</option>
                        <option value="organization">Organization</option>
                    </select>
                    <select id="filter-status" onchange="filterAccounts()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;color:var(--text-secondary)">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                    </select>
                    <select id="filter-plan" onchange="filterAccounts()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;color:var(--text-secondary)">
                        <option value="">All Plans</option>
                        <option value="open">Open</option>
                        <option value="standard">Standard</option>
                        <option value="enterprise">AI Provider</option>
                    </select>
                </div>
                <div id="accounts-list" style="font-size:12px"></div>
            </div>
        </div>

    </main>
</div>

<!-- COMPANY REGISTRATION MODAL -->
<div class="modal-overlay" id="company-modal">
    <div class="modal modal-wide modal-inst">
        <div class="modal-header">
            <h2>Organization Registration</h2>
            <button class="modal-close" onclick="closeModal('company-modal')">&times;</button>
        </div>
        <div class="modal-body form-inst">
            <div class="form-section">
                <div class="form-section-title">Legal Entity</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Legal Name *</label>
                        <input type="text" class="form-input" id="company-name-input" placeholder="e.g. Acme Corporation Inc.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Entity Type *</label>
                        <select class="form-input" id="company-type-input">
                            <option value="">Select type...</option>
                            <option value="corporation">Corporation</option>
                            <option value="llc">LLC</option>
                            <option value="llp">LLP</option>
                            <option value="partnership">Partnership</option>
                            <option value="foundation">Foundation</option>
                            <option value="nonprofit">Non-Profit</option>
                            <option value="university">University / Research</option>
                            <option value="government">Government</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Industry *</label>
                        <select class="form-input" id="company-industry-input">
                            <option value="">Select industry...</option>
                            <optgroup label="High-Risk Sectors">
                                <option value="healthcare">Healthcare & Medical</option>
                                <option value="financial">Financial Services</option>
                                <option value="legal">Legal Services</option>
                                <option value="insurance">Insurance</option>
                                <option value="aerospace">Aerospace</option>
                                <option value="defense">Defense & Security</option>
                                <option value="autonomous">Autonomous Systems</option>
                                <option value="energy">Energy & Utilities</option>
                                <option value="infrastructure">Critical Infrastructure</option>
                            </optgroup>
                            <optgroup label="Technology">
                                <option value="ai_ml">AI / Machine Learning</option>
                                <option value="software">Software & SaaS</option>
                                <option value="cloud">Cloud Services</option>
                                <option value="cybersecurity">Cybersecurity</option>
                                <option value="data">Data & Analytics</option>
                            </optgroup>
                            <optgroup label="Other Sectors">
                                <option value="manufacturing">Manufacturing</option>
                                <option value="retail">Retail & E-commerce</option>
                                <option value="education">Education</option>
                                <option value="media">Media & Entertainment</option>
                                <option value="consulting">Consulting</option>
                                <option value="research">Research & Academia</option>
                                <option value="government">Government & Public</option>
                                <option value="other">Other</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Registration Number *</label>
                        <input type="text" class="form-input" id="company-reg-input" placeholder="e.g. 12-3456789">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tax ID / VAT</label>
                        <input type="text" class="form-input" id="company-vat-input" placeholder="Optional">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-section-title">Registered Address</div>
                <div class="form-group">
                    <label class="form-label">Street Address *</label>
                    <input type="text" class="form-input" id="company-address-input" placeholder="123 Main Street, Suite 100">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <input type="text" class="form-input" id="company-city-input" placeholder="New York">
                    </div>
                    <div class="form-group">
                        <label class="form-label">State / Province</label>
                        <input type="text" class="form-input" id="company-state-input" placeholder="NY">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Postal Code *</label>
                        <input type="text" class="form-input" id="company-postal-input" placeholder="10001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country *</label>
                        <select class="form-input" id="company-country-input">
                            <option value="">Select country...</option>
                            <optgroup label="Common">
                                <option value="US">United States</option>
                                <option value="GB">United Kingdom</option>
                                <option value="DE">Germany</option>
                                <option value="FR">France</option>
                                <option value="CH">Switzerland</option>
                                <option value="SG">Singapore</option>
                                <option value="AE">UAE</option>
                                <option value="JP">Japan</option>
                            </optgroup>
                            <optgroup label="Americas">
                                <option value="AR">Argentina</option>
                                <option value="BR">Brazil</option>
                                <option value="CA">Canada</option>
                                <option value="CL">Chile</option>
                                <option value="CO">Colombia</option>
                                <option value="MX">Mexico</option>
                                <option value="PE">Peru</option>
                            </optgroup>
                            <optgroup label="Europe">
                                <option value="AT">Austria</option>
                                <option value="BE">Belgium</option>
                                <option value="CZ">Czech Republic</option>
                                <option value="DK">Denmark</option>
                                <option value="EE">Estonia</option>
                                <option value="FI">Finland</option>
                                <option value="GR">Greece</option>
                                <option value="HU">Hungary</option>
                                <option value="IE">Ireland</option>
                                <option value="IT">Italy</option>
                                <option value="LU">Luxembourg</option>
                                <option value="NL">Netherlands</option>
                                <option value="NO">Norway</option>
                                <option value="PL">Poland</option>
                                <option value="PT">Portugal</option>
                                <option value="RO">Romania</option>
                                <option value="ES">Spain</option>
                                <option value="SE">Sweden</option>
                            </optgroup>
                            <optgroup label="Asia Pacific">
                                <option value="AU">Australia</option>
                                <option value="CN">China</option>
                                <option value="HK">Hong Kong</option>
                                <option value="IN">India</option>
                                <option value="ID">Indonesia</option>
                                <option value="KR">South Korea</option>
                                <option value="MY">Malaysia</option>
                                <option value="NZ">New Zealand</option>
                                <option value="PH">Philippines</option>
                                <option value="TW">Taiwan</option>
                                <option value="TH">Thailand</option>
                                <option value="VN">Vietnam</option>
                            </optgroup>
                            <optgroup label="Middle East & Africa">
                                <option value="BH">Bahrain</option>
                                <option value="EG">Egypt</option>
                                <option value="IL">Israel</option>
                                <option value="KW">Kuwait</option>
                                <option value="QA">Qatar</option>
                                <option value="SA">Saudi Arabia</option>
                                <option value="ZA">South Africa</option>
                                <option value="TR">Turkey</option>
                            </optgroup>
                            <optgroup label="CIS">
                                <option value="KZ">Kazakhstan</option>
                                <option value="UZ">Uzbekistan</option>
                                <option value="AZ">Azerbaijan</option>
                                <option value="GE">Georgia</option>
                                <option value="AM">Armenia</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="OTHER">Other</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-section-title">Contact</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Organization Email *</label>
                        <input type="email" class="form-input" id="company-email-input" placeholder="contact@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="company-phone-input" placeholder="+1 (555) 123-4567">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-section-title">Authorized Representative</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-input" id="signatory-name-input" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="signatory-title-input" placeholder="Chief Technology Officer">
                    </div>
                </div>
            </div>
            
            <div class="form-section" style="border-bottom: none; padding-bottom: 0;">
                <div class="form-section-title">Agreement</div>
                <div class="agreement-notice">
                    By registering, the organization agrees to the Master Service Agreement including limitation of liability provisions. 
                    <a href="/docs/#terms" target="_blank">View Terms of Service ↗</a>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="msa-agree">
                    <label for="msa-agree">I have read and accept the Master Service Agreement</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="msa-authorized">
                    <label for="msa-authorized">I am authorized to bind this organization</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('company-modal')">Cancel</button>
            <div onclick="if(document.getElementById('register-company-btn').disabled) highlightEmptyFields();" style="display:inline-block;">
                <button class="btn-minimal" id="register-company-btn" onclick="registerCompany()" disabled style="background: var(--accent); color: white; border-color: var(--accent);">Register</button>
            </div>
        </div>
    </div>
</div>

<!-- SUBSCRIBE MODAL -->
<!-- CONTACT SALES MODAL -->
<!-- SUBSCRIBE MODAL -->
<div class="modal-overlay" id="subscribe-modal">
    <div class="modal modal-inst" style="max-width: 440px;">
        <div class="modal-header">
            <h2><span id="subscribe-plan-name">Standard</span> Tier</h2>
            <button class="modal-close" onclick="closeModal('subscribe-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="order-section">
                <div class="form-section-title">Includes</div>
                <div class="order-features" id="order-features">
                    <div class="order-feature">1,000 proxy requests/day</div>
                    <div class="order-feature">GOLD Extended — Extended Corpus</div>
                    <div class="order-feature">Ed25519 signed proof chain</div>
                    <div class="order-feature">Public verification badge</div>
                </div>
            </div>
            <div class="order-section">
                <div class="form-section-title">Billing</div>
                <div class="billing-options">
                    <label class="billing-option" id="billing-annual">
                        <input type="radio" name="billing-cycle" value="annual" checked onchange="updateOrderSummary()">
                        <span class="billing-option-content">
                            <span class="billing-option-name">Annual</span>
                            <span class="billing-option-detail">Billed once per year</span>
                        </span>
                        <span class="billing-option-price" id="price-annual-display">$30,000</span>
                    </label>
                    <label class="billing-option" id="billing-monthly">
                        <input type="radio" name="billing-cycle" value="monthly" onchange="updateOrderSummary()">
                        <span class="billing-option-content">
                            <span class="billing-option-name">Monthly</span>
                            <span class="billing-option-detail">Billed each month</span>
                        </span>
                        <span class="billing-option-price" id="price-monthly-display">$2,500/mo</span>
                    </label>
                </div>
            </div>
            <div class="order-section">
                <div class="form-section-title">Payment Method</div>
                <div class="payment-options">
                    <label class="payment-opt" id="payment-invoice">
                        <input type="radio" name="payment-method" value="invoice" checked>
                        <span class="payment-opt-name">Invoice</span>
                        <span class="payment-opt-note">Annual only</span>
                    </label>
                    <label class="payment-opt" id="payment-card">
                        <input type="radio" name="payment-method" value="card">
                        <span class="payment-opt-name">Card</span>
                        <span class="payment-opt-note">Monthly only</span>
                    </label>
                </div>
            </div>
            <div class="order-summary">
                <div class="order-summary-row">
                    <span class="order-summary-label" id="summary-plan">Standard Tier — Annual</span>
                    <span class="order-summary-value" id="summary-price">$30,000</span>
                </div>
                <div class="order-summary-row total">
                    <span class="order-summary-label">Total due</span>
                    <span class="order-summary-value" id="summary-total">$30,000</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('subscribe-modal')">Cancel</button>
            <button class="btn-minimal" onclick="processPayment()" style="background: var(--accent); color: white; border-color: var(--accent);">Proceed to Payment</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="contact-modal">
    <div class="modal modal-inst" style="max-width: 440px;">
        <div class="modal-header">
            <h2>Contact Sales</h2>
            <button class="modal-close" onclick="closeModal('contact-modal')">&times;</button>
        </div>
        <div class="modal-body form-inst">
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                For AI Provider licensing, custom integrations, or certification inquiries.
            </p>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" id="contact-name" placeholder="Your name">
            </div>
            <div class="form-group">
                <label class="form-label">Organization</label>
                <input type="text" class="form-input" id="contact-org" placeholder="Company name">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="contact-email" placeholder="work@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Message</label>
                <textarea class="form-input" id="contact-message" rows="3" placeholder="Tell us about your requirements..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('contact-modal')">Cancel</button>
            <button class="btn-minimal" onclick="submitContactForm()" style="background: var(--accent); color: white; border-color: var(--accent);">Send</button>
        </div>
    </div>
</div>

<!-- TIER EDITOR MODAL -->
<div class="modal-overlay" id="tier-modal">
    <div class="modal modal-inst" style="max-width: 400px;">
        <div class="modal-header">
            <h2>Edit Plan</h2>
            <button class="modal-close" onclick="closeModal('tier-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="tier-user-info" id="tier-user-info">
                <div class="tier-user-email">support@ontostandard.org</div>
            </div>
            <div class="tier-options">
                <label class="tier-option" data-tier="open">
                    <input type="radio" name="tier-select" value="open">
                    <div class="tier-option-content">
                        <div class="tier-option-header">
                            <span class="tier-badge tier-open">OPEN</span>
                            <span class="tier-option-price">Free</span>
                        </div>
                        <div class="tier-option-desc">10 proxy/day, GOLD Core</div>
                    </div>
                </label>
                <label class="tier-option" data-tier="standard">
                    <input type="radio" name="tier-select" value="standard">
                    <div class="tier-option-content">
                        <div class="tier-option-header">
                            <span class="tier-badge tier-standard">STANDARD</span>
                            <span class="tier-option-price">$2.5K/mo</span>
                        </div>
                        <div class="tier-option-desc">1K proxy/day, GOLD Extended, Ed25519 proof</div>
                    </div>
                </label>
                <label class="tier-option" data-tier="critical">
                    <input type="radio" name="tier-select" value="critical">
                    <div class="tier-option-content">
                        <div class="tier-option-header">
                            <span class="tier-badge tier-critical">AI PROVIDER</span>
                            <span class="tier-option-price">$250K/yr</span>
                        </div>
                        <div class="tier-option-desc">Unlimited proxy, certificate + badge, priority support</div>
                    </div>
                </label>
            </div>
            <div class="form-group" style="margin-top: 16px;">
                <label class="form-label">Duration (days)</label>
                <input type="number" class="form-input" id="tier-days" value="30" min="1" max="365">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('tier-modal')">Cancel</button>
            <button class="btn-minimal" onclick="saveTierChange()" style="background: var(--accent); color: white; border-color: var(--accent);">Save</button>
        </div>
    </div>
</div>

<!-- REGISTER MODEL MODAL -->
<div class="modal-overlay" id="register-model-modal">
    <div class="modal modal-inst" style="max-width: 440px;">
        <div class="modal-header">
            <h2>Connect Model</h2>
            <button class="modal-close" onclick="closeModal('register-model-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Provider</label>
                <select class="form-input" id="reg-model-provider" onchange="updateModelHint()">
                    <option value="">Select provider...</option>
                    <option value="OpenAI">OpenAI</option>
                    <option value="Anthropic">Anthropic</option>
                    <option value="Google">Google (Gemini)</option>
                    <option value="Meta">Meta (Llama)</option>
                    <option value="Mistral">Mistral</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Model Name</label>
                <input type="text" class="form-input" id="reg-model-name" placeholder="e.g. GPT-4o, Claude 3.5 Sonnet">
            </div>
            <div class="form-group">
                <label class="form-label">Provider API Key</label>
                <input type="password" class="form-input" id="reg-model-apikey" placeholder="sk-... / key-...">
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px" id="reg-model-hint">Your key is encrypted (AES-256) and used only to proxy requests through ONTO.</div>
            </div>
            <div style="padding:10px 12px;background:var(--bg);border-radius:6px;margin-top:8px;font-size:11px;color:var(--text-secondary);line-height:1.5">
                <strong style="color:var(--text)">How it works:</strong> ONTO proxy injects epistemic discipline into every request to your model. You change one line in your code — the base URL. Everything else stays the same.
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('register-model-modal')">Cancel</button>
            <button class="btn-minimal" onclick="submitModelRegistration()" style="background: var(--accent); color: white; border-color: var(--accent);">Connect · Start Trial</button>
        </div>
    </div>
</div>

<script>
// === API CONFIG ===
const API_BASE = 'https://api.ontostandard.org';
let authToken = null;

// === API HELPER ===
async function api(endpoint, options = {}) {
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers
    };
    
    if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
    }
    
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || data.message || 'Request failed');
        }
        
        return data;
    } catch (error) {
        console.error('API request failed');
        throw error;
    }
}

// === STATE ===
let currentUser = null;
let sessionTimer = null;
let sessionWarningTimer = null;
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
const SESSION_WARNING = 5 * 60 * 1000; // 5 minutes before timeout
let pendingVerificationEmail = "";

// === i18n STRINGS (preparation) ===
const STRINGS = {
    welcome: 'Welcome to ONTO',
    welcomeDesc: 'Get started by creating your first API key and making an evaluation request.',
    getApiKey: 'Get API Key',
    readDocs: 'Read Docs',
    copied: 'Copied to clipboard',
    sessionWarning: 'Your session will expire in 5 minutes. Click to stay signed in.',
    sessionExpired: 'Session expired. Please sign in again.',
    orgRegistered: 'Organization registered',
    messageSent: 'Message sent. We\'ll be in touch within 24 hours.',
    fillRequired: 'Please fill in all required fields',
    confirmLogout: 'Are you sure you want to sign out?',
    confirmRegenerate: 'Are you sure you want to regenerate your API key?\n\nThis will immediately invalidate your current key.'
};
const PLANS = {
    business: { monthly: 2500, annual: 30000, monthlyEquiv: 2500 },
    enterprise: { annual: 250000 },
    white_label: { annual: 500000 }
};
let selectedPlan = 'business';
let selectedCycle = 'annual';
// === SESSION MANAGEMENT ===
function resetSessionTimer() {
    clearTimeout(sessionTimer);
    clearTimeout(sessionWarningTimer);
    
    if (!currentUser) return;
    
    // Warning 5 min before timeout
    sessionWarningTimer = setTimeout(() => {
        showSessionWarning();
    }, SESSION_TIMEOUT - SESSION_WARNING);
    
    // Actual timeout
    sessionTimer = setTimeout(() => {
        handleSessionExpired();
    }, SESSION_TIMEOUT);
}

function showSessionWarning() {
    const toast = document.createElement('div');
    toast.className = 'toast session-warning';
    toast.innerHTML = `
        <span>${STRINGS.sessionWarning}</span>
        <button onclick="extendSession(this.parentElement)" style="margin-left:8px;background:white;color:#333;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;">Stay signed in</button>
    `;
    toast.style.cssText = 'background: #d97706; color: white; cursor: pointer;';
    
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    container.appendChild(toast);
}

function extendSession(toastEl) {
    if (toastEl) toastEl.remove();
    resetSessionTimer();
    showToast('Session extended', 'success');
}

function handleSessionExpired() {
    currentUser = null;
    authToken = null;
    localStorage.removeItem('onto_user');
    localStorage.removeItem('onto_token');
    localStorage.removeItem('onto_logged_in');
    const ps = document.getElementById('auth-preload-hide');
    if (ps) ps.remove();
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('dashboard').classList.remove('active');
    showLogin();
    showToast(STRINGS.sessionExpired, 'error');
}

// Activity listener to reset timer
['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
    document.addEventListener(event, () => {
        if (currentUser) resetSessionTimer();
    }, { passive: true });
});

// === THEME ===
function toggleTheme() {
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    if (isLight) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('onto-theme', 'dark');
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('onto-theme', 'light');
    }
}

// Init theme from localStorage (dark is default)
(function() {
    const saved = localStorage.getItem('onto-theme');
    if (saved === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
    }
})();

// === UTILITIES ===
function escapeHtml(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
function layerToPlan(layer) { return { open: 'free', standard: 'business', critical: 'enterprise' }[layer] || 'free'; }
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function toggleMobile() {
    document.querySelector('.sidebar').classList.toggle('mobile-open');
    document.getElementById('mobile-overlay').classList.toggle('active');
}

function toggleAuthMenu() {
    // На auth screen — открываем auth menu, в ЛК — sidebar
    const authScreen = document.getElementById('auth-screen');
    if (authScreen && authScreen.style.display !== 'none') {
        document.getElementById('auth-menu').classList.toggle('open');
        document.getElementById('auth-menu-overlay').classList.toggle('visible');
    } else {
        toggleMobile();
    }
}

function closeAuthMenu() {
    document.getElementById('auth-menu').classList.remove('open');
    document.getElementById('auth-menu-overlay').classList.remove('visible');
}

function setLoading(btn, loading) {
    if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
    } else {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

// === AUTH ===
function showLogin() {
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('verify-pending').classList.add('hidden');
    document.getElementById('verify-success').classList.add('hidden');
    document.getElementById('forgot-form').classList.add('hidden');
    document.getElementById('reset-form').classList.add('hidden');
}

function showRegister() {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.remove('hidden');
    document.getElementById('verify-pending').classList.add('hidden');
    document.getElementById('verify-success').classList.add('hidden');
    document.getElementById('forgot-form').classList.add('hidden');
    document.getElementById('reset-form').classList.add('hidden');
}

function showForgotPassword() {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('verify-pending').classList.add('hidden');
    document.getElementById('verify-success').classList.add('hidden');
    document.getElementById('forgot-form').classList.remove('hidden');
    document.getElementById('reset-form').classList.add('hidden');
    const loginEmail = document.getElementById('login-email').value;
    if (loginEmail) document.getElementById('forgot-email').value = loginEmail;
}

async function handleForgotPassword(btn) {
    const email = document.getElementById('forgot-email').value.trim();
    if (!email) { showToast('Enter your email', 'error'); return; }
    setLoading(btn, true);
    try {
        const res = await fetch(`${API_BASE}/v1/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        const data = await res.json();
        if (res.ok) {
            showToast('Reset link sent to your email', 'success');
            showLogin();
        } else {
            showToast(data.detail || 'Failed to send reset link', 'error');
        }
    } catch(e) {
        showToast('Network error', 'error');
    }
    setLoading(btn, false);
}

async function handleResetPassword(btn) {
    const password = document.getElementById('reset-password').value;
    if (!password || password.length < 8) { showToast('Password must be at least 8 characters', 'error'); return; }
    const params = new URLSearchParams(window.location.search);
    const token = params.get('reset_token');
    if (!token) { showToast('Invalid reset link', 'error'); return; }
    setLoading(btn, true);
    try {
        const res = await fetch(`${API_BASE}/v1/auth/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, new_password: password })
        });
        const data = await res.json();
        if (res.ok) {
            showToast('Password reset. Sign in with your new password.', 'success');
            window.history.replaceState({}, '', window.location.pathname);
            showLogin();
        } else {
            showToast(data.detail || 'Reset failed', 'error');
        }
    } catch(e) {
        showToast('Network error', 'error');
    }
    setLoading(btn, false);
}

function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
    } else {
        input.type = 'password';
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    }
}

// Enable register button when terms agreed
document.getElementById('terms-agree').addEventListener('change', function() {
    document.getElementById('register-btn').disabled = !this.checked;
});

async function handleLogin(btn) {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    setLoading(btn, true);
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Login failed');
        }
        
        // Store token and user data (backend format)
        authToken = data.token;
        localStorage.setItem('onto_token', authToken);
        
        // Store API key for Reference panel
        if (data.api_key) {
            localStorage.setItem('onto_first_api_key', data.api_key);
        }
        
        currentUser = {
            id: data.user_id,
            name: data.name,
            email: email,
            role: data.role || 'admin',
            plan: layerToPlan(data.layer || 'open'),
            organization_id: data.organization_id,
            organization_name: data.organization_name,
            can_invoice: false,
            company: null,
            subscription: data.tier_expires ? { expires_at: data.tier_expires } : null
        };
        // Restore company from backend profile (authoritative source)
        if (data.profile) {
            const p = data.profile;
            if (p.company || p.company_name) {
                currentUser.company = {
                    name: p.company || p.company_name || '',
                    type: p.company_type || '',
                    industry: p.industry || '',
                    reg: p.company_reg || p.registration_number || '',
                    vat: p.company_vat || '',
                    address: p.address || '',
                    city: p.city || '',
                    state: p.state || '',
                    postal: p.postal || p.zip_code || '',
                    country: p.country || '',
                    email: p.billing_email || '',
                    phone: p.phone || '',
                    signatory: p.signatory_name || '',
                    signatoryTitle: p.signatory_title || ''
                };
                currentUser.can_invoice = true;
            }
        }
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        
        // Also store in new format for consistency
        localStorage.setItem('onto_user_id', data.user_id);
        localStorage.setItem('onto_user_name', data.name || '');
        localStorage.setItem('onto_user_email', email);
        localStorage.setItem('onto_org_id', data.organization_id);
        localStorage.setItem('onto_org_name', data.organization_name || '');
        localStorage.setItem('onto_layer', data.layer || 'open');
        localStorage.setItem('onto_role', data.role || 'admin');
        localStorage.setItem('onto_logged_in', 'true');
        
        setLoading(btn, false);
        showToast('Welcome back!', 'success');
        showDashboard();
    } catch (error) {
        setLoading(btn, false);
        
        // Check if email not verified
        if (error.message && error.message.includes('not verified')) {
            pendingVerificationEmail = email;
            showVerifyPending(email);
            showToast('Please verify your email first', 'info');
            return;
        }
        
        showToast(error.message || 'Login failed', 'error');
    }
}

async function handleRegister(btn) {
    const name = document.getElementById('reg-name').value;
    const email = document.getElementById('reg-email').value;
    const password = document.getElementById('reg-password').value;
    const termsAgreed = document.getElementById('terms-agree').checked;
    
    if (!name || !email || !password) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    if (password.length < 8) {
        showToast('Password must be at least 8 characters', 'error');
        return;
    }
    
    if (!termsAgreed) {
        showToast('Please agree to the Terms of Service', 'error');
        return;
    }
    
    setLoading(btn, true);
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Registration failed');
        }
        
        // Store API key for later display
        localStorage.setItem('onto_first_api_key', data.api_key);
        pendingVerificationEmail = email;
        
        setLoading(btn, false);
        
        // Show verification pending screen
        showVerifyPending(email);
        showToast('Check your email to verify your account', 'success');
    } catch (error) {
        setLoading(btn, false);
        showToast(error.message || 'Registration failed', 'error');
    }
}

function showVerifyPending(email) {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('verify-success').classList.add('hidden');
    document.getElementById('verify-pending').classList.remove('hidden');
    document.getElementById('verify-email-display').textContent = email;
    document.getElementById('otp-error').style.display = 'none';
    
    // Clear OTP inputs
    for (let i = 1; i <= 6; i++) {
        document.getElementById('otp-' + i).value = '';
    }
    
    // Focus first input
    setTimeout(() => document.getElementById('otp-1').focus(), 100);
    
    // Setup OTP input handlers
    setupOTPInputs();
}

function setupOTPInputs() {
    for (let i = 1; i <= 6; i++) {
        const input = document.getElementById('otp-' + i);
        
        input.addEventListener('input', (e) => {
            const val = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = val;
            if (val && i < 6) {
                document.getElementById('otp-' + (i + 1)).focus();
            }
            // Auto-submit when all 6 digits entered
            if (i === 6 && val) {
                const code = getOTPCode();
                if (code.length === 6) handleVerifyOTP(document.getElementById('verify-btn'));
            }
        });
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && i > 1) {
                document.getElementById('otp-' + (i - 1)).focus();
            }
        });
        
        // Handle paste
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g, '');
            for (let j = 0; j < 6 && j < paste.length; j++) {
                document.getElementById('otp-' + (j + 1)).value = paste[j];
            }
            if (paste.length >= 6) {
                document.getElementById('otp-6').focus();
                handleVerifyOTP(document.getElementById('verify-btn'));
            }
        });
    }
}

function getOTPCode() {
    let code = '';
    for (let i = 1; i <= 6; i++) {
        code += document.getElementById('otp-' + i).value;
    }
    return code;
}

async function handleVerifyOTP(btn) {
    const code = getOTPCode();
    if (code.length !== 6) {
        document.getElementById('otp-error').textContent = 'Please enter all 6 digits';
        document.getElementById('otp-error').style.display = 'block';
        return;
    }
    
    setLoading(btn, true);
    document.getElementById('otp-error').style.display = 'none';
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/verify-email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: pendingVerificationEmail, code: code })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Verification failed');
        }
        
        // Auto-login with returned data
        authToken = data.token;
        localStorage.setItem('onto_token', authToken);
        
        if (data.api_key) {
            localStorage.setItem('onto_first_api_key', data.api_key);
        }
        
        currentUser = {
            id: data.user_id,
            name: data.name,
            email: data.email,
            role: data.role || 'admin',
            plan: layerToPlan(data.layer || 'open'),
            organization_id: data.organization_id,
            organization_name: data.organization_name
        };
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        localStorage.setItem('onto_logged_in', 'true');
        
        setLoading(btn, false);
        showToast('Email verified! Welcome to ONTO', 'success');
        showDashboard();
    } catch (error) {
        setLoading(btn, false);
        document.getElementById('otp-error').textContent = error.message;
        document.getElementById('otp-error').style.display = 'block';
        
        // Shake OTP inputs
        for (let i = 1; i <= 6; i++) {
            document.getElementById('otp-' + i).classList.add('error');
            setTimeout(() => document.getElementById('otp-' + i).classList.remove('error'), 1500);
        }
    }
}

function showVerifySuccess() {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('verify-pending').classList.add('hidden');
    document.getElementById('verify-success').classList.remove('hidden');
}

async function resendVerification() {
    if (!pendingVerificationEmail) {
        showToast('No email to verify', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/resend-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: pendingVerificationEmail })
        });
        
        const data = await response.json();
        showToast(data.message || 'Verification email sent', 'success');
    } catch (error) {
        showToast('Failed to resend email', 'error');
    }
}

async function checkEmailVerification() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('verify');
    
    if (!token) return;
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/verify-email?token=${token}`);
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Clean URL first
            window.history.replaceState({}, '', window.location.pathname);
            
            // Auto-login with returned data
            if (data.token) {
                authToken = data.token;
                localStorage.setItem('onto_token', authToken);
                
                currentUser = {
                    id: data.user_id,
                    name: data.name,
                    email: data.email,
                    role: 'admin',
                    plan: layerToPlan(data.layer || 'open'),
                    organization_id: data.organization_id,
                    can_invoice: false,
                    company: null  // Company set only after explicit registration
                };
                // Restore company data from previous session
                const savedUserVerify = JSON.parse(localStorage.getItem('onto_user') || '{}');
                if (savedUserVerify.company && savedUserVerify.id === currentUser.id) {
                    currentUser.company = savedUserVerify.company;
                    currentUser.can_invoice = savedUserVerify.can_invoice || false;
                }
                localStorage.setItem('onto_user', JSON.stringify(currentUser));
                
                showToast('Email verified! Welcome to ONTO.', 'success');
                showDashboard();
            } else {
                showVerifySuccess();
                showToast('Email verified! Please sign in.', 'success');
            }
        } else {
            showToast(data.detail || 'Verification failed', 'error');
        }
    } catch (error) {
        showToast('Verification failed', 'error');
        window.history.replaceState({}, '', window.location.pathname);
    }
}

function handleLogout() {
    if (!confirm(STRINGS.confirmLogout)) {
        return;
    }
    clearTimeout(sessionTimer);
    clearTimeout(sessionWarningTimer);
    currentUser = null;
    authToken = null;
    
    // Clear all auth data
    localStorage.removeItem('onto_user');
    localStorage.removeItem('onto_token');
    localStorage.removeItem('onto_first_api_key');
    localStorage.removeItem('onto_logged_in');
    localStorage.removeItem('onto_user_id');
    localStorage.removeItem('onto_user_name');
    localStorage.removeItem('onto_user_email');
    localStorage.removeItem('onto_org_id');
    localStorage.removeItem('onto_org_name');
    localStorage.removeItem('onto_layer');
    localStorage.removeItem('onto_role');
    
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('dashboard').classList.remove('active');
    // Remove preload hide style
    const preloadStyle = document.getElementById('auth-preload-hide');
    if (preloadStyle) preloadStyle.remove();
    showLogin();
}

// === DASHBOARD ===
function showAuthScreen() {
    const preloadStyle = document.getElementById('auth-preload-hide');
    if (preloadStyle) preloadStyle.remove();
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('dashboard').classList.remove('active');
}

function showDashboard() {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');
    
    // Handle ?page= URL parameter
    const params = new URLSearchParams(window.location.search);
    const targetPage = params.get('page');
    if (targetPage && document.getElementById('page-' + targetPage)) {
        showPage(targetPage);
    }
    
    if (currentUser) {
        document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-plan').textContent = currentUser.plan === 'enterprise' ? 'PROVIDER' : currentUser.plan === 'business' ? 'STANDARD' : 'OPEN';
        // Add expiry to sidebar
        if (currentUser.subscription && currentUser.subscription.expires_at) {
            const exp = new Date(currentUser.subscription.expires_at);
            const dateStr = exp.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
            const planEl = document.getElementById('user-plan');
            const planName = currentUser.plan === 'enterprise' ? 'PROVIDER' : currentUser.plan === 'business' ? 'STANDARD' : 'OPEN';
            planEl.textContent = `${planName} · до ${dateStr}`;
        }
        document.getElementById('settings-name').textContent = currentUser.name;
        document.getElementById('settings-email').textContent = currentUser.email;
        
        updateCompanyUI();
        updateBillingUI();
        updateDashboardMetrics();
        resetSessionTimer();
        
        // Switch dashboard view based on tier
        const proxyView = document.getElementById('dash-proxy-view');
        const providerView = document.getElementById('dash-provider-view');
        if (proxyView && providerView) {
            const isProvider = currentUser.plan === 'enterprise';
            proxyView.classList.toggle('hidden', isProvider);
            providerView.classList.toggle('hidden', !isProvider);
            // Auto-load provider status
            if (isProvider) { setTimeout(testProviderSSE, 500); }
            // Restore saved provider key
            const savedPK = localStorage.getItem('onto_provider_key');
            if (savedPK) {
                const pkInput = document.getElementById('test-std-provider-key');
                if (pkInput) pkInput.value = savedPK;
            }
        }
        
        // Init dashboard components
        const realApiKey = localStorage.getItem('onto_first_api_key');
        if (realApiKey) {
            document.getElementById('api-key-display').value = realApiKey;
            const dashApiKey = document.getElementById('dash-api-key');
            if (dashApiKey) dashApiKey.value = realApiKey;
            const connectKey = document.getElementById('connect-api-key-display');
            if (connectKey) connectKey.value = realApiKey;
        }
        loadUserSignal();
        loadOrgFromAPI();
        loadRealCertHash();
        checkReferenceAccess();

    }
}

function updateDashboardMetrics() {
    if (!currentUser) return;
    
    const sub = currentUser.subscription;
    const plan = currentUser.plan || 'free';
    
    const planNames = { free: 'Open', business: 'Standard', enterprise: 'AI Provider' };
    const rateLimits = { free: '10/day', business: '1K/day', enterprise: 'Unlimited' };
    
    // Plan card
    const nameEl = document.getElementById('dash-plan-name');
    const rateEl = document.getElementById('dash-plan-rate');
    const callsEl = document.getElementById('dash-plan-calls');
    const expiresEl = document.getElementById('dash-plan-expires');
    const upgradeBtn = document.getElementById('dash-upgrade-btn');
    
    if (nameEl) nameEl.textContent = planNames[plan] || 'Open';
    if (rateEl) rateEl.textContent = rateLimits[plan] || '10 evals / day';
    
    // Hide upgrade for paid plans
    if (upgradeBtn) upgradeBtn.style.display = plan === 'free' ? 'block' : 'none';
    
    // Expires — single tier, single date
    if (sub && sub.expires_at && expiresEl) {
        const exp = new Date(sub.expires_at);
        const now = new Date();
        const diffMs = exp - now;
        const totalDays = Math.max(0, Math.ceil(diffMs / (1000 * 60 * 60 * 24)));
        
        if (totalDays > 365) {
            const years = Math.floor(totalDays / 365);
            const months = Math.floor((totalDays % 365) / 30);
            expiresEl.textContent = 'Expires in ' + years + 'y ' + months + 'm';
        } else if (totalDays > 30) {
            const months = Math.floor(totalDays / 30);
            const days = totalDays % 30;
            expiresEl.textContent = 'Expires in ' + months + 'm ' + days + 'd';
        } else if (totalDays > 0) {
            expiresEl.textContent = 'Expires in ' + totalDays + 'd';
        } else {
            expiresEl.textContent = 'Expired';
        }
    } else if (expiresEl) {
        expiresEl.textContent = plan === 'free' ? 'No expiration' : '—';
    }
    
    // Plan includes hint
    const includesEl = document.getElementById('plan-includes-text');
    if (includesEl) {
        const planIncludes = {
            free: 'Free: 10 requests/day · GOLD Core · Signed proofs',
            business: 'Standard: 1K proxy/day · GOLD Extended · Signed proofs',
            enterprise: 'AI Provider: Unlimited · Full GOLD · All models · Proof chain'
        };
        includesEl.textContent = planIncludes[plan] || planIncludes.free;
    }
    
    // Fetch real usage from backend
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (apiKey && callsEl) {
        fetch(`${API_BASE}/v1/usage`, { headers: { 'x-api-key': apiKey } })
            .then(r => r.ok ? r.json() : null)
            .then(data => {
                if (!data) return;
                const daily = data.daily || {};
                if (daily.unlimited) {
                    callsEl.textContent = daily.used + ' today';
                } else {
                    callsEl.textContent = daily.used + ' / ' + daily.limit;
                }
            })
            .catch(() => {});
    }
}


function showPage(page, el) {
    // Backward compat
    if (page === 'dashboard' || page === 'audit') page = 'monitor';
    
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const target = document.getElementById('page-' + page);
    if (target) target.classList.add('active');
    if (el) {
        const navItem = el.closest ? el.closest('.nav-item') : el;
        if (navItem) navItem.classList.add('active');
    } else {
        document.querySelectorAll('.nav-item').forEach(n => {
            const oc = n.getAttribute('onclick');
            if (oc && oc.includes("'" + page + "'")) n.classList.add('active');
        });
    }
    if (page === 'monitor') { loadUserSignal(); initERM(); initErmCert(); }
    if (page === 'sdk') updateSdkPage();
}

// === COMPANY ===
function updateCompanyUI() {
    if (currentUser.company) {
        document.getElementById('company-not-registered').classList.add('hidden');
        document.getElementById('company-registered').classList.remove('hidden');
        document.getElementById('company-name').textContent = currentUser.company.name;
        document.getElementById('company-industry').textContent = formatIndustry(currentUser.company.industry);
        document.getElementById('company-reg').textContent = currentUser.company.reg;
        document.getElementById('settings-account-type').textContent = 'Individual + Company';
    } else {
        document.getElementById('company-not-registered').classList.remove('hidden');
        document.getElementById('company-registered').classList.add('hidden');
        document.getElementById('settings-account-type').textContent = 'Individual';
    }
}

function formatIndustry(code) {
    const industries = {
        'healthcare': 'Healthcare & Medical',
        'financial': 'Financial Services',
        'legal': 'Legal Services',
        'insurance': 'Insurance',
        'aerospace': 'Aerospace',
        'defense': 'Defense & Security',
        'autonomous': 'Autonomous Systems',
        'energy': 'Energy & Utilities',
        'infrastructure': 'Critical Infrastructure',
        'ai_ml': 'AI / Machine Learning',
        'software': 'Software & SaaS',
        'cloud': 'Cloud Services',
        'cybersecurity': 'Cybersecurity',
        'data': 'Data & Analytics',
        'manufacturing': 'Manufacturing',
        'retail': 'Retail & E-commerce',
        'education': 'Education',
        'media': 'Media & Entertainment',
        'consulting': 'Consulting',
        'research': 'Research & Academia',
        'government': 'Government & Public',
        'other': 'Other'
    };
    return industries[code] || code || '—';
}

function openCompanyModal() {
    const modal = document.getElementById('company-modal');
    const isEdit = currentUser?.company != null;
    
    // Update modal title and button for edit mode
    const title = modal.querySelector('.modal-header h2');
    const submitBtn = document.getElementById('register-company-btn');
    if (title) title.textContent = isEdit ? 'Edit Organization' : 'Organization Registration';
    if (submitBtn) submitBtn.textContent = isEdit ? 'Save Changes' : 'Register';
    
    modal.classList.add('active');
    
    // Reset form
    submitBtn.disabled = true;
    
    // Field mapping
    const fieldMap = {
        'company-name-input': 'name',
        'company-type-input': 'type',
        'company-industry-input': 'industry',
        'company-reg-input': 'reg',
        'company-vat-input': 'vat',
        'company-address-input': 'address',
        'company-city-input': 'city',
        'company-state-input': 'state',
        'company-postal-input': 'postal',
        'company-country-input': 'country',
        'company-email-input': 'email',
        'company-phone-input': 'phone',
        'signatory-name-input': 'signatory',
        'signatory-title-input': 'signatoryTitle'
    };
    
    // Add validation listeners and pre-fill if editing
    const companyFields = ['company-name-input', 'company-type-input', 'company-industry-input', 'company-reg-input', 'company-address-input', 'company-city-input', 'company-postal-input', 'company-country-input', 'company-email-input', 'signatory-name-input', 'signatory-title-input'];
    companyFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('error', 'valid', 'empty-required');
            
            // Pre-fill with existing data
            const dataKey = fieldMap[id];
            if (isEdit && currentUser.company && dataKey) {
                el.value = currentUser.company[dataKey] || '';
            } else {
                el.value = '';
            }
            
            el.oninput = function() {
                this.classList.remove('error');
                validateCompanyForm();
            };
            el.onchange = validateCompanyForm;
        }
    });
    
    // Also fill optional fields
    ['company-vat-input', 'company-state-input', 'company-phone-input'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            const dataKey = fieldMap[id];
            if (isEdit && currentUser.company && dataKey) {
                el.value = currentUser.company[dataKey] || '';
            } else {
                el.value = '';
            }
        }
    });
    
    ['msa-agree', 'msa-authorized'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.checked = isEdit; // Pre-check if editing (already agreed)
            el.onchange = validateCompanyForm;
        }
    });
    
    // Show initial state after short delay
    setTimeout(validateCompanyForm, 50);
}

// ============ INTEGRATION TESTS ============

async function testStandardProxy() {
    const providerKey = document.getElementById('test-std-provider-key').value.trim();
    if (!providerKey) { showToast('Enter your provider API key', 'error'); return; }
    localStorage.setItem('onto_provider_key', providerKey);
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) { showToast('Please sign in first', 'error'); return; }
    
    const provider = document.getElementById('test-std-provider').value;
    const btn = document.getElementById('test-std-btn');
    const status = document.getElementById('test-std-status');
    const result = document.getElementById('test-std-result');
    
    btn.disabled = true;
    btn.textContent = 'Testing...';
    status.textContent = 'Sending request through ONTO proxy...';
    status.style.color = 'var(--text-muted)';
    result.classList.add('hidden');
    
    const testPrompt = 'What is the boiling point of water? Give specific numbers and cite sources.';
    
    try {
        let url, body, headers;
        
        if (provider === 'anthropic') {
            url = `${API_BASE}/v1/proxy/anthropic/messages`;
            headers = { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'X-Provider-Key': providerKey };
            body = JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 512, messages: [{ role: 'user', content: testPrompt }] });
        } else {
            url = `${API_BASE}/v1/proxy/chat/completions`;
            headers = { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'X-Provider-Key': providerKey };
            const models = { openai: 'gpt-4o', deepseek: 'deepseek-chat', mistral: 'mistral-large-latest' };
            const model = models[provider] || 'gpt-4o';
            body = JSON.stringify({ model, max_tokens: 512, messages: [{ role: 'user', content: testPrompt }] });
            if (provider === 'deepseek') headers['X-Provider-Base-URL'] = 'https://api.deepseek.com/v1';
            if (provider === 'mistral') headers['X-Provider-Base-URL'] = 'https://api.mistral.ai/v1';
        }
        
        const startTime = Date.now();
        const res = await fetch(url, { method: 'POST', headers, body });
        const elapsed = Date.now() - startTime;
        const data = await res.json();
        
        if (!res.ok) {
            status.textContent = `✗ Error ${res.status}: ${data.detail || JSON.stringify(data)}`;
            status.style.color = '#ef4444';
            btn.disabled = false;
            btn.textContent = 'Run Test';
            return;
        }
        
        // Extract response text
        let responseText = '';
        if (provider === 'anthropic') {
            responseText = (data.content || []).map(c => c.text || '').join('');
        } else {
            responseText = data.choices?.[0]?.message?.content || '';
        }
        
        // Check for GOLD markers
        const goldMarkers = ['[QD:', '[SS:', '[UM:', '[CP:', '[CONF:', 'CONFIDENCE:', 'SOURCE:', 'UNCERTAINTY:', '±', 'CI:', 'p-value', 'citation'];
        const foundMarkers = goldMarkers.filter(m => responseText.toLowerCase().includes(m.toLowerCase()));
        
        const tokens = data.usage || {};
        const inputTok = tokens.input_tokens || tokens.prompt_tokens || '?';
        const outputTok = tokens.output_tokens || tokens.completion_tokens || '?';
        
        if (foundMarkers.length >= 2) {
            status.innerHTML = `<span style="color:var(--accent)">✓ GOLD Active</span> · ${elapsed}ms · ${inputTok}+${outputTok} tokens · ${foundMarkers.length} epistemic markers detected`;
        } else {
            status.innerHTML = `<span style="color:#f59e0b">⚠ Response received</span> · ${elapsed}ms · ${inputTok}+${outputTok} tokens · GOLD markers may be subtle`;
        }
        
        result.textContent = responseText.substring(0, 1500) + (responseText.length > 1500 ? '...' : '');
        result.classList.remove('hidden');
        
    } catch (e) {
        status.textContent = `✗ ${e.message}`;
        status.style.color = '#ef4444';
    }
    
    btn.disabled = false;
    btn.textContent = 'Run Test';
}

async function testProviderSSE() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) { showToast('Please sign in first', 'error'); return; }
    
    const btn = document.getElementById('test-prov-btn');
    
    btn.disabled = true;
    btn.textContent = 'Checking...';
    
    try {
        const res = await fetch(`${API_BASE}/v1/proxy/status`, { headers: { 'x-api-key': apiKey } });
        const data = await res.json();
        
        const streamStatus = document.getElementById('prov-stream-status');
        const layerEl = document.getElementById('prov-gold-layer');
        const cacheEl = document.getElementById('prov-gold-cache');
        const ageEl = document.getElementById('prov-gold-age');
        
        if (res.ok && data.gold_available) {
            if (streamStatus) streamStatus.innerHTML = '<span style="color:var(--accent)">● CONNECTED</span>';
            if (layerEl) layerEl.textContent = data.gold_tier?.replace('GOLD_','').replace('.md','') || '?';
            if (cacheEl) cacheEl.textContent = data.gold_cached ? 'Active' : 'Loading';
            if (ageEl) ageEl.textContent = data.gold_cache_age_seconds ? data.gold_cache_age_seconds + 's ago' : '—';
        } else {
            if (streamStatus) streamStatus.innerHTML = '<span style="color:#ef4444">● DISCONNECTED</span>';
        }
    } catch (e) {
        const streamStatus = document.getElementById('prov-stream-status');
        if (streamStatus) streamStatus.innerHTML = '<span style="color:#ef4444">● ERROR</span>';
    }
    
    btn.disabled = false;
    btn.textContent = 'Refresh Status';
}

async function testProviderEval() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) { showToast('Please sign in first', 'error'); return; }
    
    const evalText = document.getElementById('test-eval-output')?.value?.trim();
    if (!evalText) { showToast('Paste model output to evaluate', 'error'); return; }
    
    const btn = document.getElementById('test-eval-btn');
    const status = document.getElementById('test-prov-status');
    const result = document.getElementById('test-prov-result');
    
    btn.disabled = true;
    btn.textContent = 'Testing...';
    status.textContent = 'Sending test evaluation...';
    result.classList.add('hidden');
    
    try {
        const res = await fetch(`${API_BASE}/v1/models/evaluate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
            body: JSON.stringify({
                model_id: 'test-probe',
                output: evalText,
                context: 'What is the boiling point of water?',
                domain: 'general',
                confidence: 0.99
            })
        });
        const data = await res.json();
        
        if (res.ok) {
            const score = data.risk_score ?? data.score ?? '?';
            const grade = data.compliance?.grade ?? data.grade ?? '?';
            status.innerHTML = `<span style="color:var(--accent)">✓ Scoring API Active</span> · Risk Score: ${score} · Grade: ${grade}`;
            result.textContent = JSON.stringify(data, null, 2);
            result.classList.remove('hidden');
        } else if (res.status === 404 || res.status === 422) {
            status.innerHTML = `<span style="color:var(--accent)">✓ Scoring API Reachable</span> · Register a model first to run full evaluation`;
            result.textContent = 'Endpoint is live.\n\nTo run evaluations:\n1. Register a model: POST /v1/models\n2. Submit evaluation: POST /v1/models/evaluate\n\nSee API documentation for details.';
            result.classList.remove('hidden');
        } else {
            status.textContent = `✗ Error ${res.status}: ${data.detail || JSON.stringify(data)}`;
            status.style.color = '#ef4444';
        }
    } catch (e) {
        status.textContent = `✗ ${e.message}`;
        status.style.color = '#ef4444';
    }
    
    btn.disabled = false;
    btn.textContent = 'Test Scoring API';
}

async function downloadInvoice() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) { showToast('Please sign in', 'error'); return; }
    
    showToast('Loading invoice data...', 'success');
    
    let data;
    try {
        const res = await fetch(`${API_BASE}/v1/billing/invoice-data`, { headers: { 'x-api-key': apiKey } });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            showToast(err.detail || 'Failed to load invoice data', 'error');
            return;
        }
        data = await res.json();
    } catch(e) {
        showToast('Network error', 'error');
        return;
    }
    
    const prov = data.provider || {};
    const client = data.client || {};
    const sub = data.subscription || {};
    
    // Override tier from dropdown selection
    const selectedTier = document.getElementById('invoice-tier-select')?.value;
    if (selectedTier) {
        const tierMap = {
            standard_monthly: { layer: 'standard', layer_name: 'Standard', price_annual: 2500, is_monthly: true },
            standard: { layer: 'standard', layer_name: 'Standard', price_annual: 30000 },
            critical: { layer: 'critical', layer_name: 'AI Provider', price_annual: 250000 },
            white_label: { layer: 'white_label', layer_name: 'White-Label', price_annual: 500000 }
        };
        const t = tierMap[selectedTier];
        if (t) { sub.layer = t.layer; sub.layer_name = t.layer_name; sub.price_annual = t.price_annual; sub.is_monthly = t.is_monthly || false; }
    }
    
    if (!client.name) { showToast('Register organization first', 'error'); return; }
    
    const invoiceId = 'INV-' + new Date().getFullYear() + '-' + Date.now().toString(36).toUpperCase();
    const isMonthly = sub.is_monthly || false;
    const amount = sub.price_annual || 0;
    const periodDays = isMonthly ? 30 : 365;
    const expiresAt = sub.expires_at ? new Date(sub.expires_at) : new Date(Date.now() + periodDays*86400000);
    const startedAt = new Date(expiresAt.getTime() - periodDays*86400000);
    const dueDate = new Date(startedAt.getTime() + 30*86400000);
    const periodLabel = isMonthly ? 'Monthly subscription · 1 month' : 'Annual subscription · 12 months';
    const fmtDate = (d) => d.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
    const fmtMoney = (n) => '$' + n.toLocaleString('en-US', {minimumFractionDigits:2});
    const hash = simpleHash(invoiceId + client.name + sub.layer + amount);
    
    const provCity = [prov.city, prov.state, prov.postal, prov.country].filter(Boolean).join(', ');
    const clientCity = [client.city, client.state, client.postal, client.country].filter(Boolean).join(', ');
    
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>ONTO Invoice ${invoiceId}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,Helvetica,Arial,sans-serif;color:#1a1a1a;font-size:13px;line-height:1.5;padding:40px}
.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;padding-bottom:20px;border-bottom:3px solid #0c0f14}
.logo{font-size:28px;font-weight:700;color:#0c0f14;letter-spacing:-0.5px}
.logo-sub{font-size:10px;color:#888;margin-top:2px}
.inv-title{text-align:right}
.inv-title h2{font-size:24px;color:#2ec27e;font-weight:700;margin-bottom:4px}
.inv-id{font-size:11px;color:#666}
.parties{display:flex;gap:60px;margin-bottom:28px}
.party{flex:1}
.party-label{font-size:9px;text-transform:uppercase;color:#999;letter-spacing:1px;margin-bottom:6px;font-weight:600}
.party-name{font-size:14px;font-weight:600;margin-bottom:4px}
.party-detail{font-size:11px;color:#555;line-height:1.6}
.dates{display:flex;gap:40px;background:#f7f7f7;padding:12px 16px;border-radius:4px;margin-bottom:24px}
.date-col .date-label{font-size:9px;text-transform:uppercase;color:#999;letter-spacing:0.5px}
.date-col .date-val{font-size:12px;font-weight:600;margin-top:2px}
.status-paid{color:#2ec27e;font-weight:700}
table{width:100%;border-collapse:collapse;margin-bottom:24px}
thead th{background:#0c0f14;color:#fff;padding:8px 12px;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;text-align:left}
thead th:last-child{text-align:right}
tbody td{padding:10px 12px;border-bottom:1px solid #eee;font-size:12px}
tbody td:last-child{text-align:right;font-weight:600}
.item-sub{font-size:10px;color:#888;margin-top:2px}
.totals{display:flex;justify-content:flex-end;margin-bottom:28px}
.totals-table{width:220px}
.totals-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#666}
.totals-total{display:flex;justify-content:space-between;padding:8px 0;font-size:16px;font-weight:700;color:#2ec27e;border-top:2px solid #0c0f14;margin-top:4px}
.details{background:#f7f7f7;padding:14px 16px;border-radius:4px;margin-bottom:24px}
.details-title{font-size:9px;text-transform:uppercase;color:#999;letter-spacing:1px;margin-bottom:8px;font-weight:600}
.details-grid{display:flex;gap:40px;font-size:11px;color:#555}
.details-grid div{line-height:1.8}
.footer{border-top:1px solid #ddd;padding-top:12px;text-align:center;font-size:9px;color:#aaa;line-height:1.8}
@media print{body{padding:20px}@page{margin:15mm}}
</style></head><body>

<div class="header">
    <div>
        <div class="logo">ONTO</div>
        <div class="logo-sub">${prov.name || 'ONTO Standard'}</div>
        <div class="logo-sub">ontostandard.org</div>
    </div>
    <div class="inv-title">
        <h2>INVOICE</h2>
        <div class="inv-id">${invoiceId}</div>
    </div>
</div>

<div class="parties">
    <div class="party">
        <div class="party-label">From</div>
        <div class="party-name">${prov.name || 'ONTO Standard'}</div>
        <div class="party-detail">
            ${prov.address ? prov.address + '<br>' : ''}
            ${provCity ? provCity + '<br>' : ''}
            ${prov.reg ? 'Reg: ' + prov.reg + '<br>' : ''}
            ${prov.vat ? 'VAT: ' + prov.vat + '<br>' : ''}
            ${prov.email || 'billing@ontostandard.org'}
        </div>
    </div>
    <div class="party">
        <div class="party-label">Bill To</div>
        <div class="party-name">${client.name}</div>
        <div class="party-detail">
            ${client.address ? client.address + '<br>' : ''}
            ${clientCity ? clientCity + '<br>' : ''}
            ${client.reg ? 'Reg: ' + client.reg + '<br>' : ''}
            ${client.vat ? 'VAT: ' + client.vat + '<br>' : ''}
            ${client.email}
        </div>
    </div>
</div>

<div class="dates">
    <div class="date-col">
        <div class="date-label">Issue Date</div>
        <div class="date-val">${fmtDate(startedAt)}</div>
    </div>
    <div class="date-col">
        <div class="date-label">Due Date</div>
        <div class="date-val">${fmtDate(dueDate)}</div>
    </div>
    <div class="date-col">
        <div class="date-label">Status</div>
        <div class="date-val status-paid">PAID</div>
    </div>
</div>

<table>
    <thead><tr>
        <th>Description</th>
        <th>Period</th>
        <th style="text-align:right">Amount</th>
    </tr></thead>
    <tbody><tr>
        <td>
            <strong>ONTO Protocol — ${sub.layer_name} License</strong>
            <div class="item-sub">${periodLabel}</div>
        </td>
        <td>${fmtDate(startedAt)} — ${fmtDate(expiresAt)}</td>
        <td>${fmtMoney(amount)}</td>
    </tr></tbody>
</table>

<div class="totals">
    <div class="totals-table">
        <div class="totals-row"><span>Subtotal</span><span>${fmtMoney(amount)}</span></div>
        <div class="totals-row"><span>Tax (0%)</span><span>$0.00</span></div>
        <div class="totals-total"><span>Total</span><span>${fmtMoney(amount)}</span></div>
    </div>
</div>

<div class="details">
    <div class="details-title">Service Details</div>
    <div class="details-grid">
        <div>
            Layer: ${sub.layer_name}<br>
            Period: ${fmtDate(startedAt)} — ${fmtDate(expiresAt)}
        </div>
        <div>
            Rate limit: ${sub.layer === 'critical' ? 'Unlimited' : '1,000/day'}<br>
            Support: ${sub.layer === 'critical' ? 'Priority 24/7' : 'Business hours'}
        </div>
    </div>
</div>

<div style="font-size:10px;color:#888;margin-bottom:20px">
    <strong>Payment:</strong> Ref: ${invoiceId}
</div>

<div class="footer">
    ${prov.name || 'ONTO Standard'} · ontostandard.org · ${prov.email || 'billing@ontostandard.org'}<br>
    Verification: ${hash}
</div>

</body></html>`;
    
    const w = window.open('', '_blank', 'width=800,height=1000');
    w.document.write(html);
    w.document.close();
    setTimeout(() => { w.print(); }, 500);
    showToast('Invoice opened — use Save as PDF in print dialog', 'success');
}

function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash = hash & hash;
    }
    return Math.abs(hash).toString(16).padStart(16, '0');
}

async function registerCompany() {
    const btn = document.getElementById('register-company-btn');
    const fields = {
        name: document.getElementById('company-name-input'),
        type: document.getElementById('company-type-input'),
        industry: document.getElementById('company-industry-input'),
        reg: document.getElementById('company-reg-input'),
        vat: document.getElementById('company-vat-input'),
        address: document.getElementById('company-address-input'),
        city: document.getElementById('company-city-input'),
        state: document.getElementById('company-state-input'),
        postal: document.getElementById('company-postal-input'),
        country: document.getElementById('company-country-input'),
        email: document.getElementById('company-email-input'),
        phone: document.getElementById('company-phone-input'),
        signatory: document.getElementById('signatory-name-input'),
        signatoryTitle: document.getElementById('signatory-title-input')
    };
    const msaAgree = document.getElementById('msa-agree');
    const msaAuth = document.getElementById('msa-authorized');
    
    const requiredFields = ['name', 'type', 'industry', 'reg', 'address', 'city', 'postal', 'country', 'email', 'signatory', 'signatoryTitle'];
    let valid = true;
    
    // Clear previous errors
    Object.values(fields).forEach(f => { if(f) f.classList.remove('error'); });
    
    // Validate required fields
    requiredFields.forEach(key => {
        const field = fields[key];
        if (field && (!field.value || !field.value.trim())) {
            field.classList.add('error');
            valid = false;
        }
    });
    
    if (!msaAgree.checked || !msaAuth.checked) {
        valid = false;
    }
    
    if (!valid) {
        return;
    }
    
    // Loading state
    const isEdit = currentUser?.company != null;
    const originalText = btn.textContent;
    btn.textContent = isEdit ? 'Saving...' : 'Registering...';
    btn.disabled = true;
    
    const companyData = { 
        name: fields.name.value,
        type: fields.type.value,
        industry: fields.industry.value,
        reg: fields.reg.value, 
        vat: fields.vat?.value || '',
        address: fields.address.value,
        city: fields.city.value,
        state: fields.state?.value || '',
        postal: fields.postal.value,
        country: fields.country.value,
        email: fields.email.value,
        phone: fields.phone?.value || '',
        signatory: fields.signatory.value,
        signatoryTitle: fields.signatoryTitle.value
    };

    try {
        const apiKey = localStorage.getItem('onto_first_api_key');
        const response = await fetch(`${API_BASE}/v1/organization/profile`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'x-api-key': apiKey
            },
            body: JSON.stringify({
                company: companyData.name,
                industry: companyData.industry,
                country: companyData.country,
                address: companyData.address,
                city: companyData.city,
                state: companyData.state,
                postal: companyData.postal,
                phone: companyData.phone,
                billing_email: companyData.email,
                signatory_name: companyData.signatory,
                signatory_title: companyData.signatoryTitle,
                company_type: companyData.type,
                company_reg: companyData.reg,
                company_vat: companyData.vat
            })
        });
        
        if (!response.ok) throw new Error('Failed to save');
        
        currentUser.company = companyData;
        currentUser.can_invoice = true;
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        
        btn.textContent = originalText;
        closeModal('company-modal');
        updateCompanyUI();
        updateBillingUI();
        showToast(isEdit ? 'Organization updated' : 'Organization registered. You can now download invoices.', 'success');
    } catch (e) {
        btn.textContent = originalText;
        btn.disabled = false;
        showToast('Failed to save organization: ' + e.message, 'error');
    }
}

function validateCompanyForm() {
    const requiredFields = {
        'company-name-input': document.getElementById('company-name-input'),
        'company-type-input': document.getElementById('company-type-input'),
        'company-industry-input': document.getElementById('company-industry-input'),
        'company-reg-input': document.getElementById('company-reg-input'),
        'company-address-input': document.getElementById('company-address-input'),
        'company-city-input': document.getElementById('company-city-input'),
        'company-postal-input': document.getElementById('company-postal-input'),
        'company-country-input': document.getElementById('company-country-input'),
        'company-email-input': document.getElementById('company-email-input'),
        'signatory-name-input': document.getElementById('signatory-name-input'),
        'signatory-title-input': document.getElementById('signatory-title-input')
    };
    
    const msaAgree = document.getElementById('msa-agree').checked;
    const msaAuth = document.getElementById('msa-authorized').checked;
    
    let allFilled = true;
    
    // Check each required field and update visual state
    Object.values(requiredFields).forEach(field => {
        if (!field) return;
        field.classList.remove('error'); // Clear error state on validation
        
        if (field.value && field.value.trim()) {
            field.classList.add('valid');
            field.classList.remove('empty-required');
        } else {
            field.classList.remove('valid');
            field.classList.add('empty-required');
            allFilled = false;
        }
    });
    
    // Update checkboxes visual
    const msaAgreeEl = document.getElementById('msa-agree');
    const msaAuthEl = document.getElementById('msa-authorized');
    msaAgreeEl.parentElement.classList.toggle('checked', msaAgree);
    msaAuthEl.parentElement.classList.toggle('checked', msaAuth);
    
    const btn = document.getElementById('register-company-btn');
    btn.disabled = !(allFilled && msaAgree && msaAuth);
}

function highlightEmptyFields() {
    const fieldIds = ['company-name-input', 'company-type-input', 'company-industry-input', 'company-reg-input', 'company-address-input', 'company-city-input', 'company-postal-input', 'company-country-input', 'company-email-input', 'signatory-name-input', 'signatory-title-input'];
    
    fieldIds.forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;
        if (!field.value || !field.value.trim()) {
            field.classList.remove('valid', 'empty-required');
            field.classList.add('error');
        }
    });
    
    // Highlight checkboxes container if not checked
    const msaAgree = document.getElementById('msa-agree');
    const msaAuth = document.getElementById('msa-authorized');
    
    msaAgree.parentElement.style.color = msaAgree.checked ? '' : 'var(--danger)';
    msaAuth.parentElement.style.color = msaAuth.checked ? '' : 'var(--danger)';
}

// === BILLING ===
async function refreshBillingFromBackend() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return;
    try {
        const res = await fetch(`${API_BASE}/v1/billing/status`, { headers: { 'x-api-key': apiKey } });
        if (!res.ok) return;
        const data = await res.json();
        // Update currentUser with real tier from backend
        const tierToPlan = { open: 'free', standard: 'business', critical: 'enterprise', white_label: 'enterprise' };
        currentUser.plan = tierToPlan[data.layer] || 'free';
        currentUser.layer = data.layer;
        localStorage.setItem('onto_layer', data.layer);
        if (data.subscription && data.subscription.current_period_end) {
            currentUser.subscription = currentUser.subscription || {};
            currentUser.subscription.expires_at = data.subscription.current_period_end;
            currentUser.subscription.plan = currentUser.plan;
        } else if (data.tier_expires) {
            currentUser.subscription = currentUser.subscription || {};
            currentUser.subscription.expires_at = data.tier_expires;
        }
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        document.getElementById('user-plan').textContent = currentUser.plan === 'enterprise' ? 'PROVIDER' : (currentUser.plan === 'business' ? 'STANDARD' : 'OPEN');
        updateBillingUI();
        updateDashboardMetrics();
    } catch(e) {}
}

function updateBillingUI() {
    const invoiceStatus = document.getElementById('invoice-status');
    const invoiceDownload = document.getElementById('invoice-download');
    const subNone = document.getElementById('subscription-none');
    const subActive = document.getElementById('subscription-active');
    
    // Reset all buttons first
    document.getElementById('btn-free').textContent = 'Current';
    document.getElementById('btn-free').disabled = true;
    document.getElementById('btn-business').textContent = 'Select';
    document.getElementById('btn-business').disabled = false;
    if(document.getElementById('btn-enterprise')) document.getElementById('btn-enterprise').textContent = 'Select';
    if(document.getElementById('btn-enterprise')) document.getElementById('btn-enterprise').disabled = false;
    
    const planNames = { free: 'Open (Free)', business: 'Standard', enterprise: 'AI Provider' };
    const rateLimits = { free: '10/day', business: '1K/day', enterprise: 'Unlimited' };
    
    // Update current plan indicator
    if (currentUser.plan === 'free' || !currentUser.subscription) {
        document.getElementById('btn-free').textContent = 'Current';
        document.getElementById('btn-free').disabled = true;
        invoiceStatus.textContent = 'No active subscription';
        invoiceStatus.classList.remove('hidden');
        if (currentUser?.company) {
            invoiceDownload.classList.remove('hidden');
        } else {
            invoiceDownload.classList.add('hidden');
        }
        
        if (subNone) subNone.classList.remove('hidden');
        if (subActive) subActive.classList.add('hidden');
    } else {
        const sub = currentUser.subscription;
        
        if (currentUser.plan === 'business') {
            document.getElementById('btn-business').textContent = 'Extend';
        } else if (currentUser.plan === 'enterprise') {
            if(document.getElementById('btn-enterprise')) document.getElementById('btn-enterprise').textContent = 'Extend';
        }
        
        const invoiceRegOrg = document.getElementById('invoice-register-org');
        if (currentUser?.company) {
            invoiceStatus.classList.add('hidden');
            invoiceDownload.classList.remove('hidden');
            if (invoiceRegOrg) invoiceRegOrg.classList.add('hidden');
            // Auto-select tier in invoice dropdown
            const tierSelect = document.getElementById('invoice-tier-select');
            if (tierSelect) {
                const planToTier = { business: 'standard', enterprise: 'critical' };
                tierSelect.value = planToTier[currentUser.plan] || 'standard';
            }
        } else {
            invoiceStatus.classList.add('hidden');
            invoiceDownload.classList.add('hidden');
            if (invoiceRegOrg) invoiceRegOrg.classList.remove('hidden');
        }
        
        if (subNone) subNone.classList.add('hidden');
        if (subActive) subActive.classList.remove('hidden');
        
        document.getElementById('sub-plan').textContent = planNames[currentUser.plan] || currentUser.plan;
        document.getElementById('sub-rate').textContent = rateLimits[currentUser.plan] || '—';
        const expiresEl = document.getElementById('sub-expires');
        if (sub.expires_at && expiresEl) {
            const exp = new Date(sub.expires_at);
            const now = new Date();
            const daysLeft = Math.ceil((exp - now) / (1000*60*60*24));
            const dateStr = exp.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
            if (daysLeft < 0) {
                expiresEl.innerHTML = `<span style="color:var(--danger)">${dateStr} — EXPIRED</span>`;
            } else if (daysLeft < 30) {
                expiresEl.innerHTML = `<span style="color:#f59e0b">${dateStr} (${daysLeft} days left) ⚠️</span>`;
            } else {
                expiresEl.textContent = `${dateStr} (${daysLeft} days left)`;
            }
        } else if (expiresEl) {
            expiresEl.textContent = '—';
        }
        document.getElementById('sub-total').textContent = sub.total_paid ? '$' + sub.total_paid.toLocaleString() : '—';
    }
}

// === SUBSCRIBE MODAL ===
function openSubscribeModal(plan) {
    selectedPlan = plan;
    const planNames = { business: 'Standard', enterprise: 'AI Provider' };
    document.getElementById('subscribe-plan-name').textContent = planNames[plan] || plan;
    
    const annualLabel = document.querySelector('#billing-annual .billing-option-name');
    const annualDetail = document.querySelector('#billing-annual .billing-option-detail');
    const monthlyLabel = document.querySelector('#billing-monthly .billing-option-name');
    const monthlyDetail = document.querySelector('#billing-monthly .billing-option-detail');
    const monthlyOption = document.getElementById('billing-monthly');
    
    if (plan === 'enterprise') {
        // AI Provider: two license tiers
        annualLabel.textContent = 'AI Provider';
        annualDetail.textContent = 'Full GOLD access for AI model providers';
        document.getElementById('price-annual-display').textContent = '$250,000';
        monthlyOption.style.display = 'flex';
        monthlyLabel.textContent = 'White Label';
        monthlyDetail.textContent = 'Full integration · your brand · unlimited scale';
        document.getElementById('price-monthly-display').textContent = '$500,000';
        // Both are annual invoice-only
        document.querySelector('#billing-annual input').value = 'annual';
        document.querySelector('#billing-monthly input').value = 'white_label';
    } else {
        // Standard: annual/monthly
        annualLabel.textContent = 'Annual';
        annualDetail.textContent = 'Billed once per year';
        document.getElementById('price-annual-display').textContent = '$' + PLANS.business.annual.toLocaleString();
        monthlyOption.style.display = 'flex';
        monthlyLabel.textContent = 'Monthly';
        monthlyDetail.textContent = 'Billed each month';
        document.getElementById('price-monthly-display').textContent = '$' + PLANS.business.monthly.toLocaleString() + '/mo';
        document.querySelector('#billing-annual input').value = 'annual';
        document.querySelector('#billing-monthly input').value = 'monthly';
    }
    
    document.querySelector('#billing-annual input').checked = true;
    document.getElementById('subscribe-modal').classList.add('active');
    selectedCycle = 'annual';
    updateOrderSummary();
}

function updateOrderSummary() {
    const cycleVal = document.querySelector('input[name="billing-cycle"]:checked')?.value || 'annual';
    selectedCycle = cycleVal;
    
    const planFeatures = {
        business: ['1,000 proxy requests/day', 'GOLD Extended — Extended Corpus', 'Ed25519 signed proof chain', 'Public verification badge'],
        enterprise: ['GOLD Full Corpus via SSE', 'Unlimited proxy requests', 'Ed25519 proof chain', 'Full audit trail', 'Priority support']
    };
    const featuresEl = document.getElementById('order-features');
    
    let planLabel, price;
    
    if (selectedPlan === 'enterprise') {
        if (cycleVal === 'white_label') {
            planLabel = 'White Label — Annual';
            price = 500000;
            featuresEl.innerHTML = ['Everything in AI Provider', 'White-label integration', 'Your brand · unlimited scale', 'Dedicated support'].map(f => '<div class="order-feature">'+f+'</div>').join('');
        } else {
            planLabel = 'AI Provider — Annual';
            price = 250000;
            featuresEl.innerHTML = (planFeatures.enterprise||[]).map(f => '<div class="order-feature">'+f+'</div>').join('');
        }
    } else {
        planLabel = 'Standard Tier — ' + (cycleVal === 'annual' ? 'Annual' : 'Monthly');
        price = cycleVal === 'annual' ? PLANS.business.annual : PLANS.business.monthly;
        featuresEl.innerHTML = (planFeatures.business||[]).map(f => '<div class="order-feature">'+f+'</div>').join('');
    }
    
    document.getElementById('summary-plan').textContent = planLabel;
    document.getElementById('summary-price').textContent = '$' + price.toLocaleString();
    document.getElementById('summary-total').textContent = '$' + price.toLocaleString();
    
    const invoiceInput = document.querySelector('#payment-invoice input');
    const cardInput = document.querySelector('#payment-card input');
    if (selectedPlan === 'enterprise' || cycleVal === 'annual') {
        invoiceInput.disabled = false; cardInput.disabled = true; invoiceInput.checked = true;
    } else {
        invoiceInput.disabled = true; cardInput.disabled = false; cardInput.checked = true;
    }
}

async function processPayment() {
    closeModal('subscribe-modal');
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) { showToast('Please sign in first', 'error'); return; }
    
    // Map portal plan names to backend tier names
    const planToTier = { business: 'standard', enterprise: 'critical' };
    let tier = planToTier[selectedPlan];
    // White Label override
    if (selectedPlan === 'enterprise' && selectedCycle === 'white_label') {
        tier = 'white_label';
    }
    if (!tier) { showToast('Invalid plan', 'error'); return; }
    
    showToast('Redirecting to checkout...', 'success');
    
    try {
        const res = await fetch(`${API_BASE}/v1/billing/checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
            body: JSON.stringify({ layer: tier })
        });
        const data = await res.json();
        
        if (res.ok && data.checkout_url) {
            window.location.href = data.checkout_url;
        } else if (res.status === 503) {
            showToast('Billing is being configured. Contact sales@ontostandard.org', 'error');
        } else {
            showToast(data.detail || 'Checkout failed', 'error');
        }
    } catch(e) {
        showToast('Network error. Try again.', 'error');
    }
}

function contactSales() {
    document.getElementById('contact-modal').classList.add('active');
    // Pre-fill if user logged in
    if (currentUser) {
        document.getElementById('contact-name').value = currentUser.name || '';
        document.getElementById('contact-email').value = currentUser.email || '';
        if (currentUser.company) {
            document.getElementById('contact-org').value = currentUser.company.name || '';
        }
    }
}

function submitContactForm() {
    const name = document.getElementById('contact-name').value.trim();
    const org = document.getElementById('contact-org').value.trim();
    const email = document.getElementById('contact-email').value.trim();
    const message = document.getElementById('contact-message').value.trim();
    
    if (!name || !email) {
        showToast('Please fill in name and email', 'error');
        return;
    }
    
    // Send via mailto with pre-filled data
    const subject = encodeURIComponent(`ONTO Inquiry — ${org || name}`);
    const body = encodeURIComponent(
        `Name: ${name}\nOrganization: ${org || '—'}\nEmail: ${email}\n\n${message || 'Interested in ONTO Protocol.'}`
    );
    window.open(`mailto:sales@ontostandard.org?subject=${subject}&body=${body}`, '_blank');
    closeModal('contact-modal');
    showToast('Email client opened. Send to complete your inquiry.', 'success');
    document.getElementById('contact-message').value = '';
}


// === UTILS ===
function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function copyApiKey(btn) {
    if (btn.disabled) return;
    
    const input = document.getElementById('api-key-display');
    const originalType = input.type;
    input.type = 'text';
    navigator.clipboard.writeText(input.value);
    input.type = originalType;
    
    // Visual feedback
    btn.textContent = 'Copied!';
    btn.disabled = true;
    showToast('API key copied to clipboard', 'success');
    setTimeout(() => {
        btn.textContent = 'Copy';
        btn.disabled = false;
    }, 2000);
}

function toggleApiKeyVisibility() {
    const input = document.getElementById('api-key-display');
    const btn = document.getElementById('toggle-key-btn');
    if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'Hide';
    } else {
        input.type = 'password';
        btn.textContent = 'Show';
    }
}

function regenerateApiKey(btn) {
    if (!confirm('⚠️ Are you sure you want to regenerate your API key?\n\nThis will immediately invalidate your current key. Any applications using the old key will stop working.')) {
        return;
     }
    
    btn.disabled = true;
    btn.textContent = 'Regenerating...';
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) {
        showToast('No API key found. Please log in again.', 'error');
        btn.textContent = 'Regenerate Key';
        btn.disabled = false;
        return;
    }
    
    fetch(`${API_BASE}/v1/keys/regenerate-portal`, {
        method: 'POST',
        headers: { 'x-api-key': apiKey }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || `Server error ${response.status}`);
        return data;
    })
    .then(data => {
        localStorage.setItem('onto_first_api_key', data.api_key);
        authToken = localStorage.getItem('onto_token') || data.api_key;
        
        document.getElementById('api-key-display').value = data.api_key;
        document.getElementById('api-key-display').type = 'text';
        document.getElementById('toggle-key-btn').textContent = 'Hide';
        
        btn.textContent = 'Regenerate Key';
        btn.disabled = false;
        
        showToast('New API key generated! Copy it now.', 'success');
    })
    .catch(error => {
        btn.textContent = 'Regenerate Key';
        btn.disabled = false;
        showToast('Regen failed: ' + (error.message || 'Unknown error'), 'error');
        console.error('[ONTO] Regenerate failed');
    });
}

function editProfile() {
    const newName = prompt('Enter new name:', currentUser.name);
    if (newName && newName.trim()) {
        currentUser.name = newName.trim();
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
        document.getElementById('settings-name').textContent = currentUser.name;
    }
}

// === SIGNAL HASH ===
function updateSignalHash() {
    const container = document.getElementById('signal-bytes');
    if (!container) return;
    
    const bytes = Array(13).fill(0).map(() => 
        Math.floor(Math.random() * 256).toString(16).padStart(2, '0')
    );
    
    container.innerHTML = bytes.map((b, i) => 
        `<span class="byte" style="animation-delay: ${i * 0.1}s">${b}</span>`
    ).join('');
}

// === USER SIGNAL (dashboard) ===
let userSignalInterval = null;

async function loadUserSignal() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    
    try {
        // Try public status endpoint first (no auth needed)
        let stats = null;
        const pubRes = await fetch(`${API_BASE}/v1/signal/status`);
        if (pubRes.ok) {
            const pubData = await pubRes.json();
            if (pubData && !pubData.error) stats = pubData;
        }
        
        // If public doesn't have full stats, try admin endpoint
        if ((!stats || stats.uptime_seconds === undefined) && apiKey) {
            const res = await fetch(`${API_BASE}/v1/signal/status`, {
                headers: { 'x-api-key': apiKey }
            });
            if (res.ok) {
                const adminData = await res.json();
                if (adminData && !adminData.error) stats = adminData;
            }
        }
        
        if (stats && !stats.error && (stats.uptime_seconds !== undefined || stats.status === 'running')) {
            if (stats.current_signal) {
                const el = document.getElementById('user-signal-id');
                if (el) el.textContent = stats.current_signal.sigma_id || `σ_${stats.current_signal.timestamp}`;
                startUserHashAnimation(stats.current_signal.entropy_hex || '');
            } else if (stats.latest_signal) {
                const el = document.getElementById('user-signal-id');
                if (el) el.textContent = stats.latest_signal.sigma_id || `σ_${stats.latest_signal.timestamp || Date.now()}`;
                startUserHashAnimation(stats.latest_signal.entropy_hex || stats.latest_signal.hash || '');
            }
            updateUserMetric('user-signal-uptime', formatUptime(stats.uptime_seconds || 0));
            updateUserMetric('user-signal-generated', stats.signals_generated || stats.total_signals || 0);
            updateUserMetric('user-signal-requests', stats.total_requests || 0);
            const errorRate = stats.error_rate_percent || 0;
            updateUserMetric('user-signal-errors', errorRate < 5 ? 'OK' : errorRate.toFixed(1) + '%');
            const remaining = (stats.signal_interval || 300) - ((stats.uptime_seconds || 0) % (stats.signal_interval || 300));
            startUserCountdown(remaining);
            // Show LIVE
            const liveEl = document.getElementById('user-signal-live');
            if (liveEl) liveEl.innerHTML = '<span class="signal-dot"></span><span>LIVE</span>';
        } else {
            showSignalFallback();
        }
    } catch (e) {
        showSignalFallback();
    }
}

function showSignalFallback() {
    const el = document.getElementById('user-signal-id');
    if (el) el.textContent = `σ_${Math.floor(Date.now()/1000)}`;
    const hashEl = document.getElementById('user-signal-hash');
    if (hashEl) {
        const hex = Array.from({length: 64}, () => '0123456789abcdef'[Math.floor(Math.random()*16)]).join('');
        startUserHashAnimation(hex);
    }
    updateUserMetric('user-signal-uptime', '—');
    updateUserMetric('user-signal-generated', '—');
    updateUserMetric('user-signal-requests', '—');
    updateUserMetric('user-signal-errors', '—');
    const liveEl = document.getElementById('user-signal-live');
    if (liveEl) liveEl.innerHTML = '<span class="signal-dot" style="background:#eab308;box-shadow:0 0 6px #eab308"></span><span>SYNC</span>';
    startUserCountdown(30);
}

function updateUserMetric(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
}

let userHashAnimInterval = null;
function startUserHashAnimation(baseHash) {
    const hashEl = document.getElementById('user-signal-hash');
    if (!hashEl || !baseHash) return;
    if (userHashAnimInterval) clearInterval(userHashAnimInterval);
    const chars = '0123456789abcdef';
    const hashArray = baseHash.split('');
    let frame = 0;
    userHashAnimInterval = setInterval(() => {
        frame++;
        const display = hashArray.map((char) => {
            if (frame % 3 === 0 && Math.random() > 0.9) {
                return `<span style="color:#15803d;text-shadow:0 0 8px #15803d;">${chars[Math.floor(Math.random() * 16)]}</span>`;
            }
            return char;
        }).join('');
        hashEl.innerHTML = display;
        if (frame % 40 === 0) hashEl.textContent = baseHash;
    }, 80);
}

function startUserCountdown(seconds) {
    if (userSignalInterval) clearInterval(userSignalInterval);
    let remaining = seconds || 300;
    userSignalInterval = setInterval(() => {
        remaining--;
        const el = document.getElementById('user-signal-countdown');
        if (!el) return;
        if (remaining <= 0) { el.textContent = '0:00'; loadUserSignal(); remaining = 300; }
        else { el.textContent = `${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`; }
    }, 1000);
}

setTimeout(loadUserSignal, 500);
setTimeout(checkReferenceAccess, 1000);

// === CERTIFICATE VERIFICATION ===
// === CERTIFICATE VERIFICATION ===
let ermCertHash = window._realCertHash || '0'.repeat(64);
let ermProxyActive = true;

function ermVerifyHash(input) {
    const result = document.getElementById('erm-verify-result');
    const msg = document.getElementById('erm-verify-msg');
    if (!input || input.length < 4) {
        result.innerHTML = '';
        result.style.background = 'none';
        msg.innerHTML = '';
        return;
    }
    if (!ermProxyActive) {
        result.innerHTML = '✕';
        result.style.background = 'rgba(220,38,38,0.15)';
        result.style.color = '#ef4444';
        msg.innerHTML = '<span style="color:#ef4444">Certificate suspended — proxy disconnected</span>';
        return;
    }
    if (input.trim() === ermCertHash) {
        result.innerHTML = '✓';
        result.style.background = 'rgba(34,197,94,0.15)';
        result.style.color = '#22c55e';
        msg.innerHTML = '<span style="color:#22c55e">Valid — ONTO GOLD layer active since Feb 15, 2026</span>';
    } else {
        result.innerHTML = '✕';
        result.style.background = 'rgba(220,38,38,0.15)';
        result.style.color = '#ef4444';
        msg.innerHTML = '<span style="color:#ef4444">Invalid hash — certificate not found</span>';
    }
}

function ermCopyHash() {
    const hash = window._realCertHash || ermCertHash;
    navigator.clipboard.writeText(hash).then(() => {
        showToast('Hash copied to clipboard', 'success');
    }).catch(() => {
        const el = document.getElementById('erm-cert-hash');
        if (el) { const r = document.createRange(); r.selectNodeContents(el); const s = window.getSelection(); s.removeAllRanges(); s.addRange(r); document.execCommand('copy'); s.removeAllRanges(); }
        showToast('Hash copied', 'success');
    });
}

function ermDownloadCert() {
    const hash = window._realCertHash || ermCertHash;
    const orgName = currentUser?.organization_name || currentUser?.company?.name || 'Unknown';
    const cert = {
        type: 'ONTO_VERIFIED_CERTIFICATE',
        version: '1.0',
        organization: orgName,
        model: 'GOLD Stream',
        connected_since: new Date().toISOString(),
        proxy_status: ermProxyActive ? 'active' : 'suspended',
        gold_layer: 'injected',
        hash: hash,
        algorithm: 'Ed25519',
        packet_size: 104,
        chain: 'SHA-256',
        verify_url: `https://ontostandard.org/verify/?hash=${hash}`,
        disclaimer: 'Always verify certificate validity. ONTO does not guarantee accuracy. Not responsible for decisions made by AI systems or their operators.'
    };
    const blob = new Blob([JSON.stringify(cert, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `onto-certificate-${hash.substring(0,8)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('Certificate downloaded', 'success');
}

function ermSuspendCert() {
    ermProxyActive = false;
    const live = document.getElementById('user-signal-live');
    const hash = document.getElementById('erm-cert-hash');
    const statusText = document.getElementById('erm-sig-status-text');
    if (live) { live.querySelector('.signal-dot').style.background = '#ef4444'; live.querySelector('.signal-dot').style.boxShadow = '0 0 6px #ef4444'; }
    if (statusText) { statusText.textContent = 'SUSPENDED'; statusText.style.color = '#ef4444'; }
    if (hash) { hash.style.color = '#ef4444'; hash.style.textDecoration = 'line-through'; }
    ['proxy','gold','sig','chain'].forEach(k => {
        const el = document.getElementById('erm-check-' + k);
        if (el) { el.querySelector('span').innerHTML = '✕'; el.querySelector('span').style.color = '#ef4444'; }
    });
    const panel = document.getElementById('user-signal-panel');
    if (panel) { panel.style.borderColor = 'rgba(220,38,38,0.3)'; panel.style.background = 'linear-gradient(135deg, #1a0a0a 0%, #180d0d 50%, #1a0a0a 100%)'; }
    showToast('Certificate SUSPENDED — proxy disconnected', 'error');
}

function ermRestoreCert() {
    ermProxyActive = true;
    const live = document.getElementById('user-signal-live');
    const hash = document.getElementById('erm-cert-hash');
    const statusText = document.getElementById('erm-sig-status-text');
    if (live) { live.querySelector('.signal-dot').style.background = '#22c55e'; live.querySelector('.signal-dot').style.boxShadow = '0 0 6px #22c55e, 0 0 12px rgba(34, 197, 94, 0.5)'; }
    if (statusText) { statusText.textContent = 'ACTIVE'; statusText.style.color = ''; }
    if (hash) { hash.style.color = 'var(--accent)'; hash.style.textDecoration = 'none'; }
    ['proxy','gold','sig','chain'].forEach(k => {
        const el = document.getElementById('erm-check-' + k);
        if (el) { el.querySelector('span').innerHTML = '✓'; el.querySelector('span').style.color = 'var(--accent)'; }
    });
    const panel = document.getElementById('user-signal-panel');
    if (panel) { panel.style.borderColor = ''; panel.style.background = ''; }
    showToast('Certificate restored — proxy reconnected', 'success');
}

function ermDrawQR(canvas) {
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const s = canvas.width;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, s, s);
    ctx.fillStyle = '#000000';
    // Simplified QR pattern (visual placeholder — real QR from backend)
    const grid = 21;
    const cell = s / grid;
    // Finder patterns (3 corners)
    const drawFinder = (x, y) => {
        ctx.fillRect(x*cell, y*cell, 7*cell, 7*cell);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect((x+1)*cell, (y+1)*cell, 5*cell, 5*cell);
        ctx.fillStyle = '#000000';
        ctx.fillRect((x+2)*cell, (y+2)*cell, 3*cell, 3*cell);
    };
    drawFinder(0, 0);
    drawFinder(14, 0);
    drawFinder(0, 14);
    // Data modules (hash-derived pattern)
    for (let i = 0; i < ermCertHash.length && i < 40; i++) {
        const v = parseInt(ermCertHash[i], 16);
        if (v > 7) {
            const row = 8 + Math.floor(i / 8);
            const col = 8 + (i % 8);
            if (row < grid && col < grid) ctx.fillRect(col*cell, row*cell, cell, cell);
        }
    }
    // Timing
    for (let i = 8; i < 13; i += 2) {
        ctx.fillRect(i*cell, 6*cell, cell, cell);
        ctx.fillRect(6*cell, i*cell, cell, cell);
    }
}

function initErmCert() {
    const hash = document.getElementById('erm-cert-hash');
    if (hash) hash.textContent = ermCertHash;
    ermDrawQR(document.getElementById('erm-qr-canvas'));
}

function initERM() {
    // Demo removed — dashboard only
    initDashboard();
}

// === DASHBOARD KEY/CERT ===
function initDashboard() {
    // Mirror API key to dashboard
    const sdkKey = document.getElementById('api-key-display');
    const dashKey = document.getElementById('dash-api-key');
    if (sdkKey && dashKey && sdkKey.value) {
        dashKey.value = sdkKey.value;
    } else {
        const stored = localStorage.getItem('onto_first_api_key');
        if (stored && dashKey) dashKey.value = stored;
    }
    // Cert hash
    if (window._realCertHash) {
        const el = document.getElementById('erm-cert-hash');
        if (el) el.textContent = window._realCertHash;
        const link = document.getElementById('dash-verify-link');
        if (link) link.href = '/verify/?hash=' + window._realCertHash;
    }
}
function toggleDashKeyVis() {
    const inp = document.getElementById('dash-api-key');
    const btn = document.getElementById('dash-toggle-key');
    if (!inp) return;
    if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'Hide'; }
    else { inp.type = 'password'; btn.textContent = 'Show'; }
}
function copyDashKey(btn) {
    const key = document.getElementById('dash-api-key')?.value;
    if (!key) return;
    navigator.clipboard.writeText(key).then(() => {
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = orig, 1500);
    });
}

// === INIT ===
async function loadOrgFromAPI() {
    try {
        const apiKey = localStorage.getItem('onto_first_api_key');
        if (!apiKey) return;
        const resp = await fetch(`${API_BASE}/v1/organization`, {
            headers: { 'x-api-key': apiKey }
        });
        if (!resp.ok) return;
        const data = await resp.json();
        
        // Sync tier/plan from server (admin may have changed it)
        if (data.layer) {
            const serverPlan = layerToPlan(data.layer);
            if (currentUser.plan !== serverPlan || currentUser.layer !== data.layer) {
                currentUser.layer = data.layer;
                currentUser.plan = serverPlan;
                localStorage.setItem('onto_layer', data.layer);
                localStorage.setItem('onto_user', JSON.stringify(currentUser));
                // Re-render plan UI
                document.getElementById('user-plan').textContent = serverPlan === 'enterprise' ? 'PROVIDER' : serverPlan === 'business' ? 'STANDARD' : 'OPEN';
            }
        }
        
        // Sync subscription expiry
        if (data.tier_expires) {
            currentUser.subscription = currentUser.subscription || {};
            currentUser.subscription.expires_at = data.tier_expires;
        }
        
        // Restore company from profile_data (merge with existing, don't overwrite)
        if (data.profile) {
            const p = data.profile;
            const existing = currentUser.company || {};
            if (p.company || p.company_name || data.name || existing.name) {
                currentUser.company = {
                    name: p.company || p.company_name || data.name || existing.name || '',
                    type: p.company_type || existing.type || '',
                    industry: p.industry || existing.industry || '',
                    reg: p.company_reg || p.registration_number || existing.reg || '',
                    vat: p.company_vat || existing.vat || '',
                    address: p.address || existing.address || '',
                    city: p.city || existing.city || '',
                    state: p.state || existing.state || '',
                    postal: p.postal || p.zip_code || existing.postal || '',
                    country: p.country || existing.country || '',
                    email: p.billing_email || p.email || existing.email || '',
                    phone: p.phone || existing.phone || '',
                    signatory: p.signatory_name || p.contact_name || existing.signatory || '',
                    signatoryTitle: p.signatory_title || existing.signatoryTitle || ''
                };
                currentUser.can_invoice = true;
                localStorage.setItem('onto_user', JSON.stringify(currentUser));
                updateCompanyUI();
            }
        }
        
        // Update org name if changed on server
        if (data.name && data.name !== currentUser.organization_name) {
            currentUser.organization_name = data.name;
            currentUser.name = data.name;
            localStorage.setItem('onto_org_name', data.name);
            localStorage.setItem('onto_user_name', data.name);
            localStorage.setItem('onto_user', JSON.stringify(currentUser));
            document.getElementById('user-avatar').textContent = data.name.charAt(0).toUpperCase();
            document.getElementById('user-name').textContent = data.name;
            document.getElementById('settings-name').textContent = data.name;
        }
        
        // Re-render dashboard metrics with fresh data
        updateDashboardMetrics();
        updateBillingUI();
    } catch(e) { console.warn('loadOrgFromAPI:', e); }
}

async function loadRealCertHash() {
    try {
        const apiKey = localStorage.getItem('onto_first_api_key');
        if (!apiKey) return;
        const resp = await fetch(`${API_BASE}/v1/certificates`, {
            headers: { 'x-api-key': apiKey }
        });
        if (!resp.ok) return;
        const data = await resp.json();
        
        if (data.certificates && data.certificates.length > 0) {
            const cert = data.certificates[0];
            const realHash = cert.verification_hash;
            const isActive = !cert.revoked_at && new Date(cert.expires_at) > new Date();
            
            if (realHash) {
                // Update global hash variables
                window._realCertHash = realHash;
                ermCertHash = realHash;
                
                // Update ERM cert display
                const hashEl = document.getElementById('erm-cert-hash');
                if (hashEl) hashEl.textContent = realHash;
                
                // Update cert number
                const certNumEl = document.getElementById('erm-cert-number');
                if (certNumEl) certNumEl.textContent = cert.certificate_number || '';
                
                // Update verify link
                const verifyLink = document.getElementById('erm-verify-link');
                if (verifyLink) verifyLink.href = `https://ontostandard.org/verify/?hash=${realHash}`;
                
                // Update status
                if (!isActive) {
                    ermSuspendCert();
                }
            }
        }
    } catch(e) { console.warn('loadRealCertHash:', e); }
}

document.addEventListener('DOMContentLoaded', () => {
    const savedUser = localStorage.getItem('onto_user');
    const savedToken = localStorage.getItem('onto_token');
    const savedApiKey = localStorage.getItem('onto_first_api_key');
    const savedLoggedIn = localStorage.getItem('onto_logged_in');
    
    if (savedLoggedIn === 'true' && savedApiKey) {
        // Restore subscription and company from onto_user JSON if available
        let savedSub = null;
        let savedCompany = null;
        let savedCanInvoice = false;
        if (savedUser) {
            try {
                const parsed = JSON.parse(savedUser);
                savedSub = parsed.subscription || null;
                savedCompany = parsed.company || null;
                savedCanInvoice = parsed.can_invoice || false;
            } catch(e) {}
        }
        currentUser = {
            id: localStorage.getItem('onto_user_id'),
            name: localStorage.getItem('onto_user_name'),
            email: localStorage.getItem('onto_user_email'),
            organization_id: localStorage.getItem('onto_org_id'),
            organization_name: localStorage.getItem('onto_org_name'),
            layer: localStorage.getItem('onto_layer'),
            plan: layerToPlan(localStorage.getItem('onto_layer')),
            role: localStorage.getItem('onto_role'),
            subscription: savedSub,
            company: savedCompany,
            can_invoice: savedCanInvoice
        };
        authToken = savedToken || savedApiKey;
        showDashboard();
    }
    else if (savedUser && savedToken) {
        try {
            currentUser = JSON.parse(savedUser);
            authToken = savedToken;
            showDashboard();
        } catch (e) {
            localStorage.removeItem('onto_user');
            localStorage.removeItem('onto_token');
            showAuthScreen();
        }
    }
    else {
        showAuthScreen();
    }
    
    // Handle reset_token URL param
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('reset_token')) {
        showAuthScreen();
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('reset-form').classList.remove('hidden');
    }
    
    // Handle Stripe billing callback
    if (urlParams.get('billing') === 'success') {
        window.history.replaceState({}, '', window.location.pathname);
        setTimeout(() => {
            showToast('Subscription activated! Refreshing...', 'success');
            refreshBillingFromBackend();
        }, 500);
    }
    
    initERM();
    initErmCert();
    updateSignalHash();
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.remove('open');
        }
    });
});

// === REFERENCE (STEALTH ADMIN) ===
let refAccessGranted = false;

async function checkReferenceAccess() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return false;
    try {
        const res = await fetch(`${API_BASE}/v1/docs/reference-check`, {
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            const data = await res.json();
            if (data.status === 'ok') {
                refAccessGranted = true;
                document.getElementById('nav-reference').style.display = 'flex';
                return true;
            }
        }
    } catch (e) {}
    return false;
}

async function showReferencePage(el) {
    if (!refAccessGranted) {
        const hasAccess = await checkReferenceAccess();
        if (!hasAccess) { showToast('Access denied', 'error'); return; }
    }
    showPage('reference', el);
    initAdminPanel();
}

// === SIGNAL & ACCOUNTS PANEL ===
let accountsData = [];
let currentUserId = null; // For self-protection
let signalData = null;
let signalInterval = null;

// Get current user ID on load
function initAdminPanel() {
    currentUserId = currentUser?.id || null;
    loadSignalData();
    loadAccountsData();
    startSignalCountdown();
}

// === SIGNAL FUNCTIONS ===
async function loadSignalData() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return;
    
    try {
        // Get admin status with full stats
        const statusRes = await fetch(`${API_BASE}/v1/signal/status`, {
            headers: { 'x-api-key': apiKey }
        });
        
        if (statusRes.ok) {
            const stats = await statusRes.json();
            
            // Update signal ID and hash from current_signal
            if (stats.current_signal) {
                document.getElementById('signal-id').textContent = stats.current_signal.sigma_id || `σ_${stats.current_signal.timestamp}`;
                startHashAnimation(stats.current_signal.entropy_hex || '');
                
                // Pulse effect on hash
                const hashEl = document.getElementById('signal-hash');
                if (hashEl) {
                    hashEl.classList.add('pulse');
                    setTimeout(() => hashEl.classList.remove('pulse'), 1000);
                }
            }
            
            // Update metrics with pulse effect
            updateMetric('signal-uptime', formatUptime(stats.uptime_seconds));
            updateMetric('signal-generated', stats.signals_generated || 0);
            updateMetric('signal-requests', stats.total_requests || 0);
            // Error rate: show only if > 5%, otherwise "OK"
            const errorRate = stats.error_rate_percent || 0;
            if (errorRate < 5) {
                updateMetric('signal-errors', 'OK', 'good');
            } else {
                updateMetric('signal-errors', errorRate.toFixed(1) + '%', 'warn');
            }
            
            // Update pause state
            signalPaused = stats.paused || false;
            const indicator = document.getElementById('signal-live-indicator');
            if (indicator) {
                if (signalPaused) {
                    indicator.innerHTML = '<span class="signal-dot" style="background:#d97706;animation:none;"></span><span>PAUSED</span>';
                    indicator.style.background = 'rgba(245, 158, 11, 0.15)';
                    indicator.style.color = '#d97706';
                } else {
                    indicator.innerHTML = '<span class="signal-dot"></span><span>LIVE</span>';
                    indicator.style.background = 'rgba(34, 197, 94, 0.15)';
                    indicator.style.color = '#15803d';
                }
            }
            
            // Start countdown
            signalData = { next_update_in: stats.signal_interval - (stats.uptime_seconds % stats.signal_interval) };
            startSignalCountdown();
        }
    } catch (e) {
        console.error('Signal load error');
        document.getElementById('signal-hash').textContent = 'Connection error';
    }
}

function updateMetric(id, value, style) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = value;
        
        // Apply style class (good/warn)
        el.classList.remove('metric-good', 'metric-warn');
        if (style === 'good') el.classList.add('metric-good');
        if (style === 'warn') el.classList.add('metric-warn');
        
        const metric = el.closest('.signal-metric');
        if (metric) {
            metric.classList.add('updated');
            setTimeout(() => metric.classList.remove('updated'), 800);
        }
    }
}

function formatUptime(seconds) {
    if (!seconds) return '—';
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    if (hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
}

let hashAnimationInterval = null;

function startHashAnimation(baseHash) {
    const hashEl = document.getElementById('signal-hash');
    if (!hashEl) return;
    
    if (!baseHash) {
        hashEl.textContent = 'Waiting for signal...';
        return;
    }
    
    // Stop previous animation
    if (hashAnimationInterval) clearInterval(hashAnimationInterval);
    
    const chars = '0123456789abcdef';
    const hashArray = baseHash.split('');
    let frame = 0;
    
    hashAnimationInterval = setInterval(() => {
        frame++;
        
        // Animate random positions with green glow
        const display = hashArray.map((char, i) => {
            if (frame % 3 === 0 && Math.random() > 0.9) {
                return `<span style="color:#15803d;text-shadow:0 0 8px #15803d;">${chars[Math.floor(Math.random() * 16)]}</span>`;
            }
            return char;
        }).join('');
        
        hashEl.innerHTML = display;
        
        // Reset to real hash periodically
        if (frame % 40 === 0) {
            hashEl.textContent = baseHash;
        }
    }, 80);
}

function startSignalCountdown() {
    if (signalInterval) clearInterval(signalInterval);
    
    let remaining = signalData?.next_update_in || 300;
    
    signalInterval = setInterval(() => {
        remaining--;
        
        if (remaining <= 0) {
            document.getElementById('signal-countdown').textContent = '0:00';
            loadSignalData();
            remaining = 300;
        } else {
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            document.getElementById('signal-countdown').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

let signalPaused = false;

async function refreshProofStats() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return;
    try {
        const pkRes = await fetch(`${API_BASE}/v1/signal/public-key`);
        if (pkRes.ok) {
            const pk = await pkRes.json();
            const el = document.getElementById('proof-pubkey');
            if (el) el.textContent = (pk.public_key_hex || '').substring(0, 8) + '...';
        }
        const statsRes = await fetch(`${API_BASE}/v1/docs/admin/stats`, { headers: { 'x-api-key': apiKey } });
        if (statsRes.ok) {
            const stats = await statsRes.json();
            const totalEl = document.getElementById('proof-total');
            const h24El = document.getElementById('proof-24h');
            if (totalEl) totalEl.textContent = stats.total_evaluations || '—';
            if (h24El) h24El.textContent = stats.evaluations_24h || '—';
            if (stats.last_proof_hash) {
                const hashEl = document.getElementById('proof-last-hash');
                if (hashEl) hashEl.textContent = stats.last_proof_hash;
                const timeEl = document.getElementById('proof-last-time');
                if (timeEl && stats.last_proof_time) timeEl.textContent = new Date(stats.last_proof_time).toLocaleString();
            }
        }
    } catch(e) { /* proof stats load error */ }
}

// === ACCOUNTS FUNCTIONS ===
function filterAccounts() {
    loadAccountsData();
}

async function loadAccountsData() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return;
    
    const search = document.getElementById('accounts-search')?.value || '';
    const typeFilter = document.getElementById('filter-type')?.value || '';
    const statusFilter = document.getElementById('filter-status')?.value || '';
    const planFilter = document.getElementById('filter-plan')?.value || '';
    
    const container = document.getElementById('accounts-list');
    if (container) container.innerHTML = `
        <div class="account-row" style="padding: 16px;">
            <div class="skeleton skeleton-text" style="width: 200px; margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text-sm" style="width: 120px;"></div>
        </div>
        <div class="account-row" style="padding: 16px;">
            <div class="skeleton skeleton-text" style="width: 180px; margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text-sm" style="width: 100px;"></div>
        </div>
    `;
    
    try {
        let url = `${API_BASE}/v1/docs/admin/users?limit=50`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        
        const res = await fetch(url, { headers: { 'x-api-key': apiKey } });
        
        if (res.ok) {
            const data = await res.json();
            accountsData = data.users || [];
            
            // Client-side filtering
            let filtered = accountsData;
            if (typeFilter) {
                filtered = filtered.filter(u => {
                    const hasCompany = u.profile?.company_name;
                    return typeFilter === 'company' ? hasCompany : !hasCompany;
                });
            }
            if (statusFilter) {
                filtered = filtered.filter(u => {
                    const isActive = !u.suspended && u.is_active;
                    return statusFilter === 'active' ? isActive : !isActive;
                });
            }
            if (planFilter) {
                filtered = filtered.filter(u => u.tier === planFilter);
            }
            
            renderAccounts(filtered);
        }
    } catch (e) {
        console.error('Accounts load error');
        if (container) container.innerHTML = '<div class="accounts-loading">Failed to load</div>';
    }
}

function renderAccounts(accounts) {
    const container = document.getElementById('accounts-list');
    if (!container) return;
    
    if (!accounts.length) {
        container.innerHTML = '<div class="accounts-loading">No accounts found</div>';
        return;
    }
    
    container.innerHTML = accounts.map(u => {
        const isSelf = u.id === currentUserId;
        const hasCompany = u.profile?.company_name;
        const isActive = !u.suspended && u.is_active !== false;
        const date = u.created_at ? new Date(u.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '—';
        const safeEmail = escapeHtml(u.email || '');
        const safeName = escapeHtml(u.name || '—');
        const safeOrgName = escapeHtml(u.org_name || '—');
        const safeTier = escapeHtml(u.tier || '');
        const safeCompany = hasCompany ? escapeHtml(u.profile.company_name) : '';
        const safeIndustry = hasCompany ? escapeHtml(u.profile.industry || '—') : '';
        const safeId = escapeHtml(u.id || '');
        
        return `
            <div class="account-row" onclick="toggleAccountDetails('${safeId}')">
                <div class="account-email">${safeEmail}${isSelf ? ' <span style="color: var(--accent); font-size: 9px;">(you)</span>' : ''}</div>
                <div class="account-type">${hasCompany ? 'Company' : 'Individual'}</div>
                <div class="account-plan"><span class="tier-badge tier-${safeTier}">${safeTier}</span>${u.tier_expires ? '<span style="font-size:10px;color:var(--text-muted);margin-left:6px;">→ ' + new Date(u.tier_expires).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'2-digit'}) + '</span>' : ''}</div>
                <div class="account-status ${isActive ? 'active' : 'paused'}">${isActive ? 'Active' : 'Paused'}</div>
                <div class="account-date">${date}</div>
            </div>
            <div class="account-details" id="details-${safeId}">
                <div class="account-details-grid">
                    <div class="account-detail-item">
                        <div class="account-detail-label">Name</div>
                        <div class="account-detail-value">${safeName}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Email Verified</div>
                        <div class="account-detail-value">${u.email_verified ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Last Login</div>
                        <div class="account-detail-value">${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Organization</div>
                        <div class="account-detail-value">${safeOrgName}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Tier Expires</div>
                        <div class="account-detail-value">${u.tier_expires ? new Date(u.tier_expires).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) + (new Date(u.tier_expires) < new Date() ? ' <span style="color:var(--danger)">EXPIRED</span>' : '') : 'No expiry'}</div>
                    </div>
                    ${hasCompany ? `
                    <div class="account-detail-item">
                        <div class="account-detail-label">Company</div>
                        <div class="account-detail-value">${safeCompany}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Industry</div>
                        <div class="account-detail-value">${safeIndustry}</div>
                    </div>
                    ` : ''}
                </div>
                <div class="account-actions">
                    <button class="account-action-btn" onclick="event.stopPropagation(); editPlan('${safeId}', '${safeTier}', '${safeEmail}')">Edit Plan</button>
                    <button class="account-action-btn" onclick="event.stopPropagation(); toggleAccountStatus('${safeId}', ${isActive})" ${isSelf ? 'disabled title="Cannot pause own account"' : ''}>${isActive ? 'Pause' : 'Activate'}</button>
                    <button class="account-action-btn danger" onclick="event.stopPropagation(); deleteAccount('${safeId}', '${safeEmail}')" ${isSelf ? 'disabled title="Cannot delete own account"' : ''}>Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

function toggleAccountDetails(id) {
    const details = document.getElementById(`details-${id}`);
    if (details) {
        const isOpen = details.classList.contains('open');
        // Close all others
        document.querySelectorAll('.account-details').forEach(d => d.classList.remove('open'));
        if (!isOpen) details.classList.add('open');
    }
}

let editingUserId = null;
let editingUserEmail = null;

function editPlan(userId, currentTier, userEmail) {
    editingUserId = userId;
    editingUserEmail = userEmail || 'User';
    
    // Set user info
    document.getElementById('tier-user-info').innerHTML = `<div class="tier-user-email">${escapeHtml(editingUserEmail)}</div>`;
    
    // Reset selection
    document.querySelectorAll('input[name="tier-select"]').forEach(r => r.checked = false);
    
    // Select current tier
    const currentRadio = document.querySelector(`input[name="tier-select"][value="${currentTier}"]`);
    if (currentRadio) currentRadio.checked = true;
    
    // Reset days
    document.getElementById('tier-days').value = 30;
    
    // Show modal
    document.getElementById('tier-modal').classList.add('active');
}

async function saveTierChange() {
    if (!editingUserId) return;
    
    const selectedTier = document.querySelector('input[name="tier-select"]:checked');
    if (!selectedTier) {
        showToast('Select a tier', 'error');
        return;
    }
    
    const tier = selectedTier.value;
    const days = document.getElementById('tier-days').value || 30;
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/admin/users/${editingUserId}/tier?tier=${tier}&days=${days}`, {
            method: 'PUT',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast(`Plan updated to ${tier.toUpperCase()}`, 'success');
            closeModal('tier-modal');
            // Update localStorage if changing own tier
            if (editingUserId === currentUserId) {
                localStorage.setItem('onto_layer', tier);
                if (currentUser) currentUser.plan = layerToPlan(tier);
            }
            loadAccountsData();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Update failed', 'error');
        }
    } catch (e) {
        showToast('Update failed', 'error');
    }
}

async function toggleAccountStatus(userId, isCurrentlyActive) {
    if (userId === currentUserId) {
        showSignal104b('self_action_attempt', '/admin/users/suspend');
        return;
    }
    
    const action = isCurrentlyActive ? 'pause' : 'activate';
    if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} this account?`)) return;
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/admin/users/${userId}/suspend?suspend=${isCurrentlyActive}`, {
            method: 'PUT',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast(`Account ${action}d`, 'success');
            loadAccountsData();
        } else {
            showToast('Action failed', 'error');
        }
    } catch (e) {
        showToast('Action failed', 'error');
    }
}

async function deleteAccount(userId, email) {
    if (userId === currentUserId) {
        showSignal104b('self_action_attempt', '/admin/users/delete');
        return;
    }
    
    if (prompt(`Type the email to confirm deletion:\n${email}`) !== email) {
        showToast('Deletion cancelled', 'info');
        return;
    }
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const headers = { 'x-api-key': apiKey };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const res = await fetch(`${API_BASE}/v1/docs/admin/users/${userId}`, {
            method: 'DELETE',
            headers
        });
        if (res.ok) {
            showToast('Account deleted', 'success');
            loadAccountsData();
        } else {
            const data = await res.json();
            showToast(data.detail || 'Delete failed', 'error');
        }
    } catch (e) {
        showToast('Delete failed', 'error');
    }
}

// === SIGNAL 104b ===
function showSignal104b(action, endpoint) {
    showToast('Action rejected. Signal: 104b', 'error');
    
    // Show log panel
    const panel = document.getElementById('signal-log-panel');
    if (panel) panel.style.display = 'block';
    
    const list = document.getElementById('signal-log-list');
    if (list) {
        const item = document.createElement('div');
        item.className = 'signal-log-item';
        item.innerHTML = `
            <span class="signal-log-code">104b</span>
            <span class="signal-log-endpoint">${endpoint}</span>
            <span class="signal-log-time">${new Date().toLocaleTimeString()}</span>
            <div style="margin-top: 4px; color: var(--text-muted);">${action.replace(/_/g, ' ')}</div>
        `;
        list.insertBefore(item, list.firstChild);
    }
}
</script>
</body>
</html>
