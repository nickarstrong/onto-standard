<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ONTO — Client Portal</title>
<meta name="description" content="ONTO Client Portal — Connect your AI model, measure improvement with GOLD, get ONTO VERIFIED certification.">
<meta name="robots" content="noindex, nofollow">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Ccircle cx='18' cy='18' r='17' fill='white'/%3E%3Cpath d='M16 10L20 10L20 26L16 26L16 14L13 14L13 10L16 10Z' fill='%230a0a0a'/%3E%3C/svg%3E">
<style>
:root {
    color-scheme: dark;
    --bg: #0a0a0a;
    --bg-secondary: #121212;
    --bg-card: #1a1a1a;
    --bg-elevated: #242424;
    --border: #333333;
    --border-hover: #444444;
    --text: #fafafa;
    --text-secondary: #a0a0a0;
    --text-muted: #606060;
    --accent: #15803d;
    --accent-hover: #166534;
    --accent-subtle: rgba(21, 128, 61, 0.1);
    --danger: #dc2626;
    --danger-subtle: rgba(220, 38, 38, 0.1);
    --blue: #64748b;
    --blue-subtle: rgba(59, 130, 246, 0.1);
}

/* === LIGHT THEME === */
[data-theme="light"] {
    color-scheme: light;
    --bg: #ffffff;
    --bg-secondary: #fafafa;
    --bg-card: #ffffff;
    --bg-elevated: #f5f5f5;
    --border: #e5e7eb;
    --border-hover: #d1d5db;
    --text: #111827;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
}
[data-theme="light"] select,
[data-theme="light"] select option,
[data-theme="light"] select optgroup {
    background-color: #ffffff;
    color: #111827;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.6; color: var(--text); background: var(--bg-secondary); }

/* === AUTH === */
.auth-container { min-height: 100vh; display: flex; align-items: stretch; }
.auth-hero { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 48px 56px; background: var(--bg); border-right: 1px solid var(--border); }
.auth-hero-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
.auth-hero-logo svg { width: 28px; height: 28px; }
.auth-hero-logo span { font-size: 18px; font-weight: 700; letter-spacing: 1px; }
.auth-hero h1 { font-size: 28px; font-weight: 700; line-height: 1.25; margin-bottom: 16px; letter-spacing: -0.5px; }
.auth-hero p { font-size: 14px; color: var(--text-secondary); line-height: 1.6; max-width: 400px; }
.auth-hero-stats { display: flex; gap: 32px; margin-top: 40px; padding-top: 32px; border-top: 1px solid var(--border); }
.auth-hero-stat { display: flex; flex-direction: column; }
.auth-hero-stat strong { font-size: 22px; font-weight: 700; font-variant-numeric: tabular-nums; }
.auth-hero-stat span { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
.auth-form-side { width: 480px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; padding: 24px 40px; background: var(--bg-card); }
.auth-card { background: none; border: none; border-radius: 0; padding: 0; width: 100%; max-width: 380px; }
.auth-logo { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; justify-content: center; }
.auth-logo svg { width: 24px; height: 24px; }
.auth-logo span { font-size: 18px; font-weight: 700; }
.auth-title { font-size: 15px; font-weight: 600; text-align: center; margin-bottom: 4px; }
.auth-subtitle { color: var(--text-secondary); text-align: center; margin-bottom: 24px; font-size: 12px; }

/* === FORMS === */
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 11px; font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: .3px; color: var(--text-muted); }
.form-input { width: 100%; padding: 8px 10px; font-size: 13px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-elevated); color: var(--text); transition: all 0.15s; }
.form-input::placeholder { color: var(--text-muted); opacity: 0.7; }
.form-input:focus { outline: none; border-color: var(--accent); }
.form-input.error { border-color: var(--danger); }
.form-input.error:focus { box-shadow: none; }

/* Institutional Form */
.form-inst .form-group { margin-bottom: 14px; }
.form-inst .form-label { font-size: 12px; font-weight: 400; color: var(--text-muted); margin-bottom: 4px; }
.form-inst .form-label.required::after { content: ' *'; color: var(--text-muted); }
.form-inst .form-input { padding: 8px 10px; font-size: 13px; border-radius: 4px; background: var(--bg-elevated); transition: border-color 0.2s, background-color 0.2s; }
.form-inst .form-input::placeholder { color: var(--text-muted); opacity: 0.6; }
.form-inst textarea.form-input { resize: vertical; min-height: 60px; font-family: inherit; }
.form-inst .form-input:focus { box-shadow: none; border-color: var(--text-muted); }
.form-inst .form-input.valid { border-color: var(--border); }
.form-inst .form-input.empty-required { border-color: rgba(156, 163, 175, 0.5); background: rgba(156, 163, 175, 0.03); }
.form-inst .form-input.error { border-color: rgba(239, 68, 68, 0.5); background: rgba(239, 68, 68, 0.03); }
.form-inst select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 32px; cursor: pointer; }
.form-inst select.form-input option { background: var(--bg-card); color: var(--text); padding: 8px; }
.form-inst select.form-input optgroup { background: var(--bg-elevated); color: var(--text-secondary); font-weight: 600; }
.form-inst select.form-input.valid { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); }
.password-wrapper { position: relative; }
.password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); }

/* === TERMS SCROLL === */
.terms-container { border: 1px solid var(--border); border-radius: 4px; height: 160px; overflow-y: auto; padding: 12px; margin-bottom: 12px; background: var(--bg); font-size: 12px; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.terms-container h3 { font-size: 12px; margin: 12px 0 4px; color: var(--text); }
.terms-container h3:first-child { margin-top: 0; }
.terms-container p { margin-bottom: 4px; color: var(--text-secondary); }
.terms-container ul { margin: 4px 0 4px 16px; }
.terms-container li { margin-bottom: 2px; color: var(--text-secondary); }
.terms-container table { width: 100%; margin: 4px 0; font-size: 11px; border-collapse: collapse; }
.terms-container th, .terms-container td { padding: 4px 6px; border: 1px solid var(--border); text-align: left; }
.terms-container th { background: var(--bg-elevated); font-weight: 500; }

.checkbox-group { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 16px; }
.agreement-notice { font-size: 11px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5; }
.agreement-notice a { color: var(--text-muted); text-decoration: underline; }
.form-inst .checkbox-group { margin-bottom: 8px; }
.form-inst .checkbox-group label { font-size: 11px; color: var(--text-secondary); transition: color 0.2s; }
.form-inst .checkbox-group.checked label { color: var(--text); }
.form-inst .checkbox-group input[type="checkbox"] { accent-color: var(--accent); }
.checkbox-group input[type="checkbox"] { width: 16px; height: 16px; margin-top: 1px; accent-color: var(--accent); }
.checkbox-group label { font-size: 12px; color: var(--text-secondary); cursor: pointer; }
.checkbox-group a { color: var(--accent); text-decoration: none; }

/* === BUTTONS === */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; width: 100%; }
.btn-primary { background: var(--accent-subtle); color: var(--accent); border: 1px solid var(--accent); }
.btn-primary:hover { background: var(--accent); color: white; }
.btn-primary:disabled { background: var(--bg-elevated); color: var(--text-muted); cursor: not-allowed; transform: none; pointer-events: none; border-color: var(--border); }
.btn-wrapper { display: inline-block; width: 100%; }
.btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--bg-elevated); color: var(--text); }
.btn-outline { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
.btn-outline:hover { background: var(--accent-subtle); }
.btn-sm { padding: 6px 12px; font-size: 12px; width: auto; }

.auth-switch { text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-secondary); }
.auth-switch a { color: var(--accent); text-decoration: none; font-weight: 500; cursor: pointer; }

/* === AUTH MENU (mobile burger) === */
.auth-menu { display: none; position: fixed; top: 0; left: 0; width: 280px; height: 100vh; background: var(--bg-card); border-right: 1px solid var(--border); z-index: 102; flex-direction: column; transform: translateX(-100%); transition: transform 0.2s ease; }
.auth-menu.open { display: flex; transform: translateX(0); }
.auth-menu-header { display: flex; align-items: center; gap: 8px; padding: 14px 16px; border-bottom: 1px solid var(--border); }
.auth-menu-header svg { width: 24px; height: 24px; flex-shrink: 0; }
.auth-menu-close { margin-left: auto; background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; }
.auth-menu-close:hover { color: var(--text); }
.auth-menu-nav { padding: 12px 8px; flex: 1; overflow-y: auto; }
.auth-menu-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 4px; color: var(--text-secondary); text-decoration: none; font-size: 12px; font-weight: 500; transition: all 0.15s; }
.auth-menu-item:hover { background: var(--bg-elevated); color: var(--text); }
.auth-menu-item svg { width: 16px; height: 16px; flex-shrink: 0; }
.auth-menu-sub { display: block; padding: 4px 12px 4px 38px; font-size: 11px; color: var(--text-muted); text-decoration: none; }
.auth-menu-sub:hover { color: var(--text); }
.auth-menu-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 101; }
.auth-menu-overlay.visible { display: block; }
.otp-input { width: 40px; height: 46px; text-align: center; font-size: 18px; font-weight: 600; font-family: 'JetBrains Mono', monospace; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text); outline: none; transition: border-color 0.2s; }
.otp-input:focus { border-color: var(--accent); }
.otp-input.error { border-color: #ef4444; }

/* === DASHBOARD === */
.dashboard { display: none; min-height: 100vh; }
.dashboard.active { display: flex; }
.sidebar { display: none; width: 240px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 0; position: fixed; height: 100vh; flex-direction: column; }
.sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.sidebar-header-actions { display: flex; align-items: center; gap: 6px; }
.desktop-only { display: none; }
.sidebar-logo { display: flex; align-items: center; gap: 8px; }
.sidebar-logo svg { width: 24px; height: 24px; }
.sidebar-logo span { font-size: 18px; font-weight: 700; }
.sidebar-close { display: none; background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; }
.sidebar-close:hover { color: var(--text); }
.sidebar.mobile-open .sidebar-close { display: block; }
.sidebar-nav { padding: 12px 8px; flex: 1; overflow-y: auto; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 4px; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; font-size: 12px; font-weight: 500; }
.nav-item:hover { background: var(--bg-elevated); color: var(--text); }
.nav-item.active { background: var(--accent-subtle); color: var(--accent); }
.nav-item svg { width: 16px; height: 16px; }
.nav-divider { height: 1px; background: var(--border); margin: 8px 12px; }
.sidebar-footer { border-top: 1px solid var(--border); padding: 8px 12px; margin-top: auto; flex-shrink: 0; }
.sidebar-footer-actions { display: flex; gap: 4px; margin-bottom: 8px; }
.sf-btn { display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 4px; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-muted); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; flex: 1; justify-content: center; }
.sf-btn:hover { background: var(--bg-card); color: var(--text); }
.sf-btn svg { width: 14px; height: 14px; flex-shrink: 0; }
.sidebar-user { display: flex; align-items: center; gap: 8px; }
.sidebar-actions { display: flex; gap: 4px; }
.sidebar-action-btn { background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 6px; border-radius: 4px; transition: all 0.15s; }
.sidebar-action-btn:hover { background: var(--bg-elevated); color: var(--text); }
.sidebar-version { font-size: 10px; color: var(--text-muted); margin-top: 8px; }
.theme-toggle-btn { background: none; border: 1px solid var(--border); border-radius: 4px; padding: 4px 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
.theme-toggle-btn:hover { background: var(--bg-elevated); }
.user-avatar { width: 28px; height: 28px; border-radius: 4px; background: var(--bg-elevated); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 11px; border: 1px solid var(--border); }
.user-info { flex: 1; min-width: 0; }
.user-name { font-weight: 500; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-tier { font-size: 10px; color: var(--text-muted); }
.user-plan { font-size: 11px; color: var(--text-muted); }
.plan-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 500; background: var(--accent-subtle); color: var(--accent); }
.tier-badge { font-size: 10px; color: var(--text-muted); }

.main-content { flex: 1; margin-left: 0; padding: 12px; padding-top: 64px; overflow-x: hidden; }
.page { display: none; overflow-x: hidden; }
.page.active { display: block; }
.page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; gap: 16px; }
.page-title { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
.page-subtitle { color: var(--text-secondary); font-size: 12px; }

/* === INSTITUTIONAL PAGES === */
.page-header-clean { margin-bottom: 24px; }
.page-header-clean .page-title { font-size: 18px; font-weight: 500; letter-spacing: -0.3px; }

.section-block { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); overflow-x: auto; }
.section-block:last-child { border-bottom: none; margin-bottom: 0; }
.section-label { font-size: 10px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
.section-text { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; word-wrap: break-word; }
.section-footnote { font-size: 11px; color: var(--text-muted); margin-top: 10px; word-break: break-word; }
.section-footnote a { color: var(--text-secondary); text-decoration: none; word-break: break-all; }
.section-footnote a:hover { text-decoration: underline; }

.key-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.key-input { width: 100%; padding: 10px 12px; font-family: 'JetBrains Mono', monospace; font-size: 11px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
.key-buttons { display: flex; gap: 8px; }
.key-meta { display: flex; flex-direction: column; gap: 4px; font-size: 11px; color: var(--text-muted); }

.btn-minimal { padding: 8px 14px; font-size: 12px; font-weight: 500; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
.btn-minimal:hover { background: var(--bg-elevated); color: var(--text); }
.btn-minimal:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-minimal:disabled:hover { background: transparent; color: var(--text-secondary); }

.btn-danger-outline { padding: 8px 14px; font-size: 12px; font-weight: 500; background: transparent; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); cursor: pointer; transition: all 0.15s; }
.btn-danger-outline:hover { background: rgba(239, 68, 68, 0.08); }

.code-block { background: #0c0f14; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.5; overflow-x: auto; margin: 0; max-width: 100%; box-sizing: border-box; }
pre { max-width: 100%; overflow-x: auto; }

/* Info Rows */
.info-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); gap: 12px; }
.info-row:last-child { border-bottom: none; }
.info-key { font-size: 13px; color: var(--text-muted); min-width: 100px; }
.info-val { font-size: 13px; color: var(--text); flex: 1; }
a.info-val { color: var(--text-secondary); text-decoration: none; }
a.info-val:hover { color: var(--text); }
.info-val.status-active { display: flex; align-items: center; gap: 6px; }
.info-val .dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }
.info-action { font-size: 12px; color: var(--text-muted); cursor: pointer; }
.info-action:hover { color: var(--text); }

/* Doc Rows */
.doc-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
.doc-row:last-child { border-bottom: none; }
.doc-name { font-size: 13px; color: var(--text); }
.doc-link { font-size: 12px; color: var(--text-muted); cursor: pointer; }
.doc-link:hover { color: var(--text); }

/* === TIERS === */
.tiers-grid { display: grid; grid-template-columns: 1fr; gap: 12px; max-width: 320px; margin: 0 auto; }
.tier-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; }
.tier-name { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 6px; }
.tier-price { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.tier-price span { font-size: 12px; font-weight: 400; color: var(--text-muted); }
.tier-desc { font-size: 11px; color: var(--text-muted); margin-bottom: 12px; }
.tier-list { list-style: none; padding: 0; margin: 0 0 16px 0; }
.tier-list li { font-size: 12px; color: var(--text-secondary); padding: 4px 0; border-bottom: 1px solid var(--border); }
.tier-list li:last-child { border-bottom: none; }
.btn-tier { width: 100%; padding: 8px; font-size: 12px; font-weight: 500; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text); cursor: pointer; transition: all 0.15s; margin-bottom: 6px; }
.btn-tier:hover { background: var(--bg-elevated); }
.btn-tier.current { background: var(--bg-elevated); color: var(--text-muted); cursor: default; }
.btn-tier-secondary { width: 100%; padding: 6px; font-size: 11px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; }
.btn-tier-secondary:hover { color: var(--text); }

/* === CARDS === */
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 20px; }
.card-title { font-size: 14px; font-weight: 500; margin-bottom: 12px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px; }
.stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px; }
.stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 2px; text-transform: uppercase; letter-spacing: .3px; }
.stat-value { font-size: 22px; font-weight: 600; }

/* === SETTINGS === */
.settings-section { margin-bottom: 24px; }
.settings-section h3 { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
.settings-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
.settings-row:last-child { border-bottom: none; }
.settings-label { font-weight: 500; font-size: 13px; }
.settings-value { color: var(--text-secondary); font-size: 12px; }
.settings-action { color: var(--accent); font-weight: 500; cursor: pointer; font-size: 12px; }
.company-status { display: flex; align-items: center; gap: 8px; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; }
.status-dot.inactive { background: var(--text-muted); }
.status-dot.active { background: var(--accent); }

/* === BILLING CARDS === */

/* === EVALUATE PAGE === */
.eval-select { width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:6px 10px;font-size:12px;cursor:pointer; }
.eval-select:focus { outline:none;border-color:var(--accent); }

/* Compact model list */
@media (max-width: 768px) { #dash-demo-grid { grid-template-columns: 1fr !important; } #dash-detail-expanded > div:last-child { grid-template-columns: 1fr !important; } }
@media (max-width: 768px) { #dash-status-bar { flex-wrap:wrap;gap:8px; } #dash-status-bar > div[style*="width:1px"] { display:none; } }
@media (max-width: 768px) { #audit-stats-bar { grid-template-columns: repeat(2, 1fr) !important; } }
.dash-models-empty { text-align:center;padding:24px 0;color:var(--text-muted);font-size:12px; }

.eval-form-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 16px; }
.eval-form-card label { display: block; font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.eval-form-card textarea { width: 100%; min-height: 120px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); padding: 10px 12px; font-size: 13px; font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; resize: vertical; box-sizing: border-box; }
.eval-form-card textarea:focus { outline: none; border-color: var(--accent); }
.eval-form-card select { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); padding: 8px 12px; font-size: 13px; cursor: pointer; }
.eval-form-card select:focus { outline: none; border-color: var(--accent); }
.eval-form-card input[type="number"] { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); padding: 8px 12px; font-size: 13px; box-sizing: border-box; }
.eval-form-card input[type="number"]:focus { outline: none; border-color: var(--accent); }
.eval-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
.eval-form-group { margin-bottom: 14px; }
.eval-form-group:last-child { margin-bottom: 0; }
.eval-optional-toggle { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; cursor: pointer; font-size: 12px; color: var(--text-secondary); }
.eval-optional-toggle:hover { color: var(--text); }
.eval-optional-fields { display: none; }
.eval-optional-fields.show { display: block; }
.eval-submit-row { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; }
.eval-submit-btn { background: var(--accent); color: #fff; border: none; padding: 10px 28px; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; transition: opacity 0.15s; }
.eval-submit-btn:hover { opacity: 0.85; }
.eval-submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.eval-submit-hint { font-size: 11px; color: var(--text-muted); }

/* Results */
.eval-result-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 16px; display: none; }
.eval-result-card.show { display: block; }
.eval-result-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.eval-score-ring { width: 80px; height: 80px; position: relative; flex-shrink: 0; }
.eval-score-ring svg { width: 80px; height: 80px; transform: rotate(-90deg); }
.eval-score-ring .ring-bg { fill: none; stroke: var(--border); stroke-width: 6; }
.eval-score-ring .ring-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease, stroke 0.3s; }
.eval-score-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.eval-score-value { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
.eval-score-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.eval-result-meta { flex: 1; }
.eval-compliance-badge { display: inline-block; padding: 4px 12px; border-radius: 3px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px; margin-bottom: 6px; }
.eval-compliance-badge.passed { background: rgba(34,197,94,0.12); color: #22c55e; }
.eval-compliance-badge.review { background: rgba(234,179,8,0.12); color: #eab308; }
.eval-compliance-badge.failed { background: rgba(239,68,68,0.12); color: #ef4444; }
.eval-result-domain { font-size: 12px; color: var(--text-secondary); }
.eval-result-timestamp { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

/* Factor breakdown */
.eval-factors { display: grid; grid-template-columns: 1fr; gap: 8px; }
.eval-factor { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
.eval-factor-name { width: 140px; font-size: 11px; color: var(--text-secondary); flex-shrink: 0; }
.eval-factor-bar-wrap { flex: 1; height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden; }
.eval-factor-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
.eval-factor-val { width: 44px; text-align: right; font-size: 12px; font-weight: 500; font-variant-numeric: tabular-nums; flex-shrink: 0; }

/* Session history */
.eval-history { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px; }
.eval-history-title { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
.eval-history-empty { font-size: 12px; color: var(--text-muted); text-align: center; padding: 20px 0; }
.eval-history-row { display: grid; grid-template-columns: 60px 1fr 70px 70px; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; align-items: center; }
.eval-history-row:last-child { border-bottom: none; }
.eval-history-row .risk-pill { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; }
.eval-history-output { color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
@media (max-width: 768px) { .eval-form-row { grid-template-columns: 1fr; } .eval-history-row { grid-template-columns: 60px 1fr 60px; } .eval-history-row span:last-child { display: none; } }
.pricing-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-width: 320px; margin: 0 auto; }
.pricing-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px 14px; text-align: center; position: relative; transition: all 0.2s; }
.pricing-card.popular { border-color: var(--accent); }
.pricing-badge { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 2px 12px; border-radius: 3px; font-size: 10px; font-weight: 500; }
.pricing-name { font-size: 15px; font-weight: 500; margin-bottom: 6px; margin-top: 6px; }
.pricing-price { font-size: 32px; font-weight: 700; margin-bottom: 2px; }
.pricing-period { font-size: 12px; color: var(--text-muted); }
.pricing-annual { font-size: 12px; color: var(--accent); margin-top: 2px; font-weight: 500; }
.pricing-features { margin: 16px 0; text-align: left; }
.pricing-features li { display: flex; align-items: center; gap: 6px; padding: 5px 0; font-size: 12px; color: var(--text-secondary); list-style: none; }
.pricing-features li::before { content: "✓"; color: var(--accent); font-weight: 500; font-size: 11px; }
.pricing-actions { display: flex; flex-direction: column; gap: 6px; }
.pricing-actions .btn { width: 100%; }

/* === MODALS === */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
.modal-overlay.active { display: flex; }
.modal { background: var(--bg-card); border-radius: 6px; width: 100%; max-width: 520px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); }
.modal-wide { max-width: 600px; }
.modal-inst { border-radius: 6px; }
.modal-inst .modal-header { padding: 14px 16px; border-bottom: 1px solid var(--border); }
.modal-inst .modal-header h2 { font-size: 14px; font-weight: 500; }
.modal-inst .modal-body { padding: 16px; }
.modal-inst .modal-footer { padding: 12px 16px; }
.form-section { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.form-section:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.form-section-title { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
.form-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 480px) { .form-row { grid-template-columns: 1fr 1fr; } }
.modal-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-header h2 { font-size: 15px; font-weight: 500; }
.modal-close { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 20px; line-height: 1; }
.modal-body { padding: 16px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
.modal-footer .btn { width: auto; min-width: 100px; }

/* === BILLING CYCLE SELECTOR === */
.cycle-option { border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; }
.cycle-option:hover { border-color: var(--border-hover); }
.cycle-option.selected { border-color: var(--accent); background: var(--accent-subtle); }
.cycle-option-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.cycle-option-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }
.cycle-option-title input[type="radio"] { accent-color: var(--accent); }
.cycle-option-price { font-weight: 700; }
.cycle-option-desc { font-size: 13px; color: var(--text-secondary); margin-left: 24px; }
.cycle-savings { background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }

/* Order Modal - Institutional */
.order-section { margin-bottom: 20px; }
.order-features { display: flex; flex-direction: column; gap: 4px; }
.order-feature { font-size: 12px; color: var(--text-secondary); padding-left: 12px; position: relative; }
.order-feature::before { content: '—'; position: absolute; left: 0; color: var(--text-muted); font-size: 10px; }

.billing-options { display: flex; flex-direction: column; gap: 8px; }
.billing-option { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.15s; }
.billing-option:hover { border-color: var(--text-muted); }
.billing-option:has(input:checked) { border-color: var(--accent); background: rgba(34, 197, 94, 0.03); }
.billing-option input[type="radio"] { accent-color: var(--accent); }
.billing-option-content { flex: 1; display: flex; flex-direction: column; gap: 1px; }
.billing-option-name { font-size: 13px; font-weight: 500; color: var(--text); }
.billing-option-detail { font-size: 11px; color: var(--text-muted); }
.billing-option-price { font-size: 14px; font-weight: 600; color: var(--text); }

.payment-options { display: flex; gap: 8px; }
.payment-opt { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 12px 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.15s; text-align: center; }
.payment-opt:hover { border-color: var(--text-muted); }
.payment-opt:has(input:checked) { border-color: var(--accent); background: rgba(34, 197, 94, 0.03); }
.payment-opt:has(input:disabled) { opacity: 0.4; cursor: not-allowed; }
.payment-opt input[type="radio"] { accent-color: var(--accent); margin-bottom: 2px; }
.payment-opt-name { font-size: 12px; font-weight: 500; color: var(--text); }
.payment-opt-note { font-size: 10px; color: var(--text-muted); }

.order-summary { margin-top: 20px; padding: 16px; background: var(--bg-elevated); border-radius: 6px; }
.order-summary-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
.order-summary-row.total { padding-top: 12px; margin-top: 8px; border-top: 1px solid var(--border); }
.order-summary-label { font-size: 12px; color: var(--text-secondary); }
.order-summary-row.total .order-summary-label { font-size: 13px; font-weight: 500; color: var(--text); }
.order-summary-value { font-size: 13px; font-weight: 500; color: var(--text); }
.order-summary-row.total .order-summary-value { font-size: 18px; font-weight: 600; }

.payment-method { margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); }
.payment-method h4 { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
.payment-option { display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
.payment-option.disabled { opacity: 0.5; cursor: not-allowed; }
.payment-option input[type="radio"] { accent-color: var(--accent); }
.payment-option-label { flex: 1; font-size: 14px; }
.payment-option .lock-icon { color: var(--text-muted); font-size: 12px; }

/* === DOCUMENTS === */
.doc-item { display: flex; align-items: center; gap: 16px; padding: 16px 0; border-bottom: 1px solid var(--border); }
.doc-item:last-child { border-bottom: none; }
.doc-icon { width: 40px; height: 40px; background: var(--bg-elevated); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
.doc-info { flex: 1; }
.doc-name { font-weight: 500; margin-bottom: 2px; }
.doc-status { font-size: 13px; color: var(--text-muted); }
.doc-actions { display: flex; gap: 8px; }
.doc-btn { padding: 6px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); background: var(--bg); color: var(--text-secondary); transition: all 0.15s; }
.doc-btn:hover { background: var(--bg-elevated); }
.doc-btn.disabled { opacity: 0.5; cursor: not-allowed; }

/* === HIDDEN === */
.hidden { display: none !important; }

/* === DOCUMENTATION STYLES === */
.docs-container { display: flex; gap: 0; min-height: calc(100vh - 200px); max-width: 100%; box-sizing: border-box; }
.docs-sidebar { display: none; width: 200px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 12px 0; flex-shrink: 0; max-height: calc(100vh - 200px); overflow-y: auto; position: sticky; top: 0; }
.docs-nav-section { padding: 0 8px; margin-bottom: 4px; }
.docs-nav-section h4 { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); padding: 12px 10px 6px; margin: 0; font-weight: 500; }
.docs-nav-item { display: block; padding: 6px 10px; border-radius: 4px; color: var(--text-secondary); font-size: 12px; cursor: pointer; transition: .15s; border-left: 2px solid transparent; margin-left: 2px; }
.docs-nav-item:hover { background: var(--bg-elevated); color: var(--text); }
.docs-nav-item.active { background: var(--bg-elevated); color: var(--text); font-weight: 500; border-left-color: var(--accent); }
.docs-content { flex: 1; padding: 16px; max-height: calc(100vh - 200px); overflow-y: auto; max-width: 100%; box-sizing: border-box; }
.docs-article { display: none; max-width: 100%; overflow-x: hidden; }
.docs-article.active { display: block; }
.docs-article h1 { font-size: 20px; margin-bottom: 6px; font-weight: 600; color: var(--text); word-wrap: break-word; }
.docs-article .docs-meta { display: flex; gap: 8px; font-size: 11px; color: var(--text-muted); margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center; }
.docs-article h2 { font-size: 14px; margin: 28px 0 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text); }
.docs-article h3 { font-size: 13px; margin: 20px 0 8px; font-weight: 600; color: var(--text); }
.docs-article h4 { font-size: 12px; margin: 16px 0 6px; color: var(--text-secondary); font-weight: 600; }
.docs-article p { margin-bottom: 12px; color: var(--text-secondary); font-size: 13px; line-height: 1.7; word-wrap: break-word; overflow-wrap: break-word; }
.docs-article ul, .docs-article ol { margin: 0 0 12px 20px; font-size: 13px; }
.docs-article li { margin-bottom: 6px; color: var(--text-secondary); line-height: 1.6; }
.docs-article hr { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
.docs-article table { width: 100%; border-collapse: collapse; margin: 12px 0 20px; font-size: 12px; display: block; overflow-x: auto; }
.docs-article th { background: var(--bg-elevated); padding: 8px 10px; text-align: left; font-weight: 500; border: 1px solid var(--border); font-size: 11px; }
.docs-article td { padding: 8px 10px; border: 1px solid var(--border); }
.docs-article code { background: var(--bg-elevated); padding: 2px 5px; border-radius: 3px; font-size: 11px; font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace; }
.docs-article pre { background: #0c0f14; color: #e2e8f0; padding: 14px; border-radius: 6px; overflow-x: auto; margin: 12px 0; font-size: 11px; line-height: 1.5; max-width: 100%; box-sizing: border-box; }
.docs-article pre code { background: none; padding: 0; color: inherit; }
.docs-article blockquote { border-left: 2px solid var(--border); padding: 10px 16px; background: var(--bg-elevated); margin: 12px 0; border-radius: 0 4px 4px 0; }
.docs-article blockquote p { margin: 0; font-size: 12px; color: var(--text-secondary); }
.docs-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 500; }
.badge-green { background: rgba(34, 197, 94, 0.1); color: #16a34a; }
.badge-blue { background: rgba(100, 116, 139, 0.1); color: #64748b; }
.docs-disclaimer { background: var(--bg-elevated); border: 1px solid var(--border); padding: 12px; border-radius: 4px; margin: 16px 0; font-size: 12px; }
.docs-disclaimer strong { color: var(--text); }

/* Docs mobile select */
.docs-mobile-nav { display: block; margin-bottom: 16px; }
.docs-mobile-select { width: 100%; padding: 10px 12px; font-size: 13px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); color: var(--text); cursor: pointer; }

/* === LOADING STATE === */
.btn.loading { pointer-events: none; opacity: 0.7; }
.btn.loading::after { content: ""; width: 14px; height: 14px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; margin-left: 8px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* === TOAST === */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast { padding: 12px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.2s ease; }
.toast.success { background: var(--accent); color: white; }
.toast.error { background: var(--danger); color: white; }
.toast.info { background: var(--blue); color: white; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* === MOBILE === */
.mobile-header { display: flex; position: fixed; top: 0; left: 0; right: 0; height: 56px; background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 0 16px; align-items: center; justify-content: space-between; z-index: 100; }
.mobile-header .hamburger:first-child { order: 0; }
.mobile-header .logo { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; order: 1; }
.mobile-header .logo svg { width: 22px; height: 22px; }
.mobile-header .hamburger:last-child { order: 2; }
.hamburger { background: none; border: none; cursor: pointer; padding: 8px; color: var(--text); }
.hamburger svg { width: 24px; height: 24px; }
.sidebar.mobile-open { display: flex; flex-direction: column; position: fixed; z-index: 99; left: 0; top: 56px; height: calc(100vh - 56px); height: calc(100dvh - 56px); width: 240px; }
.mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 98; }
.mobile-overlay.active { display: block; }
.signal-hash { display: flex; align-items: center; gap: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
.signal-hash .label { color: var(--text-muted); }
.signal-hash .bytes { display: flex; gap: 2px; }
.signal-hash .byte { color: var(--accent); animation: pulse-byte 2s infinite; }
.signal-hash .ellipsis { color: var(--text-muted); }
.signal-hash .size { color: var(--text-muted); margin-left: 8px; font-size: 11px; }
@keyframes pulse-byte { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

/* Status Bar */
.status-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-elevated); border-radius: 6px; border: 1px solid var(--border); margin-bottom: 24px; font-size: 13px; }
.status-item { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); }
.status-item .signal-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; animation: pulse-signal 1.5s infinite; }
.status-label { color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
.utc-clock { font-family: 'JetBrains Mono', monospace; color: var(--text); }
@keyframes pulse-signal { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

/* === DASHBOARD — CLEAN INSTITUTIONAL === */

/* Header */
/* === INSTITUTIONAL DASHBOARD === */

.dash-header-new { margin-bottom: 24px; }
.dash-title { font-size: 22px; font-weight: 500; margin: 0; color: var(--text); letter-spacing: -0.3px; }

/* Status Bar — minimal, institutional */
.metrics-strip { display: flex; align-items: center; gap: 24px; padding: 12px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; flex-wrap: wrap; }
.metric-item { display: flex; align-items: center; gap: 8px; }
.metric-val { font-size: 14px; font-weight: 500; color: var(--text); }
.metric-val.mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 400; }
.metric-lbl { font-size: 11px; color: var(--text-muted); }
.plan-switch-select { 
    background: var(--bg-card); 
    color: var(--text); 
    border: 1px solid var(--border); 
    border-radius: 4px; 
    padding: 4px 8px; 
    font-size: 12px; 
    cursor: pointer;
    font-family: inherit;
}
.plan-switch-select:hover { border-color: var(--accent); }
.plan-switch-select:focus { outline: none; border-color: var(--accent); }
.metric-sep { width: 1px; height: 16px; background: var(--border); }
.status-active { display: flex; align-items: center; gap: 6px; color: var(--text); }
.status-active .dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

/* Signal Bars — subtle */
.signal-bars { display: flex; align-items: flex-end; gap: 2px; height: 12px; }
.signal-bars .bar { width: 2px; background: var(--border); border-radius: 1px; }
.signal-bars .bar:nth-child(1) { height: 3px; }
.signal-bars .bar:nth-child(2) { height: 5px; }
.signal-bars .bar:nth-child(3) { height: 7px; }
.signal-bars .bar:nth-child(4) { height: 9px; }
.signal-bars .bar:nth-child(5) { height: 12px; }
.signal-bars .bar.active { background: var(--accent); opacity: 0.8; }

/* === MODELS OVERVIEW === */
.models-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.btn-add-model { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 14px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all .15s; }
.btn-add-model:hover { border-color: var(--accent); color: var(--accent); }

/* Models Grid */
.models-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
.model-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px; cursor: pointer; transition: all .15s; position: relative; }
.model-card:hover { border-color: var(--accent); transform: translateY(-1px); }
.model-card.selected { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
.mc-name { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.mc-provider { font-size: 10px; color: var(--text-muted); margin-bottom: 12px; }
.mc-risk { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; margin-bottom: 4px; }
.mc-risk.low { color: var(--accent); }
.mc-risk.medium { color: #d97706; }
.mc-risk.high { color: #dc2626; }
.mc-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
.mc-layer { font-size: 11px; font-weight: 500; color: var(--text-secondary); background: var(--bg-elevated); padding: 2px 8px; border-radius: 3px; }
.mc-compliance { font-size: 10px; font-weight: 600; }
.mc-compliance.passed { color: var(--accent); }
.mc-compliance.review { color: #d97706; }
.mc-compliance.failed { color: #dc2626; }
.mc-calibration { width: 100%; height: 3px; background: var(--border); border-radius: 2px; margin-top: 10px; overflow: hidden; }
.mc-calibration-fill { height: 100%; border-radius: 2px; background: var(--accent); transition: width .3s; }
.mc-cal-label { font-size: 9px; color: var(--text-muted); margin-top: 4px; }
.mc-alert { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; border-radius: 50%; }
.mc-alert.ok { background: var(--accent); }
.mc-alert.warn { background: #d97706; animation: pulse-signal 1.5s infinite; }
.mc-alert.err { background: #dc2626; animation: pulse-signal 1s infinite; }

/* Comparison */
.compare-tabs { display: flex; gap: 4px; }
.compare-tab { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 3px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; }
.compare-tab.active { border-color: var(--accent); color: var(--accent); }
.compare-bars { padding: 12px 0; }
.compare-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
.compare-label { width: 90px; font-size: 12px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }
.compare-bar-wrap { flex: 1; height: 20px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden; position: relative; }
.compare-bar-fill { height: 100%; border-radius: 3px; transition: width .4s; }
.compare-bar-fill.low { background: rgba(21,128,61,0.5); }
.compare-bar-fill.medium { background: rgba(217,119,6,0.5); }
.compare-bar-fill.high { background: rgba(220,38,38,0.5); }
.compare-bar-fill.neutral { background: rgba(100,100,100,0.3); }
.compare-val { width: 50px; font-size: 12px; font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); text-align: right; flex-shrink: 0; }
.compare-best { font-size: 11px; color: var(--text-muted); padding-top: 8px; border-top: 1px solid var(--border); margin-top: 4px; }
.compare-best strong { color: var(--accent); font-weight: 600; }

/* Detail Panel */
.model-detail-panel { margin-bottom: 20px; }
.detail-back { font-size: 12px; color: var(--text-muted); cursor: pointer; margin-bottom: 12px; transition: color .15s; }
.detail-back:hover { color: var(--accent); }

/* === MODEL STATUS === */
.model-status-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 20px; }
.model-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
.model-name { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.model-id { font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
.model-risk-badge { text-align: center; padding: 12px 20px; border-radius: 6px; border: 1px solid var(--border); min-width: 100px; }
.model-risk-badge.low { border-color: var(--accent); background: rgba(21,128,61,0.08); }
.model-risk-badge.medium { border-color: #d97706; background: rgba(217,119,6,0.08); }
.model-risk-badge.high { border-color: #dc2626; background: rgba(220,38,38,0.08); }
.risk-value { font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.model-risk-badge.low .risk-value { color: var(--accent); }
.model-risk-badge.medium .risk-value { color: #d97706; }
.model-risk-badge.high .risk-value { color: #dc2626; }
.risk-label { font-size: 9px; color: var(--text-muted); letter-spacing: 1px; margin-top: 2px; }
.model-metrics { display: flex; gap: 24px; flex-wrap: wrap; }
.model-metric { display: flex; flex-direction: column; gap: 2px; }
.mm-val { font-size: 14px; font-weight: 600; color: var(--text); }
.mm-val.passed { color: var(--accent); }
.mm-val.review { color: #d97706; }
.mm-val.failed { color: #dc2626; }
.mm-lbl { font-size: 9px; color: var(--text-muted); letter-spacing: 0.5px; }

/* Trend Chart */
.trend-chart { height: 120px; display: flex; align-items: flex-end; gap: 2px; padding: 8px 0; }
.trend-bar { flex: 1; border-radius: 2px 2px 0 0; min-width: 8px; transition: height .3s; position: relative; }
.trend-bar.low { background: var(--accent); opacity: 0.7; }
.trend-bar.medium { background: #d97706; opacity: 0.7; }
.trend-bar.high { background: #dc2626; opacity: 0.7; }
.trend-bar:hover { opacity: 1; }
.trend-bar::after { content: attr(data-val); position: absolute; top: -16px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--text-muted); display: none; }
.trend-bar:hover::after { display: block; }
.trend-summary { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 8px; }
.trend-dir.improving { color: var(--accent); }
.trend-dir.worsening { color: #dc2626; }

/* Signal Compact */
.signal-compact { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 12px 16px; margin-bottom: 20px; }
.signal-compact-left { display: flex; align-items: center; gap: 10px; }
.signal-compact-label { font-size: 11px; font-weight: 500; color: var(--text-secondary); }
.signal-compact-id { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--accent); }
.signal-compact-right { display: flex; align-items: center; gap: 16px; }
.signal-compact-hash { font-size: 10px; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.signal-compact-next { font-size: 11px; color: var(--text-muted); }
.signal-compact-next span { font-family: 'JetBrains Mono', monospace; color: var(--accent); }
@media (max-width: 768px) { .signal-compact { flex-direction: column; gap: 8px; } .signal-compact-hash { max-width: 100%; } }

/* Proof Badge */
.proof-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 4px; padding: 4px 10px; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: #22c55e; cursor: pointer; transition: all 0.2s; margin-top: 8px; text-decoration: none; }
.proof-badge:hover { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.4); }
.proof-badge .proof-icon { font-size: 12px; }
.proof-badge .proof-hash-text { max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.proof-badge .proof-verify { color: rgba(34,197,94,0.6); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Grid — clean */
.dash-grid-clean { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
.dash-grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
@media (max-width: 768px) { .dash-grid-2col { grid-template-columns: 1fr; } }
@media (max-width: 768px) { .welcome-banner > div:nth-child(2) { grid-template-columns: 1fr; } }
@media (max-width: 768px) { #cert-cards { grid-template-columns: 1fr !important; } }
.dash-card-clean { background: var(--bg-card); border-radius: 6px; padding: 20px; }
.card-head { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 16px; }
.card-head-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.card-sub { font-size: 11px; color: var(--text-muted); }

/* Chart — centered */
.chart-wrap { display: flex; justify-content: center; margin-bottom: 16px; }
.chart-wrap canvas { max-width: 100px; max-height: 100px; }
.chart-legend { display: flex; flex-wrap: wrap; gap: 8px 16px; font-size: 11px; color: var(--text-secondary); justify-content: center; }
.chart-legend-item { display: flex; align-items: center; gap: 6px; }
.chart-legend-dot { width: 8px; height: 8px; border-radius: 2px; }

/* Table — clean */
.table-wrap { overflow-x: auto; margin: 0 -20px; padding: 0 20px; }
.eval-tbl { width: 100%; border-collapse: collapse; font-size: 13px; }
.eval-tbl th { text-align: left; padding: 10px 8px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; border-bottom: 1px solid var(--border); font-weight: 500; }
.eval-tbl td { padding: 12px 8px; border-bottom: 1px solid var(--border); }
.eval-tbl tr:last-child td { border-bottom: none; }
.empty-row { text-align: center; color: var(--text-muted); padding: 32px 8px !important; font-size: 13px; }
.hide-sm { display: none; }

/* Quick Start — minimal */
.qs-block { background: var(--bg-card); border-radius: 6px; padding: 16px 20px; }
.qs-block summary { font-size: 13px; font-weight: 500; color: var(--text); cursor: pointer; list-style: none; }
.qs-block summary::-webkit-details-marker { display: none; }
.qs-block[open] summary { margin-bottom: 16px; }

/* Welcome Banner */
.welcome-banner { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px 20px; margin-bottom: 24px; }

/* Plan Card */
.plan-current { margin-bottom: 16px; }
.plan-name { font-size: 20px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.plan-detail { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
.btn-upgrade { width: 100%; padding: 10px; background: transparent; border: 1px solid var(--accent); color: var(--accent); border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all .15s; }
.btn-upgrade:hover { background: var(--accent); color: #fff; }
.plan-switcher { margin-top: 12px; }
.welcome-banner.hidden { display: none; }
.welcome-content { display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap; }
.welcome-text { display: flex; flex-direction: column; gap: 4px; }
.welcome-text strong { font-size: 14px; font-weight: 600; }
.welcome-text span { font-size: 13px; color: var(--text-secondary); }
.welcome-actions { display: flex; align-items: center; gap: 8px; }
.welcome-dismiss { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; padding: 4px 8px; line-height: 1; }
.welcome-dismiss:hover { color: var(--text); }
.code { background: #0c0f14; color: #e2e8f0; padding: 14px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; overflow-x: auto; margin: 0; max-width: 100%; box-sizing: border-box; }

/* ============================================
   SKELETON
   ============================================ */
.skeleton { background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-elevated) 50%, var(--bg-secondary) 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; border-radius: 4px; }
@keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.skeleton-text { height: 14px; width: 60%; }
.skeleton-text-sm { height: 11px; width: 80%; }
.skeleton-metric { height: 20px; width: 50px; margin: 0 auto; }

/* ============================================
   ADMIN PANEL
   ============================================ */
.admin-action-btn { display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; font-size: 11px; font-weight: 500; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
.admin-action-btn:hover { background: var(--bg-elevated); color: var(--text); }
.admin-action-btn.admin-delete-btn { color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
.admin-action-btn.admin-delete-btn:hover { background: rgba(239, 68, 68, 0.1); }
.admin-detail-section { animation: slideDown 0.2s ease; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

/* Signal Panel */
.signal-panel { background: linear-gradient(135deg, #0a1a0f 0%, #0d2818 50%, #0a1a0f 100%); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 20px 24px; margin-bottom: 20px; position: relative; overflow: hidden; animation: borderGlow 4s ease-in-out infinite; }
@keyframes borderGlow {
    0%, 100% { border-color: rgba(34, 197, 94, 0.3); box-shadow: 0 0 20px rgba(34, 197, 94, 0.1); }
    50% { border-color: rgba(34, 197, 94, 0.6); box-shadow: 0 0 40px rgba(34, 197, 94, 0.2); }
}
.signal-panel::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(34, 197, 94, 0.08) 0%, transparent 70%); pointer-events: none; }
.signal-panel::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent 0%, rgba(34, 197, 94, 0.8) 50%, transparent 100%); animation: scanline 6s linear infinite; pointer-events: none; box-shadow: 0 0 10px rgba(34, 197, 94, 0.6), 0 0 20px rgba(34, 197, 94, 0.4), 0 0 30px rgba(34, 197, 94, 0.2); }
@keyframes scanline {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(300px); opacity: 0; }
}
.signal-panel-grid { position: absolute; inset: 0; background-image: 
    linear-gradient(rgba(34, 197, 94, 0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(34, 197, 94, 0.03) 1px, transparent 1px);
    background-size: 20px 20px; pointer-events: none; }
.signal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; position: relative; z-index: 1; }
.signal-title-row { display: flex; align-items: center; gap: 10px; }
.signal-live-indicator { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(34, 197, 94, 0.15); border-radius: 12px; font-size: 10px; font-weight: 600; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; }
.signal-title { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; color: var(--text); }
.signal-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #15803d, #22c55e); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: #fff; font-family: 'Times New Roman', serif; font-style: italic; box-shadow: 0 0 15px rgba(34, 197, 94, 0.5), 0 0 30px rgba(34, 197, 94, 0.2); }
.signal-live { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(34, 197, 94, 0.15); border-radius: 12px; font-size: 10px; font-weight: 600; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; }
.signal-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 0 6px #22c55e, 0 0 12px rgba(34, 197, 94, 0.5); }
@keyframes pulse { 0%, 100% { opacity: 1; box-shadow: 0 0 6px #22c55e, 0 0 12px rgba(34, 197, 94, 0.5); } 50% { opacity: 0.6; box-shadow: 0 0 3px #22c55e; } }
.signal-body { position: relative; z-index: 1; }
.signal-main-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
.signal-id-block { flex: 1; }
.signal-id { font-size: 24px; font-weight: 700; color: #22c55e; font-family: 'JetBrains Mono', monospace; margin-bottom: 6px; text-shadow: 0 0 20px rgba(34, 197, 94, 0.4); animation: idGlow 3s ease-in-out infinite; }
@keyframes idGlow {
    0%, 100% { text-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
    50% { text-shadow: 0 0 30px rgba(34, 197, 94, 0.6), 0 0 50px rgba(34, 197, 94, 0.3); }
}
.signal-skeleton-id { height: 28px; width: 200px; background: rgba(34, 197, 94, 0.1); border-radius: 4px; animation: skeleton-loading 1.5s infinite; background-size: 200% 100%; background-image: linear-gradient(90deg, rgba(34, 197, 94, 0.05) 25%, rgba(34, 197, 94, 0.15) 50%, rgba(34, 197, 94, 0.05) 75%); }
.signal-skeleton-hash { height: 14px; width: 300px; background: rgba(34, 197, 94, 0.1); border-radius: 4px; animation: skeleton-loading 1.5s infinite; background-size: 200% 100%; background-image: linear-gradient(90deg, rgba(34, 197, 94, 0.05) 25%, rgba(34, 197, 94, 0.15) 50%, rgba(34, 197, 94, 0.05) 75%); }
.signal-countdown-block { text-align: right; }
.signal-countdown-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.signal-countdown-value { font-size: 28px; font-weight: 700; color: #22c55e; font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
.signal-metrics { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
.signal-metric { text-align: center; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.1); transition: all 0.3s; }
.signal-metric.updated { border-color: rgba(34, 197, 94, 0.4); background: rgba(34, 197, 94, 0.1); }
.signal-metric-value { font-size: 14px; font-weight: 600; color: #22c55e; font-family: 'JetBrains Mono', monospace; margin-bottom: 2px; transition: color 0.3s; }
.signal-metric-value.metric-good { color: #22c55e; }
.signal-metric-value.metric-warn { color: #f59e0b; }
.signal-metric-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.signal-controls { display: flex; justify-content: flex-end; margin-top: 16px; }
.signal-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; font-size: 11px; font-weight: 500; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; color: #22c55e; cursor: pointer; transition: all 0.15s; }
.signal-btn:hover { background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.5); box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
.signal-btn svg { opacity: 0.8; }

/* Accounts Panel */
.accounts-panel { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
.accounts-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); }
.accounts-title { font-size: 13px; font-weight: 600; color: var(--text); }
.accounts-search { width: 180px; padding: 6px 10px; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); }
.accounts-search:focus { outline: none; border-color: var(--accent); }
.accounts-filters { display: flex; gap: 8px; padding: 10px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
.accounts-filter { padding: 5px 8px; font-size: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; }
.accounts-list { max-height: 300px; overflow-y: auto; }
.accounts-loading { padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px; }
.account-row { display: flex; align-items: center; padding: 10px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
.account-row:hover { background: var(--bg-secondary); }
.account-row:last-child { border-bottom: none; }
.account-email { flex: 1; font-size: 12px; color: var(--text); font-weight: 500; }
.account-type { width: 70px; font-size: 10px; color: var(--text-muted); }
.account-plan { width: 60px; }
.account-plan .tier-badge { font-size: 9px; padding: 2px 6px; }
.account-status { width: 50px; font-size: 10px; }
.account-status.active { color: #22c55e; }
.account-status.paused { color: #f59e0b; }
.account-date { width: 70px; font-size: 10px; color: var(--text-muted); text-align: right; }
.account-details { display: none; padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); animation: slideDown 0.2s ease; }
.account-details.open { display: block; }
.account-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
.account-detail-item { font-size: 11px; }
.account-detail-label { color: var(--text-muted); margin-bottom: 2px; }
.account-detail-value { color: var(--text); font-weight: 500; }
.account-actions { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border); }
.account-action-btn { padding: 5px 10px; font-size: 10px; font-weight: 500; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
.account-action-btn:hover { background: var(--bg-elevated); color: var(--text); }
.account-action-btn.danger { color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
.account-action-btn.danger:hover { background: rgba(239, 68, 68, 0.1); }
.account-action-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* Signal 104b Log */
.signal-log-panel { position: fixed; bottom: 20px; right: 20px; width: 360px; max-height: 300px; background: var(--bg-elevated); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000; overflow: hidden; }
.signal-log-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: rgba(239, 68, 68, 0.1); border-bottom: 1px solid rgba(239, 68, 68, 0.2); font-size: 11px; font-weight: 600; color: #ef4444; }
.signal-log-close { background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer; line-height: 1; }
.signal-log-list { max-height: 240px; overflow-y: auto; }
.signal-log-item { padding: 8px 14px; border-bottom: 1px solid var(--border); font-size: 10px; }
.signal-log-item:last-child { border-bottom: none; }
.signal-log-code { font-weight: 600; color: #ef4444; }
.signal-log-endpoint { color: var(--text-muted); font-family: monospace; }
.signal-log-time { color: var(--text-muted); float: right; }

.sidebar, .nav-item, button, .admin-user-card { user-select: none; -webkit-user-select: none; }

/* ============================================
   RESPONSIVE
   ============================================ */

@media (max-width: 639px) {
    .auth-title { font-size: 20px; }
    .otp-input { width: 38px; height: 46px; font-size: 20px; }
    .signal-metrics { grid-template-columns: repeat(3, 1fr); }
    .signal-main-row { flex-direction: column; gap: 12px; }
    .signal-countdown-block { text-align: left; }
}

@media (max-width: 900px) {
    .auth-container { flex-direction: column; }
    .auth-hero { padding: 32px 24px 24px; border-right: none; border-bottom: 1px solid var(--border); }
    .auth-hero h1 { font-size: 22px; }
    .auth-hero-stats { gap: 24px; margin-top: 24px; padding-top: 20px; }
    .auth-hero-stat strong { font-size: 18px; }
    .auth-form-side { width: 100%; padding: 24px; }
}

@media (min-width: 640px) {
    .main-content { padding: 24px; }
    
    .dash-header-new { display: flex; justify-content: space-between; align-items: center; }
    .dash-title { font-size: 24px; }
    .signal-hash { display: flex; }
    
    .metrics-strip { gap: 28px; }
    .metric-val { font-size: 15px; }
    
    .dash-grid-clean { grid-template-columns: 200px 1fr; gap: 20px; }
    .dash-card-clean { padding: 20px; }
    
    .chart-wrap canvas { max-width: 110px; max-height: 110px; }
    .chart-legend { font-size: 11px; gap: 10px 16px; }
    
    .eval-tbl { font-size: 13px; }
    .eval-tbl th { font-size: 11px; padding: 10px 8px; }
    .eval-tbl td { padding: 12px 8px; }
    .hide-sm { display: table-cell; }
    
    .qs-block { padding: 16px 20px; }
    .code { font-size: 12px; padding: 14px; }
    
    /* API Key page */
    .key-row { flex-direction: row; align-items: center; }
    .key-input { width: auto; flex: 1; font-size: 13px; }
    .key-meta { flex-direction: row; gap: 24px; font-size: 12px; }
    .code-block { font-size: 12px; padding: 16px; }
}

@media (min-width: 900px) {
    .sidebar { display: flex; flex-direction: column; }
    .sidebar-close { display: none !important; }
    .desktop-only { display: block; }
    .main-content { margin-left: 240px; padding: 28px 36px; padding-top: 28px; }
    .mobile-header { display: none; }
    
    .dash-header-new { margin-bottom: 28px; }
    .dash-title { font-size: 26px; }
    
    .metrics-strip { gap: 36px; border-bottom: none; padding: 0; margin-bottom: 28px; }
    .metric-val { font-size: 16px; }
    .metric-lbl { font-size: 12px; }
    
    .dash-grid-clean { grid-template-columns: 240px 1fr; gap: 24px; }
    .dash-card-clean { padding: 20px; border-radius: 6px; }
    .card-head { font-size: 13px; }
    
    .chart-wrap canvas { max-width: 130px; max-height: 130px; }
    
    .pricing-grid { grid-template-columns: repeat(3, 1fr); max-width: none; gap: 16px; }
    .tiers-grid { grid-template-columns: repeat(3, 1fr); max-width: none; gap: 16px; }
    .tier-card { padding: 20px; border-radius: 6px; }
    .pricing-card { padding: 20px 18px; border-radius: 6px; }
    .docs-sidebar { display: block; }
    .docs-content { padding: 24px 32px; }
    .docs-article { max-width: 800px; }
    .docs-mobile-nav { display: none; }
}

@media (min-width: 1200px) {
    .main-content { padding: 32px 40px; }
    
    .metrics-strip { gap: 40px; }
    .metric-val { font-size: 16px; }
    
    .dash-grid-clean { grid-template-columns: 240px 1fr; gap: 24px; }
    .dash-card-clean { padding: 24px; }
    
    .chart-wrap canvas { max-width: 150px; max-height: 150px; }
}

/* Risk badges */
.risk-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
.risk-badge.low { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
.risk-badge.medium { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
.risk-badge.high { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

/* === EPISTEMIC RISK MONITOR === */
.erm-proof-strip { padding:14px 0; border-bottom:1px solid var(--border); margin-bottom:16px; }
.erm-positioning { font-size:11px; color:var(--text-secondary); line-height:1.5; margin-bottom:10px; }
.erm-scores { display:flex; align-items:baseline; gap:14px; margin-bottom:6px; }
.erm-score { font-size:26px; font-weight:700; font-family:'JetBrains Mono',monospace; font-variant-numeric:tabular-nums; }
.erm-score.before { color:var(--danger); }
.erm-score.after { color:var(--accent); }
.erm-headline { font-size:13px; font-weight:700; color:var(--text); }
.erm-stats { display:flex; gap:16px; font-size:11px; margin-bottom:4px; }
.erm-method { font-size:10px; font-family:'JetBrains Mono',monospace; color:var(--text-muted); }
.erm-zone { padding:24px 0; border-bottom:1px solid var(--border); }
.erm-zone:last-of-type { border-bottom:none; }
.erm-step-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
.erm-step-num { width:32px; height:32px; border-radius:50%; border:2px solid var(--accent); display:flex; align-items:center; justify-content:center; font-family:'JetBrains Mono',monospace; font-size:14px; font-weight:700; color:var(--accent); flex-shrink:0; }
.erm-step-title { font-size:16px; font-weight:600; letter-spacing:-0.2px; }
.erm-step-sub { font-size:12px; color:var(--text-secondary); margin-top:2px; }
.erm-section-label { font-size:10px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; }
.erm-section-title { font-size:15px; font-weight:600; margin-bottom:14px; letter-spacing:-0.2px; }
.erm-cat-tabs { display:flex; gap:4px; margin-bottom:10px; flex-wrap:wrap; }
.erm-cat-tab { padding:4px 10px; border-radius:3px; font-size:11px; cursor:pointer; background:transparent; border:1px solid transparent; color:var(--text-muted); }
.erm-cat-tab.active { background:var(--bg-card); border-color:var(--border); color:var(--text); font-weight:600; }
.erm-q-pills { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px; }
.erm-q-pill { padding:5px 10px; border-radius:16px; font-size:11px; cursor:pointer; background:var(--bg-card); border:1px solid var(--border); color:var(--text-secondary); max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; }
.erm-q-pill.active { background:var(--accent-subtle); border-color:var(--accent); color:var(--accent); }
.erm-split { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
.erm-split-panel { background:var(--bg-card); border-radius:6px; overflow:hidden; }
.erm-split-panel.before { border:1px solid var(--border); }
.erm-split-panel.after { border:1px solid rgba(21,128,61,0.3); }
.erm-split-header { padding:8px 12px; display:flex; justify-content:space-between; align-items:center; }
.erm-split-panel.before .erm-split-header { border-bottom:1px solid var(--border); }
.erm-split-panel.after .erm-split-header { border-bottom:1px solid rgba(21,128,61,0.3); }
.erm-split-body { padding:12px; font-size:12px; line-height:1.7; min-height:60px; color:var(--text-secondary); }
.erm-split-panel.after .erm-split-body { color:var(--text); }
.erm-split-footer { padding:8px 12px; border-top:1px solid var(--border); display:flex; gap:10px; font-size:10px; }
.erm-split-panel.after .erm-split-footer { border-top-color:rgba(21,128,61,0.3); }
.erm-badge { font-size:8px; padding:2px 6px; border-radius:3px; }
.erm-changed { background:var(--bg-card); border-radius:6px; padding:12px 14px; border:1px solid var(--border); margin-bottom:12px; }
.erm-changed-row { display:grid; grid-template-columns:80px 44px 16px 44px; align-items:center; gap:4px; padding:2px 0; font-size:11px; }
.erm-changed-row.highlight { padding:4px 0; border-bottom:1px solid var(--border); }
.erm-downloads { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1px; background:var(--border); border-radius:6px; overflow:hidden; }
.erm-download-item { display:flex; justify-content:space-between; align-items:center; padding:9px 12px; background:var(--bg-card); text-decoration:none; cursor:pointer; transition:background 0.15s; }
.erm-download-item:hover { background:var(--bg-elevated); }
.erm-connect-form { background:var(--bg-card); border-radius:8px; border:1px solid rgba(21,128,61,0.3); padding:20px; }
.erm-connect-btn { width:100%; padding:10px; border-radius:4px; background:var(--accent); color:#fff; border:none; font-weight:600; font-size:14px; cursor:pointer; transition:opacity 0.15s; }
.erm-connect-btn:hover { opacity:0.85; }
.erm-steps { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1px; background:var(--border); border-radius:6px; overflow:hidden; margin-top:12px; }
.erm-step { background:var(--bg-card); padding:10px 12px; }
.erm-gold-grid { display:grid; grid-template-columns:1fr 1fr; gap:1px; background:var(--border); border-radius:6px; overflow:hidden; margin-bottom:20px; }
.erm-gold-item { background:var(--bg-card); padding:10px 14px; }
.erm-compliance-table { background:var(--bg-card); border-radius:6px; overflow:hidden; border:1px solid var(--border); margin-bottom:10px; }
.erm-compliance-row { display:grid; grid-template-columns:24px 46px 1fr auto; align-items:center; gap:8px; padding:6px 12px; border-bottom:1px solid var(--border); font-size:11px; }
.erm-compliance-row:last-child { border-bottom:none; }
.erm-cert-card { background:var(--bg-card); border-radius:6px; border:1px solid rgba(21,128,61,0.3); padding:14px; position:relative; overflow:hidden; align-self:start; }
.erm-cert-stripe { position:absolute; top:0; left:0; right:0; height:2px; background:var(--accent); }
.erm-divider { display:flex; align-items:center; gap:14px; margin:0 0 16px; }
.erm-divider-line { flex:1; height:1px; }
.erm-divider span { font-size:10px; text-transform:uppercase; letter-spacing:2px; color:var(--text-muted); font-weight:600; white-space:nowrap; }
.erm-footer { padding:10px 0; display:flex; justify-content:space-between; align-items:center; border-top:1px solid var(--border); margin-top:8px; }
@media(max-width:768px){.erm-split,.erm-downloads,.erm-steps,.erm-gold-grid{grid-template-columns:1fr}}
</style>

</head>
<body>

<!-- TOAST -->
<div class="toast-container" id="toast-container"></div>

<!-- MOBILE HEADER -->
<div class="mobile-header">
    <button class="hamburger" onclick="toggleAuthMenu()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="logo">
        <svg width="22" height="22" viewBox="0 0 36 36" fill="none"><circle cx="18" cy="18" r="17" fill="white"/><path d="M16 10L20 10L20 26L16 26L16 14L13 14L13 10L16 10Z" fill="#0a0a0a"/></svg>
        <span>ONTO</span>
    </div>
    <div style="width: 40px;"></div>
</div>

<!-- AUTH MENU (burger on login/register screen) -->
<div class="auth-menu" id="auth-menu">
    <div class="auth-menu-header">
        <svg width="24" height="24" viewBox="0 0 36 36" fill="none"><circle cx="18" cy="18" r="17" fill="white"/><path d="M16 10L20 10L20 26L16 26L16 14L13 14L13 10L16 10Z" fill="#0a0a0a"/></svg>
        <span style="font-weight: 700; font-size: 18px;">ONTO</span>
        <button class="auth-menu-close" onclick="closeAuthMenu()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
    </div>
    <nav class="auth-menu-nav">
        <a href="/" class="auth-menu-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
            Home
        </a>
        <a href="/docs/" class="auth-menu-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            Docs
        </a>
        <a href="/docs/#terms" class="auth-menu-sub">Terms of Service</a>
        <a href="/docs/#privacy" class="auth-menu-sub">Privacy Policy</a>
        <a href="/docs/#license" class="auth-menu-sub">License</a>
        <a href="/docs/#specifications" class="auth-menu-sub">Specifications</a>
        <div style="border-top: 1px solid var(--border); margin: 12px 0;"></div>
        <div class="auth-menu-item" onclick="toggleTheme(); closeAuthMenu();" style="cursor: pointer;">
            <svg id="theme-icon-mobile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>
            Theme
        </div>
    </nav>
</div>
<div class="auth-menu-overlay" id="auth-menu-overlay" onclick="closeAuthMenu()"></div>

<div class="mobile-overlay" id="mobile-overlay" onclick="toggleMobile()"></div>

<script>if(localStorage.getItem('onto_logged_in')==='true')document.write('<style id="auth-preload-hide">#auth-screen{display:none!important}</style>');</script>

<!-- AUTH SCREEN -->
<div class="auth-container" id="auth-screen">
    <div class="auth-hero">
        <h1>Make your AI<br>epistemically disciplined.</h1>
        <p>ONTO reduces epistemic error in production LLM systems through deterministic discipline enforcement and auditable scoring.</p>
        <div class="auth-hero-stats">
            <div class="auth-hero-stat">
                <strong>75%</strong>
                <span>Error Reduction</span>
            </div>
            <div class="auth-hero-stat">
                <strong>11</strong>
                <span>Models Tested</span>
            </div>
            <div class="auth-hero-stat">
                <strong>Ed25519</strong>
                <span>Signed Reports</span>
            </div>
        </div>
    </div>
    <div class="auth-form-side">
    <div class="auth-card"><!-- LOGIN FORM -->
        <div id="login-form">
            <h1 class="auth-title">Welcome back</h1>
            <p class="auth-subtitle">Sign in to your account</p>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="you@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-wrapper">
                    <input type="password" class="form-input" id="login-password" placeholder="••••••••">
                    <button type="button" class="password-toggle" onclick="togglePassword('login-password', this)"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>
            <button class="btn btn-primary" id="login-btn" onclick="handleLogin(this)">Sign In</button>
            <p class="auth-switch">Don't have an account? <a onclick="showRegister()">Create one</a></p>
        </div>
        
        <!-- REGISTER FORM -->
        <div id="register-form" class="hidden">
            <h1 class="auth-title">Create Account</h1>
            <p class="auth-subtitle">Free tier — no credit card required</p>
            
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-input" id="reg-name" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="reg-email" placeholder="you@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-wrapper">
                    <input type="password" class="form-input" id="reg-password" placeholder="Min 8 characters">
                    <button type="button" class="password-toggle" onclick="togglePassword('reg-password', this)"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>
            
            <!-- TERMS SCROLL -->
            <div class="terms-container">
                <h3>Terms of Service</h3>
                <p>By creating an account, you agree to the following:</p>
                <p><strong>Service.</strong> ONTO provides AI evaluation and epistemic risk scoring as a hosted service. Your evaluation data, API keys, and account credentials are stored securely and never shared with third parties.</p>
                <p><strong>Acceptable Use.</strong> You may use the ONTO platform to evaluate AI model outputs, track risk scores, and obtain certifications for your organization. Automated abuse, reverse engineering of scoring algorithms, and redistribution of evaluation results without attribution are prohibited.</p>
                <p><strong>Data &amp; Privacy.</strong> We collect email, name, and usage metrics necessary to provide the service. Data is processed in accordance with GDPR. We never sell your data. You may request deletion at any time.</p>
                <p><strong>Billing.</strong> Open tier includes limited evaluations. Standard billed monthly. Certified billed annually. Refund policy applies within 30 days of first payment.</p>
                <p style="margin-top: 12px;"><strong>Full terms:</strong> <a href="/legal" target="_blank">ontostandard.org/legal</a></p>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="terms-agree">
                <label for="terms-agree">I agree to the <a href="/docs/#terms" target="_blank">Terms of Service</a> and <a href="/docs/#privacy" target="_blank">Privacy Policy</a></label>
            </div>
            
            <button class="btn btn-primary" id="register-btn" onclick="handleRegister(this)" disabled>Create Account</button>
            <p class="auth-switch">Already have an account? <a onclick="showLogin()">Sign in</a></p>
        </div>
        
        <!-- OTP VERIFICATION -->
        <div id="verify-pending" class="hidden">
            <div style="text-align: center; margin-bottom: 24px;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
                    <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
            </div>
            <h1 class="auth-title">Enter verification code</h1>
            <p class="auth-subtitle">We sent a 6-digit code to</p>
            <p style="color: var(--text); font-weight: 600; margin: 8px 0 24px;" id="verify-email-display"></p>
            
            <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 24px;">
                <input type="text" id="otp-1" class="otp-input" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                <input type="text" id="otp-2" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-3" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-4" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-5" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-6" class="otp-input" maxlength="1" inputmode="numeric">
            </div>
            
            <p id="otp-error" style="color: #dc2626; font-size: 13px; margin-bottom: 16px; display: none;"></p>
            
            <button class="btn btn-primary" id="verify-btn" onclick="handleVerifyOTP(this)">Verify</button>
            
            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                <p style="color: var(--text-muted); font-size: 13px;">Didn't receive the code?</p>
                <button class="btn btn-secondary" style="margin-top: 12px;" onclick="resendVerification()">Resend code</button>
            </div>
            <p style="color: var(--text-muted); font-size: 12px; margin-top: 16px;">Code expires in 15 minutes</p>
            <p class="auth-switch" style="margin-top: 16px;"><a onclick="showLogin()">Back to sign in</a></p>
        </div>
        
        <!-- EMAIL VERIFIED SUCCESS -->
        <div id="verify-success" class="hidden">
            <div style="text-align: center; margin-bottom: 24px;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
            </div>
            <h1 class="auth-title">Email verified!</h1>
            <p class="auth-subtitle">Your account is ready. You can now sign in.</p>
            <button class="btn btn-primary" style="margin-top: 24px;" onclick="showLogin()">Sign In</button>
        </div>
    </div>
    </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" onclick="showPage('monitor', null); return false;" class="sidebar-logo" style="text-decoration: none; color: inherit;">
                <svg width="32" height="32" viewBox="0 0 36 36" fill="none">
                    <circle cx="18" cy="18" r="17" fill="white"/>
                    <path d="M16 10L20 10L20 26L16 26L16 14L13 14L13 10L16 10Z" fill="#0a0a0a"/>
                </svg>
                <span>ONTO</span>
            </a>
            <div class="sidebar-header-actions">
                <button class="sidebar-close" onclick="toggleMobile()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" onclick="showPage('monitor', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                Risk Monitor
            </div>
            <div class="nav-divider"></div>
            <div class="nav-item" onclick="showPage('sdk', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16,18 22,12 16,6"/><polyline points="8,6 2,12 8,18"/></svg>
                API & SDK
            </div>
            <div class="nav-item" onclick="showPage('billing', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                Billing
            </div>
            <div class="nav-item" onclick="showPage('settings', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
                Account
            </div>
            <div class="nav-item" id="nav-reference" onclick="showReferencePage(this)" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                Reference
            </div>
            <div class="nav-divider"></div>
            <a class="nav-item" href="/docs/" target="_blank" style="text-decoration: none; color: var(--text-muted);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Docs ↗
            </a>
            <div class="nav-item" onclick="toggleTheme()" style="color: var(--text-muted);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>
                Theme
            </div>
            <div class="nav-item" onclick="handleLogout()" style="color: var(--text-muted);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Sign Out
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="user-avatar" id="user-avatar">J</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">John Doe</div>
                    <div class="user-tier" id="user-plan">Open</div>
                </div>
            </div>
        </div>
    </aside>
    
    <main class="main-content">
        <!-- ========== AUDIT PAGE ========== -->
        <div class="page" id="page-audit">

            <!-- === WELCOME BANNER === -->
            <div class="welcome-banner" id="welcome-banner">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
                    <div>
                        <div style="font-size:15px;font-weight:600;margin-bottom:4px">Welcome to ONTO</div>
                        <div style="font-size:12px;color:var(--text-secondary)">The epistemic risk standard for AI. Get your first rolling marker in under a minute.</div>
                    </div>
                    <button onclick="dismissWelcome()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px;font-size:16px;line-height:1">&times;</button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
                    <div style="padding:14px;border:1px solid var(--border);border-radius:6px;background:var(--bg)">
                        <div style="font-size:20px;margin-bottom:6px;opacity:0.6">①</div>
                        <div style="font-size:12px;font-weight:600;margin-bottom:4px">Register a model</div>
                        <div style="font-size:11px;color:var(--text-muted);line-height:1.4">Go to <a onclick="showPage('monitor', document.querySelector('.nav-item[onclick*=monitor]'))" style="color:var(--accent);cursor:pointer">Risk Monitor</a> → Connect your AI model with your provider API key.</div>
                    </div>
                    <div style="padding:14px;border:1px solid var(--border);border-radius:6px;background:var(--bg)">
                        <div style="font-size:20px;margin-bottom:6px;opacity:0.6">②</div>
                        <div style="font-size:12px;font-weight:600;margin-bottom:4px">Evaluate outputs</div>
                        <div style="font-size:11px;color:var(--text-muted);line-height:1.4">Paste AI-generated text below. Each evaluation feeds the Proof of Chain — signed with Ed25519.</div>
                    </div>
                    <div style="padding:14px;border:1px solid var(--border);border-radius:6px;background:var(--bg)">
                        <div style="font-size:20px;margin-bottom:6px;opacity:0.6">③</div>
                        <div style="font-size:12px;font-weight:600;margin-bottom:4px">Rolling marker</div>
                        <div style="font-size:11px;color:var(--text-muted);line-height:1.4">Your marker (L1→L2→L3) recalculates with every eval. <strong>Audit Trail</strong> records cryptographic snapshots of model state.</div>
                    </div>
                </div>
                <div style="margin-top:14px;padding:10px 12px;background:rgba(34,197,94,0.04);border:1px solid rgba(34,197,94,0.1);border-radius:4px;font-size:11px;color:var(--text-secondary);line-height:1.5">
                    <strong style="color:var(--text)">How it works:</strong> Open = diagnostic (limited evals, 5 manual snapshots). Standard ($15K/yr) = unlimited evals, auto-snapshots, drift alerts. Critical ($100K+/yr) = multi-model, regulatory reports, dedicated support.
                </div>
                <div style="margin-top:10px;display:flex;gap:12px;align-items:center">
                    <a href="/docs/" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none;font-weight:500">Documentation →</a>
                    <a href="/verify/" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none;font-weight:500">Public Verify →</a>
                    <span style="font-size:11px;color:var(--text-muted)">or paste an AI output below to start</span>
                </div>
            </div>

            <!-- === STATUS BAR === -->
            <div id="audit-stats-bar" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px">
                <div class="dash-card-clean" style="padding:14px 16px;margin-bottom:0">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Models</div>
                    <div style="display:flex;align-items:baseline;gap:6px">
                        <span style="font-size:22px;font-weight:700;font-variant-numeric:tabular-nums" id="stat-models-count">0</span>
                        <span style="font-size:11px;color:var(--text-muted)">registered</span>
                    </div>
                </div>
                <div class="dash-card-clean" style="padding:14px 16px;margin-bottom:0">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Avg Risk</div>
                    <div style="display:flex;align-items:baseline;gap:6px">
                        <span style="font-size:22px;font-weight:700;font-variant-numeric:tabular-nums" id="stat-avg-risk">—</span>
                        <span style="font-size:11px" id="stat-avg-risk-label" style="color:var(--text-muted)"></span>
                    </div>
                </div>
                <div class="dash-card-clean" style="padding:14px 16px;margin-bottom:0">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Evaluations</div>
                    <div style="display:flex;align-items:baseline;gap:6px">
                        <span style="font-size:22px;font-weight:700;font-variant-numeric:tabular-nums" id="stat-eval-count">0</span>
                        <span style="font-size:11px;color:var(--text-muted)">total</span>
                    </div>
                </div>
                <div class="dash-card-clean" style="padding:14px 16px;margin-bottom:0">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Compliance</div>
                    <div style="display:flex;align-items:baseline;gap:6px">
                        <span style="font-size:22px;font-weight:700;font-variant-numeric:tabular-nums" id="stat-compliance">—</span>
                    </div>
                </div>
            </div>

            <!-- === EVALUATE FORM === -->
            <div class="eval-form-card" id="dash-eval-form">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                    <div>
                        <div style="font-size:15px;font-weight:500">Evaluate AI Output</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Paste any AI output → get risk score with 6-factor analysis</div>
                    </div>
                    <span class="eval-submit-hint" id="dash-eval-hint" style="font-size:10px;color:var(--text-muted)" data-base="Uses 1 API call"></span>
                </div>
                <div class="eval-form-group">
                    <textarea id="dash-eval-output" placeholder="Paste AI-generated text here..." spellcheck="false" style="min-height:80px"></textarea>
                </div>
                <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
                    <div style="width:140px;flex-shrink:0">
                        <label style="display:block;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Domain</label>
                        <select id="dash-eval-domain" class="eval-select">
                            <option value="general">General</option>
                            <option value="medical">Medical</option>
                            <option value="legal">Legal</option>
                            <option value="finance">Finance</option>
                            <option value="safety">Safety</option>
                            <option value="education">Education</option>
                            <option value="chat">Chat</option>
                            <option value="creative">Creative</option>
                        </select>
                    </div>
                    <div style="width:160px;flex-shrink:0">
                        <label style="display:block;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Model <span style="font-weight:400">(opt)</span></label>
                        <select id="dash-eval-model" class="eval-select" onchange="updateEvalHint()">
                            <option value="">—</option>
                        </select>
                    </div>
                    <div class="eval-optional-toggle" onclick="toggleDashEvalAdvanced()" style="margin-bottom:4px;flex-shrink:0">
                        <svg id="dash-eval-chevron" viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" style="transition:transform 0.2s"><polyline points="9,18 15,12 9,6"/></svg>
                        <span style="font-size:11px">Advanced</span>
                    </div>
                    <button class="eval-submit-btn" id="dash-eval-btn" onclick="dashSubmitEval()" style="flex-shrink:0;padding:8px 24px">Evaluate →</button>
                </div>
                <div class="eval-optional-fields" id="dash-eval-advanced" style="margin-top:12px">
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
                        <div>
                            <label style="display:block;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Ground Truth</label>
                            <input type="text" id="dash-eval-gt" placeholder="Correct answer" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:6px 10px;font-size:12px;box-sizing:border-box">
                        </div>
                        <div>
                            <label style="display:block;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Confidence</label>
                            <input type="number" id="dash-eval-conf" min="0" max="1" step="0.01" placeholder="0.0–1.0" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:6px 10px;font-size:12px;box-sizing:border-box">
                        </div>
                        <div>
                            <label style="display:block;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Context</label>
                            <input type="text" id="dash-eval-ctx" placeholder="User prompt" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:6px 10px;font-size:12px;box-sizing:border-box">
                        </div>
                    </div>
                </div>
            </div>

            <!-- === RISK ANALYSIS RESULT (full width) === -->
            <div class="dash-card-clean" id="dash-result-panel" style="margin-bottom:16px">
                <div id="dash-result-empty" style="text-align:center;padding:24px 0;color:var(--text-muted);font-size:12px">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--border);margin-bottom:8px"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                    <div style="font-weight:500;color:var(--text-secondary);margin-bottom:4px">Risk Analysis</div>
                    <div>Results will appear here after evaluation</div>
                </div>
                <div id="dash-result-content" style="display:none">
                    <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border)">
                        <div class="eval-score-ring">
                            <svg viewBox="0 0 80 80">
                                <circle class="ring-bg" cx="40" cy="40" r="34"/>
                                <circle class="ring-fill" id="dash-ring-fill" cx="40" cy="40" r="34" stroke-dasharray="213.6" stroke-dashoffset="213.6"/>
                            </svg>
                            <div class="eval-score-center">
                                <span class="eval-score-value" id="dash-score-val">—</span>
                                <span class="eval-score-label">Risk</span>
                            </div>
                        </div>
                        <div style="flex:1">
                            <div class="eval-compliance-badge" id="dash-comp-badge">—</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px" id="dash-result-meta">—</div>
                        </div>
                    </div>
                    <div style="font-size:10px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Factor Analysis</div>
                    <div class="eval-factors" id="dash-factors">
                        <div class="eval-factor"><span class="eval-factor-name">EM1 · Hedging & Uncertainty</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="df-f1" style="width:0"></div></div><span class="eval-factor-val" id="dv-f1">—</span></div>
                        <div class="eval-factor"><span class="eval-factor-name">EM2 · Confidence Calibration</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="df-f2" style="width:0"></div></div><span class="eval-factor-val" id="dv-f2">—</span></div>
                        <div class="eval-factor"><span class="eval-factor-name">EM3 · Token Entropy</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="df-f3" style="width:0"></div></div><span class="eval-factor-val" id="dv-f3">—</span></div>
                        <div class="eval-factor"><span class="eval-factor-name">EM4 · Semantic Consistency</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="df-f4" style="width:0"></div></div><span class="eval-factor-val" id="dv-f4">—</span></div>
                        <div class="eval-factor"><span class="eval-factor-name">EM5 · Factual Accuracy</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="df-f5" style="width:0"></div></div><span class="eval-factor-val" id="dv-f5">—</span></div>
                        <div class="eval-factor"><span class="eval-factor-name">REP · Refusal Posture</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="df-f6" style="width:0"></div></div><span class="eval-factor-val" id="dv-f6">—</span></div>
                        <div class="eval-factor"><span class="eval-factor-name" style="color:var(--text-muted)">Domain Multiplier</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="df-dm" style="width:0"></div></div><span class="eval-factor-val" id="dv-dm">—</span></div>
                    </div>
                    <div style="margin-top:12px;font-size:10px;color:var(--text-muted)" id="dash-result-signals">—</div>
                    <div id="dash-proof-badge-wrap" style="display:none">
                        <a class="proof-badge" id="dash-proof-badge" href="#" target="_blank" title="Verify this evaluation">
                            <span class="proof-icon">🔒</span>
                            <span class="proof-hash-text" id="dash-proof-hash">—</span>
                            <span class="proof-verify">verify →</span>
                        </a>
                    </div>
                    <!-- Recommendations -->
                    <div id="dash-recs-wrap" style="display:none;margin-top:12px">
                        <div style="font-size:10px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Recommendations</div>
                        <div id="dash-recs-list"></div>
                    </div>
                    <!-- Rolling Marker -->
                    <div id="dash-marker-wrap" style="display:none;margin-top:12px;padding:10px 12px;background:rgba(34,197,94,0.04);border:1px solid rgba(34,197,94,0.15);border-radius:6px">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <span style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Rolling Marker</span>
                                <div style="display:flex;align-items:baseline;gap:8px;margin-top:2px">
                                    <span id="dash-marker-level" style="font-size:20px;font-weight:700;color:#22c55e">—</span>
                                    <span id="dash-marker-risk" style="font-size:11px;color:var(--text-muted)">avg risk: —</span>
                                </div>
                            </div>
                            <div style="text-align:right">
                                <div id="dash-marker-progress" style="font-size:11px;color:var(--text-secondary)">— / — evals</div>
                                <div id="dash-marker-status" style="font-size:10px;color:var(--text-muted);margin-top:2px"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === EVALUATION HISTORY === -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <span class="card-head">Evaluation History</span>
                    <span style="font-size:11px;color:var(--text-muted)" id="dash-history-count">0 evaluations</span>
                </div>
                <div id="dash-history-empty" style="text-align:center;padding:16px 0;color:var(--text-muted);font-size:12px">Paste any AI output above and hit Evaluate to see results here</div>
                <div id="dash-history-rows"></div>
            </div>
        </div>

        <!-- ========== MONITOR PAGE ========== -->
        <div class="page active" id="page-monitor">

            <!-- INSTITUTIONAL HEADER -->
            <div style="padding:24px 0;border-bottom:1px solid var(--border);margin-bottom:20px">
                <div style="font-size:9px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">Epistemic Risk Reduction Protocol</div>
                <div style="font-size:16px;font-weight:600;letter-spacing:-0.3px;margin-bottom:8px;line-height:1.4;max-width:560px">ONTO GOLD is an epistemic discipline layer that reduces over-confidence, enforces source citation, and marks uncertainty in production AI systems.</div>
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;margin-bottom:18px;max-width:560px">The layer is injected server-side via proxy. No model retraining. No code changes. Every response passes through GOLD before reaching the end user. The effect is measurable, reproducible, and cryptographically signed.</div>

                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--border);border-radius:6px;overflow:hidden;margin-bottom:16px">
                    <div style="background:var(--bg-card);padding:14px">
                        <div style="display:flex;align-items:baseline;gap:6px;margin-bottom:4px">
                            <span style="font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--danger)">0.12</span>
                            <span style="color:var(--text-muted);font-size:10px">→</span>
                            <span style="font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--accent)">0.78</span>
                        </div>
                        <div style="font-size:9px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Measured improvement</div>
                        <div style="font-size:10px;color:var(--text-secondary);line-height:1.4">GPT 5.2 · 100Q · cross-domain transfer Δ +0.58 · reproducible</div>
                    </div>
                    <div style="background:var(--bg-card);padding:14px">
                        <div style="font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text);margin-bottom:4px">Ed25519</div>
                        <div style="font-size:9px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Independent certificate</div>
                        <div style="font-size:10px;color:var(--text-secondary);line-height:1.4">Verifiable by regulators, auditors, and clients at ontostandard.org/verify</div>
                    </div>
                    <div style="background:var(--bg-card);padding:14px">
                        <div style="font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text);margin-bottom:4px">104 B</div>
                        <div style="font-size:9px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Proof packet</div>
                        <div style="font-size:10px;color:var(--text-secondary);line-height:1.4">Cryptographic proof chain. SHA-256. Deterministic scoring. Zero AI judge.</div>
                    </div>
                </div>

                <div style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text-muted)">CS-2026-001 · n=100 · regex scoring · open methodology</div>
            </div>

            <!-- DEMO -->
            <div style="margin-bottom:20px">
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:20px">
                    <div style="font-size:14px;font-weight:600;margin-bottom:4px;letter-spacing:-0.2px">Evidence</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-bottom:14px">Same model. Same question. Left panel: raw output. Right panel: output with ONTO GOLD discipline layer active. Scoring is deterministic — regex only, no AI judge.</div>

                    <!-- Category tabs -->
                    <div class="erm-cat-tabs" id="erm-cat-tabs"></div>

                    <!-- Question pills -->
                    <div class="erm-q-pills" id="erm-q-pills"></div>

                    <!-- Split view -->
                    <div class="erm-split">
                        <div class="erm-split-panel before">
                            <div class="erm-split-header">
                                <span style="font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--danger);font-weight:600">Without ONTO</span>
                                <span style="font-size:8px;padding:2px 6px;border-radius:3px;color:var(--text-muted);background:var(--danger-subtle)">Raw</span>
                            </div>
                            <div class="erm-split-body" id="erm-before-body"></div>
                            <div class="erm-split-footer" id="erm-before-footer" style="color:var(--danger)"></div>
                        </div>
                        <div class="erm-split-panel after">
                            <div class="erm-split-header">
                                <span style="font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--accent);font-weight:600">With ONTO</span>
                                <span style="font-size:8px;padding:2px 6px;border-radius:3px;color:var(--accent);background:var(--accent-subtle)">Proxy</span>
                            </div>
                            <div class="erm-split-body" id="erm-after-body"><span style="color:var(--text-muted);font-style:italic">Waiting...</span></div>
                            <div class="erm-split-footer" id="erm-after-footer" style="display:none;color:var(--accent)"></div>
                        </div>
                    </div>

                    <!-- What changed -->
                    <div class="erm-changed" id="erm-changed" style="display:none">
                        <div style="font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:6px">What changed · regex · zero AI</div>
                        <div id="erm-changed-rows"></div>
                    </div>

                    <!-- Downloads -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--border);border-radius:6px;overflow:hidden;margin-top:12px">
                        <a style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg-card);text-decoration:none;cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='var(--bg-card)'" href="#">
                            <div><div style="font-size:11px;color:var(--text);font-weight:500">Full Report</div><div style="font-size:9px;color:var(--text-muted);margin-top:1px">100Q before/after · 12p</div></div>
                            <span style="font-size:8px;font-family:'JetBrains Mono',monospace;color:var(--text-muted);border:1px solid var(--border);border-radius:2px;padding:1px 5px">PDF</span>
                        </a>
                        <a style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg-card);text-decoration:none;cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='var(--bg-card)'" href="#">
                            <div><div style="font-size:11px;color:var(--text);font-weight:500">11-Model Baseline</div><div style="font-size:9px;color:var(--text-muted);margin-top:1px">All models ranked</div></div>
                            <span style="font-size:8px;font-family:'JetBrains Mono',monospace;color:var(--text-muted);border:1px solid var(--border);border-radius:2px;padding:1px 5px">PDF</span>
                        </a>
                        <a style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg-card);text-decoration:none;cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='var(--bg-card)'" href="#">
                            <div><div style="font-size:11px;color:var(--text);font-weight:500">Raw Data + Scorer</div><div style="font-size:9px;color:var(--text-muted);margin-top:1px">Download, run, reproduce</div></div>
                            <span style="font-size:8px;font-family:'JetBrains Mono',monospace;color:var(--text-muted);border:1px solid var(--border);border-radius:2px;padding:1px 5px">ZIP</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- CONNECT -->
            <div style="margin-bottom:20px">
                <div style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Integration</div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:6px;overflow:hidden">
                    <div style="padding:16px 20px;border-bottom:1px solid var(--border)">
                        <div style="font-size:14px;font-weight:600;margin-bottom:4px">One line change</div>
                        <div style="font-size:11px;color:var(--text-secondary);line-height:1.5">Replace your provider's base URL with the ONTO proxy endpoint. GOLD is injected server-side on every request. No SDK required. No model retraining. Certificate issued automatically upon first request.</div>
                    </div>

                    <!-- Code -->
                    <div style="padding:16px 20px;background:#0c0f14;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.7;overflow-x:auto">
                        <div style="color:var(--text-muted);margin-bottom:8px"># Before (direct to provider):</div>
                        <div><span style="color:#e2e8f0">client</span> <span style="color:var(--text-muted)">=</span> <span style="color:#22c55e">OpenAI</span>(<span style="color:rgba(34,197,94,0.7)">api_key</span>=<span style="color:#4ade80">"sk-..."</span>)</div>
                        <div style="height:12px"></div>
                        <div style="color:var(--text-muted);margin-bottom:8px"># After (through ONTO proxy — GOLD injected server-side):</div>
                        <div><span style="color:#e2e8f0">client</span> <span style="color:var(--text-muted)">=</span> <span style="color:#22c55e">OpenAI</span>(</div>
                        <div style="padding-left:24px"><span style="color:rgba(34,197,94,0.7)">api_key</span>=<span style="color:#4ade80">"onto_sk_..."</span>,</div>
                        <div style="padding-left:24px"><span style="color:rgba(34,197,94,0.7)">base_url</span>=<span style="color:#4ade80">"https://api.ontostandard.org/v1/proxy"</span></div>
                        <div>)</div>
                        <div style="height:12px"></div>
                        <div style="color:var(--text-muted)"># Everything else stays the same</div>
                        <div><span style="color:#e2e8f0">response</span> <span style="color:var(--text-muted)">=</span> <span style="color:#e2e8f0">client</span>.<span style="color:#e2e8f0">chat</span>.<span style="color:#e2e8f0">completions</span>.<span style="color:#22c55e">create</span>(</div>
                        <div style="padding-left:24px"><span style="color:rgba(34,197,94,0.7)">model</span>=<span style="color:#4ade80">"gpt-4o"</span>,</div>
                        <div style="padding-left:24px"><span style="color:rgba(34,197,94,0.7)">messages</span>=[{<span style="color:#4ade80">"role"</span>: <span style="color:#4ade80">"user"</span>, <span style="color:#4ade80">"content"</span>: <span style="color:#4ade80">"your question"</span>}]</div>
                        <div>)</div>
                    </div>

                    <!-- What happens -->
                    <div style="padding:12px 20px;border-top:1px solid var(--border);display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:1px">
                        <div style="text-align:center;padding:4px">
                            <div style="font-size:12px;color:var(--accent)">✓</div>
                            <div style="font-size:8px;color:var(--text-muted);margin-top:1px">GOLD injected</div>
                        </div>
                        <div style="text-align:center;padding:4px">
                            <div style="font-size:12px;color:var(--accent)">✓</div>
                            <div style="font-size:8px;color:var(--text-muted);margin-top:1px">Certificate issued</div>
                        </div>
                        <div style="text-align:center;padding:4px">
                            <div style="font-size:12px;color:var(--accent)">✓</div>
                            <div style="font-size:8px;color:var(--text-muted);margin-top:1px">Hash generated</div>
                        </div>
                        <div style="text-align:center;padding:4px">
                            <div style="font-size:12px;color:var(--accent)">✓</div>
                            <div style="font-size:8px;color:var(--text-muted);margin-top:1px">Publicly verifiable</div>
                        </div>
                    </div>

                    <!-- API key -->
                    <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
                        <div style="display:flex;align-items:center;gap:10px">
                            <span style="font-size:10px;color:var(--text-muted)">Your API key:</span>
                            <code style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-secondary);background:#0c0f14;padding:3px 8px;border-radius:3px;border:1px solid var(--border)">onto_sk_••••••••••••</code>
                        </div>
                        <div style="display:flex;gap:6px">
                            <button onclick="copyApiKey()" style="background:none;border:1px solid var(--border);border-radius:3px;padding:3px 10px;font-size:9px;color:var(--text-muted);cursor:pointer;font-family:'Inter',sans-serif" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)'">Copy key</button>
                            <a href="#" onclick="showPage('api');return false" style="font-size:9px;color:var(--text-muted);text-decoration:none;padding:3px 10px;border:1px solid var(--border);border-radius:3px" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--text-muted)'">Full docs →</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HOW GOLD WORKS -->
            <div style="margin-bottom:20px">
                <div style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">How GOLD works</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);border-radius:6px;overflow:hidden">
                    <div style="background:var(--bg-card);padding:12px 14px"><div style="font-size:11px;font-weight:600;margin-bottom:2px">Discipline, not knowledge</div><div style="font-size:10px;color:var(--text-muted);line-height:1.5">Teaches HOW — cite, quantify, mark uncertainty. Zero new facts.</div></div>
                    <div style="background:var(--bg-card);padding:12px 14px"><div style="font-size:11px;font-weight:600;margin-bottom:2px">Never leaves the server</div><div style="font-size:10px;color:var(--text-muted);line-height:1.5">Injected server-side via proxy. You see results, not the document.</div></div>
                    <div style="background:var(--bg-card);padding:12px 14px"><div style="font-size:11px;font-weight:600;margin-bottom:2px">Cross-domain proof</div><div style="font-size:10px;color:var(--text-muted);line-height:1.5">Topics NOT in GOLD improved Δ +0.58. Structure, not answers.</div></div>
                    <div style="background:var(--bg-card);padding:12px 14px"><div style="font-size:11px;font-weight:600;margin-bottom:2px">Zero-AI scoring</div><div style="font-size:10px;color:var(--text-muted);line-height:1.5">Regex only. Same script → same results. Open source.</div></div>
                </div>
            </div>

            <!-- SIGNAL: CERTIFICATE + VERIFICATION (unified) -->
            <div class="signal-panel" id="user-signal-panel">
                <div class="signal-panel-grid"></div>

                <!-- Header (always visible) -->
                <div class="signal-header" style="cursor:pointer" onclick="toggleSignalPanel()">
                    <div class="signal-title-row">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--accent)"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        <span class="signal-title">ONTO VERIFIED</span>
                        <span id="erm-sig-org" style="font-size:11px;color:rgba(255,255,255,0.5);margin-left:8px">Acme Corp · GPT-4o</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px">
                        <div class="signal-live-indicator" id="user-signal-live">
                            <span class="signal-dot"></span>
                            <span id="erm-sig-status-text">ACTIVE</span>
                        </div>
                        <svg id="signal-chevron" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="var(--text-muted)" stroke-width="2" style="transition:transform 0.2s"><polyline points="6,9 12,15 18,9"/></svg>
                    </div>
                </div>

                <!-- Body (collapsible) -->
                <div class="signal-body" id="signal-body-collapsible" style="display:none">

                    <!-- Value proposition -->
                    <div style="font-size:11px;color:rgba(255,255,255,0.6);line-height:1.6;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid rgba(34,197,94,0.1)">
                        This certificate confirms that the model operates under ONTO GOLD epistemic discipline layer. The layer reduces over-confidence, enforces source citation, and marks uncertainty. Certificate is valid while proxy connection is active. Verifiable by regulators, auditors, and clients without authentication.
                    </div>

                    <!-- Cert grid: info + QR -->
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:14px">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;flex:1">
                            <div>
                                <div style="font-size:8px;color:rgba(34,197,94,0.5);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px">Organization</div>
                                <div style="font-size:13px;font-weight:600;color:#e2e8f0">Acme Corp</div>
                                <div style="font-size:9px;color:rgba(255,255,255,0.35);margin-top:1px">GPT-4o · OpenAI</div>
                            </div>
                            <div>
                                <div style="font-size:8px;color:rgba(34,197,94,0.5);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px">Active since</div>
                                <div style="font-size:13px;font-weight:600;color:#e2e8f0;font-variant-numeric:tabular-nums">Feb 15, 2026</div>
                                <div style="font-size:9px;color:rgba(255,255,255,0.35);margin-top:1px">Proxy: active · GOLD: injected</div>
                            </div>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0">
                            <div style="width:64px;height:64px;background:white;border-radius:3px;display:flex;align-items:center;justify-content:center">
                                <canvas id="erm-qr-canvas" width="64" height="64"></canvas>
                            </div>
                            <div style="font-size:7px;color:rgba(34,197,94,0.4);text-transform:uppercase;letter-spacing:0.5px">Verify</div>
                        </div>
                    </div>

                    <!-- Hash + actions -->
                    <div style="background:rgba(0,0,0,0.3);border:1px solid rgba(34,197,94,0.12);border-radius:4px;padding:8px 10px;margin-bottom:10px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
                            <span style="font-size:8px;color:rgba(34,197,94,0.4);text-transform:uppercase;letter-spacing:0.5px">Hash · Ed25519 · 104b · SHA-256</span>
                            <div style="display:flex;gap:3px">
                                <button onclick="ermCopyHash()" style="background:none;border:1px solid rgba(34,197,94,0.15);border-radius:2px;padding:1px 6px;font-size:8px;color:rgba(34,197,94,0.6);cursor:pointer" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='rgba(34,197,94,0.6)'">Copy</button>
                                <button onclick="ermDownloadCert()" style="background:none;border:1px solid rgba(34,197,94,0.15);border-radius:2px;padding:1px 6px;font-size:8px;color:rgba(34,197,94,0.6);cursor:pointer" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='rgba(34,197,94,0.6)'">Download</button>
                            </div>
                        </div>
                        <div id="erm-cert-hash" style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);word-break:break-all;line-height:1.4;letter-spacing:0.3px">loading...</div>
                    </div>

                    <!-- Verify inline -->
                    <div style="display:flex;gap:5px;margin-bottom:8px">
                        <input type="text" id="erm-verify-input" placeholder="Paste hash to verify..." style="flex:1;padding:6px 8px;font-family:'JetBrains Mono',monospace;font-size:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(34,197,94,0.12);border-radius:3px;color:#e2e8f0;outline:none" oninput="ermVerifyHash(this.value)">
                        <div id="erm-verify-result" style="width:30px;display:flex;align-items:center;justify-content:center;border-radius:3px;font-size:14px"></div>
                    </div>
                    <div id="erm-verify-msg" style="font-size:9px;min-height:12px;margin-bottom:12px"></div>

                    <!-- Signal metrics (academic grid) -->
                    <div class="signal-main-row">
                        <div class="signal-id-block">
                            <div class="signal-id" id="user-signal-id"><div class="signal-skeleton-id"></div></div>
                            <div class="signal-hash" id="user-signal-hash"><div class="signal-skeleton-hash"></div></div>
                        </div>
                        <div class="signal-countdown-block">
                            <div class="signal-countdown-label">NEXT</div>
                            <div class="signal-countdown-value" id="user-signal-countdown">—</div>
                        </div>
                    </div>
                    <div class="signal-metrics">
                        <div class="signal-metric"><div class="signal-metric-value" id="user-signal-uptime"><div class="skeleton skeleton-metric"></div></div><div class="signal-metric-label">UPTIME</div></div>
                        <div class="signal-metric"><div class="signal-metric-value" id="user-signal-generated"><div class="skeleton skeleton-metric"></div></div><div class="signal-metric-label">GENERATED</div></div>
                        <div class="signal-metric"><div class="signal-metric-value" id="user-signal-requests"><div class="skeleton skeleton-metric"></div></div><div class="signal-metric-label">REQUESTS</div></div>
                        <div class="signal-metric"><div class="signal-metric-value" id="user-signal-errors"><div class="skeleton skeleton-metric"></div></div><div class="signal-metric-label">ERROR RATE</div></div>
                        <div class="signal-metric"><div class="signal-metric-value">104</div><div class="signal-metric-label">PACKET</div></div>
                        <div class="signal-metric"><div class="signal-metric-value">ED25519</div><div class="signal-metric-label">SIGNATURE</div></div>
                    </div>

                    <!-- Status checks + verify link -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
                        <div style="display:flex;gap:12px">
                            <span id="erm-check-proxy" style="font-size:9px;color:rgba(255,255,255,0.4)"><span style="color:var(--accent)">✓</span> PROXY</span>
                            <span id="erm-check-gold" style="font-size:9px;color:rgba(255,255,255,0.4)"><span style="color:var(--accent)">✓</span> GOLD</span>
                            <span id="erm-check-sig" style="font-size:9px;color:rgba(255,255,255,0.4)"><span style="color:var(--accent)">✓</span> SIG</span>
                            <span id="erm-check-chain" style="font-size:9px;color:rgba(255,255,255,0.4)"><span style="color:var(--accent)">✓</span> CHAIN</span>
                        </div>
                        <span style="font-size:8px;color:rgba(34,197,94,0.4)">ontostandard.org/c/ACM-2026-001</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding:10px 0;display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                <span style="font-size:9px;color:var(--text-muted)">ONTO-SPEC v1.0 · ontostandard.org/verify</span>
                <span style="font-size:9px;color:var(--text-muted)">ONTO does not guarantee accuracy. Not responsible for decisions made by AI systems or their operators.</span>
            </div>
        </div>

        <!-- ========== CERTIFY PAGE ========== -->
        <div class="page" id="page-certify">
            <div class="page-header-clean" style="margin-bottom:20px">
                <h1 class="page-title" style="margin-bottom:2px">Audit Trail</h1>
                <p style="color:var(--text-muted);font-size:12px;margin:0">Cryptographic snapshots record your model's state at a point in time. Ed25519 signed.</p>
            </div>

            <!-- Model selector + snapshot button -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                    <div style="flex:1;min-width:200px">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:block">Model</label>
                        <select id="snap-model-select" class="form-input" style="width:100%;font-size:12px;padding:6px 8px" onchange="loadSnapshots()">
                            <option value="">Select model...</option>
                        </select>
                    </div>
                    <button class="eval-submit-btn" id="snap-create-btn" onclick="createSnapshot()" style="padding:8px 20px;font-size:12px;margin-top:16px" disabled>
                        Create Snapshot
                    </button>
                </div>
            </div>

            <!-- Stats row -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px" id="snap-stats">
                <div class="dash-card-clean" style="text-align:center;padding:12px">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Snapshots</div>
                    <div style="font-size:20px;font-weight:700;font-variant-numeric:tabular-nums;margin-top:4px" id="snap-stat-count">0</div>
                </div>
                <div class="dash-card-clean" style="text-align:center;padding:12px">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Latest Risk</div>
                    <div style="font-size:20px;font-weight:700;font-variant-numeric:tabular-nums;margin-top:4px" id="snap-stat-risk">—</div>
                </div>
                <div class="dash-card-clean" style="text-align:center;padding:12px">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Latest Layer</div>
                    <div style="font-size:20px;font-weight:700;font-variant-numeric:tabular-nums;margin-top:4px" id="snap-stat-layer">—</div>
                </div>
                <div class="dash-card-clean" style="text-align:center;padding:12px">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Freshness</div>
                    <div style="font-size:20px;font-weight:700;font-variant-numeric:tabular-nums;margin-top:4px" id="snap-stat-age">—</div>
                </div>
            </div>

            <!-- Snapshot timeline -->
            <div class="dash-card-clean" style="padding:0">
                <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
                    <span class="card-head">Snapshot Timeline</span>
                    <span style="font-size:10px;color:var(--text-muted)" id="snap-timeline-info"></span>
                </div>
                <div id="snap-timeline-list" style="max-height:420px;overflow-y:auto">
                    <div style="padding:40px;text-align:center;color:var(--text-muted);font-size:12px">
                        Select a model to view snapshots
                    </div>
                </div>
            </div>

            <!-- Tier info -->
            <div class="dash-card-clean" style="margin-top:16px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div class="card-head" style="margin-bottom:4px">Snapshot Limits</div>
                        <div style="font-size:12px;color:var(--text-secondary)">
                            <span style="font-weight:500">Open:</span> 5 manual snapshots per model · 
                            <span style="font-weight:500">Standard:</span> Unlimited + drift alerts · 
                            <span style="font-weight:500">Critical:</span> + regulatory reports
                        </div>
                    </div>
                    <button class="btn-upgrade" id="snap-upgrade-btn" onclick="showPage('billing', document.querySelector('.nav-item[onclick*=billing]'))" style="font-size:12px;padding:8px 20px">Upgrade →</button>
                </div>
            </div>
        </div>

        <!-- ========== API & SDK PAGE ========== -->
        <div class="page" id="page-sdk">
            <div class="page-header-clean" style="margin-bottom:20px">
                <h1 class="page-title" style="margin-bottom:2px">API & SDK</h1>
                <p style="color:var(--text-muted);font-size:12px;margin:0">Integrate ONTO evaluation into your pipeline</p>
            </div>

            <!-- API Key -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div class="card-head" style="margin-bottom:12px">API Key</div>
                <div class="key-row">
                    <input type="password" class="key-input" id="api-key-display" value="onto_sk_demo_key_12345" readonly>
                    <div class="key-buttons">
                        <button class="btn-minimal" onclick="toggleApiKeyVisibility()" id="toggle-key-btn">Show</button>
                        <button class="btn-minimal" onclick="copyApiKey(this)">Copy</button>
                    </div>
                </div>
                <div class="key-meta">
                    <span id="key-created">Created: —</span>
                    <span id="key-last-used">Last used: —</span>
                </div>
                <button class="btn-danger-outline" onclick="regenerateApiKey(this)" style="margin-top:10px;font-size:11px">Regenerate</button>
            </div>

            <!-- Quick Start -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div class="card-head" style="margin-bottom:12px">Quick Start</div>
                <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Use ONTO Proxy (one line change)</div>
                <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:16px;overflow-x:auto;line-height:1.6"><code><span style="color:var(--text-muted)"># Before (direct to OpenAI):</span>
client = OpenAI(api_key=<span style="color:#4ade80">"sk-..."</span>)

<span style="color:var(--text-muted)"># After (through ONTO proxy — GOLD injected server-side):</span>
client = OpenAI(
    api_key=<span style="color:#4ade80">"onto_sk_..."</span>,
    base_url=<span style="color:#4ade80">"https://api.ontostandard.org/v1/proxy"</span>
)

<span style="color:var(--text-muted)"># Everything else stays the same</span>
response = client.chat.completions.create(
    model=<span style="color:#4ade80">"gpt-4o"</span>,
    messages=[{<span style="color:#4ade80">"role"</span>: <span style="color:#4ade80">"user"</span>, <span style="color:#4ade80">"content"</span>: <span style="color:#4ade80">"Your question"</span>}]
)</code></pre>
                <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Run Evaluation</div>
                <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;margin-bottom:16px;overflow-x:auto;line-height:1.6"><code><span style="color:#22c55e">import</span> onto

client = onto.Client(api_key=<span style="color:#4ade80">"onto_sk_..."</span>)

<span style="color:var(--text-muted)"># Runs 100 Q baseline + 100 Q with GOLD → before/after report</span>
report = client.evaluate(model_id=<span style="color:#4ade80">"your-model-id"</span>)

print(report.baseline)     <span style="color:var(--text-muted)"># 0.53 (Grade D)</span>
print(report.treatment)    <span style="color:var(--text-muted)"># 5.38 (Grade A-)</span>
print(report.improvement)  <span style="color:var(--text-muted)"># error_reduction: 75%</span></code></pre>
                <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">cURL</div>
                <pre style="background:#0c0f14;color:#e2e8f0;padding:12px 16px;border-radius:6px;font-size:12px;overflow-x:auto;line-height:1.6"><code>curl -X POST https://api.ontostandard.org/v1/models/evaluate \
  -H "x-api-key: onto_sk_..." \
  -H "Content-Type: application/json" \
  -d '{"output": "AI response text", "domain": "general"}'</code></pre>
            </div>

            <!-- Rate Limits -->
            <div class="dash-card-clean" style="margin-bottom:16px">
                <div class="card-head" style="margin-bottom:12px">Rate Limits</div>
                <table style="width:100%;border-collapse:collapse;font-size:12px">
                    <tr style="border-bottom:1px solid var(--border)">
                        <th style="text-align:left;padding:8px 10px;font-weight:500;color:var(--text-muted);font-size:10px;text-transform:uppercase">Tier</th>
                        <th style="text-align:left;padding:8px 10px;font-weight:500;color:var(--text-muted);font-size:10px;text-transform:uppercase">Rate</th>
                        <th style="text-align:left;padding:8px 10px;font-weight:500;color:var(--text-muted);font-size:10px;text-transform:uppercase">Persistence</th>
                        <th style="text-align:left;padding:8px 10px;font-weight:500;color:var(--text-muted);font-size:10px;text-transform:uppercase">Certification</th>
                    </tr>
                    <tr style="border-bottom:1px solid var(--border)">
                        <td style="padding:8px 10px;font-weight:500">Open</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">10/hr · 50/day</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Full API</td>
                        <td style="padding:8px 10px;color:var(--text-muted)">Marker only (diagnostic)</td>
                    </tr>
                    <tr style="border-bottom:1px solid var(--border)">
                        <td style="padding:8px 10px;font-weight:500">Standard</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Unlimited</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Full API + Proof Chain</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Marker (internal)</td>
                    </tr>
                    <tr>
                        <td style="padding:8px 10px;font-weight:500">Certified</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Unlimited</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">Full API + Proof Chain + Audit</td>
                        <td style="padding:8px 10px;color:var(--text-secondary)">L1 · L2 · L3 (public cert)</td>
                    </tr>
                </table>
                <div style="margin-top:12px">
                    <a href="/docs/" target="_blank" style="font-size:12px;color:var(--accent);text-decoration:none;font-weight:500">Full API documentation →</a>
                </div>
            </div>

            <!-- Current plan -->
            <div class="dash-card-clean">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div class="card-head" style="margin-bottom:4px">Current Plan</div>
                        <div style="font-size:13px"><span style="font-weight:600" id="sdk-plan-name">Open</span> · <span style="color:var(--text-muted)" id="sdk-plan-rate">1 request / hour</span></div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:4px" id="sdk-plan-calls">0 / 10 calls used</div>
                    </div>
                    <button class="btn-upgrade" id="sdk-upgrade-btn" onclick="showPage('billing', document.querySelector('.nav-item[onclick*=billing]'))" style="font-size:12px;padding:8px 20px">Upgrade →</button>
                </div>
            </div>
        </div>
        
        <!-- EVALUATE PAGE -->
        <div class="page" id="page-evaluate">
            <div class="page-header-clean">
                <h1 class="page-title">Score AI Output</h1>
                <p class="page-subtitle" style="color: var(--text-secondary); font-size: 12px; margin-top: 2px;">Submit AI output for epistemic risk scoring. See factor breakdown in real-time.</p>
            </div>

            <!-- Submission Form -->
            <div class="eval-form-card">
                <div class="eval-form-group">
                    <label for="eval-output">AI Output <span style="color:var(--text-muted);font-weight:400;text-transform:none">— paste the model response to analyze</span></label>
                    <textarea id="eval-output" placeholder="Paste AI-generated text here...&#10;&#10;Example: Take 500mg ibuprofen twice daily for pain." spellcheck="false"></textarea>
                </div>

                <div class="eval-form-row">
                    <div class="eval-form-group">
                        <label for="eval-domain">Domain</label>
                        <select id="eval-domain">
                            <option value="general">General</option>
                            <option value="medical">Medical</option>
                            <option value="legal">Legal</option>
                            <option value="finance">Finance</option>
                            <option value="safety">Safety</option>
                            <option value="education">Education</option>
                            <option value="chat">Chat</option>
                            <option value="creative">Creative</option>
                        </select>
                    </div>
                    <div class="eval-form-group">
                        <label for="eval-model-select">Model <span style="color:var(--text-muted);font-weight:400;text-transform:none">— optional</span></label>
                        <select id="eval-model-select">
                            <option value="">— none —</option>
                        </select>
                    </div>
                </div>

                <div class="eval-optional-toggle" onclick="toggleEvalOptional()">
                    <svg id="eval-opt-chevron" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="transition:transform 0.2s"><polyline points="9,18 15,12 9,6"/></svg>
                    Advanced options (ground truth, confidence)
                </div>
                <div class="eval-optional-fields" id="eval-optional">
                    <div class="eval-form-group">
                        <label for="eval-gt">Ground Truth <span style="color:var(--text-muted);font-weight:400;text-transform:none">— correct answer for accuracy check</span></label>
                        <textarea id="eval-gt" style="min-height:60px" placeholder="Optional: the factually correct answer"></textarea>
                    </div>
                    <div class="eval-form-row">
                        <div class="eval-form-group">
                            <label for="eval-confidence">Model Confidence <span style="color:var(--text-muted);font-weight:400;text-transform:none">— 0.0 to 1.0</span></label>
                            <input type="number" id="eval-confidence" min="0" max="1" step="0.01" placeholder="e.g. 0.85">
                        </div>
                        <div class="eval-form-group">
                            <label for="eval-context">Context / Prompt <span style="color:var(--text-muted);font-weight:400;text-transform:none">— optional</span></label>
                            <input type="text" id="eval-context" placeholder="What was the user asking?" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:8px 12px;font-size:13px;box-sizing:border-box;">
                        </div>
                    </div>
                </div>

                <div class="eval-submit-row">
                    <span class="eval-submit-hint" id="eval-hint">Uses 1 API call from your quota</span>
                    <button class="eval-submit-btn" id="eval-submit-btn" onclick="submitEvaluation()">Evaluate →</button>
                </div>
            </div>

            <!-- Results -->
            <div class="eval-result-card" id="eval-result-card">
                <div class="eval-result-header">
                    <div class="eval-score-ring">
                        <svg viewBox="0 0 80 80">
                            <circle class="ring-bg" cx="40" cy="40" r="34"/>
                            <circle class="ring-fill" id="eval-ring-fill" cx="40" cy="40" r="34" stroke-dasharray="213.6" stroke-dashoffset="213.6"/>
                        </svg>
                        <div class="eval-score-center">
                            <span class="eval-score-value" id="eval-score-value">—</span>
                            <span class="eval-score-label">Risk</span>
                        </div>
                    </div>
                    <div class="eval-result-meta">
                        <div class="eval-compliance-badge" id="eval-compliance-badge">—</div>
                        <div class="eval-result-domain" id="eval-result-domain">—</div>
                        <div class="eval-result-timestamp" id="eval-result-timestamp">—</div>
                    </div>
                </div>

                <div style="font-size:11px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Factor Breakdown</div>
                <div class="eval-factors" id="eval-factors">
                    <div class="eval-factor"><span class="eval-factor-name">EM1 · Hedging & Uncertainty</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="ef-f1" style="width:0"></div></div><span class="eval-factor-val" id="ev-f1">—</span></div>
                    <div class="eval-factor"><span class="eval-factor-name">EM2 · Confidence Calibration</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="ef-f2" style="width:0"></div></div><span class="eval-factor-val" id="ev-f2">—</span></div>
                    <div class="eval-factor"><span class="eval-factor-name">EM3 · Token Entropy</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="ef-f3" style="width:0"></div></div><span class="eval-factor-val" id="ev-f3">—</span></div>
                    <div class="eval-factor"><span class="eval-factor-name">EM4 · Semantic Consistency</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="ef-f4" style="width:0"></div></div><span class="eval-factor-val" id="ev-f4">—</span></div>
                    <div class="eval-factor"><span class="eval-factor-name">EM5 · Factual Accuracy</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="ef-f5" style="width:0"></div></div><span class="eval-factor-val" id="ev-f5">—</span></div>
                    <div class="eval-factor"><span class="eval-factor-name">REP · Refusal Posture</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="ef-f6" style="width:0"></div></div><span class="eval-factor-val" id="ev-f6">—</span></div>
                    <div class="eval-factor"><span class="eval-factor-name">Domain Multiplier</span><div class="eval-factor-bar-wrap"><div class="eval-factor-bar" id="ef-dm" style="width:0"></div></div><span class="eval-factor-val" id="ev-dm">—</span></div>
                </div>
            </div>

            <!-- Session History -->
            <div class="eval-history" id="eval-history">
                <div class="eval-history-title">Session History</div>
                <div class="eval-history-empty" id="eval-history-empty">Submit an AI output above to see risk analysis here</div>
                <div id="eval-history-rows"></div>
            </div>
        </div>
        
        <!-- SETTINGS PAGE -->
        <div class="page" id="page-settings">
            <div class="page-header-clean">
                <h1 class="page-title">Account</h1>
            </div>
            
            <div class="section-block">
                <div class="section-label">Identity</div>
                <div class="info-row">
                    <span class="info-key">Name</span>
                    <span class="info-val" id="settings-name">John Doe</span>
                    <span class="info-action" onclick="editProfile()">Edit</span>
                </div>
                <div class="info-row">
                    <span class="info-key">Email</span>
                    <span class="info-val" id="settings-email">support@ontostandard.org</span>
                </div>
                <div class="info-row">
                    <span class="info-key">Type</span>
                    <span class="info-val" id="settings-account-type">Individual</span>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-label">Organization</div>
                <div id="company-not-registered">
                    <p class="section-text">No organization registered. Required for institutional access tier.</p>
                    <button class="btn-minimal" onclick="openCompanyModal()">Register Organization</button>
                </div>
                <div id="company-registered" class="hidden">
                    <div class="info-row">
                        <span class="info-key">Name</span>
                        <span class="info-val" id="company-name">—</span>
                        <span class="info-action" onclick="openCompanyModal()">Edit</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Industry</span>
                        <span class="info-val" id="company-industry">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Registration</span>
                        <span class="info-val" id="company-reg">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Status</span>
                        <span class="info-val status-active"><span class="dot"></span>Verified</span>
                    </div>
                </div>
            </div>
            
            <div class="section-block" id="subscription-block">
                <div class="section-label">Subscription</div>
                <div id="subscription-none">
                    <p class="section-text">No active subscription. Using Free tier (1 request/hour).</p>
                    <button class="btn-minimal" onclick="showPage('billing')">View Plans</button>
                </div>
                <div id="subscription-active" class="hidden">
                    <div class="info-row">
                        <span class="info-key">Active Plan</span>
                        <span class="info-val" id="sub-plan">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Rate Limit</span>
                        <span class="info-val" id="sub-rate">—</span>
                    </div>
                    <div class="info-row" id="sub-critical-row">
                        <span class="info-key">Certified</span>
                        <span class="info-val" id="sub-critical-days">—</span>
                    </div>
                    <div class="info-row" id="sub-pro-row">
                        <span class="info-key">Standard</span>
                        <span class="info-val" id="sub-pro-days">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">All Expires</span>
                        <span class="info-val" id="sub-expires">—</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Total Paid</span>
                        <span class="info-val" id="sub-total">—</span>
                    </div>
                    <button class="btn-minimal" onclick="showPage('billing')" style="margin-top: 12px;">Extend Subscription</button>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-label">Documents</div>
                <div class="doc-row">
                    <span class="doc-name">Specifications & Policies</span>
                    <span class="doc-link" onclick="window.open('/docs/', '_blank')">View</span>
                </div>
                <div class="doc-row" id="invoice-row">
                    <span class="doc-name">Invoice</span>
                    <span class="doc-status" id="invoice-status">No active subscription</span>
                    <span class="doc-link hidden" id="invoice-download" onclick="downloadInvoice()">Download</span>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-label">Support</div>
                <div class="info-row">
                    <span class="info-key">General</span>
                    <a class="info-val" href="mailto:support@ontostandard.org">support@ontostandard.org</a>
                </div>
                <div class="info-row">
                    <span class="info-key">Sales</span>
                    <a class="info-val" href="mailto:support@ontostandard.org">support@ontostandard.org</a>
                </div>
                <div class="info-row">
                    <span class="info-key">Billing</span>
                    <a class="info-val" href="mailto:support@ontostandard.org">support@ontostandard.org</a>
                </div>
            </div>
        </div>
        
        <!-- BILLING PAGE -->
        <div class="page" id="page-billing">
            <div class="page-header-clean">
                <h1 class="page-title">Access Tiers</h1>
            </div>
            
            <div class="tiers-grid">
                <!-- OPEN -->
                <div class="tier-card" id="card-free">
                    <div class="tier-name">Open</div>
                    <div class="tier-price">$0</div>
                    <div class="tier-desc">Diagnostic access — see your AI's risk profile</div>
                    <ul class="tier-list">
                        <li>10 evaluations/hour</li>
                        <li>50/day · ~1,500/month</li>
                        <li>Rolling marker (informational)</li>
                        <li>No certification</li>
                        <li>Attribution required</li>
                    </ul>
                    <button class="btn-tier current" id="btn-free" disabled>Current</button>
                </div>
                
                <!-- STANDARD -->
                <div class="tier-card" id="card-business">
                    <div class="tier-name">Standard</div>
                    <div class="tier-price">$1,500<span>/month</span></div>
                    <div class="tier-desc">Unlimited access to ONTO core — calibrate your AI</div>
                    <ul class="tier-list">
                        <li>Unlimited evaluations</li>
                        <li>Real-time Proof of Chain</li>
                        <li>Rolling marker L1/L2/L3</li>
                        <li>Internal diagnostics only</li>
                        <li>No public certification</li>
                    </ul>
                    <button class="btn-tier" id="btn-business" onclick="openSubscribeModal('business')">Select</button>
                </div>
                
                <!-- CERTIFIED -->
                <div class="tier-card" id="card-enterprise">
                    <div class="tier-name">Certified</div>
                    <div class="tier-price">$100,000<span>/year</span></div>
                    <div class="tier-desc">ONTO CERTIFIED — prove your AI quality to regulators</div>
                    <ul class="tier-list">
                        <li>Everything in Standard</li>
                        <li>Rolling certification (L2/L3)</li>
                        <li>Public registry listing</li>
                        <li>ONTO CERTIFIED badge</li>
                        <li>24-month audit trail</li>
                        <li>99.99% SLA · Priority support</li>
                    </ul>
                    <button class="btn-tier" id="btn-enterprise" onclick="openSubscribeModal('enterprise')">Select</button>
                    <button class="btn-tier-secondary" onclick="contactSales()">Contact</button>
                </div>
            </div>
            
            <p class="section-footnote" style="text-align: center; margin-top: 24px;">
                Invoice payment requires registered organization. <a href="#" onclick="showPage('settings')">Account settings</a>
            </p>
        </div>
        <!-- REFERENCE PAGE (ADMIN) -->
        <div class="page" id="page-reference">
            <h1 class="page-title" style="margin-bottom:2px">Reference</h1>
            <p style="color:var(--text-muted);font-size:12px;margin:0 0 20px 0">Admin panel</p>

            <!-- ACCOUNTS -->
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:6px;overflow:hidden">
                <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
                    <div style="font-size:14px;font-weight:600">Accounts</div>
                    <input type="text" id="account-search" placeholder="Search email..." oninput="filterAccounts()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:5px 10px;font-size:11px;color:var(--text);width:200px">
                </div>
                <div style="padding:8px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
                    <select id="filter-type" onchange="filterAccounts()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;color:var(--text-secondary)">
                        <option value="">All Types</option>
                        <option value="individual">Individual</option>
                        <option value="organization">Organization</option>
                    </select>
                    <select id="filter-status" onchange="filterAccounts()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;color:var(--text-secondary)">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                    </select>
                    <select id="filter-plan" onchange="filterAccounts()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;color:var(--text-secondary)">
                        <option value="">All Plans</option>
                        <option value="open">Open</option>
                        <option value="standard">Standard</option>
                        <option value="certified">Certified</option>
                    </select>
                </div>
                <div id="accounts-list" style="font-size:12px"></div>
            </div>
        </div>

    </main>
</div>

<!-- COMPANY REGISTRATION MODAL -->
<div class="modal-overlay" id="company-modal">
    <div class="modal modal-wide modal-inst">
        <div class="modal-header">
            <h2>Organization Registration</h2>
            <button class="modal-close" onclick="closeModal('company-modal')">&times;</button>
        </div>
        <div class="modal-body form-inst">
            <div class="form-section">
                <div class="form-section-title">Legal Entity</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Legal Name *</label>
                        <input type="text" class="form-input" id="company-name-input" placeholder="e.g. Acme Corporation Inc.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Entity Type *</label>
                        <select class="form-input" id="company-type-input">
                            <option value="">Select type...</option>
                            <option value="corporation">Corporation</option>
                            <option value="llc">LLC</option>
                            <option value="llp">LLP</option>
                            <option value="partnership">Partnership</option>
                            <option value="foundation">Foundation</option>
                            <option value="nonprofit">Non-Profit</option>
                            <option value="university">University / Research</option>
                            <option value="government">Government</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Industry *</label>
                        <select class="form-input" id="company-industry-input">
                            <option value="">Select industry...</option>
                            <optgroup label="High-Risk Sectors">
                                <option value="healthcare">Healthcare & Medical</option>
                                <option value="financial">Financial Services</option>
                                <option value="legal">Legal Services</option>
                                <option value="insurance">Insurance</option>
                                <option value="aerospace">Aerospace</option>
                                <option value="defense">Defense & Security</option>
                                <option value="autonomous">Autonomous Systems</option>
                                <option value="energy">Energy & Utilities</option>
                                <option value="infrastructure">Critical Infrastructure</option>
                            </optgroup>
                            <optgroup label="Technology">
                                <option value="ai_ml">AI / Machine Learning</option>
                                <option value="software">Software & SaaS</option>
                                <option value="cloud">Cloud Services</option>
                                <option value="cybersecurity">Cybersecurity</option>
                                <option value="data">Data & Analytics</option>
                            </optgroup>
                            <optgroup label="Other Sectors">
                                <option value="manufacturing">Manufacturing</option>
                                <option value="retail">Retail & E-commerce</option>
                                <option value="education">Education</option>
                                <option value="media">Media & Entertainment</option>
                                <option value="consulting">Consulting</option>
                                <option value="research">Research & Academia</option>
                                <option value="government">Government & Public</option>
                                <option value="other">Other</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Registration Number *</label>
                        <input type="text" class="form-input" id="company-reg-input" placeholder="e.g. 12-3456789">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tax ID / VAT</label>
                        <input type="text" class="form-input" id="company-vat-input" placeholder="Optional">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-section-title">Registered Address</div>
                <div class="form-group">
                    <label class="form-label">Street Address *</label>
                    <input type="text" class="form-input" id="company-address-input" placeholder="123 Main Street, Suite 100">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <input type="text" class="form-input" id="company-city-input" placeholder="New York">
                    </div>
                    <div class="form-group">
                        <label class="form-label">State / Province</label>
                        <input type="text" class="form-input" id="company-state-input" placeholder="NY">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Postal Code *</label>
                        <input type="text" class="form-input" id="company-postal-input" placeholder="10001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country *</label>
                        <select class="form-input" id="company-country-input">
                            <option value="">Select country...</option>
                            <optgroup label="Common">
                                <option value="US">United States</option>
                                <option value="GB">United Kingdom</option>
                                <option value="DE">Germany</option>
                                <option value="FR">France</option>
                                <option value="CH">Switzerland</option>
                                <option value="SG">Singapore</option>
                                <option value="AE">UAE</option>
                                <option value="JP">Japan</option>
                            </optgroup>
                            <optgroup label="Americas">
                                <option value="AR">Argentina</option>
                                <option value="BR">Brazil</option>
                                <option value="CA">Canada</option>
                                <option value="CL">Chile</option>
                                <option value="CO">Colombia</option>
                                <option value="MX">Mexico</option>
                                <option value="PE">Peru</option>
                            </optgroup>
                            <optgroup label="Europe">
                                <option value="AT">Austria</option>
                                <option value="BE">Belgium</option>
                                <option value="CZ">Czech Republic</option>
                                <option value="DK">Denmark</option>
                                <option value="EE">Estonia</option>
                                <option value="FI">Finland</option>
                                <option value="GR">Greece</option>
                                <option value="HU">Hungary</option>
                                <option value="IE">Ireland</option>
                                <option value="IT">Italy</option>
                                <option value="LU">Luxembourg</option>
                                <option value="NL">Netherlands</option>
                                <option value="NO">Norway</option>
                                <option value="PL">Poland</option>
                                <option value="PT">Portugal</option>
                                <option value="RO">Romania</option>
                                <option value="ES">Spain</option>
                                <option value="SE">Sweden</option>
                            </optgroup>
                            <optgroup label="Asia Pacific">
                                <option value="AU">Australia</option>
                                <option value="CN">China</option>
                                <option value="HK">Hong Kong</option>
                                <option value="IN">India</option>
                                <option value="ID">Indonesia</option>
                                <option value="KR">South Korea</option>
                                <option value="MY">Malaysia</option>
                                <option value="NZ">New Zealand</option>
                                <option value="PH">Philippines</option>
                                <option value="TW">Taiwan</option>
                                <option value="TH">Thailand</option>
                                <option value="VN">Vietnam</option>
                            </optgroup>
                            <optgroup label="Middle East & Africa">
                                <option value="BH">Bahrain</option>
                                <option value="EG">Egypt</option>
                                <option value="IL">Israel</option>
                                <option value="KW">Kuwait</option>
                                <option value="QA">Qatar</option>
                                <option value="SA">Saudi Arabia</option>
                                <option value="ZA">South Africa</option>
                                <option value="TR">Turkey</option>
                            </optgroup>
                            <optgroup label="CIS">
                                <option value="KZ">Kazakhstan</option>
                                <option value="UZ">Uzbekistan</option>
                                <option value="AZ">Azerbaijan</option>
                                <option value="GE">Georgia</option>
                                <option value="AM">Armenia</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="OTHER">Other</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-section-title">Contact</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Organization Email *</label>
                        <input type="email" class="form-input" id="company-email-input" placeholder="contact@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="company-phone-input" placeholder="+1 (555) 123-4567">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-section-title">Authorized Representative</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-input" id="signatory-name-input" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="signatory-title-input" placeholder="Chief Technology Officer">
                    </div>
                </div>
            </div>
            
            <div class="form-section" style="border-bottom: none; padding-bottom: 0;">
                <div class="form-section-title">Agreement</div>
                <div class="agreement-notice">
                    By registering, the organization agrees to the Master Service Agreement including limitation of liability provisions. 
                    <a href="/docs/#terms" target="_blank">View Terms of Service ↗</a>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="msa-agree">
                    <label for="msa-agree">I have read and accept the Master Service Agreement</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="msa-authorized">
                    <label for="msa-authorized">I am authorized to bind this organization</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('company-modal')">Cancel</button>
            <div onclick="if(document.getElementById('register-company-btn').disabled) highlightEmptyFields();" style="display:inline-block;">
                <button class="btn-minimal" id="register-company-btn" onclick="registerCompany()" disabled style="background: var(--accent); color: white; border-color: var(--accent);">Register</button>
            </div>
        </div>
    </div>
</div>

<!-- SUBSCRIBE MODAL -->
<!-- CONTACT SALES MODAL -->
<!-- SUBSCRIBE MODAL -->
<div class="modal-overlay" id="subscribe-modal">
    <div class="modal modal-inst" style="max-width: 440px;">
        <div class="modal-header">
            <h2><span id="subscribe-plan-name">Standard</span> Tier</h2>
            <button class="modal-close" onclick="closeModal('subscribe-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="order-section">
                <div class="form-section-title">Includes</div>
                <div class="order-features" id="order-features">
                    <div class="order-feature">Unlimited evaluations</div>
                    <div class="order-feature">Real-time Proof of Chain</div>
                    <div class="order-feature">Rolling marker L1/L2/L3</div>
                    <div class="order-feature">Internal diagnostics</div>
                </div>
            </div>
            <div class="order-section">
                <div class="form-section-title">Billing</div>
                <div class="billing-options">
                    <label class="billing-option" id="billing-annual">
                        <input type="radio" name="billing-cycle" value="annual" checked onchange="updateOrderSummary()">
                        <span class="billing-option-content">
                            <span class="billing-option-name">Annual</span>
                            <span class="billing-option-detail">Billed once per year</span>
                        </span>
                        <span class="billing-option-price" id="price-annual-display">$15,000</span>
                    </label>
                    <label class="billing-option" id="billing-monthly">
                        <input type="radio" name="billing-cycle" value="monthly" onchange="updateOrderSummary()">
                        <span class="billing-option-content">
                            <span class="billing-option-name">Monthly</span>
                            <span class="billing-option-detail">Billed each month</span>
                        </span>
                        <span class="billing-option-price" id="price-monthly-display">$1,500/mo</span>
                    </label>
                </div>
            </div>
            <div class="order-section">
                <div class="form-section-title">Payment Method</div>
                <div class="payment-options">
                    <label class="payment-opt" id="payment-invoice">
                        <input type="radio" name="payment-method" value="invoice" checked>
                        <span class="payment-opt-name">Invoice</span>
                        <span class="payment-opt-note">Annual only</span>
                    </label>
                    <label class="payment-opt" id="payment-card">
                        <input type="radio" name="payment-method" value="card">
                        <span class="payment-opt-name">Card</span>
                        <span class="payment-opt-note">Monthly only</span>
                    </label>
                </div>
            </div>
            <div class="order-summary">
                <div class="order-summary-row">
                    <span class="order-summary-label" id="summary-plan">Standard - Annual</span>
                    <span class="order-summary-value" id="summary-price">$15,000</span>
                </div>
                <div class="order-summary-row total">
                    <span class="order-summary-label">Total due</span>
                    <span class="order-summary-value" id="summary-total">$15,000</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('subscribe-modal')">Cancel</button>
            <button class="btn-minimal" onclick="processPayment()" style="background: var(--accent); color: white; border-color: var(--accent);">Proceed to Payment</button>
        </div>
    </div>
</div>

<!-- PAYMENT PENDING MODAL -->
<div class="modal-overlay" id="payment-modal">
    <div class="modal modal-inst" style="max-width: 380px; text-align: center;">
        <div class="modal-body" style="padding: 36px;">
            <div style="font-size: 36px; margin-bottom: 12px;">&#x1F680;</div>
            <h2 style="font-size: 15px; font-weight: 500; margin-bottom: 6px;">Complete Payment</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 12px;">You will be redirected to our secure payment provider.</p>
            <button class="btn btn-primary" onclick="redirectToAirwallex()">Continue to Payment</button>
            <p style="margin-top: 12px; font-size: 11px; color: var(--text-muted);">Questions? Contact <a href="mailto:support@ontostandard.org">support@ontostandard.org</a></p>
        </div>
    </div>
</div>


<div class="modal-overlay" id="contact-modal">
    <div class="modal modal-inst" style="max-width: 440px;">
        <div class="modal-header">
            <h2>Contact Sales</h2>
            <button class="modal-close" onclick="closeModal('contact-modal')">&times;</button>
        </div>
        <div class="modal-body form-inst">
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                For Certified tier, custom integrations, or enterprise requirements.
            </p>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" id="contact-name" placeholder="Your name">
            </div>
            <div class="form-group">
                <label class="form-label">Organization</label>
                <input type="text" class="form-input" id="contact-org" placeholder="Company name">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="contact-email" placeholder="work@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Message</label>
                <textarea class="form-input" id="contact-message" rows="3" placeholder="Tell us about your requirements..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('contact-modal')">Cancel</button>
            <button class="btn-minimal" onclick="submitContactForm()" style="background: var(--accent); color: white; border-color: var(--accent);">Send</button>
        </div>
    </div>
</div>

<!-- TIER EDITOR MODAL -->
<div class="modal-overlay" id="tier-modal">
    <div class="modal modal-inst" style="max-width: 400px;">
        <div class="modal-header">
            <h2>Edit Plan</h2>
            <button class="modal-close" onclick="closeModal('tier-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="tier-user-info" id="tier-user-info">
                <div class="tier-user-email">support@ontostandard.org</div>
            </div>
            <div class="tier-options">
                <label class="tier-option" data-tier="open">
                    <input type="radio" name="tier-select" value="open">
                    <div class="tier-option-content">
                        <div class="tier-option-header">
                            <span class="tier-badge tier-open">OPEN</span>
                            <span class="tier-option-price">Free</span>
                        </div>
                        <div class="tier-option-desc">1 req/hour, +1hr delay</div>
                    </div>
                </label>
                <label class="tier-option" data-tier="standard">
                    <input type="radio" name="tier-select" value="standard">
                    <div class="tier-option-content">
                        <div class="tier-option-header">
                            <span class="tier-badge tier-standard">STANDARD</span>
                            <span class="tier-option-price">$15K/yr</span>
                        </div>
                        <div class="tier-option-desc">~10K req/day, real-time</div>
                    </div>
                </label>
                <label class="tier-option" data-tier="critical">
                    <input type="radio" name="tier-select" value="critical">
                    <div class="tier-option-content">
                        <div class="tier-option-header">
                            <span class="tier-badge tier-critical">CRITICAL</span>
                            <span class="tier-option-price">$100K+/yr</span>
                        </div>
                        <div class="tier-option-desc">Unlimited, real-time + SLA</div>
                    </div>
                </label>
            </div>
            <div class="form-group" style="margin-top: 16px;">
                <label class="form-label">Duration (days)</label>
                <input type="number" class="form-input" id="tier-days" value="30" min="1" max="365">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('tier-modal')">Cancel</button>
            <button class="btn-minimal" onclick="saveTierChange()" style="background: var(--accent); color: white; border-color: var(--accent);">Save</button>
        </div>
    </div>
</div>

<!-- REGISTER MODEL MODAL -->
<div class="modal-overlay" id="register-model-modal">
    <div class="modal modal-inst" style="max-width: 440px;">
        <div class="modal-header">
            <h2>Connect Model</h2>
            <button class="modal-close" onclick="closeModal('register-model-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Provider</label>
                <select class="form-input" id="reg-model-provider" onchange="updateModelHint()">
                    <option value="">Select provider...</option>
                    <option value="OpenAI">OpenAI</option>
                    <option value="Anthropic">Anthropic</option>
                    <option value="Google">Google (Gemini)</option>
                    <option value="Meta">Meta (Llama)</option>
                    <option value="Mistral">Mistral</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Model Name</label>
                <input type="text" class="form-input" id="reg-model-name" placeholder="e.g. GPT-4o, Claude 3.5 Sonnet">
            </div>
            <div class="form-group">
                <label class="form-label">Provider API Key</label>
                <input type="password" class="form-input" id="reg-model-apikey" placeholder="sk-... / key-...">
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px" id="reg-model-hint">Your key is encrypted (AES-256) and used only to proxy requests through ONTO.</div>
            </div>
            <div style="padding:10px 12px;background:var(--bg);border-radius:6px;margin-top:8px;font-size:11px;color:var(--text-secondary);line-height:1.5">
                <strong style="color:var(--text)">How it works:</strong> ONTO proxy injects epistemic discipline into every request to your model. You change one line in your code — the base URL. Everything else stays the same.
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-minimal" onclick="closeModal('register-model-modal')">Cancel</button>
            <button class="btn-minimal" onclick="submitModelRegistration()" style="background: var(--accent); color: white; border-color: var(--accent);">Connect · Start Trial</button>
        </div>
    </div>
</div>

<script>
// === API CONFIG ===
const API_BASE = 'https://api.ontostandard.org';
let authToken = null;

// === API HELPER ===
async function api(endpoint, options = {}) {
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers
    };
    
    if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
    }
    
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || data.message || 'Request failed');
        }
        
        return data;
    } catch (error) {
        console.error('API Error:', error);
        throw error;
    }
}

// === STATE ===
let currentUser = null;
let sessionTimer = null;
let sessionWarningTimer = null;
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
const SESSION_WARNING = 5 * 60 * 1000; // 5 minutes before timeout
let pendingVerificationEmail = "";

// === i18n STRINGS (preparation) ===
const STRINGS = {
    welcome: 'Welcome to ONTO',
    welcomeDesc: 'Get started by creating your first API key and making an evaluation request.',
    getApiKey: 'Get API Key',
    readDocs: 'Read Docs',
    copied: 'Copied to clipboard',
    sessionWarning: 'Your session will expire in 5 minutes. Click to stay signed in.',
    sessionExpired: 'Session expired. Please sign in again.',
    orgRegistered: 'Organization registered',
    messageSent: 'Message sent. We\'ll be in touch within 24 hours.',
    fillRequired: 'Please fill in all required fields',
    confirmLogout: 'Are you sure you want to sign out?',
    confirmRegenerate: 'Are you sure you want to regenerate your API key?\n\nThis will immediately invalidate your current key.'
};
const PLANS = {
    business: { monthly: 1500, annual: 15000, monthlyEquiv: 1250 },
    enterprise: { monthly: null, annual: 100000, monthlyEquiv: 8333 }
};
let selectedPlan = 'business';
let selectedCycle = 'annual';
// === SESSION MANAGEMENT ===
function resetSessionTimer() {
    clearTimeout(sessionTimer);
    clearTimeout(sessionWarningTimer);
    
    if (!currentUser) return;
    
    // Warning 5 min before timeout
    sessionWarningTimer = setTimeout(() => {
        showSessionWarning();
    }, SESSION_TIMEOUT - SESSION_WARNING);
    
    // Actual timeout
    sessionTimer = setTimeout(() => {
        handleSessionExpired();
    }, SESSION_TIMEOUT);
}

function showSessionWarning() {
    const toast = document.createElement('div');
    toast.className = 'toast session-warning';
    toast.innerHTML = `
        <span>${STRINGS.sessionWarning}</span>
        <button onclick="extendSession(this.parentElement)" style="margin-left:8px;background:white;color:#333;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;">Stay signed in</button>
    `;
    toast.style.cssText = 'background: #d97706; color: white; cursor: pointer;';
    
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    container.appendChild(toast);
}

function extendSession(toastEl) {
    if (toastEl) toastEl.remove();
    resetSessionTimer();
    showToast('Session extended', 'success');
}

function handleSessionExpired() {
    currentUser = null;
    authToken = null;
    localStorage.removeItem('onto_user');
    localStorage.removeItem('onto_token');
    localStorage.removeItem('onto_logged_in');
    const ps = document.getElementById('auth-preload-hide');
    if (ps) ps.remove();
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('dashboard').classList.remove('active');
    showLogin();
    showToast(STRINGS.sessionExpired, 'error');
}

// Activity listener to reset timer
['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
    document.addEventListener(event, () => {
        if (currentUser) resetSessionTimer();
    }, { passive: true });
});

// === THEME ===
function toggleTheme() {
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    if (isLight) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('onto-theme', 'dark');
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('onto-theme', 'light');
    }
    drawIndustryChart();
}

// Init theme from localStorage (dark is default)
(function() {
    const saved = localStorage.getItem('onto-theme');
    if (saved === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
    }
})();

// === UTILITIES ===
function escapeHtml(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
function layerToPlan(layer) { return { open: 'free', standard: 'business', critical: 'enterprise' }[layer] || 'free'; }
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function toggleMobile() {
    document.querySelector('.sidebar').classList.toggle('mobile-open');
    document.getElementById('mobile-overlay').classList.toggle('active');
}

function toggleAuthMenu() {
    // На auth screen — открываем auth menu, в ЛК — sidebar
    const authScreen = document.getElementById('auth-screen');
    if (authScreen && authScreen.style.display !== 'none') {
        document.getElementById('auth-menu').classList.toggle('open');
        document.getElementById('auth-menu-overlay').classList.toggle('visible');
    } else {
        toggleMobile();
    }
}

function closeAuthMenu() {
    document.getElementById('auth-menu').classList.remove('open');
    document.getElementById('auth-menu-overlay').classList.remove('visible');
}

function setLoading(btn, loading) {
    if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
    } else {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

// === AUTH ===
function showLogin() {
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('verify-pending').classList.add('hidden');
    document.getElementById('verify-success').classList.add('hidden');
}

function showRegister() {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.remove('hidden');
    document.getElementById('verify-pending').classList.add('hidden');
    document.getElementById('verify-success').classList.add('hidden');
}

function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
    } else {
        input.type = 'password';
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    }
}

// Enable register button when terms agreed
document.getElementById('terms-agree').addEventListener('change', function() {
    document.getElementById('register-btn').disabled = !this.checked;
});

async function handleLogin(btn) {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    setLoading(btn, true);
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Login failed');
        }
        
        // Store token and user data (backend format)
        authToken = data.token;
        localStorage.setItem('onto_token', authToken);
        
        // Store API key for Reference panel
        if (data.api_key) {
            localStorage.setItem('onto_first_api_key', data.api_key);
        }
        
        currentUser = {
            id: data.user_id,
            name: data.name,
            email: email,
            role: data.role || 'admin',
            plan: layerToPlan(data.layer || 'open'),
            organization_id: data.organization_id,
            organization_name: data.organization_name,
            can_invoice: false,
            company: null  // Company set only after explicit registration
        };
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        
        // Also store in new format for consistency
        localStorage.setItem('onto_user_id', data.user_id);
        localStorage.setItem('onto_user_name', data.name || '');
        localStorage.setItem('onto_user_email', email);
        localStorage.setItem('onto_org_id', data.organization_id);
        localStorage.setItem('onto_org_name', data.organization_name || '');
        localStorage.setItem('onto_layer', data.layer || 'open');
        localStorage.setItem('onto_role', data.role || 'admin');
        localStorage.setItem('onto_logged_in', 'true');
        
        setLoading(btn, false);
        showToast('Welcome back!', 'success');
        showDashboard();
    } catch (error) {
        setLoading(btn, false);
        
        // Check if email not verified
        if (error.message && error.message.includes('not verified')) {
            pendingVerificationEmail = email;
            showVerifyPending(email);
            showToast('Please verify your email first', 'info');
            return;
        }
        
        showToast(error.message || 'Login failed', 'error');
    }
}


async function handleRegister(btn) {
    const name = document.getElementById('reg-name').value;
    const email = document.getElementById('reg-email').value;
    const password = document.getElementById('reg-password').value;
    const termsAgreed = document.getElementById('terms-agree').checked;
    
    if (!name || !email || !password) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    if (!termsAgreed) {
        showToast('Please agree to the Terms of Service', 'error');
        return;
    }
    
    setLoading(btn, true);
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Registration failed');
        }
        
        // Store API key for later display
        localStorage.setItem('onto_first_api_key', data.api_key);
        pendingVerificationEmail = email;
        
        setLoading(btn, false);
        
        // Show verification pending screen
        showVerifyPending(email);
        showToast('Check your email to verify your account', 'success');
    } catch (error) {
        setLoading(btn, false);
        showToast(error.message || 'Registration failed', 'error');
    }
}

function showVerifyPending(email) {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('verify-success').classList.add('hidden');
    document.getElementById('verify-pending').classList.remove('hidden');
    document.getElementById('verify-email-display').textContent = email;
    document.getElementById('otp-error').style.display = 'none';
    
    // Clear OTP inputs
    for (let i = 1; i <= 6; i++) {
        document.getElementById('otp-' + i).value = '';
    }
    
    // Focus first input
    setTimeout(() => document.getElementById('otp-1').focus(), 100);
    
    // Setup OTP input handlers
    setupOTPInputs();
}

function setupOTPInputs() {
    for (let i = 1; i <= 6; i++) {
        const input = document.getElementById('otp-' + i);
        
        input.addEventListener('input', (e) => {
            const val = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = val;
            if (val && i < 6) {
                document.getElementById('otp-' + (i + 1)).focus();
            }
            // Auto-submit when all 6 digits entered
            if (i === 6 && val) {
                const code = getOTPCode();
                if (code.length === 6) handleVerifyOTP(document.getElementById('verify-btn'));
            }
        });
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && i > 1) {
                document.getElementById('otp-' + (i - 1)).focus();
            }
        });
        
        // Handle paste
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g, '');
            for (let j = 0; j < 6 && j < paste.length; j++) {
                document.getElementById('otp-' + (j + 1)).value = paste[j];
            }
            if (paste.length >= 6) {
                document.getElementById('otp-6').focus();
                handleVerifyOTP(document.getElementById('verify-btn'));
            }
        });
    }
}

function getOTPCode() {
    let code = '';
    for (let i = 1; i <= 6; i++) {
        code += document.getElementById('otp-' + i).value;
    }
    return code;
}

async function handleVerifyOTP(btn) {
    const code = getOTPCode();
    if (code.length !== 6) {
        document.getElementById('otp-error').textContent = 'Please enter all 6 digits';
        document.getElementById('otp-error').style.display = 'block';
        return;
    }
    
    setLoading(btn, true);
    document.getElementById('otp-error').style.display = 'none';
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/verify-email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: pendingVerificationEmail, code: code })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Verification failed');
        }
        
        // Auto-login with returned data
        authToken = data.token;
        localStorage.setItem('onto_token', authToken);
        
        if (data.api_key) {
            localStorage.setItem('onto_first_api_key', data.api_key);
        }
        
        currentUser = {
            id: data.user_id,
            name: data.name,
            email: data.email,
            role: data.role || 'admin',
            plan: layerToPlan(data.layer || 'open'),
            organization_id: data.organization_id,
            organization_name: data.organization_name
        };
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        localStorage.setItem('onto_logged_in', 'true');
        
        setLoading(btn, false);
        showToast('Email verified! Welcome to ONTO', 'success');
        showDashboard();
    } catch (error) {
        setLoading(btn, false);
        document.getElementById('otp-error').textContent = error.message;
        document.getElementById('otp-error').style.display = 'block';
        
        // Shake OTP inputs
        for (let i = 1; i <= 6; i++) {
            document.getElementById('otp-' + i).classList.add('error');
            setTimeout(() => document.getElementById('otp-' + i).classList.remove('error'), 1500);
        }
    }
}

function showVerifySuccess() {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('verify-pending').classList.add('hidden');
    document.getElementById('verify-success').classList.remove('hidden');
}

async function resendVerification() {
    if (!pendingVerificationEmail) {
        showToast('No email to verify', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/resend-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: pendingVerificationEmail, password: '' })
        });
        
        const data = await response.json();
        showToast(data.message || 'Verification email sent', 'success');
    } catch (error) {
        showToast('Failed to resend email', 'error');
    }
}

async function checkEmailVerification() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('verify');
    
    if (!token) return;
    
    try {
        const response = await fetch(`${API_BASE}/v1/auth/verify-email?token=${token}`);
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Clean URL first
            window.history.replaceState({}, '', window.location.pathname);
            
            // Auto-login with returned data
            if (data.token) {
                authToken = data.token;
                localStorage.setItem('onto_token', authToken);
                
                currentUser = {
                    id: data.user_id,
                    name: data.name,
                    email: data.email,
                    role: 'admin',
                    plan: layerToPlan(data.layer || 'open'),
                    organization_id: data.organization_id,
                    can_invoice: false,
                    company: null  // Company set only after explicit registration
                };
                localStorage.setItem('onto_user', JSON.stringify(currentUser));
                
                showToast('Email verified! Welcome to ONTO.', 'success');
                showDashboard();
            } else {
                showVerifySuccess();
                showToast('Email verified! Please sign in.', 'success');
            }
        } else {
            showToast(data.detail || 'Verification failed', 'error');
        }
    } catch (error) {
        showToast('Verification failed', 'error');
        window.history.replaceState({}, '', window.location.pathname);
    }
}

function handleLogout() {
    if (!confirm(STRINGS.confirmLogout)) {
        return;
    }
    clearTimeout(sessionTimer);
    clearTimeout(sessionWarningTimer);
    currentUser = null;
    authToken = null;
    
    // Clear all auth data
    localStorage.removeItem('onto_user');
    localStorage.removeItem('onto_token');
    localStorage.removeItem('onto_first_api_key');
    localStorage.removeItem('onto_logged_in');
    localStorage.removeItem('onto_user_id');
    localStorage.removeItem('onto_user_name');
    localStorage.removeItem('onto_user_email');
    localStorage.removeItem('onto_org_id');
    localStorage.removeItem('onto_org_name');
    localStorage.removeItem('onto_layer');
    localStorage.removeItem('onto_role');
    
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('dashboard').classList.remove('active');
    // Remove preload hide style
    const preloadStyle = document.getElementById('auth-preload-hide');
    if (preloadStyle) preloadStyle.remove();
    showLogin();
}

// === DASHBOARD ===
function showAuthScreen() {
    const preloadStyle = document.getElementById('auth-preload-hide');
    if (preloadStyle) preloadStyle.remove();
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('dashboard').classList.remove('active');
}

function showDashboard() {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');
    
    // Handle ?page= URL parameter
    const params = new URLSearchParams(window.location.search);
    const targetPage = params.get('page');
    if (targetPage && document.getElementById('page-' + targetPage)) {
        showPage(targetPage);
    }
    
    if (currentUser) {
        document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-plan').textContent = currentUser.plan === 'enterprise' ? 'CRITICAL' : currentUser.plan === 'business' ? 'PRO' : 'FREE';
        document.getElementById('settings-name').textContent = currentUser.name;
        document.getElementById('settings-email').textContent = currentUser.email;
        
        updateCompanyUI();
        updateBillingUI();
        updateDashboardMetrics();
        checkWelcomeBanner();
        resetSessionTimer();
        
        // Init dashboard components
        const realApiKey = localStorage.getItem('onto_first_api_key');
        if (realApiKey) {
            document.getElementById('api-key-display').value = realApiKey;
        }
        renderDashModels();
        populateEvalModels();
        fetchUserModels();
        loadUserSignal();
        refreshProofStats();
        checkReferenceAccess();

    }
}

function updateDashboardMetrics() {
    if (!currentUser) return;
    
    const sub = currentUser.subscription;
    const plan = currentUser.plan || 'free';
    
    const planNames = { free: 'Open', business: 'Standard', enterprise: 'Certified' };
    const rateLimits = { free: '10/hr · 50/day', business: 'Unlimited', enterprise: 'Unlimited' };
    
    // Plan card
    const nameEl = document.getElementById('dash-plan-name');
    const rateEl = document.getElementById('dash-plan-rate');
    const callsEl = document.getElementById('dash-plan-calls');
    const expiresEl = document.getElementById('dash-plan-expires');
    const upgradeBtn = document.getElementById('dash-upgrade-btn');
    const switcherEl = document.getElementById('plan-switcher');
    const switchSelect = document.getElementById('plan-switch');
    
    if (nameEl) nameEl.textContent = planNames[plan] || 'Open';
    if (rateEl) rateEl.textContent = rateLimits[plan] || '1 request / hour';
    
    // Hide upgrade for paid plans
    if (upgradeBtn) upgradeBtn.style.display = plan === 'free' ? 'block' : 'none';
    
    // Show plan switcher if both plans available
    if (sub && sub.critical_days > 0 && sub.pro_days > 0 && switcherEl) {
        switcherEl.classList.remove('hidden');
        if (switchSelect) switchSelect.value = plan;
    } else if (switcherEl) {
        switcherEl.classList.add('hidden');
    }
    
    // Expires
    if (sub && expiresEl) {
        const criticalDays = sub.critical_days || 0;
        const proDays = sub.pro_days || 0;
        const totalDays = criticalDays + proDays;
        
        if (totalDays > 365) {
            const years = Math.floor(totalDays / 365);
            const months = Math.floor((totalDays % 365) / 30);
            expiresEl.textContent = 'Expires in ' + years + 'y ' + months + 'm';
        } else if (totalDays > 30) {
            const months = Math.floor(totalDays / 30);
            const days = totalDays % 30;
            expiresEl.textContent = 'Expires in ' + months + 'm ' + days + 'd';
        } else if (totalDays > 0) {
            expiresEl.textContent = 'Expires in ' + totalDays + 'd';
        } else {
            expiresEl.textContent = 'No expiration';
        }
    }
    
    // Plan includes hint
    const includesEl = document.getElementById('plan-includes-text');
    if (includesEl) {
        const planIncludes = {
            free: 'Free: 1 eval/hr · 5 models · Public /check endpoint',
            business: 'Pro: 10K eval/day · Unlimited models · Certification · Priority support',
            enterprise: 'Certified: Rolling certification · Public registry · ONTO CERTIFIED badge · 24mo audit'
        };
        includesEl.textContent = planIncludes[plan] || planIncludes.free;
    }
}

function updateAuditStats() {
    const models = window._cachedModels || [];
    const countEl = document.getElementById('stat-models-count');
    const riskEl = document.getElementById('stat-avg-risk');
    const riskLabel = document.getElementById('stat-avg-risk-label');
    const evalEl = document.getElementById('stat-eval-count');
    const compEl = document.getElementById('stat-compliance');
    
    if (countEl) countEl.textContent = models.length;
    
    if (models.length > 0) {
        const risks = models.filter(m => m.risk_score != null).map(m => m.risk_score);
        const evals = models.reduce((sum, m) => sum + (m.eval_count || 0), 0);
        const passed = models.filter(m => ['A','B','C','PASSED'].includes((m.compliance || '').toUpperCase())).length;
        
        if (risks.length > 0) {
            const avg = risks.reduce((a, b) => a + b, 0) / risks.length;
            if (riskEl) {
                riskEl.textContent = avg.toFixed(2);
                riskEl.style.color = avg < 0.35 ? '#22c55e' : avg < 0.65 ? '#eab308' : '#ef4444';
            }
            if (riskLabel) {
                riskLabel.textContent = avg < 0.35 ? 'LOW' : avg < 0.65 ? 'MODERATE' : 'HIGH';
                riskLabel.style.color = avg < 0.35 ? '#22c55e' : avg < 0.65 ? '#eab308' : '#ef4444';
            }
        }
        
        if (evalEl) evalEl.textContent = evals;
        if (compEl) {
            compEl.textContent = passed + '/' + models.length;
            compEl.style.color = passed === models.length ? '#22c55e' : passed > 0 ? '#eab308' : 'var(--text-muted)';
        }
    }
}

function switchActivePlan(newPlan) {
    if (!currentUser || !currentUser.subscription) return;
    
    const sub = currentUser.subscription;
    const criticalDays = sub.critical_days || 0;
    const proDays = sub.pro_days || 0;
    
    if (newPlan === 'enterprise' && criticalDays <= 0) {
        showToast('No Certified days remaining', 'error');
        return;
    }
    if (newPlan === 'business' && proDays <= 0) {
        showToast('No Pro days remaining', 'error');
        return;
    }
    
    currentUser.plan = newPlan;
    currentUser.subscription.plan = newPlan;
    localStorage.setItem('onto_user', JSON.stringify(currentUser));
    
    const planLabel = newPlan === 'enterprise' ? 'CRITICAL' : 'PRO';
    document.getElementById('user-plan').textContent = planLabel;
    
    updateDashboardMetrics();
    updateBillingUI();
    
    showToast('Switched to ' + (newPlan === 'enterprise' ? 'Certified' : 'Standard'), 'success');
}

function showPage(page, el) {
    // Backward compat
    if (page === 'dashboard' || page === 'audit') page = 'monitor';
    
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const target = document.getElementById('page-' + page);
    if (target) target.classList.add('active');
    if (el) {
        const navItem = el.closest ? el.closest('.nav-item') : el;
        if (navItem) navItem.classList.add('active');
    } else {
        document.querySelectorAll('.nav-item').forEach(n => {
            const oc = n.getAttribute('onclick');
            if (oc && oc.includes("'" + page + "'")) n.classList.add('active');
        });
    }
    if (page === 'audit' || page === 'evaluate') populateEvalModels();
    if (page === 'monitor') { renderDashModels(); loadUserSignal(); initERM(); initErmCert(); }
    if (page === 'certify') updateCertifyPage();
    if (page === 'sdk') updateSdkPage();
}

// === COMPANY ===
function updateCompanyUI() {
    if (currentUser.company) {
        document.getElementById('company-not-registered').classList.add('hidden');
        document.getElementById('company-registered').classList.remove('hidden');
        document.getElementById('company-name').textContent = currentUser.company.name;
        document.getElementById('company-industry').textContent = formatIndustry(currentUser.company.industry);
        document.getElementById('company-reg').textContent = currentUser.company.reg;
        document.getElementById('settings-account-type').textContent = 'Individual + Company';
    } else {
        document.getElementById('company-not-registered').classList.remove('hidden');
        document.getElementById('company-registered').classList.add('hidden');
        document.getElementById('settings-account-type').textContent = 'Individual';
    }
}

function formatIndustry(code) {
    const industries = {
        'healthcare': 'Healthcare & Medical',
        'financial': 'Financial Services',
        'legal': 'Legal Services',
        'insurance': 'Insurance',
        'aerospace': 'Aerospace',
        'defense': 'Defense & Security',
        'autonomous': 'Autonomous Systems',
        'energy': 'Energy & Utilities',
        'infrastructure': 'Critical Infrastructure',
        'ai_ml': 'AI / Machine Learning',
        'software': 'Software & SaaS',
        'cloud': 'Cloud Services',
        'cybersecurity': 'Cybersecurity',
        'data': 'Data & Analytics',
        'manufacturing': 'Manufacturing',
        'retail': 'Retail & E-commerce',
        'education': 'Education',
        'media': 'Media & Entertainment',
        'consulting': 'Consulting',
        'research': 'Research & Academia',
        'government': 'Government & Public',
        'other': 'Other'
    };
    return industries[code] || code || '—';
}

function openCompanyModal() {
    const modal = document.getElementById('company-modal');
    const isEdit = currentUser?.company != null;
    
    // Update modal title and button for edit mode
    const title = modal.querySelector('.modal-header h2');
    const submitBtn = document.getElementById('register-company-btn');
    if (title) title.textContent = isEdit ? 'Edit Organization' : 'Organization Registration';
    if (submitBtn) submitBtn.textContent = isEdit ? 'Save Changes' : 'Register';
    
    modal.classList.add('active');
    
    // Reset form
    submitBtn.disabled = true;
    
    // Field mapping
    const fieldMap = {
        'company-name-input': 'name',
        'company-type-input': 'type',
        'company-industry-input': 'industry',
        'company-reg-input': 'reg',
        'company-vat-input': 'vat',
        'company-address-input': 'address',
        'company-city-input': 'city',
        'company-state-input': 'state',
        'company-postal-input': 'postal',
        'company-country-input': 'country',
        'company-email-input': 'email',
        'company-phone-input': 'phone',
        'signatory-name-input': 'signatory',
        'signatory-title-input': 'signatoryTitle'
    };
    
    // Add validation listeners and pre-fill if editing
    const companyFields = ['company-name-input', 'company-type-input', 'company-industry-input', 'company-reg-input', 'company-address-input', 'company-city-input', 'company-postal-input', 'company-country-input', 'company-email-input', 'signatory-name-input', 'signatory-title-input'];
    companyFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('error', 'valid', 'empty-required');
            
            // Pre-fill with existing data
            const dataKey = fieldMap[id];
            if (isEdit && currentUser.company && dataKey) {
                el.value = currentUser.company[dataKey] || '';
            } else {
                el.value = '';
            }
            
            el.oninput = function() {
                this.classList.remove('error');
                validateCompanyForm();
            };
            el.onchange = validateCompanyForm;
        }
    });
    
    // Also fill optional fields
    ['company-vat-input', 'company-state-input', 'company-phone-input'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            const dataKey = fieldMap[id];
            if (isEdit && currentUser.company && dataKey) {
                el.value = currentUser.company[dataKey] || '';
            } else {
                el.value = '';
            }
        }
    });
    
    ['msa-agree', 'msa-authorized'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.checked = isEdit; // Pre-check if editing (already agreed)
            el.onchange = validateCompanyForm;
        }
    });
    
    // Show initial state after short delay
    setTimeout(validateCompanyForm, 50);
}

function downloadInvoice() {
    if (!currentUser?.subscription) {
        showToast('No active subscription', 'error');
        return;
    }
    
    const now = new Date();
    const sub = currentUser.subscription;
    const invoiceId = 'INV-' + new Date(sub.started).getFullYear() + '-' + Date.now().toString(36).toUpperCase();
    const plan = sub.plan;
    const amount = sub.amount;
    const planNames = { business: 'Standard', enterprise: 'Certified' };
    
    const invoice = {
        schema: 'onto-invoice/v1',
        id: invoiceId,
        created_at: sub.started,
        due_date: new Date(new Date(sub.started).getTime() + 30*24*60*60*1000).toISOString(),
        status: 'PAID',
        
        provider: {
            name: 'ONTO Standard',
            jurisdiction: 'See ontostandard.org/legal',
            email: 'billing@ontostandard.org',
            website: 'https://ontostandard.org',
            tax_id: null
        },
        
        client: {
            company: currentUser?.company?.name || currentUser.name,
            legal_name: currentUser?.company?.name || null,
            tax_id: currentUser?.company?.reg || null,
            industry: currentUser?.company?.industry || null,
            address: {
                street: currentUser?.company?.address || null,
                city: currentUser?.company?.city || null,
                postal: currentUser?.company?.postal || null,
                country: currentUser?.company?.country || null
            },
            signatory: currentUser?.company?.signatory || currentUser.name,
            email: currentUser?.company?.email || currentUser.email
        },
        
        line_items: [{
            description: 'ONTO Protocol — ' + planNames[plan] + ' Layer',
            details: sub.cycle === 'annual' ? 'Annual subscription (12 months)' : 'Monthly subscription',
            quantity: 1,
            unit_price: amount,
            amount: amount
        }],
        
        subtotal: amount,
        total_paid: sub.total_paid || amount,
        tax: { rate: 0, amount: 0 },
        total: amount,
        currency: 'USD',
        
        payment: {
            terms: sub.cycle === 'annual' ? 'PREPAID' : 'NET_30',
            method: 'invoice',
            reference: invoiceId,
            paid_at: sub.started
        },
        
        service: {
            layer: planNames[plan],
            cycle: sub.cycle,
            term_months: sub.cycle === 'annual' ? 12 : 1,
            started: sub.started,
            expires_at: sub.expires_at || null,
            features: plan === 'enterprise' ? {
                rate_limit: 'unlimited',
                signal: 'dedicated',
                sla: '99.99%',
                support: '24/7'
            } : {
                rate_limit: '1/8.64s',
                signal: 'real-time',
                sla: '99.5%',
                support: 'business hours'
            }
        },
        
        hash: simpleHash(invoiceId + (currentUser?.company?.name || currentUser.name) + plan + amount)
    };
    
    const blob = new Blob([JSON.stringify(invoice, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ONTO_Invoice_' + planNames[plan] + '_' + new Date(sub.started).toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('Invoice downloaded', 'success');
}

function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash = hash & hash;
    }
    return Math.abs(hash).toString(16).padStart(16, '0');
}

function registerCompany() {
    const btn = document.getElementById('register-company-btn');
    const fields = {
        name: document.getElementById('company-name-input'),
        type: document.getElementById('company-type-input'),
        industry: document.getElementById('company-industry-input'),
        reg: document.getElementById('company-reg-input'),
        vat: document.getElementById('company-vat-input'),
        address: document.getElementById('company-address-input'),
        city: document.getElementById('company-city-input'),
        state: document.getElementById('company-state-input'),
        postal: document.getElementById('company-postal-input'),
        country: document.getElementById('company-country-input'),
        email: document.getElementById('company-email-input'),
        phone: document.getElementById('company-phone-input'),
        signatory: document.getElementById('signatory-name-input'),
        signatoryTitle: document.getElementById('signatory-title-input')
    };
    const msaAgree = document.getElementById('msa-agree');
    const msaAuth = document.getElementById('msa-authorized');
    
    const requiredFields = ['name', 'type', 'industry', 'reg', 'address', 'city', 'postal', 'country', 'email', 'signatory', 'signatoryTitle'];
    let valid = true;
    
    // Clear previous errors
    Object.values(fields).forEach(f => { if(f) f.classList.remove('error'); });
    
    // Validate required fields
    requiredFields.forEach(key => {
        const field = fields[key];
        if (field && (!field.value || !field.value.trim())) {
            field.classList.add('error');
            valid = false;
        }
    });
    
    if (!msaAgree.checked || !msaAuth.checked) {
        valid = false;
    }
    
    if (!valid) {
        return;
    }
    
    // Loading state
    const isEdit = currentUser?.company != null;
    const originalText = btn.textContent;
    btn.textContent = isEdit ? 'Saving...' : 'Registering...';
    btn.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        currentUser.company = { 
            name: fields.name.value,
            type: fields.type.value,
            industry: fields.industry.value,
            reg: fields.reg.value, 
            vat: fields.vat?.value || '',
            address: fields.address.value,
            city: fields.city.value,
            state: fields.state?.value || '',
            postal: fields.postal.value,
            country: fields.country.value,
            email: fields.email.value,
            phone: fields.phone?.value || '',
            signatory: fields.signatory.value,
            signatoryTitle: fields.signatoryTitle.value
        };
        currentUser.can_invoice = true;
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        
        btn.textContent = originalText;
        closeModal('company-modal');
        updateCompanyUI();
        showToast(isEdit ? 'Organization updated' : 'Organization registered', 'success');
    }, 800);
}

function validateCompanyForm() {
    const requiredFields = {
        'company-name-input': document.getElementById('company-name-input'),
        'company-type-input': document.getElementById('company-type-input'),
        'company-industry-input': document.getElementById('company-industry-input'),
        'company-reg-input': document.getElementById('company-reg-input'),
        'company-address-input': document.getElementById('company-address-input'),
        'company-city-input': document.getElementById('company-city-input'),
        'company-postal-input': document.getElementById('company-postal-input'),
        'company-country-input': document.getElementById('company-country-input'),
        'company-email-input': document.getElementById('company-email-input'),
        'signatory-name-input': document.getElementById('signatory-name-input'),
        'signatory-title-input': document.getElementById('signatory-title-input')
    };
    
    const msaAgree = document.getElementById('msa-agree').checked;
    const msaAuth = document.getElementById('msa-authorized').checked;
    
    let allFilled = true;
    
    // Check each required field and update visual state
    Object.values(requiredFields).forEach(field => {
        if (!field) return;
        field.classList.remove('error'); // Clear error state on validation
        
        if (field.value && field.value.trim()) {
            field.classList.add('valid');
            field.classList.remove('empty-required');
        } else {
            field.classList.remove('valid');
            field.classList.add('empty-required');
            allFilled = false;
        }
    });
    
    // Update checkboxes visual
    const msaAgreeEl = document.getElementById('msa-agree');
    const msaAuthEl = document.getElementById('msa-authorized');
    msaAgreeEl.parentElement.classList.toggle('checked', msaAgree);
    msaAuthEl.parentElement.classList.toggle('checked', msaAuth);
    
    const btn = document.getElementById('register-company-btn');
    btn.disabled = !(allFilled && msaAgree && msaAuth);
}

function highlightEmptyFields() {
    const fieldIds = ['company-name-input', 'company-type-input', 'company-industry-input', 'company-reg-input', 'company-address-input', 'company-city-input', 'company-postal-input', 'company-country-input', 'company-email-input', 'signatory-name-input', 'signatory-title-input'];
    
    fieldIds.forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;
        if (!field.value || !field.value.trim()) {
            field.classList.remove('valid', 'empty-required');
            field.classList.add('error');
        }
    });
    
    // Highlight checkboxes container if not checked
    const msaAgree = document.getElementById('msa-agree');
    const msaAuth = document.getElementById('msa-authorized');
    
    msaAgree.parentElement.style.color = msaAgree.checked ? '' : 'var(--danger)';
    msaAuth.parentElement.style.color = msaAuth.checked ? '' : 'var(--danger)';
}

// === BILLING ===
function updateBillingUI() {
    const invoiceStatus = document.getElementById('invoice-status');
    const invoiceDownload = document.getElementById('invoice-download');
    const subNone = document.getElementById('subscription-none');
    const subActive = document.getElementById('subscription-active');
    
    // Reset all buttons first
    document.getElementById('btn-free').textContent = 'Current';
    document.getElementById('btn-free').disabled = true;
    document.getElementById('btn-business').textContent = 'Select';
    document.getElementById('btn-business').disabled = false;
    document.getElementById('btn-enterprise').textContent = 'Select';
    document.getElementById('btn-enterprise').disabled = false;
    
    const planNames = { free: 'Open (Free)', business: 'Standard', enterprise: 'Certified' };
    const rateLimits = { free: '1/hour', business: '1/8.64s', enterprise: 'Unlimited' };
    
    // Update current plan indicator
    if (currentUser.plan === 'free' || !currentUser.subscription) {
        document.getElementById('btn-free').textContent = 'Current';
        document.getElementById('btn-free').disabled = true;
        invoiceStatus.textContent = 'No active subscription';
        invoiceStatus.classList.remove('hidden');
        invoiceDownload.classList.add('hidden');
        
        if (subNone) subNone.classList.remove('hidden');
        if (subActive) subActive.classList.add('hidden');
    } else {
        const sub = currentUser.subscription;
        const criticalDays = sub.critical_days || 0;
        const proDays = sub.pro_days || 0;
        
        if (currentUser.plan === 'business') {
            document.getElementById('btn-business').textContent = 'Extend';
        } else if (currentUser.plan === 'enterprise') {
            document.getElementById('btn-enterprise').textContent = 'Extend';
        }
        
        invoiceStatus.classList.add('hidden');
        invoiceDownload.classList.remove('hidden');
        
        if (subNone) subNone.classList.add('hidden');
        if (subActive) subActive.classList.remove('hidden');
        
        document.getElementById('sub-plan').textContent = planNames[currentUser.plan] || currentUser.plan;
        document.getElementById('sub-rate').textContent = rateLimits[currentUser.plan] || '—';
        document.getElementById('sub-expires').textContent = sub.expires_at ? new Date(sub.expires_at).toLocaleDateString() : '—';
        document.getElementById('sub-total').textContent = sub.total_paid ? '$' + sub.total_paid.toLocaleString() : '—';
        
        // Show/hide day counters
        const criticalRow = document.getElementById('sub-critical-row');
        const proRow = document.getElementById('sub-pro-row');
        
        if (criticalDays > 0) {
            criticalRow.classList.remove('hidden');
            document.getElementById('sub-critical-days').textContent = criticalDays + ' days';
        } else {
            criticalRow.classList.add('hidden');
        }
        
        if (proDays > 0) {
            proRow.classList.remove('hidden');
            document.getElementById('sub-pro-days').textContent = proDays + ' days' + (criticalDays > 0 ? ' (after Certified)' : '');
        } else {
            proRow.classList.add('hidden');
        }
    }
}


// === SUBSCRIBE MODAL ===
function openSubscribeModal(plan) {
    selectedPlan = plan;
    const planNames = { business: 'Standard', enterprise: 'Certified' };
    document.getElementById('subscribe-plan-name').textContent = planNames[plan] || plan;
    const prices = PLANS[plan];
    document.getElementById('price-annual-display').textContent = '$' + prices.annual.toLocaleString();
    document.getElementById('price-monthly-display').textContent = '$' + (prices.monthly ? prices.monthly.toLocaleString() + '/mo' : 'N/A');
    const monthlyOption = document.getElementById('billing-monthly');
    if (plan === 'enterprise') {
        monthlyOption.style.display = 'none';
        document.querySelector('input[name="billing-cycle"][value="annual"]').checked = true;
    } else { monthlyOption.style.display = 'flex'; }
    document.getElementById('subscribe-modal').classList.add('active');
    selectedCycle = 'annual';
    updateOrderSummary();
}

function updateOrderSummary() {
    const cycle = document.querySelector('input[name="billing-cycle"]:checked')?.value || 'annual';
    selectedCycle = cycle;
    const prices = PLANS[selectedPlan];
    const planNames = { business: 'Standard', enterprise: 'Certified' };
    const planName = planNames[selectedPlan] || selectedPlan;
    const planFeatures = {
        business: ['Unlimited evaluations', 'Real-time Proof of Chain', 'Rolling marker L1/L2/L3', 'Internal diagnostics'],
        enterprise: ['Unlimited + Certification', 'Public registry listing', 'ONTO CERTIFIED badge', '24mo audit trail']
    };
    const featuresEl = document.getElementById('order-features');
    featuresEl.innerHTML = (planFeatures[selectedPlan]||[]).map(f => '<div class="order-feature">'+f+'</div>').join('');
    let price = cycle === 'annual' ? prices.annual : prices.monthly;
    document.getElementById('summary-plan').textContent = planName + ' Tier \u2014 ' + (cycle==='annual'?'Annual':'Monthly');
    document.getElementById('summary-price').textContent = '$' + price.toLocaleString();
    document.getElementById('summary-total').textContent = '$' + price.toLocaleString();
    const invoiceInput = document.querySelector('#payment-invoice input');
    const cardInput = document.querySelector('#payment-card input');
    if (cycle === 'annual') { invoiceInput.disabled=false; cardInput.disabled=true; invoiceInput.checked=true; }
    else { invoiceInput.disabled=true; cardInput.disabled=false; cardInput.checked=true; }
}

function processPayment() {
    closeModal('subscribe-modal');
    document.getElementById('payment-modal').classList.add('active');
}

function redirectToAirwallex() {
    const isAnnual = selectedCycle === 'annual';
    const daysToAdd = isAnnual ? 365 : 30;
    const amount = isAnnual ? PLANS[selectedPlan].annual : PLANS[selectedPlan].monthly;
    const now = new Date();
    const sub = currentUser.subscription || {};
    let proDays = sub.pro_days || 0, criticalDays = sub.critical_days || 0;
    if (selectedPlan === 'business') proDays += daysToAdd;
    else if (selectedPlan === 'enterprise') criticalDays += daysToAdd;
    const activePlan = criticalDays > 0 ? 'enterprise' : (proDays > 0 ? 'business' : 'free');
    const totalDays = criticalDays + proDays;
    const expiresAt = totalDays > 0 ? new Date(now.getTime() + totalDays * 86400000) : null;
    currentUser.subscription = {
        plan: activePlan, cycle: selectedCycle,
        started: sub.started || now.toISOString(), last_payment: now.toISOString(),
        expires_at: expiresAt ? expiresAt.toISOString() : null,
        pro_days: proDays, critical_days: criticalDays,
        amount: amount, total_paid: (sub.total_paid||0) + amount
    };
    currentUser.plan = activePlan;
    localStorage.setItem('onto_user', JSON.stringify(currentUser));
    closeModal('payment-modal');
    updateBillingUI(); updateDashboardMetrics();
    document.getElementById('user-plan').textContent = activePlan==='enterprise'?'CRITICAL':(activePlan==='business'?'PRO':'FREE');
    let msg = 'Subscription activated!';
    if (criticalDays>0 && proDays>0) msg = 'Activated! '+criticalDays+'d Certified then '+proDays+'d Pro';
    else if (criticalDays>0) msg = 'Activated! '+criticalDays+' days Certified';
    else if (proDays>0) msg = 'Activated! '+proDays+' days Pro';
    showToast(msg, 'success');
}
// === SUBSCRIBE MODAL ===
function openSubscribeModal(plan) {
    selectedPlan = plan;
    const planNames = { business: 'Standard', enterprise: 'Certified' };
    document.getElementById('subscribe-plan-name').textContent = planNames[plan] || plan;
    const prices = PLANS[plan];
    document.getElementById('price-annual-display').textContent = '$' + prices.annual.toLocaleString();
    document.getElementById('price-monthly-display').textContent = '$' + (prices.monthly ? prices.monthly.toLocaleString() + '/mo' : 'N/A');
    const monthlyOption = document.getElementById('billing-monthly');
    if (plan === 'enterprise') {
        monthlyOption.style.display = 'none';
        document.querySelector('input[name="billing-cycle"][value="annual"]').checked = true;
    } else { monthlyOption.style.display = 'flex'; }
    document.getElementById('subscribe-modal').classList.add('active');
    selectedCycle = 'annual';
    updateOrderSummary();
}

function updateOrderSummary() {
    const cycle = document.querySelector('input[name="billing-cycle"]:checked')?.value || 'annual';
    selectedCycle = cycle;
    const prices = PLANS[selectedPlan];
    const planNames = { business: 'Standard', enterprise: 'Certified' };
    const planName = planNames[selectedPlan] || selectedPlan;
    const planFeatures = {
        business: ['Unlimited evaluations', 'Real-time Proof of Chain', 'Rolling marker L1/L2/L3', 'Internal diagnostics'],
        enterprise: ['Unlimited + Certification', 'Public registry listing', 'ONTO CERTIFIED badge', '24mo audit trail']
    };
    const featuresEl = document.getElementById('order-features');
    featuresEl.innerHTML = (planFeatures[selectedPlan]||[]).map(f => '<div class="order-feature">'+f+'</div>').join('');
    let price = cycle === 'annual' ? prices.annual : prices.monthly;
    document.getElementById('summary-plan').textContent = planName + ' Tier \u2014 ' + (cycle==='annual'?'Annual':'Monthly');
    document.getElementById('summary-price').textContent = '$' + price.toLocaleString();
    document.getElementById('summary-total').textContent = '$' + price.toLocaleString();
    const invoiceInput = document.querySelector('#payment-invoice input');
    const cardInput = document.querySelector('#payment-card input');
    if (cycle === 'annual') { invoiceInput.disabled=false; cardInput.disabled=true; invoiceInput.checked=true; }
    else { invoiceInput.disabled=true; cardInput.disabled=false; cardInput.checked=true; }
}

function processPayment() {
    closeModal('subscribe-modal');
    document.getElementById('payment-modal').classList.add('active');
}

function redirectToAirwallex() {
    const isAnnual = selectedCycle === 'annual';
    const daysToAdd = isAnnual ? 365 : 30;
    const amount = isAnnual ? PLANS[selectedPlan].annual : PLANS[selectedPlan].monthly;
    const now = new Date();
    const sub = currentUser.subscription || {};
    let proDays = sub.pro_days || 0, criticalDays = sub.critical_days || 0;
    if (selectedPlan === 'business') proDays += daysToAdd;
    else if (selectedPlan === 'enterprise') criticalDays += daysToAdd;
    const activePlan = criticalDays > 0 ? 'enterprise' : (proDays > 0 ? 'business' : 'free');
    const totalDays = criticalDays + proDays;
    const expiresAt = totalDays > 0 ? new Date(now.getTime() + totalDays * 86400000) : null;
    currentUser.subscription = {
        plan: activePlan, cycle: selectedCycle,
        started: sub.started || now.toISOString(), last_payment: now.toISOString(),
        expires_at: expiresAt ? expiresAt.toISOString() : null,
        pro_days: proDays, critical_days: criticalDays,
        amount: amount, total_paid: (sub.total_paid||0) + amount
    };
    currentUser.plan = activePlan;
    localStorage.setItem('onto_user', JSON.stringify(currentUser));
    closeModal('payment-modal');
    updateBillingUI(); updateDashboardMetrics();
    document.getElementById('user-plan').textContent = activePlan==='enterprise'?'CRITICAL':(activePlan==='business'?'PRO':'FREE');
    let msg = 'Subscription activated!';
    if (criticalDays>0 && proDays>0) msg = 'Activated! '+criticalDays+'d Certified then '+proDays+'d Pro';
    else if (criticalDays>0) msg = 'Activated! '+criticalDays+' days Certified';
    else if (proDays>0) msg = 'Activated! '+proDays+' days Pro';
    showToast(msg, 'success');
}
function contactSales() {
    document.getElementById('contact-modal').classList.add('active');
    // Pre-fill if user logged in
    if (currentUser) {
        document.getElementById('contact-name').value = currentUser.name || '';
        document.getElementById('contact-email').value = currentUser.email || '';
        if (currentUser.company) {
            document.getElementById('contact-org').value = currentUser.company.name || '';
        }
    }
}

function submitContactForm() {
    const name = document.getElementById('contact-name').value.trim();
    const org = document.getElementById('contact-org').value.trim();
    const email = document.getElementById('contact-email').value.trim();
    const message = document.getElementById('contact-message').value.trim();
    
    if (!name || !email) {
        showToast('Please fill in name and email', 'error');
        return;
    }
    
    // Simulate sending
    const btn = document.querySelector('#contact-modal .modal-footer button:last-child');
    btn.textContent = 'Sending...';
    btn.disabled = true;
    
    setTimeout(() => {
        closeModal('contact-modal');
        showToast('Message sent. We\'ll be in touch within 24 hours.', 'success');
        btn.textContent = 'Send';
        btn.disabled = false;
        // Clear form
        document.getElementById('contact-message').value = '';
    }, 800);
}

function dismissWelcome() {
    const banner = document.getElementById('welcome-banner');
    if (banner) banner.classList.add('hidden');
    localStorage.setItem('onto_welcome_dismissed', 'true');
}

function checkWelcomeBanner() {
    const dismissed = localStorage.getItem('onto_welcome_dismissed');
    const banner = document.getElementById('welcome-banner');
    if (!banner) return;
    if (dismissed || (currentUser && currentUser.apiCalls > 0)) {
        banner.classList.add('hidden');
    } else {
        banner.classList.remove('hidden');
    }
}

// === UTILS ===
function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function copyApiKey(btn) {
    if (btn.disabled) return;
    
    const input = document.getElementById('api-key-display');
    const originalType = input.type;
    input.type = 'text';
    navigator.clipboard.writeText(input.value);
    input.type = originalType;
    
    // Visual feedback
    btn.textContent = 'Copied!';
    btn.disabled = true;
    showToast('API key copied to clipboard', 'success');
    setTimeout(() => {
        btn.textContent = 'Copy';
        btn.disabled = false;
    }, 2000);
}

function toggleApiKeyVisibility() {
    const input = document.getElementById('api-key-display');
    const btn = document.getElementById('toggle-key-btn');
    if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'Hide';
    } else {
        input.type = 'password';
        btn.textContent = 'Show';
    }
}

function regenerateApiKey(btn) {
    if (!confirm('⚠️ Are you sure you want to regenerate your API key?\n\nThis will immediately invalidate your current key. Any applications using the old key will stop working.')) {
        return;
     }
    
    btn.disabled = true;
    btn.textContent = 'Regenerating...';
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) {
        showToast('No API key found. Please log in again.', 'error');
        btn.textContent = 'Regenerate Key';
        btn.disabled = false;
        return;
    }
    
    fetch(`${API_BASE}/v1/keys/regenerate-portal`, {
        method: 'POST',
        headers: { 'x-api-key': apiKey }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || `Server error ${response.status}`);
        return data;
    })
    .then(data => {
        localStorage.setItem('onto_first_api_key', data.api_key);
        authToken = localStorage.getItem('onto_token') || data.api_key;
        
        document.getElementById('api-key-display').value = data.api_key;
        document.getElementById('api-key-display').type = 'text';
        document.getElementById('toggle-key-btn').textContent = 'Hide';
        
        btn.textContent = 'Regenerate Key';
        btn.disabled = false;
        
        showToast('New API key generated! Copy it now.', 'success');
    })
    .catch(error => {
        btn.textContent = 'Regenerate Key';
        btn.disabled = false;
        showToast('Regen failed: ' + (error.message || 'Unknown error'), 'error');
        console.error('[ONTO] Regenerate failed:', error);
    });
}

function editProfile() {
    const newName = prompt('Enter new name:', currentUser.name);
    if (newName && newName.trim()) {
        currentUser.name = newName.trim();
        localStorage.setItem('onto_user', JSON.stringify(currentUser));
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
        document.getElementById('settings-name').textContent = currentUser.name;
    }
}

// === SIGNAL HASH ===
function updateSignalHash() {
    const container = document.getElementById('signal-bytes');
    if (!container) return;
    
    const bytes = Array(13).fill(0).map(() => 
        Math.floor(Math.random() * 256).toString(16).padStart(2, '0')
    );
    
    container.innerHTML = bytes.map((b, i) => 
        `<span class="byte" style="animation-delay: ${i * 0.1}s">${b}</span>`
    ).join('');
}


// === USER SIGNAL (dashboard) ===
let userSignalInterval = null;

async function loadUserSignal() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    
    try {
        // Try public status endpoint first (no auth needed)
        let stats = null;
        const pubRes = await fetch(`${API_BASE}/v1/signal/status`);
        if (pubRes.ok) {
            const pubData = await pubRes.json();
            if (pubData && !pubData.error) stats = pubData;
        }
        
        // If public doesn't have full stats, try admin endpoint
        if ((!stats || stats.uptime_seconds === undefined) && apiKey) {
            const res = await fetch(`${API_BASE}/v1/signal/admin-status`, {
                headers: { 'x-api-key': apiKey }
            });
            if (res.ok) {
                const adminData = await res.json();
                if (adminData && !adminData.error) stats = adminData;
            }
        }
        
        if (stats && !stats.error && (stats.uptime_seconds !== undefined || stats.status === 'running')) {
            if (stats.current_signal) {
                const el = document.getElementById('user-signal-id');
                if (el) el.textContent = stats.current_signal.sigma_id || `σ_${stats.current_signal.timestamp}`;
                startUserHashAnimation(stats.current_signal.entropy_hex || '');
            } else if (stats.latest_signal) {
                const el = document.getElementById('user-signal-id');
                if (el) el.textContent = stats.latest_signal.sigma_id || `σ_${stats.latest_signal.timestamp || Date.now()}`;
                startUserHashAnimation(stats.latest_signal.entropy_hex || stats.latest_signal.hash || '');
            }
            updateUserMetric('user-signal-uptime', formatUptime(stats.uptime_seconds || 0));
            updateUserMetric('user-signal-generated', stats.signals_generated || stats.total_signals || 0);
            updateUserMetric('user-signal-requests', stats.total_requests || 0);
            const errorRate = stats.error_rate_percent || 0;
            updateUserMetric('user-signal-errors', errorRate < 5 ? 'OK' : errorRate.toFixed(1) + '%');
            const remaining = (stats.signal_interval || 300) - ((stats.uptime_seconds || 0) % (stats.signal_interval || 300));
            startUserCountdown(remaining);
            // Show LIVE
            const liveEl = document.getElementById('user-signal-live');
            if (liveEl) liveEl.innerHTML = '<span class="signal-dot"></span><span>LIVE</span>';
        } else {
            showSignalFallback();
        }
    } catch (e) {
        showSignalFallback();
    }
}

function showSignalFallback() {
    const el = document.getElementById('user-signal-id');
    if (el) el.textContent = `σ_${Math.floor(Date.now()/1000)}`;
    const hashEl = document.getElementById('user-signal-hash');
    if (hashEl) {
        const hex = Array.from({length: 64}, () => '0123456789abcdef'[Math.floor(Math.random()*16)]).join('');
        startUserHashAnimation(hex);
    }
    updateUserMetric('user-signal-uptime', '—');
    updateUserMetric('user-signal-generated', '—');
    updateUserMetric('user-signal-requests', '—');
    updateUserMetric('user-signal-errors', '—');
    const liveEl = document.getElementById('user-signal-live');
    if (liveEl) liveEl.innerHTML = '<span class="signal-dot" style="background:#eab308;box-shadow:0 0 6px #eab308"></span><span>SYNC</span>';
    startUserCountdown(30);
}

function updateUserMetric(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
}

let userHashAnimInterval = null;
function startUserHashAnimation(baseHash) {
    const hashEl = document.getElementById('user-signal-hash');
    if (!hashEl || !baseHash) return;
    if (userHashAnimInterval) clearInterval(userHashAnimInterval);
    const chars = '0123456789abcdef';
    const hashArray = baseHash.split('');
    let frame = 0;
    userHashAnimInterval = setInterval(() => {
        frame++;
        const display = hashArray.map((char) => {
            if (frame % 3 === 0 && Math.random() > 0.9) {
                return `<span style="color:#15803d;text-shadow:0 0 8px #15803d;">${chars[Math.floor(Math.random() * 16)]}</span>`;
            }
            return char;
        }).join('');
        hashEl.innerHTML = display;
        if (frame % 40 === 0) hashEl.textContent = baseHash;
    }, 80);
}

function startUserCountdown(seconds) {
    if (userSignalInterval) clearInterval(userSignalInterval);
    let remaining = seconds || 300;
    userSignalInterval = setInterval(() => {
        remaining--;
        const el = document.getElementById('user-signal-countdown');
        if (!el) return;
        if (remaining <= 0) { el.textContent = '0:00'; loadUserSignal(); remaining = 300; }
        else { el.textContent = `${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`; }
    }, 1000);
}

setTimeout(loadUserSignal, 500);
setTimeout(checkReferenceAccess, 1000);

// === MOCK MULTI-MODEL DATA ===
const mockModels = [
    {
        id: 'mdl_01', name: 'GPT-5.2', provider: 'OpenAI', cert: 'ONTO-L3-089',
        risk_score: 0.19, layer: 'L3', calibration: 92, requests: 1247, compliance: 'PASSED', last_eval: '4 min ago',
        evaluations: [
            { id: 'EV-089', risk: 0.19, level: 'L3', time: '4 min ago' },
            { id: 'EV-088', risk: 0.22, level: 'L3', time: '28 min ago' },
            { id: 'EV-087', risk: 0.17, level: 'L3', time: '1h ago' },
            { id: 'EV-086', risk: 0.21, level: 'L3', time: '3h ago' },
            { id: 'EV-085', risk: 0.24, level: 'L3', time: '5h ago' },
        ],
        trend: [0.31, 0.28, 0.26, 0.24, 0.22, 0.21, 0.20, 0.19, 0.22, 0.17, 0.21, 0.24, 0.19],
        alert: 'ok'
    },
    {
        id: 'mdl_02', name: 'GPT-5.1', provider: 'OpenAI', cert: 'ONTO-L2-074',
        risk_score: 0.23, layer: 'L2', calibration: 85, requests: 892, compliance: 'PASSED', last_eval: '12 min ago',
        evaluations: [
            { id: 'EV-074', risk: 0.23, level: 'L2', time: '12 min ago' },
            { id: 'EV-073', risk: 0.25, level: 'L2', time: '45 min ago' },
            { id: 'EV-072', risk: 0.21, level: 'L2', time: '2h ago' },
            { id: 'EV-071', risk: 0.28, level: 'L2', time: '4h ago' },
            { id: 'EV-070', risk: 0.30, level: 'L2', time: '8h ago' },
        ],
        trend: [0.35, 0.33, 0.30, 0.28, 0.27, 0.25, 0.23, 0.25, 0.21, 0.28, 0.30, 0.25, 0.23],
        alert: 'ok'
    },
    {
        id: 'mdl_03', name: 'GPT-4o', provider: 'OpenAI', cert: 'ONTO-L2-061',
        risk_score: 0.31, layer: 'L2', calibration: 78, requests: 2340, compliance: 'REVIEW', last_eval: '1h ago',
        evaluations: [
            { id: 'EV-061', risk: 0.31, level: 'L2', time: '1h ago' },
            { id: 'EV-060', risk: 0.29, level: 'L2', time: '3h ago' },
            { id: 'EV-059', risk: 0.34, level: 'L2', time: '6h ago' },
            { id: 'EV-058', risk: 0.27, level: 'L2', time: '12h ago' },
            { id: 'EV-057', risk: 0.25, level: 'L2', time: '1d ago' },
        ],
        trend: [0.25, 0.24, 0.27, 0.29, 0.31, 0.34, 0.29, 0.31, 0.33, 0.34, 0.29, 0.31, 0.31],
        alert: 'warn'
    },
    {
        id: 'mdl_04', name: 'Claude-4', provider: 'Anthropic', cert: 'ONTO-L3-091',
        risk_score: 0.12, layer: 'L3', calibration: 94, requests: 567, compliance: 'PASSED', last_eval: '8 min ago',
        evaluations: [
            { id: 'EV-091', risk: 0.12, level: 'L3', time: '8 min ago' },
            { id: 'EV-090', risk: 0.14, level: 'L3', time: '35 min ago' },
            { id: 'EV-089', risk: 0.11, level: 'L3', time: '2h ago' },
            { id: 'EV-088', risk: 0.15, level: 'L3', time: '5h ago' },
            { id: 'EV-087', risk: 0.13, level: 'L3', time: '8h ago' },
        ],
        trend: [0.18, 0.17, 0.15, 0.14, 0.13, 0.14, 0.12, 0.11, 0.14, 0.15, 0.13, 0.12, 0.12],
        alert: 'ok'
    }
];

// Old comparison/grid functions removed — dashboard v2 uses compact model list

function showAddModelModal() {
    document.getElementById('reg-model-provider').value = '';
    document.getElementById('reg-model-name').value = '';
    document.getElementById('reg-model-apikey').value = '';
    document.getElementById('register-model-modal').classList.add('active');
}

function updateModelHint() {
    const provider = document.getElementById('reg-model-provider').value;
    const hints = {
        'OpenAI': 'Starts with sk-... Get it at platform.openai.com/api-keys',
        'Anthropic': 'Starts with sk-ant-... Get it at console.anthropic.com',
        'Google': 'Get it at aistudio.google.com/apikey',
        'Meta': 'For Llama via Together/Groq — enter that provider\'s API key',
        'Mistral': 'Get it at console.mistral.ai/api-keys',
        'Other': 'Enter the API key for your model provider'
    };
    const hintEl = document.getElementById('reg-model-hint');
    if (hintEl) hintEl.textContent = hints[provider] || 'Your key is encrypted (AES-256) and used only to proxy requests through ONTO.';
}

async function submitModelRegistration() {
    const provider = document.getElementById('reg-model-provider').value;
    const name = document.getElementById('reg-model-name').value.trim();
    const providerKey = document.getElementById('reg-model-apikey').value.trim();
    
    if (!provider || !name) {
        showToast('Select a provider and enter model name', 'error');
        return;
    }
    if (!providerKey) {
        showToast('Enter your provider API key to enable ONTO proxy', 'error');
        return;
    }
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) {
        showToast('ONTO API key not found. Re-login or regenerate key.', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/v1/models/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
            body: JSON.stringify({ name, provider, provider_key: providerKey })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || 'Connection failed');
        
        closeModal('register-model-modal');
        showToast('Model "' + name + '" connected. ONTO proxy active. 14-day trial started.', 'success');
        await fetchUserModels();
    } catch (err) {
        showToast(err.message || 'Model connection failed', 'error');
    }
}

// === REFERENCE (STEALTH ADMIN) ===
let refAccessGranted = false;
let refNodesData = [];
let refNamespacesData = [];

async function checkReferenceAccess() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return false;
    try {
        const res = await fetch(`${API_BASE}/v1/docs/reference-check`, {
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            const data = await res.json();
            if (data.status === 'ok') {
                refAccessGranted = true;
                document.getElementById('nav-reference').style.display = 'flex';
                return true;
            }
        }
    } catch (e) {}
    return false;
}

async function showReferencePage(el) {
    if (!refAccessGranted) {
        const hasAccess = await checkReferenceAccess();
        if (!hasAccess) { showToast('Access denied', 'error'); return; }
    }
    showPage('reference', el);
    initAdminPanel();
}

// === SIGNAL & ACCOUNTS PANEL ===
let accountsData = [];
let currentUserId = null; // For self-protection
let signalData = null;
let signalInterval = null;
let accountSearchTimeout = null;

// Get current user ID on load
function initAdminPanel() {
    currentUserId = currentUser?.id || null;
    loadSignalData();
    loadAccountsData();
    startSignalCountdown();
}

// === SIGNAL FUNCTIONS ===
async function loadSignalData() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return;
    
    try {
        // Get admin status with full stats
        const statusRes = await fetch(`${API_BASE}/v1/signal/admin-status`, {
            headers: { 'x-api-key': apiKey }
        });
        
        if (statusRes.ok) {
            const stats = await statusRes.json();
            
            // Update signal ID and hash from current_signal
            if (stats.current_signal) {
                document.getElementById('signal-id').textContent = stats.current_signal.sigma_id || `σ_${stats.current_signal.timestamp}`;
                startHashAnimation(stats.current_signal.entropy_hex || '');
                
                // Pulse effect on hash
                const hashEl = document.getElementById('signal-hash');
                if (hashEl) {
                    hashEl.classList.add('pulse');
                    setTimeout(() => hashEl.classList.remove('pulse'), 1000);
                }
            }
            
            // Update metrics with pulse effect
            updateMetric('signal-uptime', formatUptime(stats.uptime_seconds));
            updateMetric('signal-generated', stats.signals_generated || 0);
            updateMetric('signal-requests', stats.total_requests || 0);
            // Error rate: show only if > 5%, otherwise "OK"
            const errorRate = stats.error_rate_percent || 0;
            if (errorRate < 5) {
                updateMetric('signal-errors', 'OK', 'good');
            } else {
                updateMetric('signal-errors', errorRate.toFixed(1) + '%', 'warn');
            }
            
            // Update pause state
            signalPaused = stats.paused || false;
            const indicator = document.getElementById('signal-live-indicator');
            if (indicator) {
                if (signalPaused) {
                    indicator.innerHTML = '<span class="signal-dot" style="background:#d97706;animation:none;"></span><span>PAUSED</span>';
                    indicator.style.background = 'rgba(245, 158, 11, 0.15)';
                    indicator.style.color = '#d97706';
                } else {
                    indicator.innerHTML = '<span class="signal-dot"></span><span>LIVE</span>';
                    indicator.style.background = 'rgba(34, 197, 94, 0.15)';
                    indicator.style.color = '#15803d';
                }
            }
            
            // Start countdown
            signalData = { next_update_in: stats.signal_interval - (stats.uptime_seconds % stats.signal_interval) };
            startSignalCountdown();
        }
    } catch (e) {
        console.error('Signal load error:', e);
        document.getElementById('signal-hash').textContent = 'Connection error';
    }
}

function updateMetric(id, value, style) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = value;
        
        // Apply style class (good/warn)
        el.classList.remove('metric-good', 'metric-warn');
        if (style === 'good') el.classList.add('metric-good');
        if (style === 'warn') el.classList.add('metric-warn');
        
        const metric = el.closest('.signal-metric');
        if (metric) {
            metric.classList.add('updated');
            setTimeout(() => metric.classList.remove('updated'), 800);
        }
    }
}

function formatUptime(seconds) {
    if (!seconds) return '—';
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    if (hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
}

let hashAnimationInterval = null;

function startHashAnimation(baseHash) {
    const hashEl = document.getElementById('signal-hash');
    if (!hashEl) return;
    
    if (!baseHash) {
        hashEl.textContent = 'Waiting for signal...';
        return;
    }
    
    // Stop previous animation
    if (hashAnimationInterval) clearInterval(hashAnimationInterval);
    
    const chars = '0123456789abcdef';
    const hashArray = baseHash.split('');
    let frame = 0;
    
    hashAnimationInterval = setInterval(() => {
        frame++;
        
        // Animate random positions with green glow
        const display = hashArray.map((char, i) => {
            if (frame % 3 === 0 && Math.random() > 0.9) {
                return `<span style="color:#15803d;text-shadow:0 0 8px #15803d;">${chars[Math.floor(Math.random() * 16)]}</span>`;
            }
            return char;
        }).join('');
        
        hashEl.innerHTML = display;
        
        // Reset to real hash periodically
        if (frame % 40 === 0) {
            hashEl.textContent = baseHash;
        }
    }, 80);
}

function renderSignal() {
    // Now handled in loadSignalData directly
}

function startSignalCountdown() {
    if (signalInterval) clearInterval(signalInterval);
    
    let remaining = signalData?.next_update_in || 300;
    
    signalInterval = setInterval(() => {
        remaining--;
        
        if (remaining <= 0) {
            document.getElementById('signal-countdown').textContent = '0:00';
            loadSignalData();
            remaining = 300;
        } else {
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            document.getElementById('signal-countdown').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

let signalPaused = false;

function refreshSignal() {
    loadSignalData();
    showToast('Signal refreshed', 'success');
}

async function refreshProofStats() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return;
    try {
        const pkRes = await fetch(`${API_BASE}/v1/signal/public-key`);
        if (pkRes.ok) {
            const pk = await pkRes.json();
            const el = document.getElementById('proof-pubkey');
            if (el) el.textContent = (pk.public_key_hex || '').substring(0, 8) + '...';
        }
        const statsRes = await fetch(`${API_BASE}/v1/admin/stats`, { headers: { 'x-api-key': apiKey } });
        if (statsRes.ok) {
            const stats = await statsRes.json();
            const totalEl = document.getElementById('proof-total');
            const h24El = document.getElementById('proof-24h');
            if (totalEl) totalEl.textContent = stats.total_evaluations || '—';
            if (h24El) h24El.textContent = stats.evaluations_24h || '—';
            if (stats.last_proof_hash) {
                const hashEl = document.getElementById('proof-last-hash');
                if (hashEl) hashEl.textContent = stats.last_proof_hash;
                const timeEl = document.getElementById('proof-last-time');
                if (timeEl && stats.last_proof_time) timeEl.textContent = new Date(stats.last_proof_time).toLocaleString();
            }
        }
    } catch(e) { console.log('Proof stats load:', e); }
}

// === ACCOUNTS FUNCTIONS ===
function debounceAccountSearch() {
    clearTimeout(accountSearchTimeout);
    accountSearchTimeout = setTimeout(loadAccountsData, 300);
}

function filterAccounts() {
    loadAccountsData();
}

async function loadAccountsData() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) return;
    
    const search = document.getElementById('accounts-search')?.value || '';
    const typeFilter = document.getElementById('filter-type')?.value || '';
    const statusFilter = document.getElementById('filter-status')?.value || '';
    const planFilter = document.getElementById('filter-plan')?.value || '';
    
    const container = document.getElementById('accounts-list');
    if (container) container.innerHTML = `
        <div class="account-row" style="padding: 16px;">
            <div class="skeleton skeleton-text" style="width: 200px; margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text-sm" style="width: 120px;"></div>
        </div>
        <div class="account-row" style="padding: 16px;">
            <div class="skeleton skeleton-text" style="width: 180px; margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text-sm" style="width: 100px;"></div>
        </div>
    `;
    
    try {
        let url = `${API_BASE}/v1/docs/admin/users?limit=50`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        
        const res = await fetch(url, { headers: { 'x-api-key': apiKey } });
        
        if (res.ok) {
            const data = await res.json();
            accountsData = data.users || [];
            
            // Client-side filtering
            let filtered = accountsData;
            if (typeFilter) {
                filtered = filtered.filter(u => {
                    const hasCompany = u.profile?.company_name;
                    return typeFilter === 'company' ? hasCompany : !hasCompany;
                });
            }
            if (statusFilter) {
                filtered = filtered.filter(u => {
                    const isActive = !u.suspended && u.is_active;
                    return statusFilter === 'active' ? isActive : !isActive;
                });
            }
            if (planFilter) {
                filtered = filtered.filter(u => u.tier === planFilter);
            }
            
            renderAccounts(filtered);
        }
    } catch (e) {
        console.error('Accounts load error:', e);
        if (container) container.innerHTML = '<div class="accounts-loading">Failed to load</div>';
    }
}

function renderAccounts(accounts) {
    const container = document.getElementById('accounts-list');
    if (!container) return;
    
    if (!accounts.length) {
        container.innerHTML = '<div class="accounts-loading">No accounts found</div>';
        return;
    }
    
    container.innerHTML = accounts.map(u => {
        const isSelf = u.id === currentUserId;
        const hasCompany = u.profile?.company_name;
        const isActive = !u.suspended && u.is_active !== false;
        const date = u.created_at ? new Date(u.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '—';
        const safeEmail = escapeHtml(u.email || '');
        const safeName = escapeHtml(u.name || '—');
        const safeOrgName = escapeHtml(u.org_name || '—');
        const safeTier = escapeHtml(u.tier || '');
        const safeCompany = hasCompany ? escapeHtml(u.profile.company_name) : '';
        const safeIndustry = hasCompany ? escapeHtml(u.profile.industry || '—') : '';
        const safeId = escapeHtml(u.id || '');
        
        return `
            <div class="account-row" onclick="toggleAccountDetails('${safeId}')">
                <div class="account-email">${safeEmail}${isSelf ? ' <span style="color: var(--accent); font-size: 9px;">(you)</span>' : ''}</div>
                <div class="account-type">${hasCompany ? 'Company' : 'Individual'}</div>
                <div class="account-plan"><span class="tier-badge tier-${safeTier}">${safeTier}</span></div>
                <div class="account-status ${isActive ? 'active' : 'paused'}">${isActive ? 'Active' : 'Paused'}</div>
                <div class="account-date">${date}</div>
            </div>
            <div class="account-details" id="details-${safeId}">
                <div class="account-details-grid">
                    <div class="account-detail-item">
                        <div class="account-detail-label">Name</div>
                        <div class="account-detail-value">${safeName}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Email Verified</div>
                        <div class="account-detail-value">${u.email_verified ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Last Login</div>
                        <div class="account-detail-value">${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Organization</div>
                        <div class="account-detail-value">${safeOrgName}</div>
                    </div>
                    ${hasCompany ? `
                    <div class="account-detail-item">
                        <div class="account-detail-label">Company</div>
                        <div class="account-detail-value">${safeCompany}</div>
                    </div>
                    <div class="account-detail-item">
                        <div class="account-detail-label">Industry</div>
                        <div class="account-detail-value">${safeIndustry}</div>
                    </div>
                    ` : ''}
                </div>
                <div class="account-actions">
                    <button class="account-action-btn" onclick="event.stopPropagation(); editPlan('${safeId}', '${safeTier}', '${safeEmail}')" ${isSelf ? 'disabled title="Cannot modify own plan"' : ''}>Edit Plan</button>
                    <button class="account-action-btn" onclick="event.stopPropagation(); toggleAccountStatus('${safeId}', ${isActive})" ${isSelf ? 'disabled title="Cannot pause own account"' : ''}>${isActive ? 'Pause' : 'Activate'}</button>
                    <button class="account-action-btn danger" onclick="event.stopPropagation(); deleteAccount('${safeId}', '${safeEmail}')" ${isSelf ? 'disabled title="Cannot delete own account"' : ''}>Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

function toggleAccountDetails(id) {
    const details = document.getElementById(`details-${id}`);
    if (details) {
        const isOpen = details.classList.contains('open');
        // Close all others
        document.querySelectorAll('.account-details').forEach(d => d.classList.remove('open'));
        if (!isOpen) details.classList.add('open');
    }
}

let editingUserId = null;
let editingUserEmail = null;

function editPlan(userId, currentTier, userEmail) {
    if (userId === currentUserId) {
        showSignal104b('self_action_attempt', '/admin/users/tier');
        return;
    }
    
    editingUserId = userId;
    editingUserEmail = userEmail || 'User';
    
    // Set user info
    document.getElementById('tier-user-info').innerHTML = `<div class="tier-user-email">${escapeHtml(editingUserEmail)}</div>`;
    
    // Reset selection
    document.querySelectorAll('input[name="tier-select"]').forEach(r => r.checked = false);
    
    // Select current tier
    const currentRadio = document.querySelector(`input[name="tier-select"][value="${currentTier}"]`);
    if (currentRadio) currentRadio.checked = true;
    
    // Reset days
    document.getElementById('tier-days').value = 30;
    
    // Show modal
    document.getElementById('tier-modal').classList.add('active');
}

async function saveTierChange() {
    if (!editingUserId) return;
    
    const selectedTier = document.querySelector('input[name="tier-select"]:checked');
    if (!selectedTier) {
        showToast('Select a tier', 'error');
        return;
    }
    
    const tier = selectedTier.value;
    const days = document.getElementById('tier-days').value || 30;
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/admin/users/${editingUserId}/tier?tier=${tier}&days=${days}`, {
            method: 'PUT',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast(`Plan updated to ${tier.toUpperCase()}`, 'success');
            closeModal('tier-modal');
            loadAccountsData();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Update failed', 'error');
        }
    } catch (e) {
        showToast('Update failed', 'error');
    }
}

async function toggleAccountStatus(userId, isCurrentlyActive) {
    if (userId === currentUserId) {
        showSignal104b('self_action_attempt', '/admin/users/suspend');
        return;
    }
    
    const action = isCurrentlyActive ? 'pause' : 'activate';
    if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} this account?`)) return;
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/admin/users/${userId}/suspend?suspend=${isCurrentlyActive}`, {
            method: 'PUT',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast(`Account ${action}d`, 'success');
            loadAccountsData();
        } else {
            showToast('Action failed', 'error');
        }
    } catch (e) {
        showToast('Action failed', 'error');
    }
}

async function deleteAccount(userId, email) {
    if (userId === currentUserId) {
        showSignal104b('self_action_attempt', '/admin/users/delete');
        return;
    }
    
    if (prompt(`Type the email to confirm deletion:\n${email}`) !== email) {
        showToast('Deletion cancelled', 'info');
        return;
    }
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/admin/users/${userId}`, {
            method: 'DELETE',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast('Account deleted', 'success');
            loadAccountsData();
        } else {
            const data = await res.json();
            showToast(data.detail || 'Delete failed', 'error');
        }
    } catch (e) {
        showToast('Delete failed', 'error');
    }
}

// === SIGNAL 104b ===
function showSignal104b(action, endpoint) {
    showToast('Action rejected. Signal: 104b', 'error');
    
    // Show log panel
    const panel = document.getElementById('signal-log-panel');
    if (panel) panel.style.display = 'block';
    
    const list = document.getElementById('signal-log-list');
    if (list) {
        const item = document.createElement('div');
        item.className = 'signal-log-item';
        item.innerHTML = `
            <span class="signal-log-code">104b</span>
            <span class="signal-log-endpoint">${endpoint}</span>
            <span class="signal-log-time">${new Date().toLocaleTimeString()}</span>
            <div style="margin-top: 4px; color: var(--text-muted);">${action.replace(/_/g, ' ')}</div>
        `;
        list.insertBefore(item, list.firstChild);
    }
}

function closeSignalLog() {
    const panel = document.getElementById('signal-log-panel');
    if (panel) panel.style.display = 'none';
}

async function loadReferenceData() {
    // Legacy - no longer used
}

function renderRefNodes() {
    const tbody = document.getElementById('ref-nodes-tbody');
    tbody.innerHTML = refNodesData.map(n => `
        <tr>
            <td>${n.ref || n.email}</td>
            <td>${n.label || n.name}</td>
            <td>${n.namespace || n.org_name || '-'}</td>
            <td><span class="tier-badge tier-${n.tier || 'open'}">${n.tier || 'open'}</span></td>
            <td><span class="ref-status ${n.active ? 'active' : 'archived'}">${n.active ? 'Active' : 'Archived'}</span></td>
            <td>
                ${n.active 
                    ? `<button class="ref-action-btn archive" onclick="refArchiveNode('${n.id}')">Archive</button>`
                    : `<button class="ref-action-btn restore" onclick="refRestoreNode('${n.id}')">Restore</button>`
                }
            </td>
        </tr>
    `).join('');
}

function filterRefNodes() {
    const search = document.getElementById('ref-search-nodes').value.toLowerCase();
    const filtered = refNodesData.filter(n => 
        (n.ref || n.email || '').toLowerCase().includes(search) ||
        (n.label || n.name || '').toLowerCase().includes(search) ||
        (n.namespace || n.org_name || '').toLowerCase().includes(search)
    );
    const tbody = document.getElementById('ref-nodes-tbody');
    tbody.innerHTML = filtered.map(n => `
        <tr>
            <td>${n.ref || n.email}</td>
            <td>${n.label || n.name}</td>
            <td>${n.namespace || n.org_name || '-'}</td>
            <td><span class="tier-badge tier-${n.tier || 'open'}">${n.tier || 'open'}</span></td>
            <td><span class="ref-status ${n.active ? 'active' : 'archived'}">${n.active ? 'Active' : 'Archived'}</span></td>
            <td>
                ${n.active 
                    ? `<button class="ref-action-btn archive" onclick="refArchiveNode('${n.id}')">Archive</button>`
                    : `<button class="ref-action-btn restore" onclick="refRestoreNode('${n.id}')">Restore</button>`
                }
            </td>
        </tr>
    `).join('');
}

function renderRefNamespaces() {
    const tbody = document.getElementById('ref-namespaces-tbody');
    tbody.innerHTML = refNamespacesData.map(ns => `
        <tr>
            <td>${ns.name}</td>
            <td><code style="font-size:11px;">${ns.slug}</code></td>
            <td><span class="tier-badge tier-${ns.tier || 'open'}">${ns.tier || 'open'}</span></td>
            <td>${ns.node_count || 0}</td>
            <td><span class="ref-status ${ns.is_banned ? 'frozen' : 'active'}">${ns.is_banned ? 'Frozen' : 'Active'}</span></td>
            <td>
                ${ns.is_banned 
                    ? `<button class="ref-action-btn restore" onclick="refUnfreezeNamespace('${ns.id}')">Unfreeze</button>`
                    : `<button class="ref-action-btn archive" onclick="refFreezeNamespace('${ns.id}')">Freeze</button>`
                }
                <button class="ref-action-btn export" onclick="refExportNamespace('${ns.id}')">Export</button>
            </td>
        </tr>
    `).join('');
}

function renderRefViolations(violations) {
    const tbody = document.getElementById('ref-violations-tbody');
    tbody.innerHTML = violations.length ? violations.map(v => `
        <tr>
            <td>${new Date(v.created_at).toLocaleString()}</td>
            <td>${v.org_name || v.org_slug || '-'}</td>
            <td><code style="font-size:11px;">${v.endpoint}</code></td>
            <td>${v.ip_address}</td>
            <td>${v.request_count}/${v.limit_value}</td>
        </tr>
    `).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">No violations</td></tr>';
}

function renderRefHoneypot(attempts) {
    const tbody = document.getElementById('ref-honeypot-tbody');
    tbody.innerHTML = attempts.length ? attempts.slice().reverse().map(a => `
        <tr>
            <td>${new Date(a.timestamp).toLocaleString()}</td>
            <td>${a.ip}</td>
            <td><code style="font-size:11px;">${a.endpoint}</code></td>
            <td>${a.method}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${a.user_agent || '-'}</td>
        </tr>
    `).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">No trap hits yet 🎣</td></tr>';
}

function showRefTab(tabId, el) {
    document.querySelectorAll('.ref-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.ref-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('ref-tab-' + tabId).classList.add('active');
    if (el) el.classList.add('active');
}

async function refArchiveNode(nodeId) {
    if (!confirm('Archive this node?')) return;
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/node-index/${nodeId}/archive`, {
            method: 'POST',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast('Node archived', 'success');
            loadReferenceData();
        } else {
            showToast('Failed to archive', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function refRestoreNode(nodeId) {
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/node-index/${nodeId}/restore`, {
            method: 'POST',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast('Node restored', 'success');
            loadReferenceData();
        } else {
            showToast('Failed to restore', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function refFreezeNamespace(nsId) {
    if (!confirm('Freeze this namespace? All API keys will be disabled.')) return;
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/namespace-registry/${nsId}/freeze`, {
            method: 'POST',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast('Namespace frozen', 'success');
            loadReferenceData();
        } else {
            showToast('Failed to freeze', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function refUnfreezeNamespace(nsId) {
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/namespace-registry/${nsId}/unfreeze`, {
            method: 'POST',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast('Namespace unfrozen', 'success');
            loadReferenceData();
        } else {
            showToast('Failed to unfreeze', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function refExportNamespace(nsId) {
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/namespace-export/${nsId}`, {
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            const data = await res.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `namespace-${nsId}-export.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Export downloaded', 'success');
        } else {
            showToast('Failed to export', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function refBroadcastAction(action) {
    const apiKey = localStorage.getItem('onto_first_api_key');
    try {
        const res = await fetch(`${API_BASE}/v1/docs/broadcast-control?action=${action}`, {
            method: 'POST',
            headers: { 'x-api-key': apiKey }
        });
        if (res.ok) {
            showToast(`Broadcast ${action} successful`, 'success');
            loadReferenceData();
        } else {
            showToast('Failed: ' + action, 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Check reference access on load


// === TELEMETRY ===
function updateUTCClock() {
    const el = document.getElementById('utc-clock');
    if (!el) return;
    const now = new Date();
    el.textContent = now.toISOString().substr(11, 8) + ' UTC';
}

function updateSparkline() {
    const container = document.getElementById('sparkline');
    if (!container) return;
    
    // Generate 7 random bars for week activity
    const heights = Array(7).fill(0).map(() => Math.floor(Math.random() * 16) + 4);
    container.innerHTML = heights.map(h => 
        `<div class="spark" style="height: ${h}px"></div>`
    ).join('');
}

function drawIndustryChart() {
    const canvas = document.getElementById('industry-canvas');
    const legend = document.getElementById('industry-legend');
    if (!canvas || !legend) return;
    
    const ctx = canvas.getContext('2d');
    const data = [
        { label: 'Finance', value: 28, color: '#d97706' },
        { label: 'Healthcare', value: 22, color: '#dc2626' },
        { label: 'AI Labs', value: 18, color: '#15803d' },
        { label: 'Enterprise', value: 12, color: '#64748b' },
        { label: 'Other', value: 20, color: '#6b7280' }
    ];
    
    const total = data.reduce((sum, d) => sum + d.value, 0);
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const radius = Math.min(cx, cy) - 10;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    let startAngle = -Math.PI / 2;
    data.forEach(d => {
        const sliceAngle = (d.value / total) * 2 * Math.PI;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, radius, startAngle, startAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = d.color;
        ctx.fill();
        startAngle += sliceAngle;
    });
    
    // Legend
    legend.innerHTML = data.map(d => 
        `<div class="legend-item">
            <span class="legend-dot" style="background: ${d.color}"></span>
            <span>${d.label}</span>
            <span class="legend-value">${d.value}%</span>
        </div>`
    ).join('');
}

// === CERTIFICATE VERIFICATION ===
const ermCertHash = 'a1b2c3d4e5f67890abcdef1234567890a1b2c3d4e5f67890abcdef1234567890';
let ermProxyActive = true;

function ermVerifyHash(input) {
    const result = document.getElementById('erm-verify-result');
    const msg = document.getElementById('erm-verify-msg');
    if (!input || input.length < 4) {
        result.innerHTML = '';
        result.style.background = 'none';
        msg.innerHTML = '';
        return;
    }
    if (!ermProxyActive) {
        result.innerHTML = '✕';
        result.style.background = 'rgba(220,38,38,0.15)';
        result.style.color = '#ef4444';
        msg.innerHTML = '<span style="color:#ef4444">Certificate suspended — proxy disconnected</span>';
        return;
    }
    if (input.trim() === ermCertHash) {
        result.innerHTML = '✓';
        result.style.background = 'rgba(34,197,94,0.15)';
        result.style.color = '#22c55e';
        msg.innerHTML = '<span style="color:#22c55e">Valid — ONTO GOLD layer active since Feb 15, 2026</span>';
    } else {
        result.innerHTML = '✕';
        result.style.background = 'rgba(220,38,38,0.15)';
        result.style.color = '#ef4444';
        msg.innerHTML = '<span style="color:#ef4444">Invalid hash — certificate not found</span>';
    }
}

function ermCopyHash() {
    navigator.clipboard.writeText(ermCertHash).then(() => {
        showToast('Hash copied to clipboard', 'success');
    }).catch(() => {
        const el = document.getElementById('erm-cert-hash');
        if (el) { const r = document.createRange(); r.selectNodeContents(el); const s = window.getSelection(); s.removeAllRanges(); s.addRange(r); document.execCommand('copy'); s.removeAllRanges(); }
        showToast('Hash copied', 'success');
    });
}

function ermDownloadCert() {
    const cert = {
        type: 'ONTO_VERIFIED_CERTIFICATE',
        version: '1.0',
        organization: 'Acme Corp',
        model: 'GPT-4o',
        provider: 'OpenAI',
        connected_since: '2026-02-15T00:00:00Z',
        proxy_status: ermProxyActive ? 'active' : 'suspended',
        gold_layer: 'injected',
        hash: ermCertHash,
        algorithm: 'Ed25519',
        packet_size: 104,
        chain: 'SHA-256',
        verify_url: 'https://ontostandard.org/c/ACM-2026-001',
        disclaimer: 'Always verify certificate validity. ONTO does not guarantee accuracy. Not responsible for decisions made by AI systems or their operators.'
    };
    const blob = new Blob([JSON.stringify(cert, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'onto-certificate-ACM-2026-001.json';
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('Certificate downloaded', 'success');
}

function ermSuspendCert() {
    ermProxyActive = false;
    const live = document.getElementById('user-signal-live');
    const hash = document.getElementById('erm-cert-hash');
    const statusText = document.getElementById('erm-sig-status-text');
    if (live) { live.querySelector('.signal-dot').style.background = '#ef4444'; live.querySelector('.signal-dot').style.boxShadow = '0 0 6px #ef4444'; }
    if (statusText) { statusText.textContent = 'SUSPENDED'; statusText.style.color = '#ef4444'; }
    if (hash) { hash.style.color = '#ef4444'; hash.style.textDecoration = 'line-through'; }
    ['proxy','gold','sig','chain'].forEach(k => {
        const el = document.getElementById('erm-check-' + k);
        if (el) { el.querySelector('span').innerHTML = '✕'; el.querySelector('span').style.color = '#ef4444'; }
    });
    const panel = document.getElementById('user-signal-panel');
    if (panel) { panel.style.borderColor = 'rgba(220,38,38,0.3)'; panel.style.background = 'linear-gradient(135deg, #1a0a0a 0%, #180d0d 50%, #1a0a0a 100%)'; }
    showToast('Certificate SUSPENDED — proxy disconnected', 'error');
}

function ermRestoreCert() {
    ermProxyActive = true;
    const live = document.getElementById('user-signal-live');
    const hash = document.getElementById('erm-cert-hash');
    const statusText = document.getElementById('erm-sig-status-text');
    if (live) { live.querySelector('.signal-dot').style.background = '#22c55e'; live.querySelector('.signal-dot').style.boxShadow = '0 0 6px #22c55e, 0 0 12px rgba(34, 197, 94, 0.5)'; }
    if (statusText) { statusText.textContent = 'ACTIVE'; statusText.style.color = ''; }
    if (hash) { hash.style.color = 'var(--accent)'; hash.style.textDecoration = 'none'; }
    ['proxy','gold','sig','chain'].forEach(k => {
        const el = document.getElementById('erm-check-' + k);
        if (el) { el.querySelector('span').innerHTML = '✓'; el.querySelector('span').style.color = 'var(--accent)'; }
    });
    const panel = document.getElementById('user-signal-panel');
    if (panel) { panel.style.borderColor = ''; panel.style.background = ''; }
    showToast('Certificate restored — proxy reconnected', 'success');
}

function ermDrawQR(canvas) {
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const s = canvas.width;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, s, s);
    ctx.fillStyle = '#000000';
    // Simplified QR pattern (visual placeholder — real QR from backend)
    const grid = 21;
    const cell = s / grid;
    // Finder patterns (3 corners)
    const drawFinder = (x, y) => {
        ctx.fillRect(x*cell, y*cell, 7*cell, 7*cell);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect((x+1)*cell, (y+1)*cell, 5*cell, 5*cell);
        ctx.fillStyle = '#000000';
        ctx.fillRect((x+2)*cell, (y+2)*cell, 3*cell, 3*cell);
    };
    drawFinder(0, 0);
    drawFinder(14, 0);
    drawFinder(0, 14);
    // Data modules (hash-derived pattern)
    for (let i = 0; i < ermCertHash.length && i < 40; i++) {
        const v = parseInt(ermCertHash[i], 16);
        if (v > 7) {
            const row = 8 + Math.floor(i / 8);
            const col = 8 + (i % 8);
            if (row < grid && col < grid) ctx.fillRect(col*cell, row*cell, cell, cell);
        }
    }
    // Timing
    for (let i = 8; i < 13; i += 2) {
        ctx.fillRect(i*cell, 6*cell, cell, cell);
        ctx.fillRect(6*cell, i*cell, cell, cell);
    }
}

function initErmCert() {
    const hash = document.getElementById('erm-cert-hash');
    if (hash) hash.textContent = ermCertHash;
    ermDrawQR(document.getElementById('erm-qr-canvas'));
}

// === EPISTEMIC RISK MONITOR ===
const ermQuestions = {
    med: [
        { q: "Evaluate the clinical evidence for statin therapy in cardiovascular prevention.",
          before: "Statins provide moderate benefit for high-risk patients, though individual response varies. They are generally recommended for patients with elevated cardiovascular risk, and the benefits typically outweigh the risks for most populations.",
          after: "Relative risk reduction ~20-25% per mmol/L LDL lowering (CTT Collaborators meta-analysis, 2010). Absolute risk reduction typically <1-2% over 5 years for primary prevention. NNT ~40-100 depending on baseline risk. Side effects: muscle symptoms 5-10%, rhabdomyolysis <0.01% (MHRA 2014). New-onset diabetes ~9% increased risk (Sattar et al., 2010). Confidence overall benefit in high-risk: 0.85. Confidence net benefit in low-risk primary prevention: 0.55." },
        { q: "What is the current evidence for SSRI efficacy in treating major depression?",
          before: "SSRIs are considered effective first-line treatments for major depression. While they help many patients, individual responses can vary significantly, and they may take several weeks to show full effects.",
          after: "Mean effect size vs placebo: SMD ~0.3 (Cipriani et al., Lancet 2018, network meta-analysis of 522 trials, n=116,477). Response rate: ~50% on SSRI vs ~35% placebo. NNT ~7-8 for response. Time to effect: 2-4 weeks, full effect 6-8 weeks. Discontinuation syndrome in ~20-50% (Davies & Read, 2019). Sexual dysfunction 25-73% (Serretti & Chiesa, 2009). Confidence efficacy moderate-severe: 0.80. Confidence efficacy mild vs placebo: 0.45." },
    ],
    ai: [
        { q: "What are the fundamental limitations of current large language models?",
          before: "LLMs have several limitations including hallucination, lack of true reasoning, potential bias in training data, and inability to access real-time information. They also struggle with mathematical reasoning and factual consistency.",
          after: "Key measurable limitations: (1) Hallucination rate ~3-15% depending on domain (Ji et al., ACM Computing Surveys 2023). (2) Calibration gap: models assign ~0.9 confidence to claims correct ~0.6-0.7 (Kadavath et al., 2022). (3) Arithmetic: accuracy drops above 5-digit operations, ~70% to ~20% (Dziri et al., 2023). (4) Context window finite. (5) Training data cutoff. No grounded world model. Confidence this covers major limitations: 0.75. Unknown: emergent capabilities at larger scales." },
        { q: "How effective is RLHF at aligning AI systems?",
          before: "RLHF has been an important technique for aligning AI systems with human values. It has shown promise in making models more helpful and less harmful, though it has some limitations.",
          after: "RLHF reduces harmful outputs by ~70-80% vs base models (Bai et al., 2022). Reward model accuracy: ~65-75% agreement with human preferences (Stiennon et al., 2020). Failure modes: reward hacking (Gao et al., 2023), sycophancy ~25-40% (Perez et al., 2022). Confidence surface behavior improvement: 0.85. Confidence deep alignment: 0.30." },
    ],
    econ: [
        { q: "Assess the effectiveness of quantitative easing as a monetary policy tool.",
          before: "Quantitative easing has been used by major central banks to stimulate economic activity during periods of crisis. While it has helped prevent deeper recessions, its long-term effects remain debated.",
          after: "Fed QE1-QE3 (2008-2014): ~$4.5T asset purchases. GDP impact: +2-3% cumulative (Engen et al., 2015). 10yr yield reduction: ~100-120bps (Gagnon et al., 2011). Employment: ~2-3M jobs preserved (Chung et al., 2012). Top 10% holds ~89% equities. Confidence QE prevents deflation: 0.80. Confidence sustainable growth: 0.40. Unknown: unwinding $9T+ balance sheet." },
    ],
    phys: [
        { q: "What is the current status of dark matter detection efforts?",
          before: "Despite decades of research, dark matter has not been directly detected. Various experiments continue to search using different approaches, and the mystery remains one of the biggest in physics.",
          after: "Direct detection: no confirmed signal after ~30 years. Best limits: XENONnT <9.2x10^-48 cm^2 at 28 GeV (Aprile et al., PRL 2023). DAMA/LIBRA 13.7 sigma signal not reproduced by ANAIS-112 or COSINE-100. Confidence DM exists as particle: 0.60. Confidence WIMP: 0.20." },
    ],
    bio: [
        { q: "What is the current understanding of the RNA World hypothesis?",
          before: "The RNA World hypothesis suggests RNA was the first self-replicating molecule and preceded both DNA and proteins. It remains one of the leading theories for the origin of life.",
          after: "Core: self-replicating RNA preceded DNA-protein life. Evidence: ribozyme catalysis (Cech 1982), ribosome = RNA catalyst (Ban et al., Science 2000). Gaps: no self-replicating ribozyme >200nt prebiotic, cytosine half-life ~340yr (Levy & Miller, PNAS 1998). Confidence RNA central role: 0.75. Confidence pure RNA World: 0.35." },
    ],
};
const ermCategories = [
    { id: 'med', name: 'Medicine' },
    { id: 'ai', name: 'AI / ML' },
    { id: 'econ', name: 'Economics' },
    { id: 'phys', name: 'Physics' },
    { id: 'bio', name: 'Biology' },
];
let ermCat = 'med', ermQIdx = 0, ermTyping = null, ermDone = false;

function ermCountNums(t) { return (t.match(/\d+[\.,]?\d*[%×^]*/g) || []).length; }
function ermCountSrc(t) { return (t.match(/\([A-Z][a-z].*?\d{4}\)/g) || []).length; }
function ermGetConf(t) { const m = t.match(/[Cc]onfidence[^:]*:\s*(0\.\d+)/g); return m ? m.length : 0; }
function ermHasUnc(t) { return /unknown|uncertain|no consensus|unclear|gap/i.test(t); }
function ermHasCounter(t) { return /however|but |although|limitation|risk|side effect|failure/i.test(t); }
function ermCountVague(t) {
    const v = t.match(/\b(moderate|significant|substantial|considerable|generally)\b/gi) || [];
    return v.filter(w => { const i = t.indexOf(w); return !/\d/.test(t.slice(Math.max(0, i - 20), i + w.length + 20)); }).length;
}

function ermTypewrite(el, text, speed, cb) {
    if (ermTyping) clearInterval(ermTyping);
    let idx = 0;
    el.innerHTML = '<span class="erm-typewriter-cursor">▋</span>';
    ermTyping = setInterval(() => {
        idx += 2;
        const shown = text.slice(0, idx);
        el.innerHTML = shown + (idx < text.length ? '<span class="erm-typewriter-cursor">▋</span>' : '');
        if (idx >= text.length) { clearInterval(ermTyping); ermTyping = null; if (cb) cb(); }
    }, speed);
}

function ermRenderTabs() {
    const tabsEl = document.getElementById('erm-cat-tabs');
    if (!tabsEl) return;
    tabsEl.innerHTML = ermCategories.map(c =>
        `<button class="erm-cat-tab ${ermCat === c.id ? 'active' : ''}" onclick="ermSwitchCat('${c.id}')">${c.name}</button>`
    ).join('');
}

function ermRenderPills() {
    const el = document.getElementById('erm-q-pills');
    if (!el) return;
    const qs = ermQuestions[ermCat];
    el.innerHTML = qs.map((q, i) =>
        `<button class="erm-q-pill ${ermQIdx === i ? 'active' : ''}" onclick="ermSwitchQ(${i})" title="${q.q}">${q.q}</button>`
    ).join('');
}

function ermRenderSplit() {
    const q = ermQuestions[ermCat][ermQIdx];
    const beforeBody = document.getElementById('erm-before-body');
    const afterBody = document.getElementById('erm-after-body');
    const beforeFoot = document.getElementById('erm-before-footer');
    const afterFoot = document.getElementById('erm-after-footer');
    const changedEl = document.getElementById('erm-changed');

    ermDone = false;
    if (changedEl) changedEl.style.display = 'none';
    if (afterFoot) afterFoot.style.display = 'none';

    // Before side
    ermTypewrite(beforeBody, q.before, 5);
    const bN = ermCountNums(q.before), bS = ermCountSrc(q.before), bC = ermGetConf(q.before);
    beforeFoot.innerHTML = `<span style="color:var(--danger)">${bN} numbers</span><span style="color:var(--danger)">${bS} sources</span><span style="color:var(--danger)">${bC} confidence</span>`;

    // After side delayed
    afterBody.innerHTML = '<span style="color:var(--text-muted);font-style:italic">Waiting...</span>';
    setTimeout(() => {
        ermTypewrite(afterBody, q.after, 4, () => {
            ermDone = true;
            const aN = ermCountNums(q.after), aS = ermCountSrc(q.after), aC = ermGetConf(q.after);
            afterFoot.innerHTML = `<span style="color:var(--accent)">${aN} numbers</span><span style="color:var(--accent)">${aS} sources</span><span style="color:var(--accent)">${aC} confidence</span>`;
            afterFoot.style.display = 'flex';
            ermRenderChanged(q);
        });
    }, 600);
}

function ermRenderChanged(q) {
    const el = document.getElementById('erm-changed');
    const rows = document.getElementById('erm-changed-rows');
    if (!el || !rows) return;
    const bN=ermCountNums(q.before),aN=ermCountNums(q.after);
    const bS=ermCountSrc(q.before),aS=ermCountSrc(q.after);
    const bC=ermGetConf(q.before),aC=ermGetConf(q.after);
    const bH=ermHasUnc(q.before),aH=ermHasUnc(q.after);
    const bB=ermHasCounter(q.before),aB=ermHasCounter(q.after);
    const bV=ermCountVague(q.before),aV=ermCountVague(q.after);
    const metrics = [
        { label: 'Numbers', b: bN, a: aN, tip: 'Regex: \\d+%?. Range: 0-20+' },
        { label: 'Over-conf', b: 'high', a: '−35%', highlight: true, tip: 'Confident claims without evidence. Enterprise safety metric.' },
        { label: 'Sources', b: bS, a: aS, tip: 'Pattern: (Author, Year). 0-10+' },
        { label: 'Confidence', b: bC, a: aC, tip: "'Confidence: 0.XX'. 0-5+" },
        { label: 'Honesty', b: bH?'yes':'no', a: aH?'yes':'no', tip: 'unknown/unclear/gap. Binary.' },
        { label: 'Balance', b: bB?'yes':'no', a: aB?'yes':'no', tip: 'however/risk/limitation. Binary.' },
        { label: 'Filler', b: bV, a: aV, penalty: true, tip: 'Vague words w/o number. Lower=better.' },
    ];
    rows.innerHTML = metrics.map(m => {
        const bColor = m.highlight ? 'var(--text-muted)' : m.penalty ? 'var(--text-muted)' : 'var(--danger)';
        const aColor = m.highlight ? 'var(--accent)' : m.penalty ? (m.a < m.b ? 'var(--accent)' : 'var(--danger)') : 'var(--accent)';
        const labelColor = m.highlight ? 'var(--accent)' : 'var(--text)';
        return `<div class="erm-changed-row ${m.highlight ? 'highlight' : ''}">
            <span style="font-weight:600;cursor:help;color:${labelColor}" title="${m.tip}">${m.label}</span>
            <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:${bColor};text-align:right">${m.b}</span>
            <span style="color:var(--text-muted);text-align:center">→</span>
            <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:${aColor}">${m.a}</span>
        </div>`;
    }).join('');
    el.style.display = 'block';
}

function ermSwitchCat(cat) {
    ermCat = cat; ermQIdx = 0;
    ermRenderTabs(); ermRenderPills(); ermRenderSplit();
}
function ermSwitchQ(idx) {
    ermQIdx = idx;
    ermRenderPills(); ermRenderSplit();
}

function initERM() {
    ermRenderTabs(); ermRenderPills(); ermRenderSplit();
}

// === INIT ===
document.addEventListener('DOMContentLoaded', () => {
    const savedUser = localStorage.getItem('onto_user');
    const savedToken = localStorage.getItem('onto_token');
    const savedApiKey = localStorage.getItem('onto_first_api_key');
    const savedLoggedIn = localStorage.getItem('onto_logged_in');
    
    if (savedLoggedIn === 'true' && savedApiKey) {
        // Restore subscription from onto_user JSON if available
        let savedSub = null;
        if (savedUser) {
            try { savedSub = JSON.parse(savedUser).subscription || null; } catch(e) {}
        }
        currentUser = {
            id: localStorage.getItem('onto_user_id'),
            name: localStorage.getItem('onto_user_name'),
            email: localStorage.getItem('onto_user_email'),
            organization_id: localStorage.getItem('onto_org_id'),
            organization_name: localStorage.getItem('onto_org_name'),
            layer: localStorage.getItem('onto_layer'),
            plan: layerToPlan(localStorage.getItem('onto_layer')),
            role: localStorage.getItem('onto_role'),
            subscription: savedSub
        };
        authToken = savedToken || savedApiKey;
        showDashboard();
    }
    else if (savedUser && savedToken) {
        try {
            currentUser = JSON.parse(savedUser);
            authToken = savedToken;
            showDashboard();
        } catch (e) {
            localStorage.removeItem('onto_user');
            localStorage.removeItem('onto_token');
            showAuthScreen();
        }
    }
    else {
        showAuthScreen();
    }
    
    checkWelcomeBanner();
    initERM();
    initErmCert();
    updateSignalHash();
    updateUTCClock();
    updateSparkline();
    drawIndustryChart();
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.remove('open');
        }
    });
});

// ================================================================
// EVALUATE PAGE (standalone — redirects to dashboard)
// ================================================================
let evalSessionHistory = [];

function toggleEvalOptional() {
    const fields = document.getElementById('eval-optional');
    const chevron = document.getElementById('eval-opt-chevron');
    if (!fields) return;
    const isOpen = fields.classList.contains('show');
    fields.classList.toggle('show');
    chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
}

function populateEvalModels() {
    // Only populate with real API models, not mock data
    const models = window._cachedModels || [];
    ['eval-model-select', 'dash-eval-model'].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '<option value="">— optional —</option>';
        models.forEach(m => {
            sel.innerHTML += `<option value="${m.id}">${m.name}</option>`;
        });
    });
}

async function submitEvaluation() {
    // Standalone evaluate page — redirect to dashboard with all fields
    showPage('dashboard', document.querySelector('.nav-item[onclick*=dashboard]'));
    document.getElementById('dash-eval-output').value = document.getElementById('eval-output')?.value || '';
    document.getElementById('dash-eval-domain').value = document.getElementById('eval-domain')?.value || 'general';
    // Copy model selection
    const modelVal = document.getElementById('eval-model-select')?.value || '';
    if (modelVal) document.getElementById('dash-eval-model').value = modelVal;
    // Copy advanced fields
    const gt = document.getElementById('eval-gt')?.value || '';
    const conf = document.getElementById('eval-confidence')?.value || '';
    const ctx = document.getElementById('eval-context')?.value || '';
    if (gt) document.getElementById('dash-eval-gt').value = gt;
    if (conf) document.getElementById('dash-eval-conf').value = conf;
    if (ctx) document.getElementById('dash-eval-ctx').value = ctx;
    dashSubmitEval();
}

// ================================================================
// DASHBOARD — EVALUATE-FIRST
// ================================================================

function updateEvalHint() {
    const hint = document.getElementById('dash-eval-hint');
    const modelId = document.getElementById('dash-eval-model')?.value;
    hint.textContent = modelId ? '→ Saved to model history' : 'Quick check · not saved';
}

function toggleSignalPanel() {
    const body = document.getElementById('signal-body-collapsible');
    const chevron = document.getElementById('signal-chevron');
    const isOpen = body.style.display !== 'none';
    body.style.display = isOpen ? 'none' : 'block';
    chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
}

function toggleDevTools() {
    const body = document.getElementById('dev-tools-body');
    const hint = document.getElementById('dev-tools-hint');
    const chevron = document.getElementById('dev-tools-chevron');
    const isOpen = body.style.display !== 'none';
    body.style.display = isOpen ? 'none' : 'block';
    hint.style.display = isOpen ? 'block' : 'none';
    chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
}

// Certification thresholds — single source of truth
// ============================================================
// AUDIT TRAIL / SNAPSHOTS (Phase 2.5 — Certify→Snapshots pivot)
// ============================================================

function updateCertifyPage() {
    // Populate model selector from cached models
    const select = document.getElementById('snap-model-select');
    if (!select) return;
    
    const models = window._cachedModels || [];
    const currentVal = select.value;
    select.innerHTML = '<option value="">Select model...</option>';
    
    models.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = `${m.name} (${m.provider || '—'})`;
        select.appendChild(opt);
    });
    
    if (currentVal) select.value = currentVal;
    
    const btn = document.getElementById('snap-create-btn');
    if (btn) btn.disabled = !select.value;
    
    if (select.value) loadSnapshots();
}

async function loadSnapshots() {
    const select = document.getElementById('snap-model-select');
    const modelId = select?.value;
    const btn = document.getElementById('snap-create-btn');
    if (btn) btn.disabled = !modelId;
    
    if (!modelId) {
        document.getElementById('snap-timeline-list').innerHTML = 
            '<div style="padding:40px;text-align:center;color:var(--text-muted);font-size:12px">Select a model to view snapshots</div>';
        document.getElementById('snap-stat-count').textContent = '0';
        document.getElementById('snap-stat-risk').textContent = '—';
        document.getElementById('snap-stat-layer').textContent = '—';
        document.getElementById('snap-stat-age').textContent = '—';
        document.getElementById('snap-timeline-info').textContent = '';
        return;
    }
    
    try {
        const apiKey = localStorage.getItem('onto_first_api_key');
        const res = await fetch(`${API_BASE}/v1/models/${modelId}/snapshots?limit=50`, {
            headers: { 'x-api-key': apiKey }
        });
        
        if (!res.ok) throw new Error('Failed to load snapshots');
        const data = await res.json();
        const snaps = data.snapshots || [];
        
        // Update stats
        document.getElementById('snap-stat-count').textContent = data.total || 0;
        document.getElementById('snap-timeline-info').textContent = `${data.total || 0} total`;
        
        if (snaps.length > 0) {
            const latest = snaps[0];
            document.getElementById('snap-stat-risk').textContent = latest.risk_score != null ? latest.risk_score.toFixed(3) : '—';
            document.getElementById('snap-stat-risk').style.color = riskColor(latest.risk_score);
            document.getElementById('snap-stat-layer').textContent = latest.layer || '—';
            document.getElementById('snap-stat-layer').style.color = layerColor(latest.layer);
            
            const ageEl = document.getElementById('snap-stat-age');
            ageEl.textContent = latest.age || '—';
            ageEl.style.color = ageColor(latest.age);
        } else {
            document.getElementById('snap-stat-risk').textContent = '—';
            document.getElementById('snap-stat-layer').textContent = '—';
            document.getElementById('snap-stat-age').textContent = '—';
        }
        
        renderSnapshotTimeline(snaps);
    } catch (e) {
        console.error('Snapshots load error:', e);
        document.getElementById('snap-timeline-list').innerHTML = 
            '<div style="padding:40px;text-align:center;color:var(--text-muted);font-size:12px">Failed to load snapshots</div>';
    }
}

function renderSnapshotTimeline(snaps) {
    const list = document.getElementById('snap-timeline-list');
    if (!snaps.length) {
        list.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted);font-size:12px">No snapshots yet. Create your first snapshot to start the audit trail.</div>';
        return;
    }
    
    list.innerHTML = snaps.map((s, i) => {
        const date = s.created_at ? new Date(s.created_at) : null;
        const dateStr = date ? date.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) : '—';
        const timeStr = date ? date.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}) : '';
        const ageBadge = ageBadgeHtml(s.age);
        const proofShort = s.proof_hash ? s.proof_hash.substring(0, 12) + '…' : 'unsigned';
        const verifyUrl = s.proof_hash ? `${API_BASE}/v1/verify/${s.proof_hash}` : '';
        
        return `<div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;${i===0?'background:var(--bg-elevated)':''}">
            <div style="width:3px;height:32px;border-radius:2px;background:${layerColor(s.layer)};flex-shrink:0"></div>
            <div style="flex:1;min-width:0">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px">
                    <span style="font-size:12px;font-weight:600;font-family:var(--mono)">${s.snapshot_number}</span>
                    ${ageBadge}
                </div>
                <div style="font-size:11px;color:var(--text-muted)">${dateStr} ${timeStr} · ${s.eval_count || 0} evals</div>
            </div>
            <div style="text-align:right;flex-shrink:0">
                <div style="font-size:14px;font-weight:700;font-variant-numeric:tabular-nums;color:${riskColor(s.risk_score)}">${s.risk_score != null ? s.risk_score.toFixed(3) : '—'}</div>
                <div style="font-size:10px;color:${layerColor(s.layer)};font-weight:600">${s.layer || '—'} · ${s.compliance || '—'}</div>
            </div>
            <div style="flex-shrink:0;font-size:10px;color:var(--text-muted);font-family:var(--mono);max-width:100px;overflow:hidden;text-overflow:ellipsis" title="${s.proof_hash || ''}">
                ${verifyUrl ? `<a href="${verifyUrl}" target="_blank" style="color:var(--accent);text-decoration:none">${proofShort}</a>` : proofShort}
            </div>
        </div>`;
    }).join('');
}

async function createSnapshot() {
    const select = document.getElementById('snap-model-select');
    const modelId = select?.value;
    if (!modelId) { showToast('Select a model first', 'error'); return; }
    
    const btn = document.getElementById('snap-create-btn');
    btn.disabled = true;
    btn.textContent = 'Creating…';
    
    try {
        const apiKey = localStorage.getItem('onto_first_api_key');
        const res = await fetch(`${API_BASE}/v1/models/${modelId}/snapshot`, {
            method: 'POST',
            headers: { 'x-api-key': apiKey, 'Content-Type': 'application/json' }
        });
        
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Snapshot creation failed');
        }
        
        const data = await res.json();
        showToast(`Snapshot ${data.snapshot_number} created. Proof: ${(data.proof_hash || '').substring(0, 12)}…`, 'success');
        loadSnapshots();
    } catch (e) {
        showToast(e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create Snapshot';
    }
}

function ageColor(age) {
    if (age === 'fresh') return '#22c55e';
    if (age === 'stale') return '#eab308';
    if (age === 'expired') return '#ef4444';
    return 'var(--text-muted)';
}

function ageBadgeHtml(age) {
    const colors = { fresh: '#22c55e', stale: '#eab308', expired: '#ef4444' };
    const c = colors[age] || 'var(--text-muted)';
    return `<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:${c}15;color:${c};font-weight:600;text-transform:uppercase;letter-spacing:0.3px">${age || '—'}</span>`;
}

function layerColor(layer) {
    if (layer === 'L3') return '#22c55e';
    if (layer === 'L2') return '#64748b';
    if (layer === 'L1') return '#eab308';
    return 'var(--text-muted)';
}

function riskColor(risk) {
    if (risk == null) return 'var(--text-muted)';
    if (risk < 0.25) return '#22c55e';
    if (risk < 0.50) return '#64748b';
    if (risk < 0.70) return '#eab308';
    return '#ef4444';
}

function updateSdkPage() {
    if (!currentUser) return;
    const plan = currentUser.plan || 'free';
    const planNames = { free: 'Open', business: 'Standard', enterprise: 'Certified' };
    const rateLimits = { free: '10/hr · 50/day', business: 'Unlimited', enterprise: 'Unlimited' };
    
    const nameEl = document.getElementById('sdk-plan-name');
    const rateEl = document.getElementById('sdk-plan-rate');
    const callsEl = document.getElementById('sdk-plan-calls');
    const upgradeBtn = document.getElementById('sdk-upgrade-btn');
    if (nameEl) nameEl.textContent = planNames[plan] || 'Open';
    if (rateEl) rateEl.textContent = rateLimits[plan] || '1 request / hour';
    if (upgradeBtn) upgradeBtn.style.display = plan === 'free' ? 'inline-block' : 'none';
    
    const realApiKey = localStorage.getItem('onto_first_api_key');
    if (realApiKey) {
        const keyInput = document.getElementById('api-key-display');
        if (keyInput) keyInput.value = realApiKey;
    }
}

function toggleDashEvalAdvanced() {
    const fields = document.getElementById('dash-eval-advanced');
    const chevron = document.getElementById('dash-eval-chevron');
    const isOpen = fields.classList.contains('show');
    fields.classList.toggle('show');
    chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
}

async function dashSubmitEval() {
    const output = document.getElementById('dash-eval-output').value.trim();
    if (!output) { showToast('Paste AI output to evaluate', 'error'); return; }

    const domain = document.getElementById('dash-eval-domain').value;
    const modelId = document.getElementById('dash-eval-model')?.value || '';
    const gt = document.getElementById('dash-eval-gt')?.value.trim();
    const confVal = document.getElementById('dash-eval-conf')?.value;
    const context = document.getElementById('dash-eval-ctx')?.value.trim();

    const btn = document.getElementById('dash-eval-btn');
    btn.disabled = true;
    btn.textContent = 'Evaluating...';

    try {
        let result;
        if (modelId) {
            // Model selected → authenticated evaluate, persists to DB
            const apiKey = localStorage.getItem('onto_first_api_key');
            if (!apiKey) {
                showToast('API key not found. Regenerate in Settings.', 'error');
                return;
            }
            const body = { model_id: modelId, output, domain };
            if (gt) body.ground_truth = gt;
            if (confVal !== '' && confVal !== undefined) body.confidence = parseFloat(confVal);
            if (context) body.context = context;
            
            const response = await fetch(`${API_BASE}/v1/models/evaluate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.detail || 'Evaluation failed');
            result = data;
            // Refresh models list to update layer/status
            setTimeout(() => fetchUserModels(), 500);
        } else {
            // No model → public /v1/check
            const body = { output, domain };
            if (gt) body.ground_truth = gt;
            if (confVal !== '' && confVal !== undefined) body.confidence = parseFloat(confVal);
            if (context) body.context = context;
            
            result = await api('/v1/check', {
                method: 'POST',
                body: JSON.stringify(body)
            });
        }
        dashDisplayResult(result, domain, output);
    } catch (err) {
        showToast('Evaluation failed: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Evaluate →';
    }
}

function dashDisplayResult(r, domain, output) {
    document.getElementById('dash-result-empty').style.display = 'none';
    document.getElementById('dash-result-content').style.display = 'block';

    const risk = r.risk_score || 0;
    const circumference = 213.6;
    const offset = circumference * (1 - risk);
    const ring = document.getElementById('dash-ring-fill');
    ring.style.strokeDashoffset = offset;
    ring.style.stroke = risk >= 0.65 ? '#ef4444' : risk >= 0.35 ? '#eab308' : '#22c55e';
    document.getElementById('dash-score-val').textContent = risk.toFixed(3);

    const comp = (r.compliance || '—').toUpperCase();
    const badge = document.getElementById('dash-comp-badge');
    badge.textContent = comp;
    const compClass = ['A','B'].includes(comp) ? 'passed' : ['C','D'].includes(comp) ? 'review' : ['E','F','FAILED'].includes(comp) ? 'failed' : 'review';
    badge.className = 'eval-compliance-badge ' + compClass;

    const dm = r.factors?.domain_multiplier || 1.0;
    const layerStr = r.layer || '—';
    const engineStr = r.engine_version ? 'v' + r.engine_version : '';
    const sigStr = r.signals_used ? r.signals_used + ' signals' : '';
    document.getElementById('dash-result-meta').textContent = 
        layerStr + ' · ' + domain.charAt(0).toUpperCase() + domain.slice(1) + ' ×' + dm.toFixed(1) + 
        (engineStr ? ' · ' + engineStr : '') + (sigStr ? ' · ' + sigStr : '') + 
        ' · ' + new Date().toLocaleTimeString();

    const f = r.factors || {};
    dashSetFactor('f1', f.linguistic_uncertainty, true);
    dashSetFactor('f2', f.confidence_calibration);
    dashSetFactor('f3', f.logprob_entropy);
    dashSetFactor('f4', f.semantic_consistency, true);
    dashSetFactor('f5', f.ground_truth_accuracy);
    dashSetFactor('f6', f.refusal_awareness);
    dashSetFactorDM(f.domain_multiplier);

    // Signal info
    const hib = f.honest_ignorance_bonus || 0;
    let signalText = '';
    if (hib > 0) signalText += 'Honest ignorance bonus: -' + hib.toFixed(3) + '  ';
    const hardSignals = [f.confidence_calibration, f.logprob_entropy, f.ground_truth_accuracy].filter(v => v !== null && v !== undefined).length;
    signalText += hardSignals + '/3 hard signals provided';
    document.getElementById('dash-result-signals').textContent = signalText;

    // Proof badge
    const proofWrap = document.getElementById('dash-proof-badge-wrap');
    const proofHash = r.proof_hash;
    if (proofHash && proofWrap) {
        proofWrap.style.display = 'block';
        document.getElementById('dash-proof-hash').textContent = proofHash.substring(0, 16) + '...' + proofHash.substring(proofHash.length - 8);
        document.getElementById('dash-proof-badge').href = '/verify/?hash=' + proofHash;
        document.getElementById('dash-proof-badge').onclick = function(e) {
            e.preventDefault();
            window.open('/verify/?hash=' + proofHash, '_blank');
        };
    } else if (proofWrap) {
        proofWrap.style.display = 'none';
    }

    // Recommendations
    const recsWrap = document.getElementById('dash-recs-wrap');
    const recsList = document.getElementById('dash-recs-list');
    const recs = r.recommendations || [];
    if (recs.length > 0 && recsWrap && recsList) {
        recsWrap.style.display = 'block';
        const sevColors = { critical: '#ef4444', high: '#f97316', medium: '#eab308', low: '#64748b', info: '#22c55e' };
        recsList.innerHTML = recs.map(rec => {
            const c = sevColors[rec.severity] || 'var(--text-muted)';
            return `<div style="padding:6px 8px;margin-bottom:4px;border-left:2px solid ${c};background:${c}08;border-radius:0 4px 4px 0;font-size:11px;color:var(--text-secondary);line-height:1.5">
                <span style="color:${c};font-weight:600;text-transform:uppercase;font-size:9px;letter-spacing:0.3px">${rec.severity || ''}</span>
                <span style="margin-left:6px">${rec.message || ''}</span>
            </div>`;
        }).join('');
    } else if (recsWrap) {
        recsWrap.style.display = 'none';
    }

    // Rolling marker update
    const markerWrap = document.getElementById('dash-marker-wrap');
    if (r.marker && markerWrap) {
        markerWrap.style.display = 'block';
        const m = r.marker;
        const levelEl = document.getElementById('dash-marker-level');
        const riskEl = document.getElementById('dash-marker-risk');
        const progressEl = document.getElementById('dash-marker-progress');
        const statusEl = document.getElementById('dash-marker-status');
        
        if (levelEl) {
            levelEl.textContent = m.marker;
            levelEl.style.color = m.marker === 'L3' ? '#22c55e' : m.marker === 'L2' ? '#eab308' : '#ef4444';
        }
        if (riskEl) riskEl.textContent = 'avg risk: ' + (m.avg_risk !== null ? m.avg_risk.toFixed(4) : '—');
        if (progressEl) progressEl.textContent = m.eval_count + ' / ' + m.window + ' evals';
        if (statusEl) {
            if (m.changed) {
                statusEl.textContent = '⬆ Changed from ' + m.previous;
                statusEl.style.color = '#22c55e';
            } else if (m.eval_count < m.window) {
                statusEl.textContent = 'Calibrating (' + Math.round(m.eval_count / m.window * 100) + '%)';
                statusEl.style.color = 'var(--text-muted)';
            } else {
                statusEl.textContent = 'Stable';
                statusEl.style.color = 'var(--text-muted)';
            }
        }
    }

    // Add to history
    evalSessionHistory.unshift({ risk, compliance: comp, domain, output: output.substring(0, 60), time: new Date().toLocaleTimeString(), proof_hash: r.proof_hash || null });
    renderDashHistory();

    // Scroll to result
    document.getElementById('dash-result-content').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function dashSetFactor(id, value, inverted) {
    const bar = document.getElementById('df-' + id);
    const val = document.getElementById('dv-' + id);
    if (value === null || value === undefined) {
        bar.style.width = '0%';
        val.textContent = 'n/a';
        bar.style.background = 'var(--border)';
        return;
    }
    val.textContent = typeof value === 'number' ? value.toFixed(3) : value;
    const pct = (typeof value === 'number' ? value : 0) * 100;
    bar.style.width = Math.max(pct, 2) + '%';
    if (inverted) {
        bar.style.background = pct >= 60 ? '#ef4444' : pct >= 30 ? '#eab308' : '#22c55e';
    } else {
        bar.style.background = pct >= 60 ? '#22c55e' : pct >= 30 ? '#eab308' : '#ef4444';
    }
}

function dashSetFactorDM(value) {
    const bar = document.getElementById('df-dm');
    const val = document.getElementById('dv-dm');
    if (!value) { val.textContent = '×1.0'; bar.style.width = '0%'; return; }
    val.textContent = '×' + value.toFixed(1);
    const pct = Math.max(0, Math.min(100, ((value - 0.5) / 1.0) * 100));
    bar.style.width = pct + '%';
    bar.style.background = value >= 1.3 ? '#ef4444' : value >= 1.1 ? '#eab308' : '#22c55e';
}

function renderDashHistory() {
    const container = document.getElementById('dash-history-rows');
    const empty = document.getElementById('dash-history-empty');
    const count = document.getElementById('dash-history-count');
    if (evalSessionHistory.length === 0) { empty.style.display = 'block'; container.innerHTML = ''; return; }
    empty.style.display = 'none';
    count.textContent = evalSessionHistory.length + ' evaluation' + (evalSessionHistory.length !== 1 ? 's' : '');

    container.innerHTML = evalSessionHistory.slice(0, 30).map(h => {
        const color = h.compliance === 'FAILED' ? '#ef4444' : h.compliance === 'REVIEW' ? '#eab308' : '#22c55e';
        const bg = h.compliance === 'FAILED' ? 'rgba(239,68,68,0.12)' : h.compliance === 'REVIEW' ? 'rgba(234,179,8,0.12)' : 'rgba(34,197,94,0.12)';
        return `<div class="eval-history-row">
            <span class="risk-pill" style="background:${bg};color:${color}">${h.risk.toFixed(3)}</span>
            <span class="eval-history-output" title="${h.output}">${h.output}</span>
            <span style="color:${color};font-weight:500;font-size:11px">${h.compliance}</span>
            <span style="color:var(--text-muted);font-size:11px;text-align:right">${h.time}</span>
        </div>`;
    }).join('');
}

// === MODELS & DASHBOARD ===
let _currentDetailModelId = null;

// ONTO Composite grading (from experiment data)
function gradeFromComposite(c) {
    if (c >= 5.0) return { grade: 'A', label: 'ONTO VERIFIED', color: '#22c55e', badgeColor: '#22c55e', certified: true };
    if (c >= 4.0) return { grade: 'A-', label: 'ONTO VERIFIED', color: '#22c55e', badgeColor: '#22c55e', certified: true };
    if (c >= 3.0) return { grade: 'B', label: 'ONTO VERIFIED', color: '#4ade80', badgeColor: '#4ade80', certified: true };
    if (c >= 2.0) return { grade: 'C', label: 'ONTO MEASURED', color: '#eab308', badgeColor: '#eab308', certified: false };
    if (c >= 1.0) return { grade: 'D', label: 'Report only', color: '#f97316', badgeColor: '#f97316', certified: false };
    return { grade: 'F', label: 'Report only', color: '#ef4444', badgeColor: '#ef4444', certified: false };
}

async function fetchUserModels() {
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (!apiKey) { window._cachedModels = []; return; }
    try {
        const response = await fetch(`${API_BASE}/v1/models`, {
            headers: { 'x-api-key': apiKey }
        });
        if (!response.ok) { window._cachedModels = []; return; }
        const data = await response.json();
        window._cachedModels = (data.models || []).map(m => ({
            id: m.id, name: m.name, provider: m.provider, version: m.version,
            layer: m.layer, composite: m.latest_risk || 0, compliance: m.latest_compliance,
            calibration: m.latest_calibration, eval_count: m.eval_count,
            created_at: m.created_at, updated_at: m.updated_at,
            baseline: null, treatment: null, demo: false, status: 'connected'
        }));
        renderDashModels();
        populateEvalModels();
        updateAuditStats();
    } catch (e) { window._cachedModels = []; }
}

function renderDashModels() {
    const onboarding = document.getElementById('dash-onboarding');
    const modelsSection = document.getElementById('dash-models-section');
    const modelsList = document.getElementById('dash-models-list');
    const realModels = window._cachedModels || [];
    const hasReal = realModels.length > 0;
    
    // Demo is always visible (static HTML), no rendering needed
    
    if (!hasReal) {
        if (onboarding) onboarding.style.display = 'block';
        if (modelsSection) modelsSection.style.display = 'none';
        updateDashStatusBar([]);
        return;
    }
    
    if (onboarding) onboarding.style.display = 'none';
    if (modelsSection) modelsSection.style.display = 'block';
    
    // Compact rows
    if (modelsList) {
        modelsList.innerHTML = realModels.map((m, i) => renderModelRow(m, i === realModels.length - 1)).join('');
    }
    
    updateDashStatusBar(realModels);
}

function renderModelRow(m, isLast) {
    const status = m.eval_count > 0 ? 'Evaluated' : 'Connected';
    const statusColor = m.eval_count > 0 ? 'var(--accent)' : 'var(--text-muted)';
    const statusIcon = m.eval_count > 0
        ? '<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--accent)"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
        : '<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--text-muted)"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
    const border = isLast ? '' : 'border-bottom:1px solid var(--border);';
    const evalText = m.eval_count > 0 ? `${m.eval_count} eval${m.eval_count !== 1 ? 's' : ''}` : 'No evaluations yet';
    const actionBtn = m.eval_count > 0
        ? `<button class="btn-minimal" onclick="event.stopPropagation();openDashModelDetail('${m.id}')" style="font-size:10px;padding:3px 10px;border:1px solid var(--border)">Details →</button>`
        : `<button class="eval-submit-btn" onclick="event.stopPropagation();showToast('Proxy activates GOLD on every request','info')" style="font-size:10px;padding:3px 12px">Run Evaluation</button>`;
    
    return `<div style="display:flex;align-items:center;gap:12px;padding:10px 14px;${border}cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background=''" onclick="openDashModelDetail('${m.id}')">
        <div style="flex:1;min-width:0">
            <div style="font-size:12px;font-weight:600;color:var(--text)">${m.name}</div>
            <div style="font-size:10px;color:var(--text-muted)">${m.provider || '—'}</div>
        </div>
        <div style="display:flex;align-items:center;gap:4px">
            ${statusIcon}
            <span style="font-size:10px;color:${statusColor}">${status}</span>
        </div>
        <div style="font-size:10px;color:var(--text-muted);min-width:80px;text-align:right">${evalText}</div>
        ${actionBtn}
    </div>`;
}

function updateDashStatusBar(models) {
    models = models || window._cachedModels || [];
    const plan = currentUser ? (currentUser.plan || 'free') : 'free';
    const planNames = { free: 'Trial', trial: 'Trial', business: 'Standard', enterprise: 'Critical' };
    const planEl = document.getElementById('dash-status-plan');
    const trialEl = document.getElementById('dash-status-trial');
    const modelsEl = document.getElementById('dash-status-models');
    const evalsEl = document.getElementById('dash-status-evals');
    const apiEl = document.getElementById('dash-status-api');
    
    if (planEl) planEl.textContent = planNames[plan] || 'Trial';
    
    // Trial countdown (demo: 12 days)
    if (trialEl) {
        if (plan === 'free' || plan === 'trial') {
            const daysLeft = currentUser?.trial_days_left || 14;
            trialEl.textContent = `· ${daysLeft} days left`;
            trialEl.style.display = 'inline';
            trialEl.style.color = daysLeft <= 3 ? '#ef4444' : '#eab308';
        } else {
            trialEl.style.display = 'none';
        }
    }
    
    if (modelsEl) modelsEl.textContent = models.length;
    const totalEvals = models.reduce((sum, m) => sum + (m.eval_count || 0), 0);
    if (evalsEl) evalsEl.textContent = totalEvals;
    
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (apiEl) {
        if (apiKey && models.length > 0) {
            apiEl.textContent = 'active';
            apiEl.style.color = '#22c55e';
        } else if (apiKey) {
            apiEl.textContent = 'ready';
            apiEl.style.color = 'var(--text-secondary)';
        } else {
            apiEl.textContent = 'inactive';
            apiEl.style.color = 'var(--text-muted)';
        }
    }
}

function openDashModelDetail(modelId) {
    const realModels = window._cachedModels || [];
    const m = realModels.find(x => x.id === modelId);
    if (!m) return;
    _currentDetailModelId = modelId;
    
    const demo = document.getElementById('dash-demo');
    const modelsSection = document.getElementById('dash-models-section');
    const detail = document.getElementById('dash-detail-expanded');
    if (demo) demo.style.display = 'none';
    if (modelsSection) modelsSection.style.display = 'none';
    if (detail) detail.style.display = 'block';

    document.getElementById('dash-detail-name').textContent = m.name;
    document.getElementById('dash-detail-provider').textContent = m.provider || '—';
    
    const comp = m.composite || 0;
    const g = gradeFromComposite(comp);
    
    // Baseline (current data)
    const baseEl = document.getElementById('dash-detail-baseline');
    if (baseEl) { baseEl.textContent = comp.toFixed(2); baseEl.style.color = g.color; }
    const bgEl = document.getElementById('dash-detail-baseline-grade');
    if (bgEl) { bgEl.textContent = 'Grade ' + g.grade; bgEl.style.color = g.color; }
    
    // Treatment
    const treatEl = document.getElementById('dash-detail-treatment');
    const tgEl = document.getElementById('dash-detail-treatment-grade');
    const impEl = document.getElementById('dash-detail-improvement');
    if (m.treatment) {
        const tG = gradeFromComposite(m.treatment.composite);
        if (treatEl) { treatEl.textContent = m.treatment.composite.toFixed(2); treatEl.style.color = tG.color; }
        if (tgEl) { tgEl.textContent = 'Grade ' + tG.grade; tgEl.style.color = tG.color; }
        const pct = Math.round(((m.treatment.composite - comp) / Math.max(comp, 0.01)) * 100);
        if (impEl) { impEl.textContent = '+' + pct + '%'; impEl.style.color = 'var(--accent)'; }
    } else {
        if (treatEl) treatEl.textContent = '—';
        if (tgEl) { tgEl.textContent = 'Run evaluation to measure'; tgEl.style.color = 'var(--text-muted)'; }
        if (impEl) { impEl.textContent = 'Pending'; impEl.style.color = 'var(--text-muted)'; }
    }
    
    // Grade / Evals
    document.getElementById('dash-detail-layer').textContent = g.certified ? '✓' : '—';
    document.getElementById('dash-detail-comp').textContent = g.grade;
    document.getElementById('dash-detail-evals').textContent = m.eval_count || 0;

    // Trend
    const trendContainer = document.getElementById('dash-detail-trend');
    if (m.trend && m.trend.length) {
        const max = Math.max(...m.trend, 3);
        trendContainer.innerHTML = m.trend.map(v => {
            const gv = gradeFromComposite(v);
            const h = Math.max((v / max) * 80, 4);
            return `<div class="trend-bar" style="height:${h}px;background:${gv.color}" data-val="${v.toFixed(2)}"></div>`;
        }).join('');
        const avg = m.trend.reduce((a, b) => a + b, 0) / m.trend.length;
        document.getElementById('dash-detail-trend-avg').textContent = 'Avg: ' + avg.toFixed(2);
        const dir = m.trend.length > 1 && m.trend[m.trend.length - 1] > m.trend[0];
        const dirEl = document.getElementById('dash-detail-trend-dir');
        dirEl.textContent = dir ? '↑ Improving' : '↓ Declining';
        dirEl.className = 'trend-dir ' + (dir ? 'improving' : 'worsening');
    } else {
        trendContainer.innerHTML = '<div style="text-align:center;padding:20px 0;color:var(--text-muted);font-size:11px">No trend data yet · Run evaluation to start tracking</div>';
    }
    
    // Metrics (placeholder until backend)
    const metricNames = { qd: 'Numbers instead of words', ss: 'Sources cited', um: 'Admits uncertainty', cp: 'Counterarguments', conf: 'Calibrated confidence' };
    ['qd','ss','um','cp','conf'].forEach(k => {
        const bEl = document.getElementById('dm-'+k+'-before');
        const aEl = document.getElementById('dm-'+k+'-after');
        if (m.baseline && bEl) bEl.textContent = m.baseline[k]?.toFixed(2) || '—';
        else if (bEl) bEl.textContent = '—';
        if (m.treatment && aEl) aEl.textContent = m.treatment[k]?.toFixed(2) || '—';
        else if (aEl) aEl.textContent = '—';
    });
}

function closeDashModelDetail() {
    const demo = document.getElementById('dash-demo');
    const modelsSection = document.getElementById('dash-models-section');
    const detail = document.getElementById('dash-detail-expanded');
    if (detail) detail.style.display = 'none';
    if (demo) demo.style.display = 'block';
    if (modelsSection) modelsSection.style.display = 'block';
    _currentDetailModelId = null;
}

async function deleteDashModel() {
    if (!_currentDetailModelId) return;
    if (!confirm('Disconnect this model? This cannot be undone.')) return;
    const apiKey = localStorage.getItem('onto_first_api_key');
    if (apiKey) {
        try {
            await fetch(`${API_BASE}/v1/models/${_currentDetailModelId}`, {
                method: 'DELETE', headers: { 'x-api-key': apiKey }
            });
        } catch (e) { /* continue */ }
    }
    window._cachedModels = (window._cachedModels || []).filter(m => m.id !== _currentDetailModelId);
    closeDashModelDetail();
    renderDashModels();
    populateEvalModels();
    showToast('Model disconnected', 'success');
}

// Initialize dashboard models on page load
setTimeout(() => { renderDashModels(); populateEvalModels(); }, 100);
</script>
</body>
</html>
